<?xml version="1.0" encoding="UTF-8"?>
<!-- author:Guine -->
<sqlMap>
    <parameterMap class="commonj.sdo.DataObject" id="parameterMap">
        <parameter javaType="date" jdbcType="DATE" property="dateType"/>
    </parameterMap>
    <resultMap class="commonj.sdo.DataObject" id="resultMap">
        <result column="TYPEID" javaType="string" property="typeId"/>
    </resultMap>
    <!--字典定义-->
    <select id="queryIncomeExpenItem" parameterClass="HashMap" resultClass="HashMap">
    	SELECT A.id, orgid, code, A.name, item_type_id itemTypeId, is_primary_business isPrimaryBusiness, parent_id parentId, 
        B.name parentName, level_num levelNum, is_disabled isDisabled, modifier, modify_date modifyDate, B.num
        FROM fib_income_expenses A
		LEFT JOIN(
			select A.ID, P.name, CASE WHEN COUNT(B.id)>0 then 1 ELSE 0 END NUM 
			from fib_income_expenses A 
			LEFT JOIN fib_income_expenses B ON B.parent_id=A.ID AND B.is_disabled=0
            LEFT JOIN fib_income_expenses P ON A.parent_id = P.id
			GROUP BY A.ID, P.name
		)B ON A.ID=B.ID
		WHERE is_disabled = 0
		
        <isNull property="parentId">
            <isNull property="code">
                <isNull property="name">
                    And LENGTH(IFNULL(A.parent_id,''))=0
                </isNull>
            </isNull>
        </isNull>
        <isNotNull property="parentId">
			And A.parent_id = #parentId#
		</isNotNull>
        
		<isNotNull property="code">
			AND A.code like '%$code$%'
		</isNotNull>
        <isNotNull property="name">
			AND A.name like '%$name$%'
		</isNotNull>
    </select>
     <select id="queryInit" parameterClass="HashMap" resultClass="HashMap">
     	SELECT a.rp_code rpCode,a.id, a.orgid, a.guest_id guestId, a.guest_full_name guestFullName, c.full_name fullName, a.rp_type rpType, a.service_code serviceCode, a.service_type_id serviceTypeId, 
         a.rp_amt rpAmt, a.rp_amt_yes rpAmtYes, a.rp_amt_no rpAmtNo, a.bill_amt billAmt, a.bill_status billStatus, a.auditor, a.audit_date auditDate, a.on_account_date onAccountDate, 
         b.pay_sum paySum, a.on_account_surety onAccountSurety, a.on_account_type onAccountType, a.remark, a.recorder, a.record_date recordDate, datediff( CURDATE(),a.audit_date) OwnDay
 		 FROM fis_rp_account a LEFT JOIN ( 
         SELECT service_code,   SUM(rp_amt) pay_sum
         FROM fis_rp_account b 
         WHERE rp_type = -1 
         GROUP BY service_code 
 		) b on a.service_code = b.service_code  
		LEFT JOIN wb_common.com_guest c on a.guest_id = c.id 
		
		WHERE a.rp_amt &gt;0 and a.orgid = #userOrgId# and a.rp_type = 1 
		and a.service_type_id not in ('1', '-1') 
		and (a.rp_amt_no &lt;&gt; 0 OR (a.rp_amt_no = 0 
		and not exists   (select 1 from fis_rp_check_off b where a.id = b.rp_id)))
		<isNotNull property="guestId">
			AND a.guest_id = #guestId#
		</isNotNull>
		<isNotNull property="gd">
			AND a.service_code like '%$gd$%'
		</isNotNull>
		<isNotNull property="assignStatus">
			AND a.bill_status = #assignStatus#
		</isNotNull>
		
		
		<isEqual  property="timeStatus" compareValue="today">
	
			AND date(a.record_date) = date(NOW())
			
		</isEqual>
		<isEqual  property="timeStatus" compareValue="yesterday">
			<!--AND SELECT PERIOD_DIFF( date_format( now( ) , '%Y%m%d' ) , date_format(a.record_date, '%Y%m%d' ) )=1-->
			AND TO_DAYS(NOW()) - TO_DAYS(a.record_date) = 1
		</isEqual>
		<isEqual  property="timeStatus" compareValue="week">
	
			And YEARWEEK(a.record_date) = YEARWEEK(now())
		</isEqual>
		<isEqual  property="timeStatus" compareValue="month">
			And MONTH(a.record_date) = MONTH(now())
		
		</isEqual>
		<isEqual  property="timeStatus" compareValue="smounth">
			And PERIOD_DIFF( date_format( now( ) , '%Y%m' ) , date_format( a.record_date , '%Y%m' ) ) =1

		</isEqual>
		<isEqual  property="timeStatus" compareValue="year">
			And YEAR(a.record_date) = YEAR(now())

		</isEqual>

    </select>
    
     <select id="queryreciveInit" parameterClass="HashMap" resultClass="HashMap">
     	SELECT
			id,orgid,guest_id guestId,guest_full_name guestFullName,rp_type rpType,service_code serviceCode,
			service_type_id serviceTypeId,rp_amt rpAmt,rp_amt_yes rpAmtYes,rp_amt_no rpAmtNo,bill_amt billAmt,
			bill_status billStatus,auditor,audit_date auditDate,on_account_date onAccountDate,on_account_surety onAccountSurety,
			on_account_type onAccountType,remark,recorder,record_date recordDate,
			DATEDIFF(CURDATE(), a.audit_date) OwnDay
		FROM
			fis_rp_account a
		WHERE
			1 = 1
		AND orgid = #userOrgId#
		AND rp_type = -1
		AND service_type_id NOT IN ('1', '-1')
		AND rp_amt &gt;= 0
	
		AND (
			rp_amt_no &lt;&gt; 0
			OR (
				rp_amt_no = 0
				AND NOT EXISTS (
					SELECT
						1
					FROM
						fis_rp_check_off b
					WHERE
						a.id = b.rp_id
				)
			)
		)	
	
		AND EXISTS (
			SELECT
				1
			FROM
				wb_common.com_dataitems
			WHERE
				DictID IN (
					'DDT20130706000015',
					'DDT20130706000016'
			)
		
		and CustomID = a.service_type_id	
		AND Property1 = '0') 
			
		<isNotNull property="guestId">
			AND a.guest_id = #guestId#
		</isNotNull>
		<isNotNull property="gd">
			AND a.service_code like '%$gd$%'
		</isNotNull>
		<isNotNull property="assignStatus">
			AND a.bill_status = #assignStatus#
		</isNotNull>
		<isEqual  property="timeStatus" compareValue="today">
	
			AND date(a.record_date) = date(NOW())
			
		</isEqual>
		<isEqual  property="timeStatus" compareValue="yesterday">
			AND TO_DAYS(NOW()) - TO_DAYS(a.record_date) = 1
			
		</isEqual>
		<isEqual  property="timeStatus" compareValue="week">
	
			And YEARWEEK(a.record_date) = YEARWEEK(now())
		</isEqual>
		<isEqual  property="timeStatus" compareValue="month">
			And MONTH(a.record_date) = MONTH(now())
		
		</isEqual>
		<isEqual  property="timeStatus" compareValue="smounth">
			And PERIOD_DIFF( date_format( now( ) , '%Y%m' ) , date_format( a.record_date , '%Y%m' ) ) =1

		</isEqual>
		<isEqual  property="timeStatus" compareValue="year">
			And YEAR(a.record_date) = YEAR(now())

		</isEqual>

    </select>
    
    
    
    
    
    <update id="updateInit" parameterClass="HashMap">
    	update fis_rp_account
    	set bill_status = 0
    	where service_code=#serviceCode#
    </update>
    
    <select id="getrevenueAndExpenditure" parameterClass="HashMap" resultClass="HashMap">
    select a.id,a.orgid,a.rp_bill_id rpBillId,a.rp_id rpId,a.guest_id guestId,a.rp_mode_type rpModeType,a.check_off_amt checkOffAmt,a.check_off_man checkOffMan,a.check_off_date checkOffDate,a.bill_status billStatus,a.remark,b.service_code serviceCode from fis_rp_check_off a left join fis_rp_account b on a.rp_id = b.id 
 	where a.orgid = 'COM20171009000001' 
 	AND a.rp_bill_id IN (
	SELECT id FROM fis_rp_bill_list WHERE orgid = 'COM20171009000001' AND rp_date gt;= '2018-05-01'
	AND rp_date &lt;= '2018-05-31 23:59:59'
	and rp_type_id = 1
	) ORDER BY a.rp_bill_id 
    </select>
    
    
     <select id="dayMoneyReporttwo" parameterClass="HashMap" resultClass="HashMap">
   
      	SELECT   
        	a.id tid, b.id AS checkid, b.rp_bill_id rpBillId, a.guest_full_name guestFullName, 
			c.service_code ServiceCode, ABS(b.check_off_amt) AS Famount ,
			b.check_off_man checkOffMan, b.check_off_date checkOffDate, b.remark remark
			FROM 
			fis_rp_bill_list AS a INNER JOIN  fis_rp_check_off AS b ON a.id = b.rp_bill_id 
			LEFT OUTER JOIN   fis_rp_account AS c ON b.rp_id = c.id 
			<!--WHERE (a.id IN (SELECT  id FROM  fis_rp_bill_list 
			WHERE (orgid = 'COM20171009000001') AND (rp_purpose_id = '02020108'))) -->
			
				<isEqual  property="timeStatus" compareValue="today">
			
					AND date(a.record_date) = date(NOW())
					
				</isEqual>
				<isEqual  property="timeStatus" compareValue="tomorrow">
					AND date(a.record_date) = date(NOW())-1
					
				</isEqual>
				<isEqual  property="timeStatus" compareValue="week">
			
					And YEARWEEK(a.record_date) = YEARWEEK(now())
				</isEqual>
				<isEqual  property="timeStatus" compareValue="month">
					And MONTH(a.record_date) = MONTH(now())
				
				</isEqual>
				<isEqual  property="timeStatus" compareValue="smounth">
					And MONTH(a.record_date) = MONTH(now())-1
		
				</isEqual>
				<isEqual  property="timeStatus" compareValue="year">
					And YEAR(a.record_date) = YEAR(now())
		
				</isEqual>
         </select>
      <select id="dayMoneyReportone" parameterClass="HashMap" resultClass="HashMap">
           SELECT a.id, a.code, a.orgid, a.guest_id guestId, a.guest_full_name guestFullName , a.rp_type_id rpTypeId,
				a.rp_mode_id rpModeId, a.rp_purpose_id rpPurposeId , a.rp_amt rpAmt, a.offset_amt offsetAmt, a.offset_amt_no offsetAmtNo,
				a.service_ids serviceIds, a.remark remark, a.rp_man rpMan, a.record_date recordDate<!--, 
				CASE WHEN rp_mode_id = '020101' 
				THEN rp_amt END XJ,   CASE WHEN rp_mode_id = '020102' THEN rp_amt END SK, CASE WHEN 
				rp_mode_id = '020103' THEN rp_amt END  HK, CASE WHEN rp_mode_id = '020104' THEN rp_amt END  ZP, 
				 CASE WHEN rp_mode_id = '020105' THEN rp_amt END  ZZ,  CASE WHEN rp_mode_id = '020107' 
				THEN rp_amt END DK,   
				CASE WHEN rp_mode_id = '020107' THEN rp_amt END memberAmt, 
				CASE WHEN rp_mode_id not in ('020101', '020102', '020105','020106','020107') THEN rp_amt END QT,  
				 CASE WHEN rp_mode_id = '020106' THEN rp_amt END  HZ -->  
				 FROM fis_rp_bill_list a LEFT JOIN (                    
				SELECT rp_bill_id,  SUM(check_off_amt) SSum FROM  fis_rp_check_off C INNER JOIN 
				fis_rp_account R ON C.rp_id = R.id  <!--WHERE rp_amt &lt; 0  -->GROUP BY rp_bill_id  ) 
				b ON a.id = b.rp_bill_id LEFT JOIN (   SELECT  rp_bill_id, SUM(check_off_amt) FSum   
				FROM  fis_rp_check_off C INNER JOIN fis_rp_account R ON C.rp_id = R.id  <!--WHERE  rp_amt &gt; 0  -->
				GROUP BY rp_bill_id  ) c ON a.id = c.rp_bill_id  
				<!--WHERE   a.orgid = 'COM20171009000001'-->
				
				<isEqual  property="timeStatus" compareValue="today">
			
					AND date(a.record_date) = date(NOW())
					
				</isEqual>
				<isEqual  property="timeStatus" compareValue="tomorrow">
					AND date(a.record_date) = date(NOW())-1
					
				</isEqual>
				<isEqual  property="timeStatus" compareValue="week">
			
					And YEARWEEK(a.record_date) = YEARWEEK(now())
				</isEqual>
				<isEqual  property="timeStatus" compareValue="month">
					And MONTH(a.record_date) = MONTH(now())
				
				</isEqual>
				<isEqual  property="timeStatus" compareValue="smounth">
					And MONTH(a.record_date) = MONTH(now())-1
		
				</isEqual>
				<isEqual  property="timeStatus" compareValue="year">
					And YEAR(a.record_date) = YEAR(now())
		
				</isEqual>
				
				ORDER BY a.id , a.service_ids 
	</select>
    <select id="querySettlementrAmt" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
			SELECT
				a.bala_type_code as code,
				sum(a.char_off_amt) as rAmt
			FROM
				fis_rp_account_d_type a
				 INNER JOIN fis_rp_account as b on(a.main_id=b.id)
			
			WHERE 
				a.rp_dc=1

            <isNotEmpty prepend="and" property="startDate">  
                (b.create_date &gt;= #startDate#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="endDate">  
                (b.create_date &lt; #endDate#)
            </isNotEmpty>
            			GROUP BY
				a.bala_type_code
    </select>
    <select id="querySettlementcAmt" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
			SELECT
				a.bala_type_code as code,
				sum(a.char_off_amt) as cAmt
			FROM
				fis_rp_account_d_type a
				 INNER JOIN fis_rp_account as b on(a.main_id=b.id)
			
			WHERE 
				a.rp_dc=-1

            <isNotEmpty prepend="and" property="startDate">  
                (b.create_date &gt;= #startDate#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="endDate">  
                (b.create_date &lt; #endDate#)
            </isNotEmpty>
            			GROUP BY
				a.bala_type_code
    </select>
    
    <select id="queryOtherIncomeAndExpenditure" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
			SELECT
				a.guest_name AS guestName,
				b.name    AS billTypeId,
				a.bill_dc AS billDc,
				a.rp_amt AS rpAmt,
				a.char_off_amt AS charOffAmt,
				a.auditor,
				a.audit_sign AS auditSign,
				a.audit_date AS auditDate,
				a.settle_status AS settleStatus,
				a.remark AS remark,
				a.rp_bill_id AS rpBillId,
				a.create_date AS createDate
			FROM
				wb_frm.fis_rp_bill a
				LEFT JOIN wb_frm.fib_income_expenses b on (b.id=a.bill_type_id)
			WHERE
				rp_type_id = 2
		<dynamic>
            <isNotEmpty prepend="and" property="guestName">  
                (a.guest_name  like '%$guestName$%')
            </isNotEmpty>
            <isNotEmpty prepend="and" property="settleStatus">  
                (a.settle_status = #settleStatus#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="auditSign">  
                (a.audit_sign = #auditSign#)
            </isNotEmpty>

            <isNotEmpty prepend="and" property="screateDate">  
                (a.create_date &gt;= #screateDate#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="ecreateDate">  
                (a.create_date &lt; #ecreateDate#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="sauditDate">  
                (a.audit_date  &gt;= #sauditDate#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="eauditDate">  
                (a.audit_date  &lt; #eauditDate#)
            </isNotEmpty>
        </dynamic>  
        order by a.create_date
	</select>
    
    
    	<!--结算账户余额表-->
     <select id="querySummaryAccountBalances" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
			SELECT
			    a.id as id,
	            a.main_id as mainId,
	            a.sett_account_id as settAccountId,
	            a.sett_account_name as settAccountName,
	            a.bala_type_code as balaTypeCode,
	            a.bala_type_name as balaTypeName,
	            a.sett_account_code as settAccountCode,
	            a.rp_dc  as rpDc,
	            a.char_off_amt as charOffAmt,
	            a.remark as remark,
				b.create_date as createDate,
				b.guest_name as guestName,
				b.orgid as orgid,
				b.rp_account_id as rpAccountId,
				b.guest_id as guestId
			FROM
				fis_rp_account_d_type a
				 INNER JOIN fis_rp_account  b on(a.main_id=b.id)
			
			WHERE 
				a.sett_account_id=#settAccountId#
		       AND  b.orgid = #orgid#

            <isNotEmpty prepend="and" property="startDate">  
                (b.create_date &gt;= #startDate#)
            </isNotEmpty>
            <isNotEmpty prepend="and" property="endDate">  
                (b.create_date &lt; #endDate#)
            </isNotEmpty>
    </select>
    
    
    </sqlMap>