!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.M800Call=t():e.M800Call=t()}("undefined"!=typeof self?self:this,function(){return webpackJsonpM800_name_([1],{138:function(e,t,i){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}Object.defineProperty(t,"__esModule",{value:!0}),t.setting=t.rejectReason=t.ErrorCode=t.EndCause=t.DTMF=t.CallType=t.CallStatus=t.CallState=t.CallSessionEvent=t.CallScheme=t.CallResult=t.CallEvent=t.CallError=t.CallDirection=void 0;var s=i(729),n=r(s),a=i(730),o=r(a),u=i(343),c=r(u),l=i(731),h=r(l),d=i(732),p=r(d),f=i(733),g=r(f),m=i(734),v=r(m),T=i(212),_=r(T),E=i(735),C=r(E),S=i(736),y=r(S),A=i(344),R=r(A),b=i(737),I=r(b),w=i(738),D=r(w),O=i(345),N=r(O);t.CallDirection=n,t.CallError=o,t.CallEvent=c,t.CallResult=h,t.CallScheme=p,t.CallSessionEvent=g,t.CallState=v,t.CallStatus=_,t.CallType=C,t.DTMF=y,t.EndCause=R,t.ErrorCode=I,t.rejectReason=D,t.setting=N,t.default={CallDirection:n,CallError:o,CallEvent:c,CallResult:h,CallScheme:p,CallSessionEvent:g,CallState:v,CallStatus:_,CallType:C,DTMF:y,EndCause:R,ErrorCode:I,rejectReason:D,setting:N}},212:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.IDLE="idle",t.INCOMING="incoming-call",t.CONNECTING="connecting-call",t.ACTIVE="call-active",t.ENDED="call-ended"},343:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ERROR="call-error",t.STATUS_UPDATED="call-status-updated",t.MUTE_STATUS_UPDATED="mute-status-updated",t.HOLD_STATUS_UPDATED="hold-status-updated",t.INCOMING_CALL="incoming-call",t.CALLS_UPDATED="calls-updated",t.OUTGOING_CALL="outgoing-call",t.CALL_ENDED="call-ended"},344:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ANSWERED="answered",t.CANCELLED="cancelled",t.DECLINED="declined",t.MISSED="missed",t.REJECTED="rejected",t.TERMINATED="terminated",t.TIMEOUT="timeout",t.FAILED="failed",t.NO_ACCESS="no-access"},345:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.DO_REGISTER=!1},346:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}Object.defineProperty(t,"__esModule",{value:!0});var a,o,u,c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},l=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),h=i(5),d=r(h),p=i(739),f=r(p),g=i(3),m=r(g),v=i(12),T=r(v),_=i(138),E=i(0),C=(a={},n(a,_.CallStatus.INCOMING,_.CallState.RINGING),n(a,_.CallStatus.CONNECTING,_.CallState.CONNECTING),n(a,_.CallStatus.ACTIVE,_.CallState.TALKING),n(a,_.CallStatus.ENDED,_.CallState.ENDED),a),S=Object.values(_.DTMF),y=function(e){return S.indexOf(e)>-1},A=(o={},n(o,_.EndCause.ANSWERED,_.CallResult.ANSWERED),n(o,_.EndCause.MISSED,_.CallResult.MISSED),n(o,_.EndCause.TIMEOUT,_.CallResult.NO_ANSWER),n(o,_.EndCause.REJECTED,_.CallResult.REJECTED),n(o,_.EndCause.DECLINED,_.CallResult.REJECTED),n(o,_.EndCause.TERMINATED,_.CallResult.HUNG_UP),n(o,_.EndCause.CANCELLED,_.CallResult.CANCELLED),n(o,_.EndCause.FAILED,_.CallResult.ERROR),n(o,_.EndCause.NO_ACCESS,_.CallResult.ERROR),o),R=(u={},n(u,_.EndCause.FAILED,_.CallError.UNKNOWN),n(u,_.EndCause.NO_ACCESS,_.CallError.NO_ACCESS),u),b=function(){function e(t,i){s(this,e),(0,d.default)(this),this._callService=t,this._metadata=i,this._id=i.id,this._uri=i.uri,this._isMuted=!!i.isMuted,this._hold=c({},i.hold),this._state=i.state,this._type=i.type,this._callTimeInfo={startTime:i.startTime||null,connectedTime:i.connectedTime||null,endTime:i.endTime||null},this._setupEventHandlers()}return l(e,[{key:"answer",value:function(){this._callService.answerCall(this._uri)}},{key:"end",value:function(e){this._callService.endCall(this._uri,e)}},{key:"setMute",value:function(e){(0,m.default)("mute",e,f.default,"Expect boolean for mute state"),this._validateCallState(_.CallState.TALKING,_.CallState.LOCAL_HELD,_.CallState.REMOTE_HELD);var t=e?"mute":"unmute";this._callService[t](this._uri),this._isMuted=e}},{key:"sendDTMF",value:function(e){(0,m.default)("tone",e,y,"Expect 0-9A-D*# for tone"),this._validateCallState(_.CallState.TALKING,_.CallState.LOCAL_HELD,_.CallState.REMOTE_HELD,_.CallState.CONNECTING,_.CallState.RINGING),this._callService.sendDTMF(this._uri,e)}},{key:"isMuted",value:function(){return this._isMuted}},{key:"setHold",value:function(e){(0,m.default)("hold",e,f.default,"Expect boolean for hold state"),this._validateCallState(_.CallState.TALKING,_.CallState.LOCAL_HELD,_.CallState.REMOTE_HELD);var t=e?"hold":"unhold";this._callService[t](this._uri)}},{key:"isOnHold",value:function(){return this._hold.local}},{key:"getId",value:function(){return this._id}},{key:"getCallType",value:function(){return this._type}},{key:"getUri",value:function(){return this._uri}},{key:"getState",value:function(){return this._state}},{key:"getCallSessionResult",value:function(){return this._callResult}},{key:"getCallTimeInformation",value:function(){var e=this._callTimeInfo.endTime||Date.now(),t=this._callTimeInfo.connectedTime,i=t?(e-t)/1e3:null;return c({},this._callTimeInfo,{elapsedTime:i})}},{key:"deinit",value:function(){this._clearCallServiceHandler()}},{key:"_validateCallState",value:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];if(!t.includes(this._state))throw new E.InvalidOperationError('Expected "'+t.join("/")+'" call session state, but got "'+this._state+'".')}},{key:"_clearCallServiceHandler",value:function(){this._callServiceEventHandler&&(this._callServiceEventHandler.reset(),this._callServiceEventHandler=null)}},{key:"_setupEventHandlers",value:function(){var e=this;this._callServiceEventHandler=new T.default(this._callService),this._callServiceEventHandler.add(_.CallEvent.STATUS_UPDATED,function(t){var i=t.id,r=t.uri,s=t.status,n=t.endCause,a=t.endContext,o=t.startTime,u=t.connectedTime,c=t.endTime;if((i||r)===e._id){var l=e._state,h=C[s];e._setState(h),e._callTimeInfo={startTime:o,connectedTime:u||null,endTime:c||null};var d=A[n],p=void 0;switch(d){case _.CallResult.ERROR:p=R[n]||_.CallError.UNKNOWN;break;case _.CallResult.REJECTED:p=a}switch(h){case _.CallState.ENDED:var f={context:p,type:d};e._callResult=f}e.emit(_.CallSessionEvent.STATE_CHANGED,e,l,h)}}),this._callServiceEventHandler.add(_.CallEvent.MUTE_STATUS_UPDATED,function(t){var i=t.id,r=t.uri,s=t.isMuted;(i||r)===e._id&&(e._isMuted=s,e.emit(_.CallSessionEvent.MUTE_STATE_CHANGED,e,e.isMuted()))}),this._callServiceEventHandler.add(_.CallEvent.HOLD_STATUS_UPDATED,function(t){e._hold=c({},t.hold);var i=void 0;i=t.hold.local?_.CallState.LOCAL_HELD:t.hold.remote?_.CallState.REMOTE_HELD:_.CallState.TALKING;var r=e._state;e._setState(i),e.emit(_.CallSessionEvent.STATE_CHANGED,e,r,i)}),this._callServiceEventHandler.add(_.CallEvent.ERROR,function(t){var i=t.uri,r=t.error,s=t.callDirection;i===e.getUri()&&r.code===_.ErrorCode.WEBRTC_ERROR&&e.emit(_.CallSessionEvent.ERROR,{uri:i,code:r.code,message:r.message,callDirection:s})})}},{key:"_setState",value:function(e){this._state=e}}]),e}();t.default=b,e.exports=t.default},347:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function r(s,n){try{var a=t[s](n),o=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){var i={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(i[r]=e[r]);return i}function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function u(e){var t,i=(t={},o(t,S.CallStatus.INCOMING,S.CallState.RINGING),o(t,S.CallStatus.CONNECTING,S.CallState.CONNECTING),o(t,S.CallStatus.ACTIVE,S.CallState.TALKING),o(t,S.CallStatus.ENDED,S.CallState.ENDED),t),r=e.status,s=e.uri,n=e.type,u=a(e,["status","uri","type"]),c=e.id||e.uri;return d({},u,{id:c,type:n,uri:s,state:i[r]})}function c(e){return A.test(e)}function l(e){var t=(0,g.parse)(e);return(0,g.format)(t,"International_plaintext")||e.replace(R,"")}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},p=i(5),f=r(p),g=i(303),m=i(12),v=r(m),T=i(3),_=r(T),E=i(346),C=r(E),S=i(138),y=i(193),A=/^\+\d{2,50}/,R=/[-.()\s]/g,b=function(){function e(t,i){n(this,e),(0,f.default)(this),this._callService=t,this._iceProviderRegistry=i,this._activeCallSession=null,this._callSessions=new Map,this._callSessionEventHandlers=new Map,this._callSessionStateChangedHandler=this._callSessionStateChangedHandler.bind(this),this._pendingOutgoingCall=new Map,this._setupEventHandlers(),this._restoreCallSessions()}return h(e,[{key:"makeCall",value:function(e){var t=this,i=new Promise(function(i,r){t._pendingOutgoingCall.set(e,{resolve:i,reject:r})});return this._callService.makeCall(e),i}},{key:"makeOffnetCall",value:function(){function e(e){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark(function e(t){var i,r,s=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=l(t),(0,_.default)("phone number",i,c),n.prefix&&(i="+"+n.prefix+i.replace("+","")),r=new Promise(function(e,t){s._pendingOutgoingCall.set(i,{resolve:e,reject:t})}),this._callService.makeCall(i,{scheme:S.CallScheme.TEL}),e.abrupt("return",r);case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"getCallSessions",value:function(){return Array.from(this._callSessions.values())}},{key:"getTalkingCallSession",value:function(){return this._activeCallSession}},{key:"getCallSessionById",value:function(e){return this._callSessions.get(e)}},{key:"getICEProviderRegistry",value:function(){return this._iceProviderRegistry}},{key:"deinit",value:function(){this._callEventHandlers&&(this._callEventHandlers.reset(),this._callEventHandlers=null),this._callSessions.forEach(function(e){return e.deinit()}),this._callSessions.clear(),this._callSessionEventHandlers.forEach(function(e){return e.reset()}),this._callSessionEventHandlers.clear()}},{key:"_setupEventHandlers",value:function(){var e=this;this._callEventHandlers=new v.default(this._callService),this._callEventHandlers.add(S.CallEvent.CALL_ENDED,function(t){var i=t.id||t.uri,r=e.getCallSessionById(i);e.emit(S.CallSessionEvent.CALL_ENDED,r),e._callSessions.get(i).deinit(),e._callSessions.delete(i),e._callSessionEventHandlers.get(i).reset(),e._callSessionEventHandlers.delete(i)}),this._callEventHandlers.add(S.CallEvent.INCOMING_CALL,function(t){var i=e._initCallSession(t);e.emit(S.CallSessionEvent.INCOMING_CALL,i)}),this._callEventHandlers.add(S.CallEvent.OUTGOING_CALL,function(t){var i=e._initCallSession(t);e._pendingOutgoingCall.has(i.getUri())&&e._pendingOutgoingCall.get(i.getUri()).resolve(i),e.emit(S.CallSessionEvent.OUTGOING_CALL,i)}),this._callEventHandlers.add(S.CallEvent.ERROR,function(t){var i=t.id,r=t.uri,s=t.error,n=t.callDirection;n!==S.CallDirection.INCOMING&&e._pendingOutgoingCall.has(r)&&(e._pendingOutgoingCall.get(r).reject(y.CallCreationError.createFromDetails({id:i,uri:r,callDirection:n},s)),e.emit(S.CallSessionEvent.CALL_CREATION_FAILED,{uri:r,callDirection:n,code:s.code,message:s.message}))})}},{key:"_restoreCallSessions",value:function(){this._callService.getCalls().forEach(this._initCallSession.bind(this))}},{key:"_setupCallSessionEventHandlers",value:function(e){var t=new v.default(e);t.add(S.CallSessionEvent.STATE_CHANGED,this._callSessionStateChangedHandler),this._callSessionEventHandlers.set(e.getId(),t)}},{key:"_initCallSession",value:function(e){var t=this._createCallSession(e);return this._callSessions.set(t.getId(),t),t}},{key:"_createCallSession",value:function(e){var t=u(e),i=new C.default(this._callService,t);return this._setupCallSessionEventHandlers(i),i}},{key:"_callSessionStateChangedHandler",value:function(e,t,i){switch(i){case S.CallState.ENDED:var r=e.getCallSessionResult();switch(t===S.CallState.TALKING&&(this._activeCallSession=null),r&&r.type){case S.CallResult.MISSED:this.emit(S.CallSessionEvent.CALL_MISSED,e)}break;case S.CallState.TALKING:this._activeCallSession=e;break;case S.CallState.LOCAL_HELD:case S.CallState.REMOTE_HELD:t===S.CallState.TALKING&&(this._activeCallSession=null)}}}]),e}();t.default=b,e.exports=t.default},348:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MAKE_CALL="Call:makeCall",t.ANSWER_CALL="Call:answerCall",t.END_CALL="Call:endCall",t.MUTE="Call:mute",t.UNMUTE="Call:unmute",t.HOLD="Call:hold",t.UNHOLD="Call:unhold",t.DTMF="Call:dtmf"},349:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.CALL_OWNER_LEFT="call-owner-left"},350:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=i(744);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var s=i(745);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}})})},726:function(e,t,i){e.exports=i(727)},727:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function r(s,n){try{var a=t[s](n),o=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function n(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=new(Function.prototype.bind.apply(e,[null].concat(n(t),n(i))));return(0,w.isFunction)(r.init)&&r.init(),r}function o(e){return{getICEServers:function(){var t=this;return s(regeneratorRuntime.mark(function i(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e);case 1:case"end":return t.stop()}},i,t)}))()}}}function u(e){return{getICEServers:function(){var t=this;return s(regeneratorRuntime.mark(function i(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e();case 2:if(r=t.sent,!(0,w.isArray)(r)){t.next=5;break}return t.abrupt("return",r);case 5:return t.abrupt("return",[r]);case 6:case"end":return t.stop()}},i,t)}))()}}}function c(e,t){(0,w.isString)(t)?e.addProvider(o([{urls:t}])):(0,w.isFunction)(t)?e.addProvider(u(t)):t.urls&&e.addProvider(o([t]))}Object.defineProperty(t,"__esModule",{value:!0});var l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},h=i(86),d=i(728),p=r(d),f=i(740),g=r(f),m=i(742),v=r(m),T=i(347),_=r(T),E=i(743),C=r(E),S=i(746),y=r(S),A=i(747),R=r(A),b=i(787),I=r(b),w=i(10);t.default=l({},p.default,{version:h.version,name:"call",getModuleDefinitions:function(e){var t=e.applicationIdentifier,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=i.multiTab;return{call:{deps:["service.call","iceProviderRegistry"],factory:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return a(_.default,t)}},"service.call.notification":{deps:["service.notification"],factory:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return a(C.default,t)}},"service.call":{deps:["account","service.call.notification","storage.call","iceProviderRegistry","tab","callOwner"],factory:function(e,s,n,o,u,c){var l=i.sipHeadersModifier,h={applicationIdentifier:t,wsServers:i.callServers,iceCheckingTimeout:i.iceCheckingTimeout,sipHeadersModifier:l},d=a(R.default,[e,s,n,o],[h]);return!1===r?d:a(y.default,[u,d,n,c])}},"storage.call":{deps:["tab"],factory:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return a(g.default,t)}},callOwner:{deps:["tab"],factory:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return a(v.default,t)}},iceProviderRegistry:{deps:[],factory:function(){var e=new I.default,t=i.iceServers;return t&&((0,w.isArray)(t)?t.forEach(function(t){c(e,t)}):c(e,t)),e}}}}}),e.exports=t.default},728:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},n=i(138),a=r(n),o=i(346),u=r(o),c=i(347),l=r(c);t.default=s({constants:a.default},a.default,{CallSession:u.default,CallSessionManager:l.default}),e.exports=t.default},729:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.INCOMING="incoming",t.OUTGOING="outgoing"},730:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.NO_CREDIT="no-credit",t.NO_ACCESS="no-mic-access",t.USER_DEACTIVATED="user-deactivated",t.UNKNOWN="unknown"},731:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ANSWERED="answered",t.HUNG_UP="hung-up",t.REJECTED="rejected",t.CANCELLED="cancelled",t.MISSED="missed",t.NO_ANSWER="no-answer",t.ERROR="error"},732:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SIP="sip",t.TEL="tel"},733:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.INCOMING_CALL="incoming-call",t.OUTGOING_CALL="outgoing-call",t.STATE_CHANGED="state-changed",t.MUTE_STATE_CHANGED="mute-state-changed",t.CALL_ENDED="call-ended",t.CALL_MISSED="call-missed",t.CALL_CREATION_FAILED="call-creation-failed",t.ERROR="error"},734:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.RINGING="ringing",t.CONNECTING="connecting",t.TALKING="talking",t.ENDED="ended",t.LOCAL_HELD="local-held",t.REMOTE_HELD="remote-held"},735:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ONNET="on-net",t.OFFNET="off-net"},736:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ONE="1",t.TWO="2",t.THREE="3",t.FOUR="4",t.FIVE="5",t.SIX="6",t.SEVEN="7",t.EIGHT="8",t.NINE="9",t.ZERO="0",t.HASH="#",t.POUND="#",t.A="A",t.B="B",t.C="C",t.D="D",t.ASTERISK="*"},737:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.WEBRTC_ERROR=400},738:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BUSY="busy",t.NO_ACCESS="callee has no access to the required hardware"},739:function(e,t,i){function r(e){return!0===e||!1===e||n(e)&&s(e)==a}var s=i(32),n=i(20),a="[object Boolean]";e.exports=r},740:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=i(5),o=r(a),u=i(12),c=r(u),l=i(11),h=i(741),d=i(14),p=i(35),f=r(p),g=i(47),m=(0,f.default)(localStorage),v=(0,g.generateKey)(d.CALL_STATES+"~states"),T=function(){function e(t){s(this,e),(0,o.default)(this),this._tabMgr=t,this._setupTabEventListeners()}return n(e,[{key:"getCalls",value:function(){var e=m.getItem(d.CALL_STATES);return e?JSON.parse((0,g.decrypt)(e,v)):{}}},{key:"getCall",value:function(e){return this.getCalls()[e]||null}},{key:"setCall",value:function(e,t){var i=this.getCalls(),r=i[e]?"updated":"added";i[e]=t,this._setCallStates(i),this._notifyUpdated(r,{id:e,state:t})}},{key:"unsetCall",value:function(e){var t=this.getCalls();delete t[e],this._setCallStates(t),this._notifyUpdated("removed",{id:e})}},{key:"clearCalls",value:function(){m.removeItem(d.CALL_STATES),this._notifyUpdated("cleared")}},{key:"_setupTabEventListeners",value:function(){this._tabMgrEventHandlers=new c.default(this._tabMgr),this._tabMgrEventHandlers.add(l.MESSAGE_RECEIVED,this._handleMessage.bind(this))}},{key:"_handleMessage",value:function(e){var t=e.origin,i=e.data,r=i.event,s=i.payload;t!==this._tabMgr.getId()&&"CallStorage:call-states-updated"===r&&this.emit(h.CALL_STATES_UPDATED,s)}},{key:"_setCallStates",value:function(e){var t=(0,g.encrypt)(JSON.stringify(e),v);m.setItem(d.CALL_STATES,t)}},{key:"_notifyUpdated",value:function(e,t){var i={type:e,data:t};this.emit(h.CALL_STATES_UPDATED,i),this._tabMgr.broadcastMessage({event:"CallStorage:call-states-updated",payload:i})}}]),e}();t.default=T,e.exports=t.default},741:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.CALL_STATES_UPDATED="call-states-updated"},742:function(e,t,i){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function s(e){return e&&e.__esModule?e:{default:e}}function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var i=[],r=!0,s=!1,n=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){s=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(s)throw n}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},c=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),l=i(5),h=s(l),d=i(12),p=s(d),f=i(11),g=i(14),m=i(348),v=r(m),T=i(212),_=r(T),E=i(349),C=i(0),S=i(35),y=s(S),A=i(47),R=(0,y.default)(localStorage),b=(0,A.generateKey)(g.CALL_OWNERS+"~tabIds"),I=[v.MAKE_CALL,v.ANSWER_CALL],w=function(){function e(t){a(this,e),(0,h.default)(this),this._tabMgr=t,this._ownerResolver=this._defaultCallOwnerResolver,this._setupTabEventListeners()}return c(e,[{key:"setOwnerResolver",value:function(e){this._ownerResolver=e}},{key:"resolveOwner",value:function(e){return this._ownerResolver(e)}},{key:"setOwner",value:function(e,t){var i=this.getOwnersMap();i[e]!==t&&this.setOwnersMap(u({},i,n({},e,t)))}},{key:"setOwnersMap",value:function(e){var t=(0,A.encrypt)(JSON.stringify(e),b);R.setItem(g.CALL_OWNERS,t)}},{key:"unsetOwner",value:function(e){var t=this.getOwnersMap();t[e]&&(delete t[e],this.setOwnersMap(t))}},{key:"unsetOwners",value:function(e){var t=this.getOwnersMap(),i=e.filter(function(e){return t[e]});i.length&&(i.forEach(function(e){delete t[e]}),this.setOwnersMap(t))}},{key:"getOwnerTabId",value:function(e){return this.getOwnersMap()[e]}},{key:"getOwnersMap",value:function(){var e=R.getItem(g.CALL_OWNERS);return e?JSON.parse((0,A.decrypt)(e,b)):{}}},{key:"hasOwner",value:function(e){return!!this.getOwnerTabId(e)}},{key:"_setupTabEventListeners",value:function(){this._tabMgrEventHandlers=new p.default(this._tabMgr),this._tabMgrEventHandlers.add(f.PEER_LEFT,this._handleTabLeft.bind(this))}},{key:"_handleTabLeft",value:function(e){var t=e.id;if(this._shouldHandleTabClosed()){var i=Object.entries(this.getOwnersMap()).filter(function(e){return o(e,2)[1]===t}).map(function(e){return o(e,1)[0]});i.length&&this.emit(E.CALL_OWNER_LEFT,{callIds:i})}}},{key:"_shouldHandleTabClosed",value:function(){return this._tabMgr.getParticipants().reduce(function(e,t){var i=t.id;return e&&i>=e?e:i},null)===this._tabMgr.getId()}},{key:"_defaultCallOwnerResolver",value:function(e){var t=e.action,i=e.callId,r=e.status,s=v.END_CALL;if(this.hasOwner(i))return this.getOwnerTabId(i);var n=this._tabMgr.getId();if(I.includes(t))return n;if(t===s&&r===_.INCOMING)return n;throw new C.InvalidOperationError('Invalid call owner state to perform the action "'+t+'"')}}]),e}();t.default=w,e.exports=t.default},743:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=i(5),o=r(a),u=i(311),c=r(u),l=i(269),h=r(l),d=i(350),p=i(124),f=i(4),g=f.LoggerFactory.getInstance(),m=g.getLogger("call/CallNotificationService"),v=function(){function e(t){s(this,e),(0,o.default)(this),this._notificationService=t,this._notificationMap={},this._setupNotificationHandlers()}return n(e,[{key:"_setupNotificationHandlers",value:function(){var e=this,t={"incoming.call":d.parseIncomingCallNotification,"missed.call":d.parseMissedCallNotification,"answered.call":d.parseAnsweredCallNotification,"terminated.call":d.parseTerminatedCallNotification};this._notificationService.on(p.NOTIFICATION_RECEIVED,function(i){var r=t[i.type];r&&e._handleIncomingNotification(r,i)})}},{key:"_handleIncomingNotification",value:function(e,t){var i=this,r=e(t),s=r.callId,n=r.caller;if(!s||!n)return void m.warn("Invalid Call Notification! Missing callId or Caller.");var a=this._getNotificationMapByType(t.type);if(a.has(s)){var o=a.get(s),u=o.handler,l=o.reset;return u(),void l()}var d=(0,c.default)(function(){var e=(0,h.default)(a.get(s).parsedNotification,function(e){return null===e||void 0===e});i.emit(t.type,e)},500,{leading:!0,trailing:!1}),p=(0,c.default)(function(){return a.delete(s)},500);a.set(s,{parsedNotification:r,handler:d,reset:p}),d(),p()}},{key:"_getNotificationMapByType",value:function(e){return this._notificationMap[e]=this._notificationMap[e]||new Map,this._notificationMap[e]}}]),e}();t.default=v,e.exports=t.default},744:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseAnsweredCallNotification=t.parseMissedCallNotification=t.parseTerminatedCallNotification=t.parseIncomingCallNotification=void 0;var r=i(200),s=function(e){return e&&e.__esModule?e:{default:e}}(r);t.parseIncomingCallNotification=function(e){var t=(0,s.default)(e);return{callId:t.attr("c")||t.attr("callId"),caller:t.attr("f")||t.attr("caller"),serverId:t.attr("s")||t.attr("serverId"),media:t.attr("m")||t.attr("media"),name:t.attr("n")||t.attr("callerName"),inquiryId:t.attr("i")||t.attr("inquiryId"),"com.maaii.notifications.delivery.control.sound":t.attr("com.maaii.notifications.delivery.control.sound"),"com.maaii.notification.type":t.attr("com.maaii.notification.type")}},t.parseTerminatedCallNotification=function(e){var t=(0,s.default)(e);return{media:t.attr("m")||t.attr("media"),duration:t.attr("d")||t.attr("duration"),callId:t.attr("c")||t.attr("callId"),caller:t.attr("f")||t.attr("caller"),callee:t.attr("e")||t.attr("callee"),recordId:t.attr("r")||t.attr("recordId"),statusCode:t.attr("s")||t.attr("statusCode"),type:t.attr("t")||t.attr("type")}},t.parseMissedCallNotification=function(e){var t=(0,s.default)(e);return{callId:t.attr("c")||t.attr("callId"),caller:t.attr("f")||t.attr("caller"),media:t.attr("m")||t.attr("media"),"com.maaii.notifications.delivery.control.sound":t.attr("com.maaii.notifications.delivery.control.sound"),"com.maaii.notifications.delivery.control.badge":t.attr("com.maaii.notifications.delivery.control.badge"),"com.maaii.notification.type":t.attr("com.maaii.notification.type")}},t.parseAnsweredCallNotification=function(e){var t=(0,s.default)(e);return{callId:t.attr("c")||t.attr("callId"),caller:t.attr("f")||t.attr("caller"),media:t.attr("m")||t.attr("media")}}},745:function(e,t,i){"use strict";function r(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function r(s,n){try{var a=t[s](n),o=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}Object.defineProperty(t,"__esModule",{value:!0});t.injectSessionName=function(){var e=r(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.sdp=t.sdp.replace(/s= /,"s=-"),e.abrupt("return",t);case 2:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}()},746:function(e,t,i){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function s(e){return e&&e.__esModule?e:{default:e}}function n(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},c=function(){function e(e,t){var i=[],r=!0,s=!1,n=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){s=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(s)throw n}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),h=i(5),d=s(h),p=i(12),f=s(p),g=i(10),m=i(349),v=i(343),T=r(v),_=i(212),E=r(_),C=i(348),S=r(C),y=i(344),A=r(y),R=i(11),b=function(){function e(t,i,r,s){o(this,e),(0,d.default)(this),this._tabMgr=t,this._callService=i,this._callStorage=r,this._ownerCtrl=s,this._init()}return l(e,[{key:"_init",value:function(){var e,t;this._callStates={},this._tabId=this._tabMgr.getId(),this._eventHandlerMap=(e={},a(e,"Call:outgoingCall",this._updateCallAndEmitOutgoing.bind(this)),a(e,"Call:incomingCall",this._updateCallAndEmitIncoming.bind(this)),a(e,"Call:callEnded",this._updateCallAndEmitCallEnded.bind(this)),a(e,"Call:statusUpdated",this._updateCallAndEmitStatusUpdated.bind(this)),a(e,"Call:muteStatusUpdated",this._updateCallAndEmitMuteStatusUpdated.bind(this)),a(e,"Call:holdStatusUpdated",this._updateCallAndEmitHoldStatusUpdated.bind(this)),a(e,"Call:error",this._updateCallAndEmitError.bind(this)),e),this._actionHandlerMap=(t={},a(t,S.MAKE_CALL,this.makeCall.bind(this)),a(t,S.ANSWER_CALL,this.answerCall.bind(this)),a(t,S.END_CALL,this.endCall.bind(this)),a(t,S.MUTE,this.mute.bind(this)),a(t,S.UNMUTE,this.unmute.bind(this)),a(t,S.HOLD,this.hold.bind(this)),a(t,S.UNHOLD,this.unhold.bind(this)),a(t,S.DTMF,this.sendDTMF.bind(this)),t),this._setupTabEventListeners(),this._setupCallOwnerEventListeners(),this._setupCallServiceEventListeners(),this._synchronizeCalls()}},{key:"_synchronizeCalls",value:function(){var e=this,t=this._tabMgr.getParticipants().map(function(e){return e.id});if(t.length>1)return void this._restoreCallStates();var i=Object.entries(this._ownerCtrl.getOwnersMap()).filter(function(e){var i=c(e,2),r=i[1];return t.includes(r)}),r=i.map(function(e){return c(e,1)[0]}),s=this._callStorage.getCalls(),n=Object.entries(s).reduce(function(e,t){var i=c(t,2),s=i[0],n=i[1];return r.includes(s)?u({},e,a({},s,n)):e},{});this._setCallStates(n),Object.entries(n).map(function(t){var i=c(t,2),r=i[0],s=i[1];return e._setCallStateToStorage(r,s)});var o=i.reduce(function(e,t){var i=c(t,2),r=i[0],s=i[1];return u({},e,a({},r,s))},{});this._ownerCtrl.setOwnersMap(o)}},{key:"_restoreCallStates",value:function(){var e=this._callStorage.getCalls();this._setCallStates(e)}},{key:"makeCall",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var s=this._callService.makeCall.bind(this._callService),n={callId:e,handler:s,args:i};this._performActionOnCallOwner(S.MAKE_CALL,n)}},{key:"answerCall",value:function(e,t){var i=this._callService.answerCall.bind(this._callService),r={callId:e,args:[t],handler:i};this._performActionOnCallOwner(S.ANSWER_CALL,r)}},{key:"endCall",value:function(e,t){var i=this._callService.endCall.bind(this._callService),r={callId:e,args:[t],handler:i};this._performActionOnCallOwner(S.END_CALL,r)}},{key:"mute",value:function(e){var t=this._callService.mute.bind(this._callService),i={callId:e,handler:t};this._performActionOnCallOwner(S.MUTE,i)}},{key:"unmute",value:function(e){var t=this._callService.unmute.bind(this._callService),i={callId:e,handler:t};this._performActionOnCallOwner(S.UNMUTE,i)}},{key:"hold",value:function(e){var t=this._callService.hold.bind(this._callService),i={callId:e,handler:t};this._performActionOnCallOwner(S.HOLD,i)}},{key:"unhold",value:function(e){var t=this._callService.unhold.bind(this._callService),i={callId:e,handler:t};this._performActionOnCallOwner(S.UNHOLD,i)}},{key:"getCalls",value:function(){return Object.values(this._callStates)}},{key:"sendDTMF",value:function(e,t){var i=this._callService.sendDTMF.bind(this._callService),r={callId:e,handler:i,args:[t]};this._performActionOnCallOwner(S.DTMF,r)}},{key:"reset",value:function(){this._callStates={},this._tabMgrEventHandlers.reset(),this._callServiceEventHandlers.reset()}},{key:"_setupTabEventListeners",value:function(){this._tabMgrEventHandlers=new f.default(this._tabMgr),this._tabMgrEventHandlers.add(R.MESSAGE_RECEIVED,this._handleMessage.bind(this))}},{key:"_setupCallOwnerEventListeners",value:function(){this._ownerCtrlEventHandlers=new f.default(this._ownerCtrl),this._ownerCtrlEventHandlers.add(m.CALL_OWNER_LEFT,this._handleCallOwnerLeft.bind(this))}},{key:"_setupCallServiceEventListeners",value:function(){var e=this;this._callServiceEventHandlers=new f.default(this._callService),this._callServiceEventHandlers.add(T.CALL_ENDED,function(t){e._updateCallAndEmitCallEnded(t),e._broadcast("Call:callEnded",t)}),this._callServiceEventHandlers.add(T.OUTGOING_CALL,function(t){e._updateCallAndEmitOutgoing(t),e._broadcast("Call:outgoingCall",t)}),this._callServiceEventHandlers.add(T.INCOMING_CALL,function(t){e._updateCallAndEmitIncoming(t),e._broadcast("Call:incomingCall",t)}),this._callServiceEventHandlers.add(T.STATUS_UPDATED,function(t){var i=t.uri;e._updateCallAndEmitStatusUpdated(t),t.status===E.ENDED&&e._ownerCtrl.unsetOwner(i),e._broadcast("Call:statusUpdated",t)}),this._callServiceEventHandlers.add(T.MUTE_STATUS_UPDATED,function(t){e._updateCallAndEmitMuteStatusUpdated(t),e._broadcast("Call:muteStatusUpdated",t)}),this._callServiceEventHandlers.add(T.HOLD_STATUS_UPDATED,function(t){e._updateCallAndEmitHoldStatusUpdated(t),e._broadcast("Call:holdStatusUpdated",t)}),this._callServiceEventHandlers.add(T.ERROR,function(t){e._updateCallAndEmitError(t),e._broadcast("Call:error",t)})}},{key:"_performActionOnCallOwner",value:function(e,t){var i=t.callId,r=t.handler,s=t.args,a=void 0===s?[]:s,o=this._getCallState(i),u=o&&o.status,c={callId:i,action:e,status:u},l=this._ownerCtrl.resolveOwner(c);if(this._ownerCtrl.setOwner(i,l),l===this._tabId)return void r.apply(void 0,[i].concat(n(a)));var h={action:e,id:i,args:[i].concat(n(a))};this._unicast(h,l)}},{key:"_getCallState",value:function(e){return this._callStates[e]}},{key:"_setCallState",value:function(e,t){this._callStates[e]=t}},{key:"_setCallStates",value:function(e){this._callStates=e}},{key:"_unsetCallState",value:function(e){delete this._callStates[e]}},{key:"_setCallStateToStorage",value:function(e,t){this._callStorage.setCall(e,t)}},{key:"_updateCallAndEmitIncoming",value:function(e){this._setCallState(e.uri,e),this.emit(T.INCOMING_CALL,e)}},{key:"_updateCallAndEmitOutgoing",value:function(e){this._setCallState(e.uri,e),this.emit(T.OUTGOING_CALL,e)}},{key:"_updateCallAndEmitCallEnded",value:function(e){var t=e.uri;this._unsetCallState(t),this.emit(T.CALL_ENDED,e)}},{key:"_updateCallAndEmitStatusUpdated",value:function(e){var t=e.uri;e.status!==E.ENDED&&this._setCallState(t,e),this.emit(T.STATUS_UPDATED,e)}},{key:"_updateCallAndEmitMuteStatusUpdated",value:function(e){this._setCallState(e.uri,e),this.emit(T.MUTE_STATUS_UPDATED,e)}},{key:"_updateCallAndEmitHoldStatusUpdated",value:function(e){this._setCallState(e.uri,e),this.emit(T.HOLD_STATUS_UPDATED,e)}},{key:"_updateCallAndEmitError",value:function(e){this._unsetCallState(e.uri),this.emit(T.ERROR,e)}},{key:"_broadcast",value:function(e,t){this._tabMgr.broadcastMessage({event:e,payload:t})}},{key:"_unicast",value:function(e,t){var i=e.id;(0,g.isString)(t)||(t=this._ownerCtrl.getOwnerTabId(i)),t!==this._tabId&&this._tabMgr.broadcastMessage(e,t)}},{key:"_handleMessage",value:function(e){var t=e.origin,i=e.data,r=i.event,s=i.payload,a=i.action,o=i.args;if(t!==this._tabId){if(r&&this._eventHandlerMap[r])return void this._eventHandlerMap[r](s);if(a&&this._actionHandlerMap[a]){var u;(u=this._actionHandlerMap)[a].apply(u,n(o))}}}},{key:"_handleCallOwnerLeft",value:function(e){var t=this,i=e.callIds;i.length&&(this._ownerCtrl.unsetOwners(i),i.forEach(function(e){var i=u({},t._getCallState(e),{status:E.ENDED,endCause:A.TERMINATED});t._updateCallAndEmitStatusUpdated(i),t._broadcast("Call:statusUpdated",i)}))}}]),e}();t.default=b,e.exports=t.default},747:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function n(e,t){var i={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(i[r]=e[r]);return i}function a(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function r(s,n){try{var a=t[s](n),o=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.outbound,r=t.scheme,s=t.type,n=void 0===s?w.CallType.ONNET:s,a=r+":"+e;return i||n!==w.CallType.OFFNET||(a+="@Maaii-In"),{to_displayName:i?F.PHONE:F.WEB,to_uri:a,from_displayName:i?F.WEB:F.PHONE}}function c(){return function(e,t,i,r){L[B[e]](r)}}function l(e){if(!e)return"";var t=e.call_id,i=e.data,r=e.method,s=e.reason_phrase,n=e.status_code,a={call_id:t,data:i,method:r,reason_phrase:s,status_code:n};return JSON.stringify(a)}Object.defineProperty(t,"__esModule",{value:!0});var h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},d=function(){function e(e,t){var i=[],r=!0,s=!1,n=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){s=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(s)throw n}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),p=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),f=i(1),g=i(748),m=r(g),v=i(59),T=r(v),_=i(5),E=r(_),C=i(201),S=r(C),y=i(785),A=r(y),R=i(10),b=i(786),I=r(b),w=i(138),D=i(0),O=i(86),N=i(46),U=r(N),x=i(4),$=i(193),k=i(350),H=i(7),M=x.LoggerFactory.getInstance(),P=M.getLogger("call/sip/MaaiiCallService"),L=P.child({component:"call/sip/MaaiiCallService/SIP"}),q={ACCEPT:"accept",DECLINE:"decline",BUSY:"busy"},F={WEB:"Web",PHONE:"Phone"},j=m.default.C.causes,G=m.default.C.dtmfType,B={debug:"debug",log:"debug",warn:"warn",error:"error"},W=function(){function e(t,i,r){o(this,e),this.element=t,this.pc=i,this.mediaSource=r,this.stream=new MediaStream,this.tracks=[],this.playing=Promise.resolve(),this.attachTracks()}return p(e,[{key:"attachTracks",value:function(){if("remote"===this.mediaSource)this.attachTracksFromEntities(this.pc.getReceivers());else{if("local"!==this.mediaSource)throw new D.ArgumentError("Invalid media source");this.attachTracksFromEntities(this.pc.getSenders(),function(e){return"video"===e.kind})}}},{key:"attachTracksFromEntities",value:function(e,t){var i=this;e.forEach(function(e){return i.attachTrack(e.track,t)}),this.element.srcObject=this.stream}},{key:"attachTrack",value:function(e,t){e&&!this.tracks.includes(e)&&(this.tracks.find(function(t){return t.id===e.id})&&!this.removeDeadTrack(e)||(this.tracks.push(e),t&&!t(e)||this.stream.addTrack(e)))}},{key:"removeDeadTrack",value:function(e){var t=this.tracks.findIndex(function(t){return t.id===e.id});return!(-1===t||!this.tracks[t].muted)&&this.removeTrackByIndex(t)}},{key:"removeTrackByIndex",value:function(e){if(-1===e)return!1;var t=this.tracks.splice(e,1),i=d(t,1),r=i[0];return this.stream.removeTrack(r),!!r}},{key:"play",value:function(){function e(){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.element){e.next=2;break}return e.abrupt("return");case 2:return this.playing=this.element.play().catch(function(e){P.warn("play() was rejected",e.message)}),e.next=5,this.playing;case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"stop",value:function(){function e(){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.playing;case 2:this.element.pause(),this.element.srcObject=null;case 4:case"end":return e.stop()}},e,this)}));return e}()},{key:"setEnabled",value:function(e){this.tracks.forEach(function(t){t.enabled=e})}}]),e}(),K=function(){function e(){o(this,e),this.mediaMap=new Map}return p(e,[{key:"addMedia",value:function(e,t,i,r){var s=r.sessionDescriptionHandler.peerConnection,n={session:r,localStream:new W(t,s,"local"),remoteStream:new W(i,s,"remote")};this.mediaMap.set(e,n),n.localStream.element.volume=0,n.localStream.play(),n.remoteStream.play()}},{key:"removeMedia",value:function(e){var t=this.mediaMap.get(e);t&&(t.localStream&&t.localStream.stop(),t.remoteStream&&t.remoteStream.stop(),this.mediaMap.delete(e))}},{key:"getMedia",value:function(e){return this.mediaMap.get(e)}},{key:"setMute",value:function(e,t){this.mediaMap.get(e).localStream.setEnabled(t)}}]),e}(),V=function(){function e(){o(this,e),this.store={}}return p(e,[{key:"set",value:function(e,t,i){this.store[e]=this.store[e]||new Map,this.store[e].set(t,i)}},{key:"get",value:function(e){return this.store[e]}},{key:"delete",value:function(e,t){this.store[e]&&(this.store[e].delete(t),this.store[e].size||delete this.store[e])}}]),e}(),Y=function(){function e(t,i,r,s){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};o(this,e),(0,E.default)(this),this._accountManager=t,this._callNotificationService=i,this._callStorage=r,this._iceProviderRegistry=s,this._appId=n.applicationIdentifier,this._wsServers=n.wsServers,this._iceCheckingTimeout=n.iceCheckingTimeout,this._sipHeadersModifier=n.sipHeadersModifier,this._pendingOutgoingCall=new Map,this._sipSessionMap=new Map,this._pendingNotificationMap=new V,this._mediaController=new K,this._logConnector=c(),this._setupCallNotificationHandlers()}return p(e,[{key:"makeCall",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.scheme,r=void 0===i?w.CallScheme.SIP:i;this._pendingOutgoingCall.set(e,!0),this._invite(e,{scheme:r,outbound:!0})}},{key:"answerCall",value:function(e,t){var i=this._getCallFromStorage(e)||{};i=h({},i,t,{uri:e,outbound:!1,status:w.CallStatus.CONNECTING,isMuted:!1,hold:{local:!1,remote:!1},endCause:null,scheme:w.CallScheme.SIP}),this._setCallToStorage(e,i),this.emit(w.CallEvent.STATUS_UPDATED,h({},i)),this._invite(e,i)}},{key:"endCall",value:function(e,t){var i=this._getCallFromStorage(e);if(!i)throw new D.NotFoundError("The call with "+e+" does not exist");var r=this._sipSessionMap.get(e);switch(i.status){case w.CallStatus.INCOMING:this._rejectCall(e,t);break;case w.CallStatus.CONNECTING:r.cancel();break;case w.CallStatus.ACTIVE:r.bye()}}},{key:"getCalls",value:function(){return this._getAllCallsFromStorage()}},{key:"getCallStatus",value:function(e){var t=this._getCallFromStorage(e);if(!t)throw new D.NotFoundError("The call with "+e+" does not exist");return t.status}},{key:"isMuted",value:function(e){var t=this._getCallFromStorage(e);if(!t)throw new D.NotFoundError("The call with "+e+" does not exist");return t.isMuted}},{key:"isOnHold",value:function(e){var t=this._getCallFromStorage(e);if(!t)throw new D.NotFoundError("The call with "+e+" does not exist");return t.hold.local}},{key:"getHoldState",value:function(e){var t=this._getCallFromStorage(e);if(!t)throw new D.NotFoundError("The call with "+e+" does not exist");return t.hold}},{key:"mute",value:function(e){this._toggleMute(e,!0)}},{key:"unmute",value:function(e){this._toggleMute(e,!1)}},{key:"hold",value:function(e){this._toggleHold(e,!0)}},{key:"unhold",value:function(e){this._toggleHold(e,!1)}},{key:"reset",value:function(){var e=this;this._getAllCallsFromStorage().forEach(function(t){var i=t.uri;e._sipSessionMap.has(i)?e.endCall(i,!0):e._unsetCallFromStorage(i)}),this._sipSessionMap.clear()}},{key:"sendDTMF",value:function(e,t){var i=this._getCallFromStorage(e);if(!i)throw new D.NotFoundError("The call with "+e+" does not exist");if(i.status!==w.CallStatus.ENDED){var r=this._sipSessionMap.get(e);try{r.dtmf(t)}catch(i){P.warn("Failed to send dtmf tone. tone: "+t+", uri: "+e,i.message)}}}},{key:"_setupCallNotificationHandlers",value:function(){var e=this;this._callNotificationService.on("incoming.call",function(t){e._onIncomingCall(t)}),this._callNotificationService.on("missed.call",function(t){e._onMissedCall(t)}),this._callNotificationService.on("answered.call",function(t){e._onAnsweredCall(t)}),this._callNotificationService.on("terminated.call",function(t){e._onTerminatedCall(t)})}},{key:"_getCallFromStorage",value:function(e){return this._callStorage.getCall(e)}},{key:"_getAllCallsFromStorage",value:function(){return Object.values(this._callStorage.getCalls())}},{key:"_setCallToStorage",value:function(e,t){this._callStorage.setCall(e,t)}},{key:"_unsetCallFromStorage",value:function(e){this._callStorage.unsetCall(e)}},{key:"_validateStateTransition",value:function(e){var t=e.uri,i=e.status,r=this._getCallFromStorage(t);return r?r.status!==i:i!==w.CallStatus.ENDED}},{key:"_onIncomingCall",value:function(e){var t=this,i=e.caller,r=e.callId,s=n(e,["caller","callId"]);if(!i||!r)return void P.warn("Unexpected incoming call, either caller or call-id is missing.\n        caller: "+i+"; call-id: "+r);var a=(0,H.isJid)(i)?w.CallType.ONNET:w.CallType.OFFNET,o=h({type:a,uri:i,incomingCallId:r,outbound:!1,status:w.CallStatus.INCOMING,isMuted:!1,hold:{local:!1,remote:!1},startTime:Date.now(),endCause:null},s);if(this._validateStateTransition(o)){this._setCallToStorage(i,o),this.emit(w.CallEvent.INCOMING_CALL,o);var u=this._pendingNotificationMap.get(r);u&&(u.forEach(function(e,i){switch(i){case"terminated.call":t._onTerminatedCall(e),u.delete(i);break;case"missed.call":t._onMissedCall(e),u.delete(i)}}),this._pendingNotificationMap.delete(r))}}},{key:"_onMissedCall",value:function(e){var t=e.caller,i=e.callId;if(!this._getCallFromStorage(t))return void this._deferNotification(i,"missed.call",e);this._updateStatus(t,w.CallStatus.ENDED,w.EndCause.MISSED)}},{key:"_onAnsweredCall",value:function(e){var t=e.caller,i=this._getCallFromStorage(t);if(i)switch(i.status){case w.CallStatus.INCOMING:case w.CallStatus.IDLE:this._updateStatus(t,w.CallStatus.ENDED,w.EndCause.ANSWERED)}}},{key:"_onTerminatedCall",value:function(e){var t=e.caller,i=e.callId,r=e.callee;if(!this._getCallFromStorage(t))return void this._deferNotification(i,"terminated.call",e);var s=this._accountManager.getJid()===t?r:t;this._updateStatus(s,w.CallStatus.ENDED,w.EndCause.TERMINATED)}},{key:"_onCallMade",value:function(e,t){var i=t===w.CallScheme.SIP?w.CallType.ONNET:w.CallType.OFFNET,r={type:i,uri:e,outbound:!0,status:w.CallStatus.CONNECTING,startTime:Date.now(),isMuted:!1,hold:{local:!1,remote:!1},endCause:null};this._setCallToStorage(e,r),this.emit(w.CallEvent.OUTGOING_CALL,h({},r))}},{key:"_deferNotification",value:function(e,t,i){var r=this;this._pendingNotificationMap.set(e,t,h({},i)),(0,T.default)(5e3).then(function(){return r._pendingNotificationMap.delete(e,t)})}},{key:"_rejectCall",value:function(){function e(e,i){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(t,i){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._delegateRejectCall(t,i);case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return");case 5:this._handleSession(t,r);case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"_delegateRejectCall",value:function(){function e(e){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(t){var i,r,s,n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w.rejectReason.BUSY;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getUserAgent();case 3:return i=e.sent,r=this._getCallFromStorage(t),s=this._prepareBaseInviteOptions(r),s.inviteWithoutSdp=!0,s.extraHeaders.push('X-Call-Action: Reject;cause=603;text="'+a+'"'),s.params=h({},s.params,u(t,h({},r,{scheme:w.CallScheme.SIP}))),n=i.invite(t,s),this._sipSessionMap.set(t,n),e.abrupt("return",n);case 14:return e.prev=14,e.t0=e.catch(0),P.warn("Failed to reject the call, cannot wake User Agent. ",e.t0.message),this._updateStatus(t,w.CallStatus.ENDED,w.EndCause.FAILED),this._unsetCallFromStorage(t),this.emit(w.CallEvent.ERROR,{id:t,uri:t,error:e.t0,callDirection:w.CallDirection.INCOMING}),e.abrupt("return",null);case 21:case"end":return e.stop()}},e,this,[[0,14]])}));return e}()},{key:"_invite",value:function(){function e(e,i){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(t,i){var r,s,n,a,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q.ACCEPT;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getUserAgent();case 3:return r=e.sent,s=this._getCallFromStorage(t)||h({uri:t},i),o===q.ACCEPT&&this._prepareDomElements(),e.next=8,this._prepareInviteOptions(s,o);case 8:n=e.sent,n.params=Object.assign({},n.params,u(t,i)),a=r.invite(t,n),this._sipSessionMap.set(t,a),this._handleSession(t,a,s),e.next=22;break;case 15:e.prev=15,e.t0=e.catch(0),P.warn("start() failed, unable to wake User Agent",e.t0.message),this._updateStatus(t,w.CallStatus.ENDED,w.EndCause.FAILED),this._unsetCallFromStorage(t),this._cleanUpIfNeeded(),this.emit(w.CallEvent.ERROR,{id:t,uri:t,error:e.t0,callDirection:w.CallDirection.OUTGOING});case 22:case"end":return e.stop()}},e,this,[[0,15]])}));return e}()},{key:"_computeTrackState",value:function(e){return!e.isMuted&&!e.hold.local&&!e.hold.remote}},{key:"_toggleMute",value:function(e,t){var i=this._getCallFromStorage(e),r=this._sipSessionMap.get(e);if(!i||!r)throw new D.NotFoundError("The call with "+e+" does not exist");if(i.status!==w.CallStatus.ACTIVE)throw new D.InvalidOperationError("The call with "+e+" is not active");if(i.isMuted===t)return void P.debug("Call "+(i.id||i.uri)+" is already "+(t?"muted":"unmuted")+", skipping action.");i.isMuted=t;var s=this._computeTrackState(i);this._mediaController.setMute(i.uri,s),this._setCallToStorage(i.uri,i),P.debug("Set call "+(i.id||i.uri)+" mute status to "+(t?"muted":"unmuted")),this.emit(w.CallEvent.MUTE_STATUS_UPDATED,h({},i))}},{key:"_toggleHold",value:function(e,t){var i=this,r=this._getCallFromStorage(e),s=this._sipSessionMap.get(e);if(!r||!s)throw new D.NotFoundError("The call with "+e+" does not exist");if(r.status!==w.CallStatus.ACTIVE)throw new D.InvalidOperationError("The call with "+e+" is not active");if(t?s.hold({},[function(){var e=a(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.hold.remote&&(t.sdp=t.sdp.replace(/a=sendonly\r\n/g,"a=inactive\r\n")),e.abrupt("return",t);case 2:case"end":return e.stop()}},e,i)}));return function(t){return e.apply(this,arguments)}}()]):s.unhold({},[function(){var e=a(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.hold.remote&&(t.sdp=t.sdp.replace(/a=sendrecv\r\n/g,"a=recvonly\r\n")),e.abrupt("return",t);case 2:case"end":return e.stop()}},e,i)}));return function(t){return e.apply(this,arguments)}}()]),r.hold.local===t)return void P.debug("Call "+(r.id||r.uri)+" is already "+(t?"held":"active")+", skipping action.");r.hold.local=t;var n=this._computeTrackState(r);this._mediaController.setMute(r.uri,n)}},{key:"_getUserAgentWaker",value:function(){function e(){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(){var t,i,r,s,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._accountManager.getJid(),i=f.Strophe.getBareJidFromJid(t),r=this._accountManager.getPassword(),e.next=5,this._resolveICEServers();case 5:return s=e.sent,n={uri:i,dtmfType:G.RTP,password:r,transportOptions:{wsServers:this._wsServers,traceSip:!0},sessionDescriptionHandlerFactoryOptions:{peerConnectionOptions:{iceCheckingTimeout:this._iceCheckingTimeout,rtcConfiguration:{iceServers:s}},modifiers:[k.injectSessionName]},log:{builtinEnabled:!1,level:"debug",connector:this._logConnector},register:!1,autostart:!1},this._uaWaker&&(0,S.default)(n,this._uaConfig)||(this._uaWaker&&this._uaWaker.sleep(),this._uaConfig=n,this._uaWaker=new I.default(new m.default.UA((0,A.default)(this._uaConfig)))),e.abrupt("return",this._uaWaker);case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"_getUserAgent",value:function(){function e(){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getUserAgentWaker();case 2:return t=e.sent,e.abrupt("return",t.wake());case 4:case"end":return e.stop()}},e,this)}));return e}()},{key:"_resolveICEServers",value:function(){function e(){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(){var t,i,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._iceProviderRegistry.getProviders(),e.next=3,Promise.all(t.map(function(e){return e.getICEServers()}));case 3:return i=e.sent,r=[],i.forEach(function(e){r.push.apply(r,s(e))}),e.abrupt("return",r);case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"_prepareDomElements",value:function(){this._remoteEle=document.createElement("video"),this._remoteEle.setAttribute("playsInline",""),this._remoteEle.id="remote",this._remoteEle.autoplay=!0,this._remoteEle.width=0,this._remoteEle.height=0,document.body.appendChild(this._remoteEle),this._localEle=document.createElement("video"),this._localEle.setAttribute("playsInline",""),this._localEle.id="local",this._localEle.autoplay=!0,this._localEle.width=0,this._localEle.height=0,document.body.appendChild(this._localEle)}},{key:"_prepareBaseInviteOptions",value:function(e){var t={sessionDescriptionHandlerOptions:{constraints:{audio:!0,video:!1}},extraHeaders:["X-DID: "+U.default.uniqueId,"X-AID: "+this._appId,"X-SDK-Version: "+O.version]};if(e.outbound||(t.extraHeaders.push("X-Call-Answer: "+e.incomingCallId),t.extraHeaders.push("webrtc: "+e.serverId)),(0,R.isFunction)(this._sipHeadersModifier)){var i;(i=t.extraHeaders).push.apply(i,s(this._sipHeadersModifier({uri:e.uri})))}return t}},{key:"_prepareInviteOptions",value:function(){function e(e,i){return t.apply(this,arguments)}var t=a(regeneratorRuntime.mark(function e(t,i){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r={sessionDescriptionHandlerOptions:{constraints:{audio:!0,video:!1}},extraHeaders:["X-DID: "+U.default.uniqueId,"X-AID: "+this._appId,"X-SDK-Version: "+O.version,"X-AT: "+this._accountManager.getSsoToken()]},t.outbound){e.next=11;break}r.extraHeaders.push("X-Call-Answer: "+t.incomingCallId),r.extraHeaders.push("webrtc: "+t.serverId),e.t0=i,e.next=e.t0===q.DECLINE?7:e.t0===q.BUSY?9:11;break;case 7:return r.extraHeaders.push('X-Call-Action: Reject;cause=603;text="Decline"'),e.abrupt("break",11);case 9:return r.extraHeaders.push('X-Call-Action: Reject;cause=486;text="Busy Here"'),e.abrupt("break",11);case 11:return(0,R.isFunction)(this._sipHeadersModifier)&&(n=r.extraHeaders).push.apply(n,s(this._sipHeadersModifier({uri:t.uri}))),e.abrupt("return",r);case 13:case"end":return e.stop()}},e,this)}));return e}()},{key:"_handleSession",value:function(e,t,i){var r=this;t.on("progress",function(t){P.info("SIP SESSION progress: ",l(t)),r._pendingOutgoingCall.has(e)&&(r._pendingOutgoingCall.delete(e),r._onCallMade(e,i.scheme))}),t.once("accepted",function(i){P.info("SIP SESSION accepted: ",i),r._updateStatus(e,w.CallStatus.ACTIVE),t.removeAllListeners("failed")}),t.once("rejected",function(t,i){if(P.info("SIP SESSION rejected: ",l(t),i),!r._getCallFromStorage(e).outbound)return void r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.DECLINED);switch(i){case j.UNAVAILABLE:r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.TIMEOUT);break;default:var s=void 0,n=t&&t.data||"",a=n.match(/;text="(.+)"/);if(a&&a.length>1&&(s=a[1]),403===t.status_code){P.warn("SIP SESSION rejected due to wrong username or password"),r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.FAILED,s);break}r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.REJECTED,s)}}),t.once("failed",function(i,s){switch(P.info("SIP SESSION failed: ",l(i),s),s){case j.NO_ANSWER:case j.EXPIRES:r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.TIMEOUT);break;case j.WEBRTC_ERROR:var n=r._pendingOutgoingCall.has(e);r._pendingOutgoingCall.delete(e),r._cleanUpSessionHandlers(t),r._sipSessionMap.delete(e),r._cleanUpIfNeeded(),r.emit(w.CallEvent.ERROR,{id:e,uri:e,callDirection:n?w.CallDirection.OUTGOING:w.CallDirection.INCOMING,error:new $.WebRTCError(w.ErrorCode.WEBRTC_ERROR,s)});break;default:r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.FAILED)}}),t.on("trackAdded",function(){P.info("SIP SESSION trackAdded"),r._mediaController.addMedia(e,r._localEle,r._remoteEle,t)}),t.on("reinviteAccepted",function(i){P.info("SIP SESSION reinviteAccepted: ",i);var s=function(e){r._setCallToStorage(e.uri,e),r.emit(w.CallEvent.HOLD_STATUS_UPDATED,h({},e))},n=r._getCallFromStorage(e);if(n.hold.local!==t.local_hold)return n.hold.local=t.local_hold,void s(n);var a=t.sessionDescriptionHandler.peerConnection.remoteDescription.sdp,o=/(?:a=(sendrecv|sendonly|recvonly|inactive))[\s\S]+?m=audio/.exec(a),u=o&&o[1],c=/m=audio[\s\S]+?(?:a=(sendrecv|sendonly|recvonly|inactive))/.exec(a),l=c&&c[1],d=l||u,p=void 0;switch(d){case"inactive":case"sendonly":p=!0;break;case"recvonly":case"sendrecv":default:p=!1}if(n.hold.remote!==p){n.hold.remote=p;var f=r._computeTrackState(n);r._mediaController.setMute(n.uri,f),s(n)}}),t.on("reinviteFailed",function(e){P.info("SIP SESSION reinviteFailed: ",e)}),t.on("terminated",function(t,i){P.info("SIP SESSION terminated: ",t,i),i!==j.WEBRTC_ERROR&&r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.TERMINATED)}),t.on("cancel",function(){P.info("SIP SESSION cancel"),r._updateStatus(e,w.CallStatus.ENDED,w.EndCause.CANCELLED)}),t.on("refer",function(e){P.info("SIP SESSION refer: ",e)}),t.on("replaced",function(e){P.info("SIP SESSION replaced: ",e)}),t.on("dtmf",function(e){P.info("SIP SESSION dtmf ",e)})}},{key:"_cleanUpSessionHandlers",value:function(e){e.removeAllListeners("progress"),e.removeAllListeners("accepted"),e.removeAllListeners("trackAdded"),e.removeAllListeners("cancel"),e.removeAllListeners("rejected"),e.removeAllListeners("failed"),e.removeAllListeners("reinviteAccepted"),e.removeAllListeners("reinviteFailed"),e.removeAllListeners("terminated"),e.removeAllListeners("bye"),e.removeAllListeners("refer"),e.removeAllListeners("replaced"),e.removeAllListeners("dtmf")}},{key:"_cleanUpIfNeeded",value:function(){this._getAllCallsFromStorage().length||(this._uaWaker&&this._uaWaker.sleep(),this._remoteEle&&(document.body.removeChild(this._remoteEle),this._remoteEle=null),this._localEle&&(document.body.removeChild(this._localEle),this._localEle=null))}},{key:"_updateStatus",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=this._getCallFromStorage(e);if(!s)return void P.debug("Attempt to update the status of an nonexisting call: "+e);if(this._validateStateTransition({uri:e,status:t})){s.status=t;var n=null,a=this._sipSessionMap.get(e);switch(s.status){case w.CallStatus.ENDED:a&&(n=new Date(a.endTime).getTime(),this._cleanUpSessionHandlers(a),this._sipSessionMap.delete(e)),n||(n=Date.now()),s.endTime=n,s.endCause=i,s.endContext=r,this._unsetCallFromStorage(e),(this._remoteEle||this._localEle)&&this._mediaController.removeMedia(e),this._cleanUpIfNeeded(),this.emit(w.CallEvent.STATUS_UPDATED,h({},s)),this.emit(w.CallEvent.CALL_ENDED,h({},s));break;case w.CallStatus.ACTIVE:s.connectedTime=new Date(a.startTime).getTime(),this._setCallToStorage(e,s),this.emit(w.CallEvent.STATUS_UPDATED,h({},s));break;default:this._setCallToStorage(e,s),this.emit(w.CallEvent.STATUS_UPDATED,h({},s))}}}}]),e}();t.default=Y,e.exports=t.default},748:function(e,t,i){"use strict";e.exports=i(749)()},749:function(e,t,i){"use strict";e.exports=function(){var e=i(750),t=e.version,r=e.title,s=Object.defineProperties({},{version:{get:function(){return t}},name:{get:function(){return r}}});return i(751)(s),s.LoggerFactory=i(752)(),s.EventEmitter=i(753)(),s.C=i(755)(s.name,s.version),s.Exceptions=i(756),s.Timers=i(757)(),s.Transport=i(758)(s),i(759)(s),i(760)(s),i(761)(s),i(762)(s),i(763)(s),i(764)(s),i(766)(s),i(767)(s),s.SessionDescriptionHandler=i(768)(s.EventEmitter),i(769)(s),i(770)(s),i(771)(s),i(773)(s),i(774)(s),i(775)(s),i(779)(s),s.DigestAuthentication=i(780)(s.Utils),s.Grammar=i(781)(s),s.Web={Modifiers:i(783)(s),Simple:i(784)(s)},s}},750:function(e,t){e.exports={_args:[[{raw:"m800-sip.js@^0.12.0",scope:null,escapedName:"m800-sip.js",name:"m800-sip.js",rawSpec:"^0.12.0",spec:">=0.12.0 <0.13.0",type:"range"},"/Users/seanwong/projects/m800-web-sdk"]],_from:"m800-sip.js@>=0.12.0 <0.13.0",_id:"m800-sip.js@0.12.0",_inCache:!0,_location:"/m800-sip.js",_phantomChildren:{},_requested:{raw:"m800-sip.js@^0.12.0",scope:null,escapedName:"m800-sip.js",name:"m800-sip.js",rawSpec:"^0.12.0",spec:">=0.12.0 <0.13.0",type:"range"},_requiredBy:["/"],_resolved:"http://artifactory.devops.maaii.com:8081/artifactory/api/npm/npm-repo/m800-sip.js/-/m800-sip.js-0.12.0.tgz",_shasum:"dafa035573cd01a302452db6457f9e86e7d878f1",_shrinkwrap:null,_spec:"m800-sip.js@^0.12.0",_where:"/Users/seanwong/projects/m800-web-sdk",author:{name:"OnSIP",email:"developer@onsip.com",url:"https://sipjs.com/aboutus/"},bugs:{url:"https://github.com/onsip/SIP.js/issues"},contributors:[{url:"https://github.com/onsip/SIP.js/blob/master/THANKS.md"}],dependencies:{"crypto-js":"^3.1.9-1"},description:"A simple, intuitive, and powerful JavaScript signaling library",devDependencies:{"awesome-typescript-loader":"^5.2.1",eslint:"^5.10.0","jasmine-core":"^3.3.0",karma:"^3.1.3","karma-chrome-launcher":"^2.2.0","karma-cli":"^2.0.0","karma-jasmine":"^2.0.1","karma-jasmine-html-reporter":"^1.4.0","karma-mocha-reporter":"^2.2.5","karma-webpack":"^3.0.5",pegjs:"^0.10.0",typescript:"^3.2.2",webpack:"^4.27.1","webpack-cli":"^3.1.2"},dist:{tarball:"http://artifactory.devops.maaii.com:8081/artifactory/api/npm/npm-repo/m800-sip.js/-/m800-sip.js-0.12.0.tgz",shasum:"dafa035573cd01a302452db6457f9e86e7d878f1"},engines:{node:">=6.0"},homepage:"https://sipjs.com",keywords:["sip","websocket","webrtc","library","javascript"],license:"MIT",main:"lib/index.js",name:"m800-sip.js",optionalDependencies:{},readme:"ERROR: No README data found!",repository:{type:"git",url:"git+https://github.com/onsip/SIP.js.git"},scripts:{browserTest:"sleep 2 && open http://0.0.0.0:9876/debug.html & karma start --reporters kjhtml --no-single-run",build:"npm run generate-grammar && npm run build-lib && npm run build-reg-bundle && npm run build-min-bundle && npm run copy-dist-files","build-bundles":"npm run build-reg-bundle && npm run build-min-bundle","build-lib":"tsc","build-min-bundle":"webpack --progress --config build/webpack.config.js --env.buildType min","build-reg-bundle":"webpack --progress --config build/webpack.config.js --env.buildType reg",buildAndBrowserTest:"npm run build && npm run browserTest",buildAndTest:"npm run build && npm run commandLineTest",commandLineTest:"karma start --reporters mocha --browsers ChromeHeadless --single-run","copy-dist-files":"cp dist/sip.js dist/sip-$npm_package_version.js && cp dist/sip.min.js  dist/sip-$npm_package_version.min.js","generate-grammar":"node build/grammarGenerator.js",prebuild:"eslint src/*.js src/**/*.js",prepack:"npm run build"},title:"SIP.js",types:"./types",version:"0.12.0"}},751:function(e,t,i){"use strict";e.exports=function(e){var t;t={defer:function(){var e={};return e.promise=new Promise(function(t,i){e.resolve=t,e.reject=i}),e},reducePromises:function(e,t){return e.reduce(function(e,t){return e=e.then(t)},Promise.resolve(t))},augment:function(e,t,i,r){var s,n;n=t.prototype;for(s in n)(r||void 0===e[s])&&(e[s]=n[s]);t.apply(e,i)},str_utf8_length:function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length},generateFakeSDP:function(e){if(e){var t=e.indexOf("o="),i=e.indexOf("\r\n",t);return"v=0\r\n"+e.slice(t,i)+"\r\ns=-\r\nt=0 0\r\nc=IN IP4 0.0.0.0"}},isDecimal:function(e){return!isNaN(e)&&parseFloat(e)===parseInt(e,10)},createRandomToken:function(e,t){var i,r,s="";for(t=t||32,i=0;i<e;i++)r=Math.random()*t|0,s+=r.toString(t);return s},newTag:function(){return e.Utils.createRandomToken(e.UA.C.TAG_LENGTH)},newUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},normalizeTarget:function(t,i){var r,s,n;if(t){if(t instanceof e.URI)return t;if("string"==typeof t){switch(r=t.split("@"),r.length){case 1:if(!i)return;s=t,n=i;break;case 2:s=r[0],n=r[1];break;default:s=r.slice(0,r.length-1).join("@"),n=r[r.length-1]}return s=s.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(s)&&(s=s.replace(/[\-\.\(\)]/g,"")),t=e.C.SIP+":"+e.Utils.escapeUser(s)+"@"+n,e.URI.parse(t)}}else;},escapeUser:function(e){return encodeURIComponent(decodeURIComponent(e)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},headerize:function(e){var t,i={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},r=e.toLowerCase().replace(/_/g,"-").split("-"),s="",n=r.length;for(t=0;t<n;t++)0!==t&&(s+="-"),s+=r[t].charAt(0).toUpperCase()+r[t].substring(1);return i[s]&&(s=i[s]),s},sipErrorCause:function(t){var i;for(i in e.C.SIP_ERROR_CAUSES)if(-1!==e.C.SIP_ERROR_CAUSES[i].indexOf(t))return e.C.causes[i];return e.C.causes.SIP_FAILURE_CODE},getReasonPhrase:function(t,i){return i||e.C.REASON_PHRASE[t]||""},getReasonHeaderValue:function(t,i){return i=e.Utils.getReasonPhrase(t,i),"SIP;cause="+t+';text="'+i+'"'},getCancelReason:function(t,i){if(t&&t<200||t>699)throw new TypeError("Invalid status_code: "+t);if(t)return e.Utils.getReasonHeaderValue(t,i)},buildStatusLine:function(e,i){if(e=e||null,i=i||null,!e||e<100||e>699)throw new TypeError("Invalid status_code: "+e);if(i&&"string"!=typeof i&&!(i instanceof String))throw new TypeError("Invalid reason_phrase: "+i);return i=t.getReasonPhrase(e,i),"SIP/2.0 "+e+" "+i+"\r\n"}},e.Utils=t}},752:function(e,t,i){"use strict";var r={error:0,warn:1,log:2,debug:3};e.exports=function(){function e(e,t,i){this.logger=e,this.category=t,this.label=i}var t=function(){var e,t=2,i=!0,s=null;this.loggers={},e=this.getLogger("sip.loggerfactory"),Object.defineProperties(this,{builtinEnabled:{get:function(){return i},set:function(t){"boolean"==typeof t?i=t:e.error('invalid "builtinEnabled" parameter value: '+JSON.stringify(t))}},level:{get:function(){return t},set:function(i){i>=0&&i<=3?t=i:i>3?t=3:r.hasOwnProperty(i)?t=r[i]:e.error('invalid "level" parameter value: '+JSON.stringify(i))}},connector:{get:function(){return s},set:function(t){null===t||""===t||void 0===t?s=null:"function"==typeof t?s=t:e.error('invalid "connector" parameter value: '+JSON.stringify(t))}}})};return t.prototype.print=function(e,t,i,r){if("string"==typeof r){var s=[new Date,t];i&&s.push(i),r=s.concat(r).join(" | ")}e.call(console,r)},Object.keys(r).forEach(function(i){e.prototype[i]=function(e){this.logger[i](this.category,this.label,e)},t.prototype[i]=function(e,t,s){this.level>=r[i]&&(this.builtinEnabled&&this.print(console[i],e,t,s),this.connector&&this.connector(i,e,t,s))}}),t.prototype.getLogger=function(t,i){var r;return i&&3===this.level?new e(this,t,i):this.loggers[t]?this.loggers[t]:(r=new e(this,t),this.loggers[t]=r,r)},t}},753:function(e,t,i){"use strict";var r=i(754).EventEmitter;e.exports=function(){function e(){r.call(this)}return e.prototype=Object.create(r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),e}},754:function(e,t,i){"use strict";function r(e){console&&console.warn&&console.warn(e)}function s(){s.init.call(this)}function n(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function a(e,t,i,s){var a,o,u;if("function"!=typeof i)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i);if(o=e._events,void 0===o?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),u=o[t]),void 0===u)u=o[t]=i,++e._eventsCount;else if("function"==typeof u?u=o[t]=s?[i,u]:[u,i]:s?u.unshift(i):u.push(i),(a=n(e))>0&&u.length>a&&!u.warned){u.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+u.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=u.length,r(c)}return e}function o(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,m(this.listener,this.target,e))}function u(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=o.bind(r);return s.listener=i,r.wrapFn=s,s}function c(e,t,i){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?p(s):h(s,s.length)}function l(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function h(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function d(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function p(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}var f,g="object"==typeof Reflect?Reflect:null,m=g&&"function"==typeof g.apply?g.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};f=g&&"function"==typeof g.ownKeys?g.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var v=Number.isNaN||function(e){return e!==e};e.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var T=10;Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return T},set:function(e){if("number"!=typeof e||e<0||v(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");T=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||v(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return n(this)},s.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var a=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw a.context=n,a}var o=s[e];if(void 0===o)return!1;if("function"==typeof o)m(o,this,t);else for(var u=o.length,c=h(o,u),i=0;i<u;++i)m(c[i],this,t);return!0},s.prototype.addListener=function(e,t){return a(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return a(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,u(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,u(this,e,t)),this},s.prototype.removeListener=function(e,t){var i,r,s,n,a;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,n=i.length-1;n>=0;n--)if(i[n]===t||i[n].listener===t){a=i[n].listener,s=n;break}if(s<0)return this;0===s?i.shift():d(i,s),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,n=Object.keys(i);for(r=0;r<n.length;++r)"removeListener"!==(s=n[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return c(this,e,!0)},s.prototype.rawListeners=function(e){return c(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):l.call(e,t)},s.prototype.listenerCount=l,s.prototype.eventNames=function(){return this._eventsCount>0?f(this._events):[]}},755:function(e,t,i){"use strict";e.exports=function(e,t){return{USER_AGENT:e+"/"+t,SIP:"sip",SIPS:"sips",TEL:"tel",causes:{CONNECTION_ERROR:"Connection Error",REQUEST_TIMEOUT:"Request Timeout",SIP_FAILURE_CODE:"SIP Failure Code",INTERNAL_ERROR:"Internal Error",BUSY:"Busy",REJECTED:"Rejected",REDIRECTED:"Redirected",UNAVAILABLE:"Unavailable",NOT_FOUND:"Not Found",ADDRESS_INCOMPLETE:"Address Incomplete",INCOMPATIBLE_SDP:"Incompatible SDP",AUTHENTICATION_ERROR:"Authentication Error",DIALOG_ERROR:"Dialog Error",WEBRTC_NOT_SUPPORTED:"WebRTC Not Supported",WEBRTC_ERROR:"WebRTC Error",CANCELED:"Canceled",NO_ANSWER:"No Answer",EXPIRES:"Expires",NO_ACK:"No ACK",NO_PRACK:"No PRACK",USER_DENIED_MEDIA_ACCESS:"User Denied Media Access",BAD_MEDIA_DESCRIPTION:"Bad Media Description",RTP_TIMEOUT:"RTP Timeout"},supported:{UNSUPPORTED:"none",SUPPORTED:"supported",REQUIRED:"required"},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},ACK:"ACK",BYE:"BYE",CANCEL:"CANCEL",INFO:"INFO",INVITE:"INVITE",MESSAGE:"MESSAGE",NOTIFY:"NOTIFY",OPTIONS:"OPTIONS",REGISTER:"REGISTER",UPDATE:"UPDATE",SUBSCRIBE:"SUBSCRIBE",PUBLISH:"PUBLISH",REFER:"REFER",PRACK:"PRACK",REASON_PHRASE:{100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"},OPTION_TAGS:{"100rel":!0,199:!0,answermode:!0,"early-session":!0,eventlist:!0,explicitsub:!0,"from-change":!0,"geolocation-http":!0,"geolocation-sip":!0,gin:!0,gruu:!0,histinfo:!0,ice:!0,join:!0,"multiple-refer":!0,norefersub:!0,nosub:!0,outbound:!0,path:!0,policy:!0,precondition:!0,pref:!0,privacy:!0,"recipient-list-invite":!0,"recipient-list-message":!0,"recipient-list-subscribe":!0,replaces:!0,"resource-priority":!0,"sdp-anat":!0,"sec-agree":!0,tdialog:!0,timer:!0,uui:!0},dtmfType:{INFO:"info",RTP:"rtp"}}}},756:function(e,t,i){"use strict";e.exports={ConfigurationError:function(){var e=function(e,t){this.code=1,this.name="CONFIGURATION_ERROR",this.parameter=e,this.value=t,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return e.prototype=new Error,e}(),InvalidStateError:function(){var e=function(e){this.code=2,this.name="INVALID_STATE_ERROR",this.status=e,this.message="Invalid status: "+e};return e.prototype=new Error,e}(),NotSupportedError:function(){var e=function(e){this.code=3,this.name="NOT_SUPPORTED_ERROR",this.message=e};return e.prototype=new Error,e}(),GetDescriptionError:function(){var e=function(e){this.code=4,this.name="GET_DESCRIPTION_ERROR",this.message=e};return e.prototype=new Error,e}(),RenegotiationError:function(){var e=function(e){this.code=5,this.name="RENEGOTIATION_ERROR",this.message=e};return e.prototype=new Error,e}(),MethodParameterError:function(){var e=function(e,t,i){this.code=6,this.name="METHOD_PARAMETER_ERROR",this.method=e,this.parameter=t,this.value=i,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return e.prototype=new Error,e}(),TransportError:function(){var e=function(e){this.code=7,this.name="TRANSPORT_ERROR",this.message=e};return e.prototype=new Error,e}(),SessionDescriptionHandlerError:function(){var e=function(e,t,i){this.code=8,this.name="SESSION_DESCRIPTION_HANDLER_ERROR",this.method=e,this.error=t,this.message=i||"Error with Session Description Handler"};return e.prototype=new Error,e}()}},757:function(e,t,i){"use strict";var r=500;e.exports=function(){return{T1:r,T2:4e3,T4:5e3,TIMER_B:32e3,TIMER_D:0,TIMER_F:32e3,TIMER_H:32e3,TIMER_I:0,TIMER_J:0,TIMER_K:0,TIMER_L:32e3,TIMER_M:32e3,TIMER_N:32e3,PROVISIONAL_RESPONSE_INTERVAL:6e4}}},758:function(e,t,i){"use strict";e.exports=function(e){var t=function(e,t){};return t.prototype=Object.create(e.EventEmitter.prototype,{connect:{writable:!0,value:function(e){return e=e||{},this.connectPromise(e).then(function(e){!e.overrideEvent&&this.emit("connected")}.bind(this))}},connectPromise:{writable:!0,value:function(e){}},isConnected:{writable:!0,value:function(){}},send:{writable:!0,value:function(e,t){return t=t||{},this.sendPromise(e).then(function(e){!e.overrideEvent&&this.emit("messageSent",e.msg)}.bind(this))}},sendPromise:{writable:!0,value:function(e,t){}},onMessage:{writable:!0,value:function(e){}},disconnect:{writable:!0,value:function(e){return e=e||{},this.disconnectPromise(e).then(function(e){!e.overrideEvent&&this.emit("disconnected")}.bind(this))}},disconnectPromise:{writable:!0,value:function(e){}},afterConnected:{writable:!0,value:function(e){this.isConnected()?e():this.once("connected",e)}},waitForConnected:{writable:!0,value:function(){return console.warn("DEPRECATION WARNING Transport.waitForConnected(): use afterConnected() instead"),new Promise(function(e){this.afterConnected(e)}.bind(this))}}}),t}},759:function(e,t,i){"use strict";e.exports=function(e){function t(e,t){var i=t,r=0,s=0;if(e.substring(i,i+2).match(/(^\r\n)/))return-2;for(;0===r;){if(-1===(s=e.indexOf("\r\n",i)))return s;!e.substring(s+2,s+4).match(/(^\r\n)/)&&e.charAt(s+2).match(/(^\s+)/)?i=s+2:r=s}return r}function i(t,i,r,s){var n,a,o,u,c=i.indexOf(":",r),l=i.substring(r,c).trim(),h=i.substring(c+1,s).trim();switch(l.toLowerCase()){case"via":case"v":t.addHeader("via",h),1===t.getHeaders("via").length?(u=t.parseHeader("Via"))&&(t.via=u,t.via_branch=u.branch):u=0;break;case"from":case"f":t.setHeader("from",h),u=t.parseHeader("from"),u&&(t.from=u,t.from_tag=u.getParam("tag"));break;case"to":case"t":t.setHeader("to",h),u=t.parseHeader("to"),u&&(t.to=u,t.to_tag=u.getParam("tag"));break;case"record-route":if(-1===(u=e.Grammar.parse(h,"Record_Route"))){u=void 0;break}for(o=u.length,a=0;a<o;a++)n=u[a],t.addHeader("record-route",h.substring(n.position,n.offset)),t.headers["Record-Route"][t.getHeaders("record-route").length-1].parsed=n.parsed;break;case"call-id":case"i":t.setHeader("call-id",h),u=t.parseHeader("call-id"),u&&(t.call_id=h);break;case"contact":case"m":if(-1===(u=e.Grammar.parse(h,"Contact"))){u=void 0;break}for(o=u.length,a=0;a<o;a++)n=u[a],t.addHeader("contact",h.substring(n.position,n.offset)),t.headers.Contact[t.getHeaders("contact").length-1].parsed=n.parsed;break;case"content-length":case"l":t.setHeader("content-length",h),u=t.parseHeader("content-length");break;case"content-type":case"c":t.setHeader("content-type",h),u=t.parseHeader("content-type");break;case"cseq":t.setHeader("cseq",h),u=t.parseHeader("cseq"),u&&(t.cseq=u.value),t instanceof e.IncomingResponse&&(t.method=u.method);break;case"max-forwards":t.setHeader("max-forwards",h),u=t.parseHeader("max-forwards");break;case"www-authenticate":t.setHeader("www-authenticate",h),u=t.parseHeader("www-authenticate");break;case"proxy-authenticate":t.setHeader("proxy-authenticate",h),u=t.parseHeader("proxy-authenticate");break;case"refer-to":case"r":t.setHeader("refer-to",h),u=t.parseHeader("refer-to"),u&&(t.refer_to=u);break;default:t.setHeader(l,h),u=0}return void 0!==u||{error:'error parsing header "'+l+'"'}}var r;r={},r.parseMessage=function(r,s){var n,a,o,u,c,l=0,h=r.indexOf("\r\n"),d=s.getLogger("sip.parser");if(-1===h)return void d.warn("no CRLF found, not a SIP message, discarded");if(a=r.substring(0,h),-1===(c=e.Grammar.parse(a,"Request_Response")))return void d.warn('error parsing first line of SIP message: "'+a+'"');for(c.status_code?(n=new e.IncomingResponse(s),n.status_code=c.status_code,n.reason_phrase=c.reason_phrase):(n=new e.IncomingRequest(s),n.method=c.method,n.ruri=c.uri),n.data=r,l=h+2;;){if(-2===(h=t(r,l))){u=l+2;break}if(-1===h)return void d.error("malformed message");if(!0!==(c=i(n,r,l,h)))return void d.error(c.error);l=h+2}return n.hasHeader("content-length")?(o=n.getHeader("content-length"),n.body=r.substr(u,o)):n.body=r.substring(u),n},e.Parser=r}},760:function(e,t,i){"use strict";e.exports=function(e){function t(t){var i=t.ua.configuration.hackAllowUnregisteredOptionTags,r=[],s={};return t.method===e.C.REGISTER?r.push("path","gruu"):t.method===e.C.INVITE&&(t.ua.contact.pub_gruu||t.ua.contact.temp_gruu)&&r.push("gruu"),t.ua.configuration.rel100===e.C.supported.SUPPORTED&&r.push("100rel"),t.ua.configuration.replaces===e.C.supported.SUPPORTED&&r.push("replaces"),r.push("outbound"),r=r.concat(t.ua.configuration.extraSupported),r=r.filter(function(t){var r=e.C.OPTION_TAGS[t],n=!s[t];return s[t]=!0,(r||i)&&n}),"Supported: "+r.join(", ")+"\r\n"}var i,r,s,n;i=function(t,i,r,s,n,a){var o,u,c,l,h,d;if(s=s||{},!t||!i||!r)return null;this.logger=r.getLogger("sip.sipmessage"),this.ua=r,this.headers={},this.method=t,this.ruri=i,this.body=a,this.extraHeaders=(n||[]).slice(),this.statusCode=s.status_code,this.reasonPhrase=s.reason_phrase,s.route_set?this.setHeader("route",s.route_set):r.configuration.usePreloadedRoute&&this.setHeader("route",r.transport.server.sip_uri),this.setHeader("via",""),this.setHeader("max-forwards",e.UA.C.MAX_FORWARDS),h=s.to_uri||i,o=s.to_displayName||0===s.to_displayName?'"'+s.to_displayName+'" ':"",o+="<"+(h&&h.toRaw?h.toRaw():h)+">",o+=s.to_tag?";tag="+s.to_tag:"",this.to=new e.NameAddrHeader.parse(o),this.setHeader("to",o),d=s.from_uri||r.configuration.uri,u=s.from_displayName||0===s.from_displayName?'"'+s.from_displayName+'" ':r.configuration.displayName?'"'+r.configuration.displayName+'" ':"",u+="<"+(d&&d.toRaw?d.toRaw():d)+">;tag=",u+=s.from_tag||e.Utils.newTag(),this.from=new e.NameAddrHeader.parse(u),this.setHeader("from",u),c=s.call_id||r.configuration.sipjsId+e.Utils.createRandomToken(15),this.call_id=c,this.setHeader("call-id",c),l=s.cseq||Math.floor(1e4*Math.random()),this.cseq=l,this.setHeader("cseq",l+" "+t)},i.prototype={setHeader:function(t,i){this.headers[e.Utils.headerize(t)]=i instanceof Array?i:[i]},getHeader:function(t){var i,r,s=this.extraHeaders.length,n=this.headers[e.Utils.headerize(t)];if(n){if(n[0])return n[0]}else for(i=new RegExp("^\\s*"+t+"\\s*:","i"),r=0;r<s;r++)if(n=this.extraHeaders[r],i.test(n))return n.substring(n.indexOf(":")+1).trim()},getHeaders:function(t){var i,r,s,n=this.headers[e.Utils.headerize(t)],a=[];if(n){for(r=n.length,i=0;i<r;i++)a.push(n[i]);return a}for(r=this.extraHeaders.length,s=new RegExp("^\\s*"+t+"\\s*:","i"),i=0;i<r;i++)n=this.extraHeaders[i],s.test(n)&&a.push(n.substring(n.indexOf(":")+1).trim());return a},hasHeader:function(t){var i,r,s=this.extraHeaders.length;if(this.headers[e.Utils.headerize(t)])return!0;for(i=new RegExp("^\\s*"+t+"\\s*:","i"),r=0;r<s;r++)if(i.test(this.extraHeaders[r]))return!0;return!1},toString:function(){var i,r,s,n="";n+=this.method+" "+(this.ruri.toRaw?this.ruri.toRaw():this.ruri)+" SIP/2.0\r\n";for(i in this.headers)for(r=this.headers[i].length,s=0;s<r;s++)n+=i+": "+this.headers[i][s]+"\r\n";for(r=this.extraHeaders.length,s=0;s<r;s++)n+=this.extraHeaders[s].trim()+"\r\n";return n+=t(this),n+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",this.body?"string"==typeof this.body?(r=e.Utils.str_utf8_length(this.body),n+="Content-Length: "+r+"\r\n\r\n",n+=this.body):this.body.body&&this.body.contentType?(r=e.Utils.str_utf8_length(this.body.body),n+="Content-Type: "+this.body.contentType+"\r\n",n+="Content-Length: "+r+"\r\n\r\n",n+=this.body.body):n+="Content-Length: 0\r\n\r\n":n+="Content-Length: 0\r\n\r\n",n}},r=function(){this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null},r.prototype={addHeader:function(t,i){var r={raw:i};t=e.Utils.headerize(t),this.headers[t]?this.headers[t].push(r):this.headers[t]=[r]},getHeader:function(t){var i=this.headers[e.Utils.headerize(t)];if(i)return i[0]?i[0].raw:void 0},getHeaders:function(t){var i,r,s=this.headers[e.Utils.headerize(t)],n=[];if(!s)return[];for(r=s.length,i=0;i<r;i++)n.push(s[i].raw);return n},hasHeader:function(t){return!!this.headers[e.Utils.headerize(t)]},parseHeader:function(t,i){var r,s,n;return t=e.Utils.headerize(t),i=i||0,this.headers[t]?i>=this.headers[t].length?void this.logger.log('not so many "'+t+'" headers present'):(r=this.headers[t][i],s=r.raw,r.parsed?r.parsed:(n=e.Grammar.parse(s,t.replace(/-/g,"_")),-1===n?(this.headers[t].splice(i,1),void this.logger.warn('error parsing "'+t+'" header field with value "'+s+'"')):(r.parsed=n,n))):void this.logger.log('header "'+t+'" not present')},s:function(e,t){return this.parseHeader(e,t)},setHeader:function(t,i){var r={raw:i};this.headers[e.Utils.headerize(t)]=[r]},toString:function(){return this.data}},s=function(e){this.logger=e.getLogger("sip.sipmessage"),this.ua=e,this.headers={},this.ruri=null,this.transport=null,this.server_transaction=null},s.prototype=new r,s.prototype.reply=function(i,r,s,n,a,o){var u,c,l,h,d,p=this.getHeader("To"),f=0,g=0;if(d=e.Utils.buildStatusLine(i,r),s=(s||[]).slice(),this.method===e.C.INVITE&&i>100&&i<=200)for(u=this.getHeaders("record-route"),l=u.length,f;f<l;f++)d+="Record-Route: "+u[f]+"\r\n";for(c=this.getHeaders("via"),l=c.length,g;g<l;g++)d+="Via: "+c[g]+"\r\n";for(!this.to_tag&&i>100?p+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(p+=";tag="+this.to_tag),d+="To: "+p+"\r\n",d+="From: "+this.getHeader("From")+"\r\n",d+="Call-ID: "+this.call_id+"\r\n",d+="CSeq: "+this.cseq+" "+this.method+"\r\n",l=s.length,h=0;h<l;h++)d+=s[h].trim()+"\r\n";return d+=t(this),d+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",n?"string"==typeof n?(l=e.Utils.str_utf8_length(n),d+="Content-Type: application/sdp\r\n",d+="Content-Length: "+l+"\r\n\r\n",d+=n):n.body&&n.contentType?(l=e.Utils.str_utf8_length(n.body),d+="Content-Type: "+n.contentType+"\r\n",d+="Content-Length: "+l+"\r\n\r\n",d+=n.body):d+="Content-Length: 0\r\n\r\n":d+="Content-Length: 0\r\n\r\n",this.server_transaction.receiveResponse(i,d).then(a,o),d},s.prototype.reply_sl=function(t,i){var r,s,n=0,a=this.getHeaders("via"),o=a.length;for(s=e.Utils.buildStatusLine(t,i),n;n<o;n++)s+="Via: "+a[n]+"\r\n";r=this.getHeader("To"),!this.to_tag&&t>100?r+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(r+=";tag="+this.to_tag),s+="To: "+r+"\r\n",s+="From: "+this.getHeader("From")+"\r\n",s+="Call-ID: "+this.call_id+"\r\n",s+="CSeq: "+this.cseq+" "+this.method+"\r\n",s+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",s+="Content-Length: 0\r\n\r\n",this.transport.send(s)},n=function(e){this.logger=e.getLogger("sip.sipmessage"),this.headers={},this.status_code=null,this.reason_phrase=null},n.prototype=new r,e.OutgoingRequest=i,e.IncomingRequest=s,e.IncomingResponse=n}},761:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i,r,s,n,a){var o,u,c,l;if(!r){if(t!==e.C.TEL)throw new TypeError('missing or invalid "host" parameter');r=""}t=t||e.C.SIP,this.parameters={},this.headers={};for(o in n)this.setParam(o,n[o]);for(u in a)this.setHeader(u,a[u]);c={scheme:t,user:i,host:r,port:s},l={scheme:t.toLowerCase(),user:i,host:r.toLowerCase(),port:s},Object.defineProperties(this,{_normal:{get:function(){return l}},_raw:{get:function(){return c}},scheme:{get:function(){return l.scheme},set:function(e){c.scheme=e,l.scheme=e.toLowerCase()}},user:{get:function(){return l.user},set:function(e){l.user=c.user=e}},host:{get:function(){return l.host},set:function(e){c.host=e,l.host=e.toLowerCase()}},aor:{get:function(){return l.user+"@"+l.host}},port:{get:function(){return l.port},set:function(e){l.port=c.port=0===e?e:parseInt(e,10)||null}}})},t.prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=void 0===t||null===t?null:t.toString())},getParam:function(e){if(e)return this.parameters[e.toLowerCase()]},hasParam:function(e){if(e)return this.parameters.hasOwnProperty(e.toLowerCase())&&!0||!1},deleteParam:function(e){var t;if(e=e.toLowerCase(),this.parameters.hasOwnProperty(e))return t=this.parameters[e],delete this.parameters[e],t},clearParams:function(){this.parameters={}},setHeader:function(t,i){this.headers[e.Utils.headerize(t)]=i instanceof Array?i:[i]},getHeader:function(t){if(t)return this.headers[e.Utils.headerize(t)]},hasHeader:function(t){if(t)return this.headers.hasOwnProperty(e.Utils.headerize(t))&&!0||!1},deleteHeader:function(t){var i;if(t=e.Utils.headerize(t),this.headers.hasOwnProperty(t))return i=this.headers[t],delete this.headers[t],i},clearHeaders:function(){this.headers={}},clone:function(){return new t(this._raw.scheme,this._raw.user,this._raw.host,this._raw.port,JSON.parse(JSON.stringify(this.parameters)),JSON.parse(JSON.stringify(this.headers)))},toRaw:function(){return this._toString(this._raw)},toString:function(){return this._toString(this._normal)},_toString:function(t){var i,r,s,n,a=[];n=t.scheme+":",t.scheme.toLowerCase().match("^sips?$")||(n+="//"),t.user&&(n+=e.Utils.escapeUser(t.user)+"@"),n+=t.host,(t.port||0===t.port)&&(n+=":"+t.port);for(r in this.parameters)n+=";"+r,null!==this.parameters[r]&&(n+="="+this.parameters[r]);for(i in this.headers)for(s in this.headers[i])a.push(i+"="+this.headers[i][s]);return a.length>0&&(n+="?"+a.join("&")),n}},t.parse=function(t){return t=e.Grammar.parse(t,"SIP_URI"),-1!==t?t:void 0},e.URI=t}},762:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i,r){var s;if(!(t&&t instanceof e.URI))throw new TypeError('missing or invalid "uri" parameter');this.uri=t,this.parameters={};for(s in r)this.setParam(s,r[s]);Object.defineProperties(this,{friendlyName:{get:function(){return this.displayName||t.aor}},displayName:{get:function(){return i},set:function(e){i=0===e?"0":e}}})},t.prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=void 0===t||null===t?null:t.toString())},getParam:e.URI.prototype.getParam,hasParam:e.URI.prototype.hasParam,deleteParam:e.URI.prototype.deleteParam,clearParams:e.URI.prototype.clearParams,clone:function(){return new t(this.uri.clone(),this.displayName,JSON.parse(JSON.stringify(this.parameters)))},toString:function(){var e,t;e=this.displayName||0===this.displayName?'"'+this.displayName+'" ':"",e+="<"+this.uri.toString()+">";for(t in this.parameters)e+=";"+t,null!==this.parameters[t]&&(e+="="+this.parameters[t]);return e}},t.parse=function(t){return t=e.Grammar.parse(t,"Name_Addr_Header"),-1!==t?t:void 0},e.NameAddrHeader=t}},763:function(e,t,i){"use strict";e.exports=function(e){function t(e,t,i){var r;return r="SIP/2.0/"+(e.ua.configuration.hackViaTcp?"TCP":t.server.scheme),r+=" "+e.ua.configuration.viaHost+";branch="+i,e.ua.configuration.forceRport&&(r+=";rport"),r}var i={STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7,NON_INVITE_CLIENT:"nict",NON_INVITE_SERVER:"nist",INVITE_CLIENT:"ict",INVITE_SERVER:"ist"},r=function(e,r,s){var n;this.type=i.NON_INVITE_CLIENT,this.transport=s,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=r,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),n=t(e,s,this.id),this.request.setHeader("via",n),this.request_sender.ua.newTransaction(this)};r.prototype=Object.create(e.EventEmitter.prototype),r.prototype.stateChanged=function(e){this.state=e,this.emit("stateChanged")},r.prototype.send=function(){var t=this;this.stateChanged(i.STATUS_TRYING),this.F=setTimeout(t.timer_F.bind(t),e.Timers.TIMER_F),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},r.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting non-INVITE client transaction "+this.id),clearTimeout(this.F),clearTimeout(this.K),this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onTransportError()},r.prototype.timer_F=function(){this.logger.debug("Timer F expired for non-INVITE client transaction "+this.id),this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout()},r.prototype.timer_K=function(){this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},r.prototype.receiveResponse=function(t){var r=this,s=t.status_code;if(s<200)switch(this.state){case i.STATUS_TRYING:case i.STATUS_PROCEEDING:this.stateChanged(i.STATUS_PROCEEDING),this.request_sender.receiveResponse(t)}else switch(this.state){case i.STATUS_TRYING:case i.STATUS_PROCEEDING:this.stateChanged(i.STATUS_COMPLETED),clearTimeout(this.F),408===s?this.request_sender.onRequestTimeout():this.request_sender.receiveResponse(t),this.K=setTimeout(r.timer_K.bind(r),e.Timers.TIMER_K)}};var s=function(e,r,s){var n,a=this;this.type=i.INVITE_CLIENT,this.transport=s,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=r,this.logger=e.ua.getLogger("sip.transaction.ict",this.id),n=t(e,s,this.id),this.request.setHeader("via",n),this.request_sender.ua.newTransaction(this),this.request.cancel=function(e,t){t=(t||[]).slice();for(var i=t.length,r=null,s=0;s<i;s++)r=(r||"")+t[s].trim()+"\r\n";a.cancel_request(a,e,r)}};s.prototype=Object.create(e.EventEmitter.prototype),s.prototype.stateChanged=function(e){this.state=e,this.emit("stateChanged")},s.prototype.send=function(){var t=this;this.stateChanged(i.STATUS_CALLING),this.B=setTimeout(t.timer_B.bind(t),e.Timers.TIMER_B),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},s.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting INVITE client transaction "+this.id),clearTimeout(this.B),clearTimeout(this.D),clearTimeout(this.M),this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.state!==i.STATUS_ACCEPTED&&this.request_sender.onTransportError()},s.prototype.timer_M=function(){this.logger.debug("Timer M expired for INVITE client transaction "+this.id),this.state===i.STATUS_ACCEPTED&&(clearTimeout(this.B),this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this))},s.prototype.timer_B=function(){this.logger.debug("Timer B expired for INVITE client transaction "+this.id),this.state===i.STATUS_CALLING&&(this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout())},s.prototype.timer_D=function(){this.logger.debug("Timer D expired for INVITE client transaction "+this.id),clearTimeout(this.B),this.stateChanged(i.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},s.prototype.sendACK=function(t){var i,r=this;t=t||{},i=this.response.getHeader("contact")?this.response.parseHeader("contact").uri:this.request.ruri;var s=new e.OutgoingRequest("ACK",i,this.request.ua,{cseq:this.response.cseq,call_id:this.response.call_id,from_uri:this.response.from.uri,from_tag:this.response.from_tag,to_uri:this.response.to.uri,to_tag:this.response.to_tag,route_set:this.response.getHeaders("record-route").reverse()},t.extraHeaders||[],t.body);return this.ackSender=new e.RequestSender({request:s,onRequestTimeout:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTimeout:function(){r.logger.warn("ACK Request timed out")},onTransportError:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTransportError:function(){r.logger.warn("ACK Request had a transport error")},receiveResponse:t.receiveResponse||function(){r.logger.warn("Received a response to an ACK which was unexpected. Dropping Response.")}},this.request.ua).send(),s},s.prototype.cancel_request=function(t,r,s){var n=t.request;this.cancel=e.C.CANCEL+" "+n.ruri+" SIP/2.0\r\n",this.cancel+="Via: "+n.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.cancel+="Route: "+n.headers.Route.toString()+"\r\n"),this.cancel+="To: "+n.headers.To.toString()+"\r\n",this.cancel+="From: "+n.headers.From.toString()+"\r\n",this.cancel+="Call-ID: "+n.headers["Call-ID"].toString()+"\r\n",this.cancel+="Max-Forwards: "+e.UA.C.MAX_FORWARDS+"\r\n",this.cancel+="CSeq: "+n.headers.CSeq.toString().split(" ")[0]+" CANCEL\r\n",r&&(this.cancel+="Reason: "+r+"\r\n"),s&&(this.cancel+=s),this.cancel+="Content-Length: 0\r\n\r\n",this.state===i.STATUS_PROCEEDING&&this.transport.send(this.cancel)},s.prototype.receiveResponse=function(t){var r=this,s=t.status_code;if(t.transaction=this,this.response&&this.response.status_code===t.status_code&&this.response.cseq===t.cseq)return this.logger.debug("ICT Received a retransmission for cseq: "+t.cseq),void(this.ackSender&&this.ackSender.send());if(this.response=t,s>=100&&s<=199)switch(this.state){case i.STATUS_CALLING:this.stateChanged(i.STATUS_PROCEEDING),this.request_sender.receiveResponse(t),this.cancel&&this.transport.send(this.cancel);break;case i.STATUS_PROCEEDING:this.request_sender.receiveResponse(t)}else if(s>=200&&s<=299)switch(this.state){case i.STATUS_CALLING:case i.STATUS_PROCEEDING:this.stateChanged(i.STATUS_ACCEPTED),this.M=setTimeout(r.timer_M.bind(r),e.Timers.TIMER_M),this.request_sender.receiveResponse(t);break;case i.STATUS_ACCEPTED:this.request_sender.receiveResponse(t)}else if(s>=300&&s<=699)switch(this.state){case i.STATUS_CALLING:case i.STATUS_PROCEEDING:this.stateChanged(i.STATUS_COMPLETED),this.sendACK(),this.request_sender.receiveResponse(t);break;case i.STATUS_COMPLETED:this.sendACK()}};var n=function(e,i,r){var s;this.transport=r,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=i,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),s=t(e,r,this.id),this.request.setHeader("via",s)};n.prototype=Object.create(e.EventEmitter.prototype),n.prototype.send=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},n.prototype.onTransportError=function(){this.logger.log("transport error occurred, for an ACK client transaction "+this.id),this.request_sender.onTransportError()};var a=function(e,t){this.type=i.NON_INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=t.transport,this.ua=t,this.last_response="",e.server_transaction=this,this.logger=t.getLogger("sip.transaction.nist",this.id),this.state=i.STATUS_TRYING,t.newTransaction(this)};a.prototype=Object.create(e.EventEmitter.prototype),a.prototype.stateChanged=function(e){this.state=e,this.emit("stateChanged")},a.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting non-INVITE server transaction "+this.id),clearTimeout(this.J),this.stateChanged(i.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.receiveResponse=function(t,r){var s=this;return new Promise(function(n,a){if(100===t)switch(s.state){case i.STATUS_TRYING:s.stateChanged(i.STATUS_PROCEEDING),s.transport.send(r).catch(s.onTransportError);break;case i.STATUS_PROCEEDING:s.last_response=r,s.transport.send(r).then(n).catch(function(){s.onTransportError(),a()})}else if(t>=200&&t<=699)switch(s.state){case i.STATUS_TRYING:case i.STATUS_PROCEEDING:s.stateChanged(i.STATUS_COMPLETED),s.last_response=r,s.J=setTimeout(function(){s.logger.debug("Timer J expired for non-INVITE server transaction "+s.id),s.stateChanged(i.STATUS_TERMINATED),s.ua.destroyTransaction(s)},e.Timers.TIMER_J),s.transport.send(r).then(n).catch(function(){s.onTransportError(),a()})}})};var o=function(e,t){this.type=i.INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=t.transport,this.ua=t,this.last_response="",e.server_transaction=this,this.logger=t.getLogger("sip.transaction.ist",this.id),this.state=i.STATUS_PROCEEDING,t.newTransaction(this),this.resendProvisionalTimer=null,e.reply(100)};o.prototype=Object.create(e.EventEmitter.prototype),o.prototype.stateChanged=function(e){this.state=e,this.emit("stateChanged")},o.prototype.timer_H=function(){this.logger.debug("Timer H expired for INVITE server transaction "+this.id),this.state===i.STATUS_COMPLETED&&this.logger.warn("transactions","ACK for INVITE server transaction was never received, call will be terminated"),this.stateChanged(i.STATUS_TERMINATED),this.ua.destroyTransaction(this)},o.prototype.timer_I=function(){this.stateChanged(i.STATUS_TERMINATED),this.ua.destroyTransaction(this)},o.prototype.timer_L=function(){this.logger.debug("Timer L expired for INVITE server transaction "+this.id),this.state===i.STATUS_ACCEPTED&&(this.stateChanged(i.STATUS_TERMINATED),this.ua.destroyTransaction(this))},o.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting INVITE server transaction "+this.id),null!==this.resendProvisionalTimer&&(clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),clearTimeout(this.L),clearTimeout(this.H),clearTimeout(this.I),this.stateChanged(i.STATUS_TERMINATED),this.ua.destroyTransaction(this))},o.prototype.receiveResponse=function(t,r){var s=this;return new Promise(function(n,a){if(t>=100&&t<=199&&s.state===i.STATUS_PROCEEDING)s.transport.send(r).catch(s.onTransportError),s.last_response=r,t>100&&null===s.resendProvisionalTimer&&(s.resendProvisionalTimer=setInterval(function(){s.transport.send(s.request).catch(function(){s.onTransportError()})},e.Timers.PROVISIONAL_RESPONSE_INTERVAL));else if(t>=200&&t<=299)switch(s.state){case i.STATUS_PROCEEDING:s.stateChanged(i.STATUS_ACCEPTED),s.last_response=r,s.L=setTimeout(s.timer_L,e.Timers.TIMER_L),null!==s.resendProvisionalTimer&&(clearInterval(s.resendProvisionalTimer),s.resendProvisionalTimer=null);case i.STATUS_ACCEPTED:s.transport.send(r).then(n).catch(function(e){s.logger.error(e),s.onTransportError(),a()})}else if(t>=300&&t<=699)switch(s.state){case i.STATUS_PROCEEDING:null!==s.resendProvisionalTimer&&(clearInterval(s.resendProvisionalTimer),s.resendProvisionalTimer=null),s.transport.send(r).then(function(){s.stateChanged(i.STATUS_COMPLETED),s.H=setTimeout(s.timer_H.bind(s),e.Timers.TIMER_H),n()}).catch(function(e){s.logger.error(e),s.onTransportError(),a()})}})};var u=function(t,r){var s;switch(r.method){case e.C.INVITE:if(s=t.transactions.ist[r.via_branch]){switch(s.state){case i.STATUS_PROCEEDING:s.transport.send(s.last_response)}return!0}break;case e.C.ACK:if(!(s=t.transactions.ist[r.via_branch]))return!1;if(s.state===i.STATUS_ACCEPTED)return!1;if(s.state===i.STATUS_COMPLETED)return s.stateChanged(i.STATUS_CONFIRMED),s.I=setTimeout(s.timer_I.bind(s),e.Timers.TIMER_I),!0;break;case e.C.CANCEL:return s=t.transactions.ist[r.via_branch],s?(r.reply_sl(200),s.state!==i.STATUS_PROCEEDING):(r.reply_sl(481),!0);default:if(s=t.transactions.nist[r.via_branch]){switch(s.state){case i.STATUS_TRYING:break;case i.STATUS_PROCEEDING:case i.STATUS_COMPLETED:s.transport.send(s.last_response)}return!0}}};e.Transactions={C:i,checkTransaction:u,NonInviteClientTransaction:r,InviteClientTransaction:s,AckClientTransaction:n,NonInviteServerTransaction:a,InviteServerTransaction:o}}},764:function(e,t,i){"use strict";e.exports=function(e){var t,r=i(765)(e),s={STATUS_EARLY:1,STATUS_CONFIRMED:2};t=function(t,i,r,n){var a;if(this.uac_pending_reply=!1,this.uas_pending_reply=!1,!i.hasHeader("contact"))return{error:"unable to create a Dialog without Contact header field"};n=i instanceof e.IncomingResponse?i.status_code<200?s.STATUS_EARLY:s.STATUS_CONFIRMED:n||s.STATUS_CONFIRMED,a=i.parseHeader("contact"),"UAS"===r?(this.id={call_id:i.call_id,local_tag:i.to_tag,remote_tag:i.from_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=n,this.remote_seqnum=i.cseq,this.local_uri=i.parseHeader("to").uri,this.remote_uri=i.parseHeader("from").uri,this.remote_target=a.uri,this.route_set=i.getHeaders("record-route"),this.invite_seqnum=i.cseq,this.local_seqnum=i.cseq):"UAC"===r&&(this.id={call_id:i.call_id,local_tag:i.from_tag,remote_tag:i.to_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=n,this.invite_seqnum=i.cseq,this.local_seqnum=i.cseq,this.local_uri=i.parseHeader("from").uri,this.pracked=[],this.remote_uri=i.parseHeader("to").uri,this.remote_target=a.uri,this.route_set=i.getHeaders("record-route").reverse()),this.logger=t.ua.getLogger("sip.dialog",this.id.toString()),this.owner=t,t.ua.dialogs[this.id.toString()]=this,this.logger.log("new "+r+" dialog created with status "+(this.state===s.STATUS_EARLY?"EARLY":"CONFIRMED")),t.emit("dialog",this)},t.prototype={update:function(e,t){this.state=s.STATUS_CONFIRMED,this.logger.log("dialog "+this.id.toString()+"  changed to CONFIRMED state"),"UAC"===t&&(this.route_set=e.getHeaders("record-route").reverse())},terminate:function(){this.logger.log("dialog "+this.id.toString()+" deleted"),this.sessionDescriptionHandler&&this.state!==s.STATUS_CONFIRMED&&this.sessionDescriptionHandler.close(),delete this.owner.ua.dialogs[this.id.toString()]},createRequest:function(t,i,r){var s,n;return i=(i||[]).slice(),this.local_seqnum||(this.local_seqnum=Math.floor(1e4*Math.random())),s=t===e.C.CANCEL||t===e.C.ACK?this.invite_seqnum:this.local_seqnum+=1,n=new e.OutgoingRequest(t,this.remote_target,this.owner.ua,{cseq:s,call_id:this.id.call_id,from_uri:this.local_uri,from_tag:this.id.local_tag,to_uri:this.remote_uri,to_tag:this.id.remote_tag,route_set:this.route_set},i,r),n.dialog=this,n},checkInDialogRequest:function(t){var i=this;if(this.remote_seqnum){if(t.cseq<this.remote_seqnum)return t.method!==e.C.ACK&&t.reply(500),t.cseq===this.invite_seqnum}else this.remote_seqnum=t.cseq;switch(t.method){case e.C.INVITE:if(!0===this.uac_pending_reply)t.reply(491);else{if(!0===this.uas_pending_reply&&t.cseq>this.remote_seqnum){var r=1+(10*Math.random()|0);return t.reply(500,null,["Retry-After:"+r]),this.remote_seqnum=t.cseq,!1}this.uas_pending_reply=!0,t.server_transaction.on("stateChanged",function t(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",t),i.uas_pending_reply=!1)})}t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_ACCEPTED&&(i.remote_target=t.parseHeader("contact").uri)});break;case e.C.NOTIFY:t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_COMPLETED&&(i.remote_target=t.parseHeader("contact").uri)})}return t.cseq>this.remote_seqnum&&(this.remote_seqnum=t.cseq),!0},sendRequest:function(e,t,i){i=i||{};var s=(i.extraHeaders||[]).slice(),n=null;i.body&&(i.body.body?n=i.body:(n={},n.body=i.body,i.contentType&&(n.contentType=i.contentType)));var a=this.createRequest(t,s,n);return new r(this,e,a).send(),a},receiveRequest:function(e){this.checkInDialogRequest(e)&&this.owner.receiveRequest(e)}},t.C=s,e.Dialog=t}},765:function(e,t,i){"use strict";e.exports=function(e){var t;return t=function(e,t,i){this.dialog=e,this.applicant=t,this.request=i,this.reattempt=!1,this.reattemptTimer=null},t.prototype={send:function(){var t=this,i=new e.RequestSender(this,this.dialog.owner.ua);i.send(),this.request.method===e.C.INVITE&&i.clientTransaction.state!==e.Transactions.C.STATUS_TERMINATED&&(this.dialog.uac_pending_reply=!0,i.clientTransaction.on("stateChanged",function i(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",i),t.dialog.uac_pending_reply=!1)}))},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var i=this;408===t.status_code||481===t.status_code?this.applicant.onDialogError(t):t.method===e.C.INVITE&&491===t.status_code?this.reattempt?this.applicant.receiveResponse(t):(this.request.cseq.value=this.dialog.local_seqnum+=1,this.reattemptTimer=setTimeout(function(){i.applicant.owner.status!==e.Session.C.STATUS_TERMINATED&&(i.reattempt=!0,i.request_sender.send())},this.getReattemptTimeout())):this.applicant.receiveResponse(t)}},t}},766:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i){this.logger=i.getLogger("sip.requestsender"),this.ua=i,this.applicant=t,this.method=t.request.method,this.request=t.request,this.credentials=null,this.challenged=!1,this.staled=!1,i.status!==e.UA.C.STATUS_USER_CLOSED||this.method===e.C.BYE&&this.method===e.C.ACK||this.onTransportError()},t.prototype={send:function(){switch(this.method){case"INVITE":this.clientTransaction=new e.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new e.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new e.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport)}return this.clientTransaction.send(),this.clientTransaction},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var i,r,s,n=t.status_code;if(401===n||407===n){if(401===t.status_code?(r=t.parseHeader("www-authenticate"),s="authorization"):(r=t.parseHeader("proxy-authenticate"),s="proxy-authorization"),!r)return this.logger.warn(t.status_code+" with wrong or missing challenge, cannot authenticate"),void this.applicant.receiveResponse(t);if(!this.challenged||!this.staled&&!0===r.stale){if(this.credentials||(this.credentials=this.ua.configuration.authenticationFactory(this.ua)),!this.credentials.authenticate(this.request,r))return void this.applicant.receiveResponse(t);this.challenged=!0,r.stale&&(this.staled=!0),t.method===e.C.REGISTER?i=this.applicant.cseq+=1:this.request.dialog?i=this.request.dialog.local_seqnum+=1:(i=this.request.cseq+1,this.request.cseq=i),this.request.setHeader("cseq",i+" "+this.method),this.request.setHeader(s,this.credentials.toString()),this.send()}else this.applicant.receiveResponse(t)}else this.applicant.receiveResponse(t)}},e.RequestSender=t}},767:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i){if(void 0===i&&(i={}),this.options={},this.logger=t.getLogger("sip.registercontext"),this.loadConfig(i),this.options.regId&&!this.options.instanceId?this.options.instanceId=e.Utils.newUUID():!this.options.regId&&this.options.instanceId&&(this.options.regId=1),this.options.params.to_uri=this.options.params.to_uri||t.configuration.uri,this.options.params.to_displayName=this.options.params.to_displayName||t.configuration.displayName,this.options.params.call_id=this.options.params.call_id||e.Utils.createRandomToken(22),this.options.params.cseq=this.options.params.cseq||Math.floor(1e4*Math.random()),!this.options.registrar){var r={};"object"==typeof t.configuration.uri?(r=t.configuration.uri.clone(),r.user=null):r=t.configuration.uri,this.options.registrar=r}this.expires=this.options.expires,this.cseq=this.options.params.cseq,this.contact=t.contact.toString(),e.Utils.augment(this,e.ClientContext,[t,"REGISTER",this.options.registrar,this.options]),this.registrationTimer=null,this.registrationExpiredTimer=null,this.registered=!1,t.on("transportCreated",function(e){e.on("disconnected",this.onTransportDisconnected.bind(this))}.bind(this))},t.prototype=Object.create({},{loadConfig:{writable:!0,value:function(t){var i,r,s,n={expires:600,extraContactHeaderParams:[],instanceId:null,params:{},regId:null,registrar:null},a=this.getConfigurationCheck();for(i in a.mandatory){if(!t.hasOwnProperty(i))throw new e.Exceptions.ConfigurationError(i);if(r=t[i],void 0===(s=a.mandatory[i](r)))throw new e.Exceptions.ConfigurationError(i,r);n[i]=s}for(i in a.optional)if(t.hasOwnProperty(i)){if((r=t[i])instanceof Array&&0===r.length)continue;if(null===r||""===r||void 0===r)continue;if("number"==typeof r&&isNaN(r))continue;if(void 0===(s=a.optional[i](r)))throw new e.Exceptions.ConfigurationError(i,r);n[i]=s}Object.assign(this.options,n),this.logger.log("configuration parameters for RegisterContext after validation:");for(i in n)this.logger.log(" "+i+": "+JSON.stringify(n[i]))}},getConfigurationCheck:{writable:!0,value:function(){return{mandatory:{},optional:{expires:function(t){if(e.Utils.isDecimal(t)){var i=Number(t);if(i>=0)return i}},extraContactHeaderParams:function(e){if(e instanceof Array)return e.filter(function(e){return"string"==typeof e})},instanceId:function(t){if("string"==typeof t)return/^uuid:/i.test(t)&&(t=t.substr(5)),-1===e.Grammar.parse(t,"uuid")?void 0:t},params:function(e){if("object"==typeof e)return e},regId:function(t){if(e.Utils.isDecimal(t)){var i=Number(t);if(i>=0)return i}},registrar:function(t){if("string"==typeof t){/^sip:/i.test(t)||(t=e.C.SIP+":"+t);var i=e.URI.parse(t);return i?i.user?void 0:i:void 0}}}}}},generateContactHeader:{writable:!0,value:function(e){void 0===e&&(e=0);var t=this.contact;return this.options.regId&&this.options.instanceId&&(t+=";reg-id="+this.options.regId,t+=';+sip.instance="<urn:uuid:'+this.options.instanceId+'>"'),this.options.extraContactHeaderParams&&this.options.extraContactHeaderParams.forEach(function(e){t+=";"+e}),t+=";expires="+e}},register:{writable:!0,value:function(t){void 0===t&&(t={}),this.options=Object.assign(this.options||{},t);var i=(this.options.extraHeaders||[]).slice();i.push("Contact: "+this.generateContactHeader(this.expires)),i.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.closeHeaders=this.options.closeWithHeaders?(this.options.extraHeaders||[]).slice():[],this.receiveResponse=function(t){var i,r,s,n=this,a=t.getHeaders("contact").length;if(t.cseq===this.cseq)switch(null!==this.registrationTimer&&(clearTimeout(this.registrationTimer),this.registrationTimer=null),!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.emit("accepted",t),t.hasHeader("expires")&&(r=t.getHeader("expires")),null!==this.registrationExpiredTimer&&(clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),!a){this.logger.warn("no Contact header in response to REGISTER, response ignored");break}for(;a--;){if(i=t.parseHeader("contact",a),i.uri.user===this.ua.contact.uri.user){r=i.getParam("expires");break}i=null}if(!i){this.logger.warn("no Contact header pointing to us, response ignored");break}r||(r=this.expires),this.registrationTimer=setTimeout(function(){n.registrationTimer=null,n.register(n.options)},1e3*r-3e3),this.registrationExpiredTimer=setTimeout(function(){n.logger.warn("registration expired"),n.registered&&n.unregistered(null,e.C.causes.EXPIRES)},1e3*r),i.hasParam("temp-gruu")&&(this.ua.contact.temp_gruu=e.URI.parse(i.getParam("temp-gruu").replace(/"/g,""))),i.hasParam("pub-gruu")&&(this.ua.contact.pub_gruu=e.URI.parse(i.getParam("pub-gruu").replace(/"/g,""))),this.registered=!0,this.emit("registered",t||null);break;case/^423$/.test(t.status_code):t.hasHeader("min-expires")?(this.expires=t.getHeader("min-expires"),this.register(this.options)):(this.logger.warn("423 response received for REGISTER without Min-Expires"),this.registrationFailure(t,e.C.causes.SIP_FAILURE_CODE));break;default:s=e.Utils.sipErrorCause(t.status_code),this.registrationFailure(t,s)}},this.onRequestTimeout=function(){this.registrationFailure(null,e.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.registrationFailure(null,e.C.causes.CONNECTION_ERROR)},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=i,this.send()}},registrationFailure:{writable:!0,value:function(e,t){this.emit("failed",e||null,t||null)}},onTransportDisconnected:{writable:!0,value:function(){this.registered_before=this.registered,null!==this.registrationTimer&&(clearTimeout(this.registrationTimer),this.registrationTimer=null),null!==this.registrationExpiredTimer&&(clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.registered&&this.unregistered(null,e.C.causes.CONNECTION_ERROR)}},close:{writable:!0,value:function(){var e={all:!1,extraHeaders:this.closeHeaders};this.registered_before=this.registered,this.registered&&this.unregister(e)}},unregister:{writable:!0,value:function(t){var i;t=t||{},this.registered||t.all||this.logger.warn("Already unregistered, but sending an unregister anyways."),i=(t.extraHeaders||[]).slice(),this.registered=!1,null!==this.registrationTimer&&(clearTimeout(this.registrationTimer),this.registrationTimer=null),t.all?(i.push("Contact: *"),i.push("Expires: 0")):i.push("Contact: "+this.generateContactHeader(0)),this.receiveResponse=function(t){var i;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("accepted",t),null!==this.registrationExpiredTimer&&(clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.unregistered(t);break;default:i=e.Utils.sipErrorCause(t.status_code),this.unregistered(t,i)}},this.onRequestTimeout=function(){},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=i,this.send()}},unregistered:{writable:!0,value:function(e,t){this.registered=!1,this.emit("unregistered",e||null,t||null)}}}),e.RegisterContext=t}},768:function(e,t,i){"use strict";e.exports=function(e){var t=function(){};return t.prototype=Object.create(e.prototype,{close:{value:function(){}},getDescription:{value:function(e,t){}},hasDescription:{value:function(e){}},holdModifier:{value:function(e){}},setDescription:{value:function(e,t,i){}},sendDtmf:{value:function(e,t){}},getDirection:{value:function(){}}}),t}},769:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i,r,s){var n=r;if(void 0===r)throw new TypeError("Not enough arguments");if(this.ua=t,this.logger=t.getLogger("sip.clientcontext"),this.method=i,!(r=t.normalizeTarget(r)))throw new TypeError("Invalid target: "+n);s=Object.create(s||Object.prototype),s.extraHeaders=(s.extraHeaders||[]).slice(),this.request=new e.OutgoingRequest(this.method,r,this.ua,s.params,s.extraHeaders),s.body&&(this.body={},this.body.body=s.body,s.contentType&&(this.body.contentType=s.contentType),this.request.body=this.body),this.localIdentity=this.request.from,this.remoteIdentity=this.request.to,this.data={}},t.prototype=Object.create(e.EventEmitter.prototype),t.prototype.send=function(){return new e.RequestSender(this,this.ua).send(),this},t.prototype.cancel=function(t){t=t||{},t.extraHeaders=(t.extraHeaders||[]).slice();var i=e.Utils.getCancelReason(t.status_code,t.reason_phrase);this.request.cancel(i,t.extraHeaders),this.emit("cancel")},t.prototype.receiveResponse=function(t){var i=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,i);break;case/^2[0-9]{2}$/.test(t.status_code):this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("accepted",t,i);break;default:this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("rejected",t,i),this.emit("failed",t,i)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ClientContext=t}},770:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i){this.ua=t,this.logger=t.getLogger("sip.servercontext"),this.request=i,i.method===e.C.INVITE?this.transaction=new e.Transactions.InviteServerTransaction(i,t):this.transaction=new e.Transactions.NonInviteServerTransaction(i,t),i.body&&(this.body=i.body),i.hasHeader("Content-Type")&&(this.contentType=i.getHeader("Content-Type")),this.method=i.method,this.data={},this.localIdentity=i.to,this.remoteIdentity=i.from,i.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(i.getHeader("P-Asserted-Identity")))},t.prototype=Object.create(e.EventEmitter.prototype),t.prototype.progress=function(e){return e=Object.create(e||Object.prototype),e.statusCode||(e.statusCode=180),e.minCode=100,e.maxCode=199,e.events=["progress"],this.reply(e)},t.prototype.accept=function(e){return e=Object.create(e||Object.prototype),e.statusCode||(e.statusCode=200),e.minCode=200,e.maxCode=299,e.events=["accepted"],this.reply(e)},t.prototype.reject=function(e){return e=Object.create(e||Object.prototype),e.statusCode||(e.statusCode=480),e.minCode=300,e.maxCode=699,e.events=["rejected","failed"],this.reply(e)},t.prototype.reply=function(t){t=t||{};var i,r=t.statusCode||100,s=t.minCode||100,n=t.maxCode||699,a=e.Utils.getReasonPhrase(r,t.reasonPhrase),o=t.extraHeaders||[],u=t.body,c=t.events||[];if(r<s||r>n)throw new TypeError("Invalid statusCode: "+r);return i=this.request.reply(r,a,o,u),c.forEach(function(e){this.emit(e,i,a)},this),this},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ServerContext=t}},771:function(e,t,i){"use strict";e.exports=function(e){var t,r,s,n,a,o=i(772)(e),u={STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_ANSWERED:5,STATUS_WAITING_FOR_PRACK:6,STATUS_WAITING_FOR_ACK:7,STATUS_CANCELED:8,STATUS_TERMINATED:9,STATUS_ANSWERED_WAITING_FOR_PRACK:10,STATUS_EARLY_MEDIA:11,STATUS_CONFIRMED:12};t=function(t){if(this.status=u.STATUS_NULL,this.dialog=null,this.pendingReinvite=!1,this.earlyDialogs={},!t)throw new e.Exceptions.SessionDescriptionHandlerMissing("A session description handler is required for the session to function");this.sessionDescriptionHandlerFactory=t,this.hasOffer=!1,this.hasAnswer=!1,this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null,rel1xxTimer:null,prackTimer:null},this.startTime=null,this.endTime=null,this.tones=null,this.local_hold=!1,this.early_sdp=null,this.rel100=e.C.supported.UNSUPPORTED},t.prototype={dtmf:function(t,i){var r=[],s=this,n=this.ua.configuration.dtmfType;if(i=i||{},void 0===t)throw new TypeError("Not enough arguments");if(this.status!==u.STATUS_CONFIRMED&&this.status!==u.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.status);if("string"!=typeof t&&"number"!=typeof t||!t.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+t);var a=function(){var e,t;if(s.status===u.STATUS_TERMINATED||!s.tones||0===s.tones.length)return s.tones=null,this;e=s.tones.shift(),e.on("failed",function(){s.tones=null}),e.send(i),t=e.duration+e.interToneGap,setTimeout(a,t)};if(t=t.toString(),n===e.C.dtmfType.RTP){this.sessionDescriptionHandler.sendDtmf(t,i)||(this.logger.warn("Attempt to use dtmfType 'RTP' has failed, falling back to INFO packet method"),n=e.C.dtmfType.INFO)}if(n===e.C.dtmfType.INFO){for(t=t.split("");t.length>0;)r.push(new o(this,t.shift(),i));if(this.tones)return this.tones=this.tones.concat(r),this;this.tones=r,a()}return this},bye:function(t){t=Object.create(t||Object.prototype);var i=t.statusCode;if(this.status===u.STATUS_TERMINATED)return this.logger.error("Error: Attempted to send BYE in a terminated session."),this;if(this.logger.log("terminating Session"),i&&(i<200||i>=700))throw new TypeError("Invalid statusCode: "+i);return t.receiveResponse=function(){},this.sendRequest(e.C.BYE,t).terminated()},refer:function(t,i){if(i=i||{},this.status!==u.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);return this.referContext=new e.ReferClientContext(this.ua,this,t,i),this.emit("referRequested",this.referContext),this.referContext.refer(i),this.referContext},sendRequest:function(t,i){i=i||{};var r=this,s=new e.OutgoingRequest(t,this.dialog.remote_target,this.ua,{cseq:i.cseq||(this.dialog.local_seqnum+=1),call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set,statusCode:i.statusCode,reasonPhrase:i.reasonPhrase},i.extraHeaders||[],i.body);return new e.RequestSender({request:s,onRequestTimeout:function(){r.onRequestTimeout()},onTransportError:function(){r.onTransportError()},receiveResponse:i.receiveResponse||function(e){r.receiveNonInviteResponse(e)}},this.ua).send(),this.emit(t.toLowerCase(),s),this},close:function(){var e;if(this.status===u.STATUS_TERMINATED)return this;this.logger.log("closing INVITE session "+this.id),this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close();for(e in this.timers)clearTimeout(this.timers[e]);this.dialog&&(this.dialog.terminate(),delete this.dialog);for(e in this.earlyDialogs)this.earlyDialogs[e].terminate(),delete this.earlyDialogs[e];return this.status=u.STATUS_TERMINATED,this.ua.transport.removeListener("transportError",this.errorListener),delete this.ua.sessions[this.id],this},createDialog:function(t,i,r){var s,n,a=t["UAS"===i?"to_tag":"from_tag"],o=t["UAS"===i?"from_tag":"to_tag"],u=t.call_id+a+o;if(n=this.earlyDialogs[u],r)return!!n||(n=new e.Dialog(this,t,i,e.Dialog.C.STATUS_EARLY),n.error?(this.logger.error(n.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.earlyDialogs[u]=n,!0));if(n){n.update(t,i),this.dialog=n,delete this.earlyDialogs[u];for(var c in this.earlyDialogs)this.earlyDialogs[c].terminate(),delete this.earlyDialogs[c];return!0}return s=new e.Dialog(this,t,i),s.error?(this.logger.error(s.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.to_tag=t.to_tag,this.dialog=s,!0)},hold:function(t,i){if(this.status!==u.STATUS_WAITING_FOR_ACK&&this.status!==u.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);if(this.local_hold)return void this.logger.log("Session is already on hold, cannot put it on hold again");t=t||{},t.modifiers=i||[],t.modifiers.push(this.sessionDescriptionHandler.holdModifier),this.local_hold=!0,this.sendReinvite(t)},unhold:function(t,i){if(this.status!==u.STATUS_WAITING_FOR_ACK&&this.status!==u.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);if(!this.local_hold)return void this.logger.log("Session is not on hold, cannot unhold it");t=t||{},i&&(t.modifiers=i),this.local_hold=!1,this.sendReinvite(t)},reinvite:function(e,t){return e=e||{},t&&(e.modifiers=t),this.sendReinvite(e)},receiveReinvite:function(t){var i,r=this;if(r.emit("reinvite",this),t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),"0"!==t.getHeader("Content-Length")||t.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))return t.reply(415),void this.emit("reinviteFailed",r);i=this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers))}else i=this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers);this.receiveRequest=function(t){t.method===e.C.ACK&&this.status===u.STATUS_WAITING_FOR_ACK?this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){clearTimeout(this.timers.ackTimer),clearTimeout(this.timers.invite2xxTimer),this.status=u.STATUS_CONFIRMED,this.emit("confirmed",t)}.bind(this))):(clearTimeout(this.timers.ackTimer),clearTimeout(this.timers.invite2xxTimer),this.status=u.STATUS_CONFIRMED,this.emit("confirmed",t)):e.Session.prototype.receiveRequest.apply(this,[t])}.bind(this),i.catch(function(i){var s;throw i instanceof e.Exceptions.SessionDescriptionHandlerError?s=500:i instanceof e.Exceptions.RenegotiationError?(r.emit("renegotiationError",i),r.logger.warn(i),s=488):(r.logger.error(i),s=488),t.reply(s),r.emit("reinviteFailed",r),i}).then(function(e){var i=["Contact: "+r.contact];t.reply(200,null,i,e,function(){r.status=u.STATUS_WAITING_FOR_ACK,r.setACKTimer(),r.emit("reinviteAccepted",r)})})},sendReinvite:function(t){if(this.pendingReinvite)return void this.logger.warn("Reinvite in progress. Please wait until complete, then try again.");this.pendingReinvite=!0,t=t||{},t.modifiers=t.modifiers||[];var i=this,r=(t.extraHeaders||[]).slice();r.push("Contact: "+this.contact),r.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){i.sendRequest(e.C.INVITE,{extraHeaders:r,body:t,receiveResponse:i.receiveReinviteResponse.bind(i)})}).catch(function(t){if(t instanceof e.Exceptions.RenegotiationError)throw i.pendingReinvite=!1,i.emit("renegotiationError",t),i.logger.warn("Renegotiation Error"),i.logger.warn(t),t;throw i.logger.error("sessionDescriptionHandler error"),i.logger.error(t),t})},receiveRequest:function(t){switch(t.method){case e.C.BYE:t.reply(200),this.status===u.STATUS_CONFIRMED&&(this.emit("bye",t),this.terminated(t,e.C.causes.BYE));break;case e.C.INVITE:this.status===u.STATUS_CONFIRMED&&(this.logger.log("re-INVITE received"),this.receiveReinvite(t));break;case e.C.INFO:if(this.status===u.STATUS_CONFIRMED||this.status===u.STATUS_WAITING_FOR_ACK){if(this.onInfo)return this.onInfo(t);var i,r,s,n=t.getHeader("content-type"),a=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,c=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;n&&(n.match(/^application\/dtmf-relay/i)?(t.body&&(i=t.body.split("\r\n",2),2===i.length&&(a.test(i[0])&&(r=i[0].replace(a,"$2")),c.test(i[1])&&(s=parseInt(i[1].replace(c,"$2"),10)))),new o(this,r,{duration:s}).init_incoming(t)):t.reply(415,null,["Accept: application/dtmf-relay"]))}break;case e.C.REFER:if(this.status===u.STATUS_CONFIRMED){this.logger.log("REFER received"),this.referContext=new e.ReferServerContext(this.ua,t);if(this.listeners("referRequested").length)this.emit("referRequested",this.referContext);else{this.logger.log("No referRequested listeners, automatically accepting and following the refer");var l={followRefer:!0};this.passedOptions&&(l.inviteOptions=this.passedOptions),this.referContext.accept(l,this.modifiers)}}break;case e.C.NOTIFY:if(this.referContext&&this.referContext instanceof e.ReferClientContext&&t.hasHeader("event")&&/^refer(;.*)?$/.test(t.getHeader("event")))return void this.referContext.receiveNotify(t);t.reply(200,"OK"),this.emit("notify",t);break;case e.C.UPDATE:t.reply(200,"OK")}},receiveReinviteResponse:function(t){var i=this;if(this.status===u.STATUS_TERMINATED)return void this.logger.error("Received reinvite response, but in STATUS_TERMINATED");if(!this.pendingReinvite)return void this.logger.error("Received reinvite response, but have no pending reinvite");switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):if(this.status=u.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.pendingReinvite=!1,clearTimeout(i.timers.invite2xxTimer),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.logger.error("2XX response received to re-invite but did not have a description"),this.emit("reinviteFailed",i),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("2XX response received to re-invite but did not have a description"));break}this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).catch(function(t){throw i.logger.error("Could not set the description in 2XX response"),i.logger.error(t),i.emit("reinviteFailed",i),i.emit("renegotiationError",t),i.sendRequest(e.C.BYE,{extraHeaders:["Reason: "+e.Utils.getReasonHeaderValue(488,"Not Acceptable Here")]}),i.terminated(null,e.C.causes.INCOMPATIBLE_SDP),t}).then(function(){i.emit("reinviteAccepted",i)});break;default:this.pendingReinvite=!1,this.logger.log("Received a non 1XX or 2XX response to a re-invite"),this.emit("reinviteFailed",i),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("Invalid response to a re-invite"))}},acceptAndTerminate:function(t,i,r){var s=[];return i&&s.push("Reason: "+e.Utils.getReasonHeaderValue(i,r)),(this.dialog||this.createDialog(t,"UAC"))&&(this.emit("ack",t.transaction.sendACK()),this.sendRequest(e.C.BYE,{extraHeaders:s})),this},setInvite2xxTimer:function(t,i){var r=this,s=e.Timers.T1;this.timers.invite2xxTimer=setTimeout(function n(){if(r.status===u.STATUS_WAITING_FOR_ACK){r.logger.log("no ACK received, attempting to retransmit OK");var a=["Contact: "+r.contact];t.reply(200,null,a,i),s=Math.min(2*s,e.Timers.T2),r.timers.invite2xxTimer=setTimeout(n,s)}},s)},setACKTimer:function(){var t=this;this.timers.ackTimer=setTimeout(function(){t.status===u.STATUS_WAITING_FOR_ACK&&(t.logger.log("no ACK received for an extended period of time, terminating the call"),clearTimeout(t.timers.invite2xxTimer),t.sendRequest(e.C.BYE),t.terminated(null,e.C.causes.NO_ACK))},e.Timers.TIMER_H)},onTransportError:function(){this.status!==u.STATUS_CONFIRMED&&this.status!==u.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)},onRequestTimeout:function(){this.status===u.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==u.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))},onDialogError:function(t){this.status===u.STATUS_CONFIRMED?this.terminated(t,e.C.causes.DIALOG_ERROR):this.status!==u.STATUS_TERMINATED&&(this.failed(t,e.C.causes.DIALOG_ERROR),this.terminated(t,e.C.causes.DIALOG_ERROR))},failed:function(e,t){return this.status===u.STATUS_TERMINATED?this:(this.emit("failed",e||null,t||null),this)},rejected:function(e,t){return this.emit("rejected",e||null,t||null),this},canceled:function(){return this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.emit("cancel"),this},accepted:function(t,i){return i=e.Utils.getReasonPhrase(t&&t.status_code,i),this.startTime=new Date,this.replacee&&(this.replacee.emit("replaced",this),this.replacee.terminate()),this.emit("accepted",t,i),this},terminated:function(e,t){return this.status===u.STATUS_TERMINATED?this:(this.endTime=new Date,this.close(),this.emit("terminated",e||null,t||null),this)},connecting:function(e){return this.emit("connecting",{request:e}),this}},t.C=u,e.Session=t,r=function(t,i){function r(e,t){i.hasHeader(e)&&i.getHeader(e).toLowerCase().indexOf("100rel")>=0&&(n.rel100=t)}var s,n=this,a=i.getHeader("Content-Type"),o=i.parseHeader("Content-Disposition");if(e.Utils.augment(this,e.ServerContext,[t,i]),e.Utils.augment(this,e.Session,[t.configuration.sessionDescriptionHandlerFactory]),o&&"render"===o.type&&(this.renderbody=i.body,this.rendertype=a),this.status=u.STATUS_INVITE_RECEIVED,this.from_tag=i.from_tag,this.id=i.call_id+this.from_tag,this.request=i,this.contact=this.ua.contact.toString(),this.receiveNonInviteResponse=function(){},this.logger=t.getLogger("sip.inviteservercontext",this.id),this.ua.sessions[this.id]=this,i.hasHeader("expires")&&(s=1e3*i.getHeader("expires")),r("require",e.C.supported.REQUIRED),r("supported",e.C.supported.SUPPORTED),i.to_tag=e.Utils.newTag(),!this.createDialog(i,"UAS",!0))return void i.reply(500,"Missing Contact header field");var c={extraHeaders:["Contact: "+n.contact]};n.rel100!==e.C.supported.REQUIRED&&n.progress(c),n.status=u.STATUS_WAITING_FOR_ANSWER,n.timers.userNoAnswerTimer=setTimeout(function(){i.reply(408),n.failed(i,e.C.causes.NO_ANSWER),n.terminated(i,e.C.causes.NO_ANSWER)},n.ua.configuration.noAnswerTimeout),s&&(n.timers.expiresTimer=setTimeout(function(){n.status===u.STATUS_WAITING_FOR_ANSWER&&(i.reply(487),n.failed(i,e.C.causes.EXPIRES),n.terminated(i,e.C.causes.EXPIRES))},s)),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)},r.prototype=Object.create({},{reject:{writable:!0,value:function(t){if(this.status===u.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);return this.logger.log("rejecting RTCSession"),e.ServerContext.prototype.reject.call(this,t),this.terminated()}},terminate:{writable:!0,value:function(t){t=t||{};var i,r=(t.extraHeaders||[]).slice(),s=t.body,n=this;return this.status===u.STATUS_WAITING_FOR_ACK&&this.request.server_transaction.state!==e.Transactions.C.STATUS_TERMINATED?(i=this.dialog,this.receiveRequest=function(t){t.method===e.C.ACK&&(this.sendRequest(e.C.BYE,{extraHeaders:r}),i.terminate())},this.request.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_TERMINATED&&this.dialog&&(this.request=new e.OutgoingRequest(e.C.BYE,this.dialog.remote_target,this.ua,{cseq:this.dialog.local_seqnum+=1,call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set},r,s),new e.RequestSender({request:this.request,onRequestTimeout:function(){n.onRequestTimeout()},onTransportError:function(){n.onTransportError()},receiveResponse:function(){}},this.ua).send(),i.terminate())}),this.emit("bye",this.request),this.terminated(),this.dialog=i,this.ua.dialogs[i.id.toString()]=i):this.status===u.STATUS_CONFIRMED?this.bye(t):this.reject(t),this}},progress:{writable:!0,value:function(t){function i(){n=t.statusCode||183,this.status=u.STATUS_WAITING_FOR_PRACK,o.push("Contact: "+this.contact),o.push("Require: 100rel"),o.push("RSeq: "+Math.floor(1e4*Math.random())),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){if(!this.isCanceled&&this.status!==u.STATUS_TERMINATED){this.early_sdp=t.body,this[this.hasOffer?"hasAnswer":"hasOffer"]=!0;var i=e.Timers.T1;this.timers.rel1xxTimer=setTimeout(function e(){this.request.reply(n,null,o,t),i*=2,this.timers.rel1xxTimer=setTimeout(e.bind(this),i)}.bind(this),i),this.timers.prackTimer=setTimeout(function(){this.status===u.STATUS_WAITING_FOR_PRACK&&(this.logger.log("no PRACK received, rejecting the call"),clearTimeout(this.timers.rel1xxTimer),this.request.reply(504),this.terminated(null,e.C.causes.NO_PRACK))}.bind(this),64*e.Timers.T1),s=this.request.reply(n,a,o,t),this.emit("progress",s,a)}}.bind(this),function(){this.request.reply(480),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))}function r(){s=this.request.reply(n,a,o,c),this.emit("progress",s,a)}t=t||{};var s,n=t.statusCode||180,a=t.reasonPhrase,o=(t.extraHeaders||[]).slice(),c=t.body;if(n<100||n>199)throw new TypeError("Invalid statusCode: "+n);return this.isCanceled||this.status===u.STATUS_TERMINATED?this:(100!==t.statusCode&&(this.rel100===e.C.supported.REQUIRED||this.rel100===e.C.supported.SUPPORTED&&t.rel100||this.rel100===e.C.supported.SUPPORTED&&this.ua.configuration.rel100===e.C.supported.REQUIRED)?(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type"))?(this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(i.apply(this)).catch(function(t){throw this.logger.warn("invalid description"),this.logger.warn(t),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR),t}.bind(this))):i.apply(this)):r.apply(this),this)}},accept:{writable:!0,value:function(t){t=t||{},this.onInfo=t.onInfo;var i=this,r=this.request,s=(t.extraHeaders||[]).slice(),n=function(t){var n,a=function(){i.status=u.STATUS_WAITING_FOR_ACK,i.setInvite2xxTimer(r,t),i.setACKTimer()},o=function(){i.failed(null,e.C.causes.CONNECTION_ERROR),i.terminated(null,e.C.causes.CONNECTION_ERROR)};s.push("Contact: "+i.contact),s.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),i.hasOffer?i.hasAnswer=!0:i.hasOffer=!0,n=r.reply(200,null,s,t,a,o),i.status!==u.STATUS_TERMINATED&&i.accepted(n,e.Utils.getReasonPhrase(200))},a=function(t){throw t instanceof e.Exceptions.SessionDescriptionHandlerError&&(i.logger.log(t.message),i.logger.log(t.error)),i.request.reply(480),i.failed(null,e.C.causes.WEBRTC_ERROR),i.terminated(null,e.C.causes.WEBRTC_ERROR),t};if(this.status===u.STATUS_WAITING_FOR_PRACK)return this.status=u.STATUS_ANSWERED_WAITING_FOR_PRACK,this;if(this.status===u.STATUS_WAITING_FOR_ANSWER)this.status=u.STATUS_ANSWERED;else if(this.status!==u.STATUS_EARLY_MEDIA)throw new e.Exceptions.InvalidStateError(this.status);if(!this.createDialog(r,"UAS"))return r.reply(500,"Missing Contact header field"),this;if(clearTimeout(this.timers.userNoAnswerTimer),this.status===u.STATUS_EARLY_MEDIA)n({});else if(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),"0"!==this.request.getHeader("Content-Length")||this.request.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type")))return void this.request.reply(415);this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(function(){return this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)}.bind(this)).catch(a).then(n)}else this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).catch(a).then(n);return this}},receiveRequest:{writable:!0,value:function(i){var r=this,s=function(){var e,t;clearTimeout(r.timers.ackTimer),clearTimeout(r.timers.invite2xxTimer),r.status=u.STATUS_CONFIRMED,e=i.getHeader("Content-Type"),t=i.getHeader("Content-Disposition"),t&&"render"===t.type&&(r.renderbody=i.body,r.rendertype=e),r.emit("confirmed",i)};switch(i.method){case e.C.CANCEL:this.status!==u.STATUS_WAITING_FOR_ANSWER&&this.status!==u.STATUS_WAITING_FOR_PRACK&&this.status!==u.STATUS_ANSWERED_WAITING_FOR_PRACK&&this.status!==u.STATUS_EARLY_MEDIA&&this.status!==u.STATUS_ANSWERED||(this.status=u.STATUS_CANCELED,this.request.reply(487),this.canceled(i),this.rejected(i,e.C.causes.CANCELED),this.failed(i,e.C.causes.CANCELED),this.terminated(i,e.C.causes.CANCELED));break;case e.C.ACK:this.status===u.STATUS_WAITING_FOR_ACK&&(this.status=u.STATUS_CONFIRMED,this.sessionDescriptionHandler.hasDescription(i.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(i.body,this.sessionDescriptionHandlerOptions,this.modifiers).catch(function(t){throw r.logger.warn(t),r.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),r.failed(i,e.C.causes.BAD_MEDIA_DESCRIPTION),r.terminated(i,e.C.causes.BAD_MEDIA_DESCRIPTION),t}).then(function(){return s()})):s());break;case e.C.PRACK:this.status===u.STATUS_WAITING_FOR_PRACK||this.status===u.STATUS_ANSWERED_WAITING_FOR_PRACK?this.hasAnswer?(clearTimeout(this.timers.rel1xxTimer),clearTimeout(this.timers.prackTimer),i.reply(200),this.status===u.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=u.STATUS_EARLY_MEDIA,this.accept()),this.status=u.STATUS_EARLY_MEDIA):(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(i.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(i.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){clearTimeout(this.timers.rel1xxTimer),clearTimeout(this.timers.prackTimer),i.reply(200),this.status===u.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=u.STATUS_EARLY_MEDIA,this.accept()),this.status=u.STATUS_EARLY_MEDIA}.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(i,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(i,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):(this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(i,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(i,e.C.causes.BAD_MEDIA_DESCRIPTION))):this.status===u.STATUS_EARLY_MEDIA&&i.reply(200);break;default:t.prototype.receiveRequest.apply(this,[i])}}},setupSessionDescriptionHandler:{writable:!0,value:function(){return this.sessionDescriptionHandler?this.sessionDescriptionHandler:this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions)}},onTransportError:{writable:!0,value:function(){this.status!==u.STATUS_CONFIRMED&&this.status!==u.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===u.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==u.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteServerContext=r,s=function(t,i,r,s){r=r||{},this.passedOptions=r,r.params=Object.create(r.params||Object.prototype);var n=(r.extraHeaders||[]).slice(),a=t.configuration.sessionDescriptionHandlerFactory;if(this.sessionDescriptionHandlerFactoryOptions=t.configuration.sessionDescriptionHandlerFactoryOptions||{},this.sessionDescriptionHandlerOptions=r.sessionDescriptionHandlerOptions||{},this.modifiers=s,this.inviteWithoutSdp=r.inviteWithoutSdp||!1,this.anonymous=r.anonymous||!1,this.renderbody=r.renderbody||null,this.rendertype=r.rendertype||"text/plain",this.from_tag=e.Utils.newTag(),r.params.from_tag=this.from_tag,this.contact=t.contact.toString({anonymous:this.anonymous,outbound:this.anonymous?!t.contact.temp_gruu:!t.contact.pub_gruu}),this.anonymous&&(r.params.from_displayName="Anonymous",r.params.from_uri="sip:anonymous@anonymous.invalid",n.push("P-Preferred-Identity: "+t.configuration.uri.toString()),n.push("Privacy: id")),n.push("Contact: "+this.contact),n.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.inviteWithoutSdp&&this.renderbody&&(n.push("Content-Type: "+this.rendertype),n.push("Content-Disposition: render;handling=optional")),t.configuration.rel100===e.C.supported.REQUIRED&&n.push("Require: 100rel"),t.configuration.replaces===e.C.supported.REQUIRED&&n.push("Require: replaces"),r.extraHeaders=n,e.Utils.augment(this,e.ClientContext,[t,e.C.INVITE,i,r]),e.Utils.augment(this,e.Session,[a]),this.status!==u.STATUS_NULL)throw new e.Exceptions.InvalidStateError(this.status);this.isCanceled=!1,this.received_100=!1,this.method=e.C.INVITE,this.receiveNonInviteResponse=this.receiveResponse,this.receiveResponse=this.receiveInviteResponse,this.logger=t.getLogger("sip.inviteclientcontext"),t.applicants[this]=this,this.id=this.request.call_id+this.from_tag,this.onInfo=r.onInfo,this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)},s.prototype=Object.create({},{invite:{writable:!0,value:function(){var t=this;return this.ua.sessions[this.id]=this,Promise.resolve().then(function(){this.inviteWithoutSdp?(this.request.body=t.renderbody,this.status=u.STATUS_INVITE_SENT,this.send()):(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers).then(function(e){t.isCanceled||t.status===u.STATUS_TERMINATED||(t.hasOffer=!0,t.request.body=e,t.status=u.STATUS_INVITE_SENT,t.send())},function(i){i instanceof e.Exceptions.SessionDescriptionHandlerError&&(t.logger.log(i.message),t.logger.log(i.error)),t.status!==u.STATUS_TERMINATED&&(t.failed(null,e.C.causes.WEBRTC_ERROR),t.terminated(null,e.C.causes.WEBRTC_ERROR))}))}.bind(this)),this}},receiveInviteResponse:{writable:!0,value:function(t){var i,r=this,s=t.call_id+t.from_tag+t.to_tag,n=[],a={};if(this.status!==u.STATUS_TERMINATED&&t.method===e.C.INVITE){if(this.dialog&&t.status_code>=200&&t.status_code<=299){if(s!==this.dialog.id.toString()){if(!this.createDialog(t,"UAC",!0))return;return this.emit("ack",t.transaction.sendACK({body:e.Utils.generateFakeSDP(t.body)})),this.earlyDialogs[s].sendRequest(this,e.C.BYE),void(this.status!==u.STATUS_CONFIRMED&&(this.failed(t,e.C.causes.WEBRTC_ERROR),this.terminated(t,e.C.causes.WEBRTC_ERROR)))}if(this.status===u.STATUS_CONFIRMED)return void this.emit("ack",t.transaction.sendACK());if(!this.hasAnswer)return}if(this.dialog&&t.status_code<200){if(-1!==this.dialog.pracked.indexOf(t.getHeader("rseq"))||this.dialog.pracked[this.dialog.pracked.length-1]>=t.getHeader("rseq")&&this.dialog.pracked.length>0)return;if(!this.earlyDialogs[s]&&!this.createDialog(t,"UAC",!0))return;if(-1!==this.earlyDialogs[s].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[s].pracked[this.earlyDialogs[s].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[s].pracked.length>0)return;return n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[s].pracked.push(t.getHeader("rseq")),void this.earlyDialogs[s].sendRequest(this,e.C.PRACK,{extraHeaders:n,body:e.Utils.generateFakeSDP(t.body)})}if(this.isCanceled)return void(t.status_code>=100&&t.status_code<200?(this.request.cancel(this.cancelReason,n),this.canceled(null)):t.status_code>=200&&t.status_code<299?(this.acceptAndTerminate(t),this.emit("bye",this.request)):t.status_code>=300&&(i=e.C.REASON_PHRASE[t.status_code]||e.C.causes.CANCELED,this.rejected(t,i),this.failed(t,i),this.terminated(t,i)));switch(!0){case/^100$/.test(t.status_code):this.received_100=!0,this.emit("progress",t);break;case/^1[0-9]{2}$/.test(t.status_code):if(!t.to_tag){this.logger.warn("1xx response received without to tag");break}if(t.hasHeader("contact")&&!this.createDialog(t,"UAC",!0))break;if(this.status=u.STATUS_1XX_RECEIVED,t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),t.hasHeader("require")&&-1!==t.getHeader("require").indexOf("100rel")){if(this.dialog||!this.earlyDialogs[s])break;if(-1!==this.earlyDialogs[s].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[s].pracked[this.earlyDialogs[s].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[s].pracked.length>0)return;if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))if(this.hasOffer){if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.dialog.pracked.push(t.getHeader("rseq")),this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),r.sendRequest(e.C.PRACK,{extraHeaders:n,receiveResponse:function(){}}),r.status=u.STATUS_EARLY_MEDIA,r.emit("progress",t)},function(i){r.logger.warn(i),r.acceptAndTerminate(t,488,"Not Acceptable Here"),r.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else{var o=this.earlyDialogs[s],c=o.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions);this.emit("SessionDescriptionHandler-created",c),o.pracked.push(t.getHeader("rseq")),c.setDescription(t.body,r.sessionDescriptionHandlerOptions,r.modifers).then(c.getDescription.bind(c,r.sessionDescriptionHandlerOptions,r.modifiers)).then(function(i){n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),o.sendRequest(r,e.C.PRACK,{extraHeaders:n,body:i}),r.status=u.STATUS_EARLY_MEDIA,r.emit("progress",t)}).catch(function(i){if(i instanceof e.Exceptions.SessionDescriptionHandlerError){if(o.pracked.push(t.getHeader("rseq")),r.status===u.STATUS_TERMINATED)return;r.failed(null,e.C.causes.WEBRTC_ERROR),r.terminated(null,e.C.causes.WEBRTC_ERROR)}else o.pracked.splice(o.pracked.indexOf(t.getHeader("rseq")),1),r.logger.warn("invalid description"),r.logger.warn(i)})}else n.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[s].pracked.push(t.getHeader("rseq")),this.earlyDialogs[s].sendRequest(this,e.C.PRACK,{extraHeaders:n}),this.emit("progress",t)}else this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.request.cseq+" "+this.request.method!==t.getHeader("cseq"))break;if(t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),this.status===u.STATUS_EARLY_MEDIA&&this.dialog){this.status=u.STATUS_CONFIRMED,a={},this.renderbody&&(n.push("Content-Type: "+this.rendertype),a.extraHeaders=n,a.body=this.renderbody),this.emit("ack",t.transaction.sendACK(a)),this.accepted(t);break}if(this.dialog)break;if(this.hasOffer)if(this.hasAnswer)this.renderbody&&(n.push("Content-Type: "+r.rendertype),a.extraHeaders=n,a.body=this.renderbody),this.emit("ack",t.transaction.sendACK(a));else{if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){var e={};r.status=u.STATUS_CONFIRMED,r.renderbody&&(n.push("Content-Type: "+r.rendertype),e.extraHeaders=n,e.body=r.renderbody),r.emit("ack",t.transaction.sendACK(e)),r.accepted(t)},function(i){r.logger.warn(i),r.acceptAndTerminate(t,488,"Not Acceptable Here"),r.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else if(this.earlyDialogs[s]&&this.earlyDialogs[s].sessionDescriptionHandler){if(this.hasOffer=!0,this.hasAnswer=!0,this.sessionDescriptionHandler=this.earlyDialogs[s].sessionDescriptionHandler,!this.createDialog(t,"UAC"))break;this.status=u.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.accepted(t)}else{if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers)).then(function(e){r.isCanceled||r.status===u.STATUS_TERMINATED||(r.status=u.STATUS_CONFIRMED,r.hasAnswer=!0,r.emit("ack",t.transaction.sendACK({body:e})),r.accepted(t))}).catch(function(i){i instanceof e.Exceptions.SessionDescriptionHandlerError&&(r.logger.warn("invalid description"),r.logger.warn(i),r.acceptAndTerminate(t,488,"Invalid session description"),r.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION))})}break;default:i=e.Utils.sipErrorCause(t.status_code),this.rejected(t,i),this.failed(t,i),this.terminated(t,i)}}}},cancel:{writable:!0,value:function(t){if(t=t||{},t.extraHeaders=(t.extraHeaders||[]).slice(),this.isCanceled)throw new e.Exceptions.InvalidStateError("CANCELED");if(this.status===u.STATUS_TERMINATED||this.status===u.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("canceling RTCSession"),this.isCanceled=!0;var i=e.Utils.getCancelReason(t.status_code,t.reason_phrase);return this.status===u.STATUS_NULL||this.status===u.STATUS_INVITE_SENT&&!this.received_100?this.cancelReason=i:this.status!==u.STATUS_INVITE_SENT&&this.status!==u.STATUS_1XX_RECEIVED&&this.status!==u.STATUS_EARLY_MEDIA||this.request.cancel(i,t.extraHeaders),this.canceled()}},terminate:{writable:!0,value:function(e){return this.status===u.STATUS_TERMINATED?this:(this.status===u.STATUS_WAITING_FOR_ACK||this.status===u.STATUS_CONFIRMED?this.bye(e):this.cancel(e),this)}},receiveRequest:{writable:!0,value:function(i){return i.method,e.C.CANCEL,i.method===e.C.ACK&&this.status===u.STATUS_WAITING_FOR_ACK&&(clearTimeout(this.timers.ackTimer),clearTimeout(this.timers.invite2xxTimer),this.status=u.STATUS_CONFIRMED,this.accepted()),t.prototype.receiveRequest.apply(this,[i])}},onTransportError:{writable:!0,value:function(){this.status!==u.STATUS_CONFIRMED&&this.status!==u.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===u.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==u.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteClientContext=s,a=function(t,i,r,s){if(this.options=s||{},this.extraHeaders=(this.options.extraHeaders||[]).slice(),void 0===t||void 0===i||void 0===r)throw new TypeError("Not enough arguments");if(e.Utils.augment(this,e.ClientContext,[t,e.C.REFER,i.remoteIdentity.uri.toString(),this.options]),this.applicant=i,r instanceof e.InviteServerContext||r instanceof e.InviteClientContext)this.target='"'+r.remoteIdentity.friendlyName+'" <'+r.dialog.remote_target.toString()+"?Replaces="+r.dialog.id.call_id+"%3Bto-tag%3D"+r.dialog.id.remote_tag+"%3Bfrom-tag%3D"+r.dialog.id.local_tag+">";else{try{this.target=e.Grammar.parse(r,"Refer_To").uri||r}catch(e){this.logger.debug(".refer() cannot parse Refer_To from",r),this.logger.debug("...falling through to normalizeTarget()")}if(this.target=this.ua.normalizeTarget(this.target),!this.target)throw new TypeError("Invalid target: "+r)}this.ua&&this.extraHeaders.push("Referred-By: <"+this.ua.configuration.uri+">"),this.extraHeaders.push("Contact: "+i.contact),this.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.extraHeaders.push("Refer-To: "+this.target),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)},a.prototype=Object.create({},{refer:{writable:!0,value:function(t){t=t||{};var i=(this.extraHeaders||[]).slice();return t.extraHeaders&&i.concat(t.extraHeaders),this.applicant.sendRequest(e.C.REFER,{extraHeaders:this.extraHeaders,receiveResponse:function(e){/^1[0-9]{2}$/.test(e.status_code)?this.emit("referRequestProgress",this):/^2[0-9]{2}$/.test(e.status_code)?this.emit("referRequestAccepted",this):/^[4-6][0-9]{2}$/.test(e.status_code)&&this.emit("referRequestRejected",this),t.receiveResponse&&t.receiveResponse(e)}.bind(this)}),this}},receiveNotify:{writable:!0,value:function(t){if(t.hasHeader("Content-Type")&&-1!==t.getHeader("Content-Type").search(/^message\/sipfrag/)){var i=e.Grammar.parse(t.body,"sipfrag");if(-1===i)return void t.reply(489,"Bad Event");switch(!0){case/^1[0-9]{2}$/.test(i.status_code):this.emit("referProgress",this);break;case/^2[0-9]{2}$/.test(i.status_code):this.emit("referAccepted",this),!this.options.activeAfterTransfer&&this.applicant.terminate&&this.applicant.terminate();break;default:this.emit("referRejected",this)}return t.reply(200),void this.emit("notify",t)}t.reply(489,"Bad Event")}}}),e.ReferClientContext=a,n=function(t,i){if(e.Utils.augment(this,e.ServerContext,[t,i]),this.ua=t,this.status=u.STATUS_INVITE_RECEIVED,this.from_tag=i.from_tag,this.id=i.call_id+this.from_tag,this.request=i,this.contact=this.ua.contact.toString(),this.logger=t.getLogger("sip.referservercontext",this.id),!this.request.hasHeader("refer-to"))return this.logger.warn("Invalid REFER packet. A refer-to header is required. Rejecting refer."),void this.reject();this.referTo=this.request.parseHeader("refer-to"),this.referredSession=this.ua.findSession(i),this.cseq=Math.floor(1e4*Math.random()),this.call_id=this.request.call_id,this.from_uri=this.request.to.uri,this.from_tag=this.request.to.parameters.tag,this.remote_target=this.request.headers.Contact[0].parsed.uri,this.to_uri=this.request.from.uri,this.to_tag=this.request.from_tag,this.route_set=this.request.getHeaders("record-route"),this.receiveNonInviteResponse=function(){},this.request.hasHeader("referred-by")&&(this.referredBy=this.request.getHeader("referred-by")),this.referTo.uri.hasHeader("replaces")&&(this.replaces=this.referTo.uri.getHeader("replaces")),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener),this.status=u.STATUS_WAITING_FOR_ANSWER},n.prototype=Object.create({},{progress:{writable:!0,value:function(){if(this.status!==u.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);this.request.reply(100)}},reject:{writable:!0,value:function(t){if(this.status===u.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("Rejecting refer"),this.status=u.STATUS_TERMINATED,e.ServerContext.prototype.reject.call(this,t),this.emit("referRequestRejected",this)}},accept:{writable:!0,value:function(t,i){var r=this;if(t=t||{},this.status!==u.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);if(this.status=u.STATUS_ANSWERED,this.request.reply(202,"Accepted"),this.emit("referRequestAccepted",this),t.followRefer){this.logger.log("Accepted refer, attempting to automatically follow it");var s=this.referTo.uri;if(!s.scheme.match("^sips?$"))return this.logger.error("SIP.js can only automatically follow SIP refer target"),void this.reject();var n=t.inviteOptions||{},a=(n.extraHeaders||[]).slice();this.replaces&&a.push("Replaces: "+decodeURIComponent(this.replaces)),this.referredBy&&a.push("Referred-By: "+this.referredBy),n.extraHeaders=a,s.clearHeaders(),this.targetSession=this.ua.invite(s,n,i),this.emit("referInviteSent",this),this.targetSession.once("progress",function(e){var t=e.status_code||100,i=e.reason_phrase;r.sendNotify(("SIP/2.0 "+t+" "+i).trim()),r.emit("referProgress",r),r.referredSession&&r.referredSession.emit("referProgress",r)}),this.targetSession.once("accepted",function(){r.logger.log("Successfully followed the refer"),r.sendNotify("SIP/2.0 200 OK"),r.emit("referAccepted",r),r.referredSession&&r.referredSession.emit("referAccepted",r)});var o=function(e){if(this.status!==u.STATUS_TERMINATED){if(this.logger.log("Refer was not successful. Resuming session"),e&&429===e.status_code)return this.logger.log("Alerting referrer that identity is required."),void this.sendNotify("SIP/2.0 429 Provide Referrer Identity");this.sendNotify("SIP/2.0 603 Declined"),this.status=u.STATUS_TERMINATED,this.emit("referRejected",this),this.referredSession&&this.referredSession.emit("referRejected")}};this.targetSession.once("rejected",o.bind(this)),this.targetSession.once("failed",o.bind(this))}else this.logger.log("Accepted refer, but did not automatically follow it"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}},sendNotify:{writable:!0,value:function(t){if(this.status!==u.STATUS_ANSWERED)throw new e.Exceptions.InvalidStateError(this.status);if(-1===e.Grammar.parse(t,"sipfrag"))throw new Error("sipfrag body is required to send notify for refer");var i=new e.OutgoingRequest(e.C.NOTIFY,this.remote_target,this.ua,{cseq:this.cseq+=1,call_id:this.call_id,from_uri:this.from_uri,from_tag:this.from_tag,to_uri:this.to_uri,to_tag:this.to_tag,route_set:this.route_set},["Event: refer","Subscription-State: terminated","Content-Type: message/sipfrag"],t);new e.RequestSender({request:i,onRequestTimeout:function(){},onTransportError:function(){},receiveResponse:function(){}},this.ua).send()}}}),e.ReferServerContext=n}},772:function(e,t,i){"use strict";e.exports=function(e){var t,i={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500};return t=function(i,r,s){var n,a;if(void 0===r)throw new TypeError("Not enough arguments");if(this.logger=i.ua.getLogger("sip.invitecontext.dtmf",i.id),this.owner=i,this.direction=null,s=s||{},n=s.duration||null,a=s.interToneGap||null,"string"==typeof r)r=r.toUpperCase();else{if("number"!=typeof r)throw new TypeError("Invalid tone: "+r);r=r.toString()}if(!r.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+r);if(this.tone=r,n&&!e.Utils.isDecimal(n))throw new TypeError("Invalid tone duration: "+n);if(n?n<t.C.MIN_DURATION?(this.logger.warn('"duration" value is lower than the minimum allowed, setting it to '+t.C.MIN_DURATION+" milliseconds"),n=t.C.MIN_DURATION):n>t.C.MAX_DURATION?(this.logger.warn('"duration" value is greater than the maximum allowed, setting it to '+t.C.MAX_DURATION+" milliseconds"),n=t.C.MAX_DURATION):n=Math.abs(n):n=t.C.DEFAULT_DURATION,this.duration=n,a&&!e.Utils.isDecimal(a))throw new TypeError("Invalid interToneGap: "+a);a?a<t.C.MIN_INTER_TONE_GAP?(this.logger.warn('"interToneGap" value is lower than the minimum allowed, setting it to '+t.C.MIN_INTER_TONE_GAP+" milliseconds"),a=t.C.MIN_INTER_TONE_GAP):a=Math.abs(a):a=t.C.DEFAULT_INTER_TONE_GAP,this.interToneGap=a},t.prototype=Object.create(e.EventEmitter.prototype),t.prototype.send=function(t){var i,r={};if(this.direction="outgoing",this.owner.status!==e.Session.C.STATUS_CONFIRMED&&this.owner.status!==e.Session.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.owner.status);t=t||{},i=t.extraHeaders?t.extraHeaders.slice():[],r.contentType="application/dtmf-relay",r.body="Signal= "+this.tone+"\r\n",r.body+="Duration= "+this.duration,this.request=this.owner.dialog.sendRequest(this,e.C.INFO,{extraHeaders:i,body:r}),this.owner.emit("dtmf",this.request,this)},t.prototype.receiveResponse=function(t){var i;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("succeeded",{originator:"remote",response:t});break;default:i=e.Utils.sipErrorCause(t.status_code),this.emit("failed",t,i)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT),this.owner.onRequestTimeout()},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR),this.owner.onTransportError()},t.prototype.onDialogError=function(t){this.emit("failed",t,e.C.causes.DIALOG_ERROR),this.owner.onDialogError(t)},t.prototype.init_incoming=function(e){this.direction="incoming",this.request=e,e.reply(200),this.tone&&this.duration?this.owner.emit("dtmf",e,this):this.logger.warn("invalid INFO DTMF received, discarded")},t.C=i,t}},773:function(e,t,i){"use strict";e.exports=function(e){e.Subscription=function(t,i,r,s){if(s=Object.create(s||Object.prototype),this.extraHeaders=s.extraHeaders=(s.extraHeaders||[]).slice(),this.id=null,this.state="init",!r)throw new TypeError("Event necessary to create a subscription.");this.event=r,"number"!=typeof s.expires?(t.logger.warn("expires must be a number. Using default of 3600."),this.expires=3600):this.expires=s.expires,this.requestedExpires=this.expires,s.extraHeaders.push("Event: "+this.event),s.extraHeaders.push("Expires: "+this.expires),s.body&&(this.body=s.body),this.contact=t.contact.toString(),s.extraHeaders.push("Contact: "+this.contact),s.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),e.Utils.augment(this,e.ClientContext,[t,e.C.SUBSCRIBE,i,s]),this.logger=t.getLogger("sip.subscription"),this.dialog=null,this.timers={N:null,sub_duration:null},this.errorCodes=[404,405,410,416,480,481,482,483,484,485,489,501,604]},e.Subscription.prototype={subscribe:function(){var t=this;return"active"===this.state?(this.refresh(),this):"notify_wait"===this.state?this:(clearTimeout(this.timers.sub_duration),clearTimeout(this.timers.N),this.timers.N=setTimeout(t.timer_fire.bind(t),e.Timers.TIMER_N),this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]=this,this.send(),this.state="notify_wait",this)},refresh:function(){"terminated"!==this.state&&"pending"!==this.state&&"notify_wait"!==this.state&&this.dialog.sendRequest(this,e.C.SUBSCRIBE,{extraHeaders:this.extraHeaders,body:this.body})},receiveResponse:function(t){var i,r=this,s=e.Utils.getReasonPhrase(t.status_code);"notify_wait"===this.state&&t.status_code>=300||"notify_wait"!==this.state&&-1!==this.errorCodes.indexOf(t.status_code)?this.failed(t,null):/^2[0-9]{2}$/.test(t.status_code)?(this.emit("accepted",t,s),i=t.getHeader("Expires"),i&&i<=this.requestedExpires?(this.expires=i,this.timers.sub_duration=setTimeout(r.refresh.bind(r),900*i)):i?(this.logger.warn("Expires header in a 200-class response to SUBSCRIBE with a higher value than the one in the request"),this.failed(t,e.C.INVALID_EXPIRES_HEADER)):(this.logger.warn("Expires header missing in a 200-class response to SUBSCRIBE"),this.failed(t,e.C.EXPIRES_HEADER_MISSING))):t.statusCode>300&&(this.emit("failed",t,s),this.emit("rejected",t,s))},unsubscribe:function(){var t=[],i=this;this.state="terminated",t.push("Event: "+this.event),t.push("Expires: 0"),t.push("Contact: "+this.contact),t.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.receiveResponse=function(){},this.dialog.sendRequest(this,this.method,{extraHeaders:t,body:this.body}),clearTimeout(this.timers.sub_duration),clearTimeout(this.timers.N),this.timers.N=setTimeout(i.timer_fire.bind(i),e.Timers.TIMER_N),this.emit("terminated")},timer_fire:function(){"terminated"===this.state?(this.terminateDialog(),clearTimeout(this.timers.N),clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]):"notify_wait"===this.state||"pending"===this.state?this.close():this.refresh()},close:function(){"notify_wait"===this.state?(this.state="terminated",clearTimeout(this.timers.N),clearTimeout(this.timers.sub_duration),this.receiveResponse=function(){},delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event],this.emit("terminated")):"terminated"!==this.state&&this.unsubscribe()},createConfirmedDialog:function(t,i){var r;return this.terminateDialog(),r=new e.Dialog(this,t,i),r.invite_seqnum=this.request.cseq,r.local_seqnum=this.request.cseq,!r.error&&(this.dialog=r,!0)},terminateDialog:function(){this.dialog&&(delete this.ua.subscriptions[this.id],this.dialog.terminate(),delete this.dialog)},receiveRequest:function(t){function i(){r.expires&&(clearTimeout(s.timers.sub_duration),r.expires=Math.min(s.expires,Math.max(r.expires,0)),s.timers.sub_duration=setTimeout(s.refresh.bind(s),900*r.expires))}var r,s=this;if(!this.matchEvent(t))return void t.reply(489);if(this.dialog||this.createConfirmedDialog(t,"UAS")&&(this.id=this.dialog.id.toString(),delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event],this.ua.subscriptions[this.id]=this),r=t.parseHeader("Subscription-State"),t.reply(200,e.C.REASON_200),clearTimeout(this.timers.N),this.emit("notify",{request:t}),"terminated"===this.state)return void("terminated"===r.state&&(this.terminateDialog(),clearTimeout(this.timers.N),clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]));switch(r.state){case"active":this.state="active",i();break;case"pending":"notify_wait"===this.state&&i(),this.state="pending";break;case"terminated":if(clearTimeout(this.timers.sub_duration),r.reason)switch(this.logger.log("terminating subscription with reason "+r.reason),r.reason){case"deactivated":case"timeout":return void this.subscribe();case"probation":case"giveup":return void(r.params&&r.params["retry-after"]?this.timers.sub_duration=setTimeout(s.subscribe.bind(s),r.params["retry-after"]):this.subscribe())}this.close()}},failed:function(e,t){return this.close(),this.emit("failed",e,t),this.emit("rejected",e,t),this},onDialogError:function(t){this.failed(t,e.C.causes.DIALOG_ERROR)},matchEvent:function(e){var t;return e.hasHeader("Event")?e.hasHeader("Subscription-State")?(t=e.parseHeader("event").event,this.event===t||(this.logger.warn("event match failed"),e.reply(481,"Event Match Failed"),!1)):(this.logger.warn("missing Subscription-State header"),!1):(this.logger.warn("missing Event header"),!1)}}}},774:function(e,t,i){"use strict";e.exports=function(e){var t;t=function(t,i,r,s){if(this.options=s=s||{},this.options.extraHeaders=(s.extraHeaders||[]).slice(),this.options.contentType=s.contentType||"text/plain","number"!=typeof s.expires||s.expires%1!=0?this.options.expires=3600:this.options.expires=Number(s.expires),"boolean"!=typeof s.unpublishOnClose?this.options.unpublishOnClose=!0:this.options.unpublishOnClose=s.unpublishOnClose,void 0===i||null===i||""===i)throw new e.Exceptions.MethodParameterError("Publish","Target",i);if(this.target=t.normalizeTarget(i),void 0===r||null===r||""===r)throw new e.Exceptions.MethodParameterError("Publish","Event",r);this.event=r,e.ClientContext.call(this,t,e.C.PUBLISH,this.target,this.options),this.logger=this.ua.getLogger("sip.publish"),this.pubRequestBody=null,this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null,this.publish_refresh_timer=null,t.on("transportCreated",function(e){e.on("transportError",this.onTransportError.bind(this))}.bind(this))},t.prototype=Object.create(e.ClientContext.prototype),t.prototype.constructor=t,t.prototype.publish=function(t){if(this.request=null,clearTimeout(this.publish_refresh_timer),void 0!==t&&null!==t&&""!==t)this.options.body=t,this.pubRequestBody=this.options.body,0===this.pubRequestExpires&&(this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]||(this.ua.publishers[this.target.toString()+":"+this.event]=this);else{if(this.pubRequestBody=null,null===this.pubRequestEtag)throw new e.Exceptions.MethodParameterError("Publish","Body",t);if(0===this.pubRequestExpires)throw new e.Exceptions.MethodParameterError("Publish","Expire",this.pubRequestExpires)}this.sendPublishRequest()},t.prototype.unpublish=function(){this.request=null,clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,null!==this.pubRequestEtag&&this.sendPublishRequest()},t.prototype.close=function(){this.options.unpublishOnClose?this.unpublish():(this.request=null,clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]&&delete this.ua.publishers[this.target.toString()+":"+this.event]},t.prototype.sendPublishRequest=function(){var t;t=Object.create(this.options||Object.prototype),t.extraHeaders=(this.options.extraHeaders||[]).slice(),t.extraHeaders.push("Event: "+this.event),t.extraHeaders.push("Expires: "+this.pubRequestExpires),null!==this.pubRequestEtag&&t.extraHeaders.push("SIP-If-Match: "+this.pubRequestEtag),this.request=new e.OutgoingRequest(e.C.PUBLISH,this.target,this.ua,this.options.params,t.extraHeaders),null!==this.pubRequestBody&&(this.request.body={},this.request.body.body=this.pubRequestBody,this.request.body.contentType=this.options.contentType),this.send()},t.prototype.receiveResponse=function(t){var i,r,s=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,s);break;case/^2[0-9]{2}$/.test(t.status_code):t.hasHeader("SIP-ETag")?this.pubRequestEtag=t.getHeader("SIP-ETag"):this.logger.warn("SIP-ETag header missing in a 200-class response to PUBLISH"),t.hasHeader("Expires")?(i=Number(t.getHeader("Expires")),"number"==typeof i&&i>=0&&i<=this.pubRequestExpires?this.pubRequestExpires=i:this.logger.warn("Bad Expires header in a 200-class response to PUBLISH")):this.logger.warn("Expires header missing in a 200-class response to PUBLISH"),0!==this.pubRequestExpires?(this.publish_refresh_timer=setTimeout(this.publish.bind(this),900*this.pubRequestExpires),this.emit("published",t,s)):this.emit("unpublished",t,s);break;case/^412$/.test(t.status_code):null!==this.pubRequestEtag&&0!==this.pubRequestExpires?(this.logger.warn("412 response to PUBLISH, recovering"),this.pubRequestEtag=null,this.emit("progress",t,s),this.publish(this.options.body)):(this.logger.warn("412 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,s),this.emit("unpublished",t,s));break;case/^423$/.test(t.status_code):0!==this.pubRequestExpires&&t.hasHeader("Min-Expires")?(r=Number(t.getHeader("Min-Expires")),"number"==typeof r||r>this.pubRequestExpires?(this.logger.warn("423 code in response to PUBLISH, adjusting the Expires value and trying to recover"),this.pubRequestExpires=r,this.emit("progress",t,s),this.publish(this.options.body)):(this.logger.warn("Bad 423 response Min-Expires header received for PUBLISH"),this.pubRequestExpires=0,this.emit("failed",t,s),this.emit("unpublished",t,s))):(this.logger.warn("423 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,s),this.emit("unpublished",t,s));break;default:this.pubRequestExpires=0,this.emit("failed",t,s),this.emit("unpublished",t,s)}0===this.pubRequestExpires&&(clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestEtag=null)},t.prototype.onRequestTimeout=function(){e.ClientContext.prototype.onRequestTimeout.call(this),this.emit("unpublished",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){e.ClientContext.prototype.onTransportError.call(this),this.emit("unpublished",null,e.C.causes.CONNECTION_ERROR)},e.PublishContext=t}},775:function(e,t,i){"use strict";(function(t){var r=t.window||t;e.exports=function(e){function s(e){if(e instanceof Function)return e.initialize||(e.initialize=function(){return Promise.resolve()}),e}var n,a={STATUS_INIT:0,STATUS_STARTING:1,STATUS_READY:2,STATUS_USER_CLOSED:3,STATUS_NOT_READY:4,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,ALLOWED_METHODS:["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],MAX_FORWARDS:70,TAG_LENGTH:10};n=function(t){function i(e){return r.emit.bind(r,e)}var r=this;a.ACCEPTED_BODY_TYPES=a.ACCEPTED_BODY_TYPES.toString(),this.log=new e.LoggerFactory,this.logger=this.getLogger("sip.ua"),this.cache={credentials:{}},this.configuration={},this.dialogs={},this.applicants={},this.data={},this.sessions={},this.subscriptions={},this.earlySubscriptions={},this.publishers={},this.transport=null,this.contact=null,this.status=a.STATUS_INIT,this.error=null,this.transactions={nist:{},nict:{},ist:{},ict:{}},Object.defineProperties(this,{transactionsCount:{get:function(){var e,t=["nist","nict","ist","ict"],i=0;for(e in t)i+=Object.keys(this.transactions[t[e]]).length;return i}},nictTransactionsCount:{get:function(){return Object.keys(this.transactions.nict).length}},nistTransactionsCount:{get:function(){return Object.keys(this.transactions.nist).length}},ictTransactionsCount:{get:function(){return Object.keys(this.transactions.ict).length}},istTransactionsCount:{get:function(){return Object.keys(this.transactions.ist).length}}}),void 0===t?t={}:("string"==typeof t||t instanceof String)&&(t={uri:t}),t.log&&(t.log.hasOwnProperty("builtinEnabled")&&(this.log.builtinEnabled=t.log.builtinEnabled),t.log.hasOwnProperty("level")&&(this.log.level=t.log.level),t.log.hasOwnProperty("connector")&&(this.log.connector=t.log.connector));try{this.loadConfig(t)}catch(e){throw this.status=a.STATUS_NOT_READY,this.error=a.CONFIGURATION_ERROR,e}this.registerContext=new e.RegisterContext(this,t.registerOptions),this.registerContext.on("failed",i("registrationFailed")),this.registerContext.on("registered",i("registered")),this.registerContext.on("unregistered",i("unregistered")),this.configuration.autostart&&this.start()},n.prototype=Object.create(e.EventEmitter.prototype),n.prototype.register=function(e){return void 0===e&&(e={}),e.register&&(this.configuration.register=!0),this.registerContext.register(e),this},n.prototype.unregister=function(e){this.configuration.register=!1;var t=this.registerContext;return this.transport.afterConnected(t.unregister.bind(t,e)),this},n.prototype.isRegistered=function(){return this.registerContext.registered},n.prototype.invite=function(t,i,r){var s=new e.InviteClientContext(this,t,i,r);return this.transport.afterConnected(function(){s.invite(),this.emit("inviteSent",s)}.bind(this)),s},n.prototype.subscribe=function(t,i,r){var s=new e.Subscription(this,t,i,r);return this.transport.afterConnected(s.subscribe.bind(s)),s},n.prototype.publish=function(t,i,r,s){var n=new e.PublishContext(this,t,i,s);return this.transport.afterConnected(n.publish.bind(n,r)),n},n.prototype.message=function(t,i,r){if(void 0===i)throw new TypeError("Not enough arguments");return r=Object.create(r||Object.prototype),r.contentType||(r.contentType="text/plain"),r.body=i,this.request(e.C.MESSAGE,t,r)},n.prototype.request=function(t,i,r){var s=new e.ClientContext(this,t,i,r);return this.transport.afterConnected(s.send.bind(s)),s},n.prototype.stop=function(){function e(){0===u.nistTransactionsCount&&0===u.nictTransactionsCount&&(u.removeListener("transactionDestroyed",e),u.transport.disconnect())}var i,s,n,o,u=this;if(this.logger.log("user requested closure..."),this.status===a.STATUS_USER_CLOSED)return this.logger.warn("UA already closed"),this;this.logger.log("closing registerContext"),this.registerContext.close();for(i in this.sessions)this.logger.log("closing session "+i),this.sessions[i].terminate();for(s in this.subscriptions)this.logger.log("unsubscribing from subscription "+s),this.subscriptions[s].close();for(s in this.earlySubscriptions)this.logger.log("unsubscribing from early subscription "+s),this.earlySubscriptions[s].close();for(o in this.publishers)this.logger.log("unpublish "+o),this.publishers[o].close();for(n in this.applicants)this.applicants[n].close();return this.status=a.STATUS_USER_CLOSED,0===this.nistTransactionsCount&&0===this.nictTransactionsCount?this.transport.disconnect():this.on("transactionDestroyed",e),"function"==typeof r.removeEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||r.removeEventListener("unload",this.environListener)),this},n.prototype.start=function(){if(this.logger.log("user requested startup..."),this.status===a.STATUS_INIT){if(this.status=a.STATUS_STARTING,!this.configuration.transportConstructor)throw new e.Exceptions.TransportError("Transport constructor not set");this.transport=new this.configuration.transportConstructor(this.getLogger("sip.transport"),this.configuration.transportOptions),this.setTransportListeners(),this.emit("transportCreated",this.transport),this.transport.connect()}else this.status===a.STATUS_USER_CLOSED?(this.logger.log("resuming"),this.status=a.STATUS_READY,this.transport.connect()):this.status===a.STATUS_STARTING?this.logger.log("UA is in STARTING status, not opening new connection"):this.status===a.STATUS_READY?this.logger.log("UA is in READY status, not resuming"):this.logger.error("Connection is down. Auto-Recovery system is trying to connect");return this.configuration.autostop&&"function"==typeof r.addEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||(this.environListener=this.stop.bind(this),r.addEventListener("unload",this.environListener))),this},n.prototype.normalizeTarget=function(t){return e.Utils.normalizeTarget(t,this.configuration.hostportParams)},n.prototype.saveCredentials=function(e){return this.cache.credentials[e.realm]=this.cache.credentials[e.realm]||{},this.cache.credentials[e.realm][e.uri]=e,this},n.prototype.getCredentials=function(e){var t,i;return t=e.ruri.host,this.cache.credentials[t]&&this.cache.credentials[t][e.ruri]&&(i=this.cache.credentials[t][e.ruri],i.method=e.method),i},n.prototype.getLogger=function(e,t){return this.log.getLogger(e,t)},n.prototype.onTransportError=function(){this.status!==a.STATUS_USER_CLOSED&&(this.error&&this.error===a.NETWORK_ERROR||(this.status=a.STATUS_NOT_READY,this.error=a.NETWORK_ERROR))},n.prototype.setTransportListeners=function(){this.transport.on("connected",this.onTransportConnected.bind(this)),this.transport.on("message",this.onTransportReceiveMsg.bind(this)),this.transport.on("transportError",this.onTransportError.bind(this))},n.prototype.onTransportConnected=function(){var e=this;this.configuration.register&&Promise.resolve().then(function(){return e.registerContext.register()})},n.prototype.onTransportReceiveMsg=function(t){var i;if(t=e.Parser.parseMessage(t,this),this.status===e.UA.C.STATUS_USER_CLOSED&&t instanceof e.IncomingRequest)return void this.logger.warn("UA received message when status = USER_CLOSED - aborting");if(e.sanityCheck(t,this,this.transport))if(t instanceof e.IncomingRequest)t.transport=this.transport,this.receiveRequest(t);else if(t instanceof e.IncomingResponse)switch(t.method){case e.C.INVITE:i=this.transactions.ict[t.via_branch],i&&i.receiveResponse(t);break;case e.C.ACK:break;default:i=this.transactions.nict[t.via_branch],i&&i.receiveResponse(t)}},n.prototype.newTransaction=function(e){this.transactions[e.type][e.id]=e,this.emit("newTransaction",{transaction:e})},n.prototype.destroyTransaction=function(e){delete this.transactions[e.type][e.id],this.emit("transactionDestroyed",{transaction:e})},n.prototype.receiveRequest=function(t){function i(e){return e&&e.user===t.ruri.user}var r,s,n,o,u,c,l=t.method,h=this;if(!(i(this.configuration.uri)||i(this.contact.uri)||i(this.contact.pub_gruu)||i(this.contact.temp_gruu)))return this.logger.warn("Request-URI does not point to us"),void(t.method!==e.C.ACK&&t.reply_sl(404));if(t.ruri.scheme===e.C.SIPS)return void t.reply_sl(416);if(!e.Transactions.checkTransaction(this,t))if(l===e.C.OPTIONS?(new e.Transactions.NonInviteServerTransaction(t,this),t.reply(200,null,["Allow: "+e.UA.C.ALLOWED_METHODS.toString(),"Accept: "+a.ACCEPTED_BODY_TYPES])):l===e.C.MESSAGE?(n=new e.ServerContext(this,t),n.body=t.body,n.content_type=t.getHeader("Content-Type")||"text/plain",t.reply(200,null),this.emit("message",n)):l!==e.C.INVITE&&l!==e.C.ACK&&new e.ServerContext(this,t),t.to_tag)r=this.findDialog(t),r?(l===e.C.INVITE&&new e.Transactions.InviteServerTransaction(t,this),r.receiveRequest(t)):l===e.C.NOTIFY?(s=this.findSession(t),o=this.findEarlySubscription(t),s?s.receiveRequest(t):o?o.receiveRequest(t):(this.logger.warn("received NOTIFY request for a non existent session or subscription"),t.reply(481,"Subscription does not exist"))):l!==e.C.ACK&&t.reply(481);else switch(l){case e.C.INVITE:if(u=this.configuration.replaces!==e.C.supported.UNSUPPORTED&&t.parseHeader("replaces")){if(!(c=this.dialogs[u.call_id+u.replaces_to_tag+u.replaces_from_tag]))return void t.reply_sl(481,null);if(c.owner.status===e.Session.C.STATUS_TERMINATED)return void t.reply_sl(603,null);if(c.state===e.Dialog.C.STATUS_CONFIRMED&&u.early_only)return void t.reply_sl(486,null)}s=new e.InviteServerContext(this,t),s.replacee=c&&c.owner,h.emit("invite",s);break;case e.C.BYE:t.reply(481);break;case e.C.CANCEL:s=this.findSession(t),s?s.receiveRequest(t):this.logger.warn("received CANCEL request for a non existent session");break;case e.C.ACK:break;case e.C.NOTIFY:this.configuration.allowLegacyNotifications&&this.listeners("notify").length>0?(t.reply(200,null),h.emit("notify",{request:t})):t.reply(481,"Subscription does not exist");break;case e.C.REFER:if(this.logger.log("Received an out of dialog refer"),this.configuration.allowOutOfDialogRefers){this.logger.log("Allow out of dialog refers is enabled on the UA");var d=new e.ReferServerContext(this,t),p=this.listeners("outOfDialogReferRequested").length;p?this.emit("outOfDialogReferRequested",d):(this.logger.log("No outOfDialogReferRequest listeners, automatically accepting and following the out of dialog refer"),d.accept({followRefer:!0}));break}t.reply(405);break;default:t.reply(405)}},n.prototype.findSession=function(e){return this.sessions[e.call_id+e.from_tag]||this.sessions[e.call_id+e.to_tag]||null},n.prototype.findDialog=function(e){return this.dialogs[e.call_id+e.from_tag+e.to_tag]||this.dialogs[e.call_id+e.to_tag+e.from_tag]||null},n.prototype.findEarlySubscription=function(e){return this.earlySubscriptions[e.call_id+e.to_tag+e.getHeader("event")]||null},n.prototype.loadConfig=function(t){var r,n,a,o,u={viaHost:e.Utils.createRandomToken(12)+".invalid",uri:new e.URI("sip","anonymous."+e.Utils.createRandomToken(6),"anonymous.invalid",null,null),custom:{},displayName:"",password:null,register:!0,registerOptions:{},transportConstructor:i(776)(e),transportOptions:{},userAgentString:e.C.USER_AGENT,noAnswerTimeout:60,hackViaTcp:!1,hackIpInContact:!1,hackWssInTransport:!1,hackAllowUnregisteredOptionTags:!1,sessionDescriptionHandlerFactoryOptions:{constraints:{},peerConnectionOptions:{}},contactName:e.Utils.createRandomToken(8),contactTransport:"ws",forceRport:!1,autostart:!0,autostop:!0,rel100:e.C.supported.UNSUPPORTED,dtmfType:e.C.dtmfType.INFO,replaces:e.C.supported.UNSUPPORTED,sessionDescriptionHandlerFactory:i(777)(e).defaultFactory,authenticationFactory:s(function(t){return new e.DigestAuthentication(t)}),allowLegacyNotifications:!1,allowOutOfDialogRefers:!1},c=this.getConfigurationCheck();for(r in c.mandatory){if(!t.hasOwnProperty(r))throw new e.Exceptions.ConfigurationError(r);if(n=t[r],void 0===(a=c.mandatory[r](n)))throw new e.Exceptions.ConfigurationError(r,n);u[r]=a}for(r in c.optional)if(t.hasOwnProperty(r)){if((n=t[r])instanceof Array&&0===n.length)continue;if(null===n||""===n||void 0===n)continue;if("number"==typeof n&&isNaN(n))continue;if(void 0===(a=c.optional[r](n)))throw new e.Exceptions.ConfigurationError(r,n);u[r]=a}if(0===u.displayName&&(u.displayName="0"),u.sipjsId=e.Utils.createRandomToken(5),o=u.uri.clone(),o.user=null,u.hostportParams=o.toRaw().replace(/^sip:/i,""),u.authorizationUser||(u.authorizationUser=u.uri.user),u.noAnswerTimeout=1e3*u.noAnswerTimeout,u.hackIpInContact)if("boolean"==typeof u.hackIpInContact){var l=Math.floor(254*Math.random()+1);u.viaHost="192.0.2."+l}else"string"==typeof u.hackIpInContact&&(u.viaHost=u.hackIpInContact);u.hackWssInTransport&&(u.contactTransport="wss"),this.contact={pub_gruu:null,temp_gruu:null,uri:new e.URI("sip",u.contactName,u.viaHost,null,{transport:u.contactTransport}),toString:function(e){e=e||{};var t=e.anonymous||null,i=e.outbound||null,r="<";return r+=t?(this.temp_gruu||"sip:anonymous@anonymous.invalid;transport="+u.contactTransport).toString():(this.pub_gruu||this.uri).toString(),i&&(r+=";ob"),r+=">"}};var h={};for(r in u)h[r]=u[r];Object.assign(this.configuration,h),this.logger.log("configuration parameters after validation:");for(r in u)switch(r){case"uri":case"sessionDescriptionHandlerFactory":this.logger.log(" "+r+": "+u[r]);break;case"password":this.logger.log(" "+r+": NOT SHOWN");break;case"transportConstructor":this.logger.log(" "+r+": "+u[r].name);break;default:this.logger.log(" "+r+": "+JSON.stringify(u[r]))}},n.prototype.getConfigurationCheck=function(){return{mandatory:{},optional:{uri:function(t){var i;return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),i=e.URI.parse(t),i&&i.user?i:void 0},transportConstructor:function(e){if(e instanceof Function)return e},transportOptions:function(e){if("object"==typeof e)return e},authorizationUser:function(t){return-1===e.Grammar.parse('"'+t+'"',"quoted_string")?void 0:t},displayName:function(t){return-1===e.Grammar.parse('"'+t+'"',"displayName")?void 0:t},dtmfType:function(t){switch(t){case e.C.dtmfType.RTP:return e.C.dtmfType.RTP;case e.C.dtmfType.INFO:default:return e.C.dtmfType.INFO}},hackViaTcp:function(e){if("boolean"==typeof e)return e},hackIpInContact:function(t){return"boolean"==typeof t?t:"string"==typeof t&&-1!==e.Grammar.parse(t,"host")?t:void 0},hackWssInTransport:function(e){if("boolean"==typeof e)return e},hackAllowUnregisteredOptionTags:function(e){if("boolean"==typeof e)return e},contactTransport:function(e){if("string"==typeof e)return e},forceRport:function(e){if("boolean"==typeof e)return e},noAnswerTimeout:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},password:function(e){return String(e)},rel100:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},replaces:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},register:function(e){if("boolean"==typeof e)return e},registerOptions:function(e){if("object"==typeof e)return e},userAgentString:function(e){if("string"==typeof e)return e},autostart:function(e){if("boolean"==typeof e)return e},autostop:function(e){if("boolean"==typeof e)return e},sessionDescriptionHandlerFactory:function(e){if(e instanceof Function)return e},sessionDescriptionHandlerFactoryOptions:function(e){if("object"==typeof e)return e},authenticationFactory:s,allowLegacyNotifications:function(e){if("boolean"==typeof e)return e},custom:function(e){if("object"==typeof e)return e},contactName:function(e){if("string"==typeof e)return e}}}},n.C=a,e.UA=n}}).call(t,i(19))},776:function(e,t,i){"use strict";(function(t){e.exports=function(e){function i(e){var t=.8*e;return 1e3*(Math.random()*(e-t)+t)}var r,s={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},n=(t.window||t).WebSocket;return r=function(e,t){t=t||{},this.logger=e,this.ws=null,this.server=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.connectionTimeout=null,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.boundOnError=null,this.reconnectionAttempts=0,this.reconnectTimer=null,this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null,this.status=s.STATUS_CONNECTING,this.configuration={},this.loadConfig(t)},r.prototype=Object.create(e.Transport.prototype,{isConnected:{writable:!0,value:function(){return this.status===s.STATUS_OPEN}},sendPromise:{writable:!0,value:function(e,t){if(t=t||{},!this.statusAssert(s.STATUS_OPEN,t.force))return this.onError("unable to send message - WebSocket not open"),Promise.reject();var i=e.toString();return this.ws?(!0===this.configuration.traceSip&&this.logger.log("sending WebSocket message:\n\n"+i+"\n"),this.ws.send(i),Promise.resolve({msg:i})):(this.onError("unable to send message - WebSocket does not exist"),Promise.reject())}},disconnectPromise:{writable:!0,value:function(e){var t=this;return this.disconnectionPromise?this.disconnectionPromise:(e=e||{},e.code=e.code||1e3,this.statusTransition(s.STATUS_CLOSING,e.force)?(this.emit("disconnecting"),this.disconnectionPromise=new Promise(function(i,r){t.disconnectDeferredResolve=i,t.reconnectTimer&&(clearTimeout(t.reconnectTimer),t.reconnectTimer=null),t.ws?(t.stopSendingKeepAlives(),t.logger.log("closing WebSocket "+t.server.ws_uri),t.ws.close(e.code,e.reason)):r("Attempted to disconnect but the websocket doesn't exist")}),this.disconnectionPromise):this.status===s.STATUS_CLOSED?Promise.resolve({overrideEvent:!0}):this.connectionPromise?this.connectionPromise.then(function(){return Promise.reject("The websocket did not disconnect")}).catch(function(){return Promise.resolve({overrideEvent:!0})}):Promise.reject("The websocket did not disconnect"))}},connectPromise:{writable:!0,value:function(e){return e=e||{},this.status!==s.STATUS_CLOSING||e.force?this.connectionPromise?this.connectionPromise:(this.server=this.server||this.getNextWsServer(e.force),this.connectionPromise=new Promise(function(t,i){var r=this;if((this.status===s.STATUS_OPEN||this.status===s.STATUS_CLOSING)&&!e.force)return this.logger.warn("WebSocket "+this.server.ws_uri+" is already connected"),void i("Failed status check - attempted to open a connection but already open/closing");this.connectDeferredResolve=t,this.status=s.STATUS_CONNECTING,this.emit("connecting"),this.logger.log("connecting to WebSocket "+this.server.ws_uri),this.disposeWs();try{this.ws=new n(this.server.ws_uri,"sip")}catch(e){return this.ws=null,this.status=s.STATUS_CLOSED,this.onError("error connecting to WebSocket "+this.server.ws_uri+":"+e),void i("Failed to create a websocket")}if(!this.ws)return void i("Unexpected instance websocket not set");this.connectionTimeout=setTimeout(function(){r.statusTransition(s.STATUS_CLOSED),r.logger.warn("took too long to connect - exceeded time set in configuration.connectionTimeout: "+r.configuration.connectionTimeout+"s"),r.emit("disconnected",{code:1e3}),r.connectionPromise=null,i("Connection timeout")},1e3*this.configuration.connectionTimeout),this.boundOnOpen=this.onOpen.bind(this),this.boundOnMessage=this.onMessage.bind(this),this.boundOnClose=this.onClose.bind(this),this.boundOnError=this.onWebsocketError.bind(this),this.ws.addEventListener("open",this.boundOnOpen),this.ws.addEventListener("message",this.boundOnMessage),this.ws.addEventListener("close",this.boundOnClose),this.ws.addEventListener("error",this.boundOnError)}.bind(this)),this.connectionPromise):Promise.reject("WebSocket "+this.server.ws_uri+" is closing")}},onOpen:{writable:!0,value:function(){if(this.status===s.STATUS_CLOSED){var e=this.ws;return this.disposeWs(),void e.close(1e3)}this.status=s.STATUS_OPEN,this.emit("connected"),clearTimeout(this.connectionTimeout),this.logger.log("WebSocket "+this.server.ws_uri+" connected"),null!==this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnectionAttempts=0,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.startSendingKeepAlives(),this.connectDeferredResolve?this.connectDeferredResolve({overrideEvent:!0}):this.logger.warn("Unexpected websocket.onOpen with no connectDeferredResolve")}},onClose:{writable:!0,value:function(e){if(this.logger.log("WebSocket disconnected (code: "+e.code+(e.reason?"| reason: "+e.reason:"")+")"),this.status!==s.STATUS_CLOSING&&(this.logger.warn("WebSocket closed without SIP.js requesting it"),this.emit("transportError")),this.stopSendingKeepAlives(),clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.disconnectDeferredResolve)return this.disconnectDeferredResolve({overrideEvent:!0}),this.statusTransition(s.STATUS_CLOSED),void(this.disconnectDeferredResolve=null);this.status=s.STATUS_CLOSED,this.emit("disconnected",{code:e.code,reason:e.reason}),this.reconnect()}},disposeWs:{writable:!0,value:function(){this.ws&&(this.ws.removeEventListener("open",this.boundOnOpen),this.ws.removeEventListener("message",this.boundOnMessage),this.ws.removeEventListener("close",this.boundOnClose),this.ws.removeEventListener("error",this.boundOnError),this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.boundOnError=null,this.ws=null)}},onMessage:{writable:!0,value:function(e){var t=e.data;if(/^(\r\n)+$/.test(t))return this.clearKeepAliveTimeout(),void(!0===this.configuration.traceSip&&this.logger.log("received WebSocket message with CRLF Keep Alive response"));if(!t)return void this.logger.warn("received empty message, message discarded");if("string"!=typeof t){try{t=String.fromCharCode.apply(null,new Uint8Array(t))}catch(e){return void this.logger.warn("received WebSocket binary message failed to be converted into string, message discarded")}!0===this.configuration.traceSip&&this.logger.log("received WebSocket binary message:\n\n"+t+"\n")}else!0===this.configuration.traceSip&&this.logger.log("received WebSocket text message:\n\n"+t+"\n");this.emit("message",t)}},onError:{writable:!0,value:function(e){this.logger.warn("Transport error: "+e),this.emit("transportError")}},onWebsocketError:{writable:!1,value:function(){this.onError("The Websocket had an error")}},reconnect:{writable:!0,value:function(){if(this.reconnectionAttempts>0&&this.logger.log("Reconnection attempt "+this.reconnectionAttempts+" failed"),this.noAvailableServers())return this.logger.warn("no available ws servers left - going to closed state"),this.status=s.STATUS_CLOSED,this.emit("closed"),void this.resetServerErrorStatus();this.isConnected()&&(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),this.disconnect({force:!0})),this.reconnectionAttempts+=1,this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.ws_uri),this.logger.log("transport "+this.server.ws_uri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,this.reconnect()):(this.logger.log("trying to reconnect to WebSocket "+this.server.ws_uri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=setTimeout(function(){this.connect(),this.reconnectTimer=null}.bind(this),1===this.reconnectionAttempts?0:1e3*this.configuration.reconnectionTimeout))}},resetServerErrorStatus:{writable:!0,value:function(){var e,t=this.configuration.wsServers.length;for(e=0;e<t;e++)this.configuration.wsServers[e].isError=!1}},getNextWsServer:{writable:!0,value:function(e){if(this.noAvailableServers())return void this.logger.warn("attempted to get next ws server but there are no available ws servers left");var t,i,r,s=[];for(i=this.configuration.wsServers.length,t=0;t<i;t++)r=this.configuration.wsServers[t],r.isError&&!e||(0===s.length?s.push(r):r.weight>s[0].weight?s=[r]:r.weight===s[0].weight&&s.push(r));return t=Math.floor(Math.random()*s.length),s[t]}},noAvailableServers:{writable:!0,value:function(){var e;for(e in this.configuration.wsServers)if(!this.configuration.wsServers[e].isError)return!1;return!0}},sendKeepAlive:{writable:!0,value:function(){if(!this.keepAliveDebounceTimeout)return this.keepAliveDebounceTimeout=setTimeout(function(){this.emit("keepAliveDebounceTimeout"),this.clearKeepAliveTimeout()}.bind(this),1e3*this.configuration.keepAliveDebounce),this.send("\r\n\r\n")}},clearKeepAliveTimeout:{writable:!0,value:function(){clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveDebounceTimeout=null}},startSendingKeepAlives:{writable:!0,value:function(){this.configuration.keepAliveInterval&&!this.keepAliveInterval&&(this.keepAliveInterval=setInterval(function(){this.sendKeepAlive(),this.startSendingKeepAlives()}.bind(this),i(this.configuration.keepAliveInterval)))}},stopSendingKeepAlives:{writable:!0,value:function(){clearInterval(this.keepAliveInterval),clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null}},statusAssert:{writable:!0,value:function(e,t){return e===this.status||(t?(this.logger.warn("Attempted to assert "+Object.keys(s)[this.status]+" as "+Object.keys(s)[e]+"- continuing with option: 'force'"),!0):(this.logger.warn("Tried to assert "+Object.keys(s)[e]+" but is currently "+Object.keys(s)[this.status]),!1))}},statusTransition:{writable:!0,value:function(e,t){return this.logger.log("Attempting to transition status from "+Object.keys(s)[this.status]+" to "+Object.keys(s)[e]),e===s.STATUS_CONNECTING&&this.statusAssert(s.STATUS_CLOSED,t)||e===s.STATUS_OPEN&&this.statusAssert(s.STATUS_CONNECTING,t)||e===s.STATUS_CLOSING&&this.statusAssert(s.STATUS_OPEN,t)||e===s.STATUS_CLOSED?(this.status=e,!0):(this.logger.warn("Status transition failed - result: no-op - reason: either gave an nonexistent status or attempted illegal transition"),!1)}},loadConfig:{writable:!0,value:function(t){var i,r,s,n={wsServers:[{scheme:"WSS",sip_uri:"<sip:edge.sip.onsip.com;transport=ws;lr>",weight:0,ws_uri:"wss://edge.sip.onsip.com",isError:!1}],connectionTimeout:5,maxReconnectionAttempts:3,reconnectionTimeout:4,keepAliveInterval:0,keepAliveDebounce:10,traceSip:!1},a=this.getConfigurationCheck();for(i in a.mandatory){if(!t.hasOwnProperty(i))throw new e.Exceptions.ConfigurationError(i);if(r=t[i],void 0===(s=a.mandatory[i](r)))throw new e.Exceptions.ConfigurationError(i,r);n[i]=s}for(i in a.optional)if(t.hasOwnProperty(i)){if((r=t[i])instanceof Array&&0===r.length)continue;if(null===r||""===r||void 0===r)continue;if("number"==typeof r&&isNaN(r))continue;if(void 0===(s=a.optional[i](r)))throw new e.Exceptions.ConfigurationError(i,r);n[i]=s}var o={};for(i in n)o[i]={value:n[i]};Object.defineProperties(this.configuration,o),this.logger.log("configuration parameters after validation:");for(i in n)this.logger.log(" "+i+": "+JSON.stringify(n[i]))}},getConfigurationCheck:{writable:!0,value:function(){return{mandatory:{},optional:{wsServers:function(t){var i,r,s;if("string"==typeof t)t=[{ws_uri:t}];else{if(!(t instanceof Array))return;for(r=t.length,i=0;i<r;i++)"string"==typeof t[i]&&(t[i]={ws_uri:t[i]})}if(0===t.length)return!1;for(r=t.length,i=0;i<r;i++){if(!t[i].ws_uri)return;if(t[i].weight&&!Number(t[i].weight))return;if(-1===(s=e.Grammar.parse(t[i].ws_uri,"absoluteURI")))return;if(["wss","ws","udp"].indexOf(s.scheme)<0)return;t[i].sip_uri="<sip:"+s.host+(s.port?":"+s.port:"")+";transport="+s.scheme.replace(/^wss$/i,"ws")+";lr>",t[i].weight||(t[i].weight=0),t[i].isError=!1,t[i].scheme=s.scheme.toUpperCase()}return t},keepAliveInterval:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},keepAliveDebounce:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},traceSip:function(e){if("boolean"==typeof e)return e},connectionTimeout:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i},maxReconnectionAttempts:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>=0)return i},reconnectionTimeout:function(t){var i;if(e.Utils.isDecimal(t)&&(i=Number(t))>0)return i}}}}}}),r.C=s,e.Web.Transport=r,r}}).call(t,i(19))},777:function(e,t,i){"use strict";(function(t){e.exports=function(e){var r=function(e,i,r){this.options=r||{},this.logger=e,this.observer=i,this.dtmfSender=null,this.shouldAcquireMedia=!0,this.CONTENT_TYPE="application/sdp",this.C={},this.C.DIRECTION={NULL:null,SENDRECV:"sendrecv",SENDONLY:"sendonly",RECVONLY:"recvonly",INACTIVE:"inactive"},this.logger.log("SessionDescriptionHandlerOptions: "+JSON.stringify(this.options)),this.direction=this.C.DIRECTION.NULL,this.modifiers=this.options.modifiers||[],Array.isArray(this.modifiers)||(this.modifiers=[this.modifiers]);var s=t.window||t;this.WebRTC={MediaStream:s.MediaStream,getUserMedia:s.navigator.mediaDevices.getUserMedia.bind(s.navigator.mediaDevices),RTCPeerConnection:s.RTCPeerConnection},this.iceGatheringDeferred=null,this.iceGatheringTimeout=!1,this.iceGatheringTimer=null,this.initPeerConnection(this.options.peerConnectionOptions),this.constraints=this.checkAndDefaultConstraints(this.options.constraints)};return r.defaultFactory=function(e,t){var s=e.ua.getLogger("sip.invitecontext.sessionDescriptionHandler",e.id),n=i(778),a=new n(e,t);return new r(s,a,t)},r.prototype=Object.create(e.SessionDescriptionHandler.prototype,{close:{writable:!0,value:function(){this.logger.log("closing PeerConnection"),this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders?this.peerConnection.getSenders().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getLocalStreams which is deprecated"),this.peerConnection.getLocalStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.peerConnection.getReceivers?this.peerConnection.getReceivers().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getRemoteStreams which is deprecated"),this.peerConnection.getRemoteStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.resetIceGatheringComplete(),this.peerConnection.close())}},getDescription:{writable:!0,value:function(e,t){var i=this;e=e||{},e.peerConnectionOptions&&this.initPeerConnection(e.peerConnectionOptions);var r=Object.assign({},this.constraints,e.constraints);return r=this.checkAndDefaultConstraints(r),JSON.stringify(r)!==JSON.stringify(this.constraints)&&(this.constraints=r,this.shouldAcquireMedia=!0),t=t||[],Array.isArray(t)||(t=[t]),t=t.concat(this.modifiers),Promise.resolve().then(function(){if(i.shouldAcquireMedia)return i.acquire(i.constraints).then(function(){i.shouldAcquireMedia=!1})}).then(function(){return i.createOfferOrAnswer(e.RTCOfferOptions,t)}).then(function(e){return i.emit("getDescription",e),{body:e.sdp,contentType:i.CONTENT_TYPE}})}},hasDescription:{writable:!0,value:function(e){return e===this.CONTENT_TYPE}},holdModifier:{writable:!0,value:function(e){return/a=(sendrecv|sendonly|recvonly|inactive)/.test(e.sdp)?(e.sdp=e.sdp.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"),e.sdp=e.sdp.replace(/a=recvonly\r\n/g,"a=inactive\r\n")):e.sdp=e.sdp.replace(/(m=[^\r]*\r\n)/g,"$1a=sendonly\r\n"),Promise.resolve(e)}},setDescription:{writable:!0,value:function(t,i,r){var s=this;i=i||{},i.peerConnectionOptions&&this.initPeerConnection(i.peerConnectionOptions),r=r||[],Array.isArray(r)||(r=[r]),r=r.concat(this.modifiers);var n={type:this.hasOffer("local")?"answer":"offer",sdp:t};return Promise.resolve().then(function(){if(s.shouldAcquireMedia&&s.options.alwaysAcquireMediaFirst)return s.acquire(s.constraints).then(function(){s.shouldAcquireMedia=!1})}).then(function(){return e.Utils.reducePromises(r,n)}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("setDescription",t,"The modifiers did not resolve successfully");throw s.logger.error(i.message),s.emit("peerConnection-setRemoteDescriptionFailed",i),i}).then(function(e){return s.emit("setDescription",e),s.peerConnection.setRemoteDescription(e)}).catch(function(n){if(n instanceof e.Exceptions.SessionDescriptionHandlerError)throw n;if(/^m=video.+$/gm.test(t)&&!i.disableAudioFallback)return i.disableAudioFallback=!0,s.setDescription(t,i,[e.Web.Modifiers.stripVideo].concat(r));var a=new e.Exceptions.SessionDescriptionHandlerError("setDescription",n);throw s.logger.error(a.error),s.emit("peerConnection-setRemoteDescriptionFailed",a),a}).then(function(){s.peerConnection.getReceivers?s.emit("setRemoteDescription",s.peerConnection.getReceivers()):s.emit("setRemoteDescription",s.peerConnection.getRemoteStreams()),s.emit("confirmed",s)})}},sendDtmf:{writable:!0,value:function(e,t){if(!this.dtmfSender&&this.hasBrowserGetSenderSupport()){var i=this.peerConnection.getSenders();i.length>0&&(this.dtmfSender=i[0].dtmf)}if(!this.dtmfSender&&this.hasBrowserTrackSupport()){var r=this.peerConnection.getLocalStreams();if(r.length>0){var s=r[0].getAudioTracks();s.length>0&&(this.dtmfSender=this.peerConnection.createDTMFSender(s[0]))}}if(!this.dtmfSender)return!1;try{this.dtmfSender.insertDTMF(e,t.duration,t.interToneGap)}catch(e){if("InvalidStateError"===e.type||"InvalidCharacterError"===e.type)return this.logger.error(e),!1;throw e}return this.logger.log("DTMF sent via RTP: "+e.toString()),!0}},getDirection:{writable:!0,value:function(){return this.direction}},createOfferOrAnswer:{writable:!0,value:function(t,i){var r,s=this,n=this.peerConnection;return t=t||{},r=this.hasOffer("remote")?"createAnswer":"createOffer",this.logger.log(r),n[r](t).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t,"peerConnection-"+r+"Failed");throw s.emit("peerConnection-"+r+"Failed",i),i}).then(function(t){return e.Utils.reducePromises(i,s.createRTCSessionDescriptionInit(t))}).then(function(e){return s.resetIceGatheringComplete(),s.logger.log("Setting local sdp."),s.logger.log(e.sdp),n.setLocalDescription(e)}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t,"peerConnection-SetLocalDescriptionFailed");throw s.emit("peerConnection-SetLocalDescriptionFailed",i),i}).then(function(){return s.waitForIceGatheringComplete()}).then(function(){var t=s.createRTCSessionDescriptionInit(s.peerConnection.localDescription);return e.Utils.reducePromises(i,t)}).then(function(e){return s.setDirection(e.sdp),e}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t);throw s.logger.error(i),i})}},createRTCSessionDescriptionInit:{writable:!0,value:function(e){return{type:e.type,sdp:e.sdp}}},addDefaultIceCheckingTimeout:{writable:!0,value:function(e){return void 0===e.iceCheckingTimeout&&(e.iceCheckingTimeout=5e3),e}},addDefaultIceServers:{writable:!0,value:function(e){return e.iceServers||(e.iceServers=[{urls:"stun:stun.l.google.com:19302"}]),e}},checkAndDefaultConstraints:{writable:!0,value:function(e){var t={audio:!0,video:!this.options.alwaysAcquireMediaFirst};return e=e||t,0===Object.keys(e).length&&e.constructor===Object?t:e}},hasBrowserTrackSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.addTrack)}},hasBrowserGetSenderSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.getSenders)}},initPeerConnection:{writable:!0,value:function(e){var t=this;e=e||{},e=this.addDefaultIceCheckingTimeout(e),e.rtcConfiguration=e.rtcConfiguration||{},e.rtcConfiguration=this.addDefaultIceServers(e.rtcConfiguration),this.logger.log("initPeerConnection"),this.peerConnection&&(this.logger.log("Already have a peer connection for this session. Tearing down."),this.resetIceGatheringComplete(),this.peerConnection.close()),this.peerConnection=new this.WebRTC.RTCPeerConnection(e.rtcConfiguration),this.logger.log("New peer connection created"),"ontrack"in this.peerConnection?this.peerConnection.addEventListener("track",function(e){t.logger.log("track added"),t.observer.trackAdded(),t.emit("addTrack",e)}):(this.logger.warn("Using onaddstream which is deprecated"),this.peerConnection.onaddstream=function(e){t.logger.log("stream added"),t.emit("addStream",e)}),this.peerConnection.onicecandidate=function(e){t.emit("iceCandidate",e),e.candidate?t.logger.log("ICE candidate received: "+(null===e.candidate.candidate?null:e.candidate.candidate.trim())):null===e.candidate&&(t.logger.log("ICE candidate gathering complete"),t.triggerIceGatheringComplete())},this.peerConnection.onicegatheringstatechange=function(){switch(t.logger.log("RTCIceGatheringState changed: "+this.iceGatheringState),this.iceGatheringState){case"gathering":t.emit("iceGathering",this),!t.iceGatheringTimer&&e.iceCheckingTimeout&&(t.iceGatheringTimeout=!1,t.iceGatheringTimer=setTimeout(function(){t.logger.log("RTCIceChecking Timeout Triggered after "+e.iceCheckingTimeout+" milliseconds"),t.iceGatheringTimeout=!0,t.triggerIceGatheringComplete()},e.iceCheckingTimeout));break;case"complete":t.triggerIceGatheringComplete()}},this.peerConnection.oniceconnectionstatechange=function(){var e;switch(this.iceConnectionState){case"new":e="iceConnection";break;case"checking":e="iceConnectionChecking";break;case"connected":e="iceConnectionConnected";break;case"completed":e="iceConnectionCompleted";break;case"failed":e="iceConnectionFailed";break;case"disconnected":e="iceConnectionDisconnected";break;case"closed":e="iceConnectionClosed";break;default:return void t.logger.warn("Unknown iceConnection state:",this.iceConnectionState)}t.logger.log("ICE Connection State changed to "+e),t.emit(e,this)}}},acquire:{writable:!0,value:function(t){var i=this;return t=this.checkAndDefaultConstraints(t),new Promise(function(e,r){i.logger.log("acquiring local media"),i.emit("userMediaRequest",t),t.audio||t.video?i.WebRTC.getUserMedia(t).then(function(t){i.observer.trackAdded(),i.emit("userMedia",t),e(t)}).catch(function(e){i.emit("userMediaFailed",e),r(e)}):e([])}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"unable to acquire streams");throw i.logger.error(r.message),i.logger.error(r.error),r}).then(function(e){i.logger.log("acquired local media streams");try{return i.peerConnection.removeTrack&&i.peerConnection.getSenders().forEach(function(e){i.peerConnection.removeTrack(e)}),e}catch(e){return Promise.reject(e)}}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"error removing streams");throw i.logger.error(r.message),i.logger.error(r.error),r}).then(function(e){try{e=[].concat(e),e.forEach(function(e){i.peerConnection.addTrack?e.getTracks().forEach(function(t){i.peerConnection.addTrack(t,e)}):i.peerConnection.addStream(e)})}catch(e){return Promise.reject(e)}return Promise.resolve()}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var r=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"error adding stream");throw i.logger.error(r.message),i.logger.error(r.error),r})}},hasOffer:{writable:!0,value:function(e){var t="have-"+e+"-offer";return this.peerConnection.signalingState===t}},isIceGatheringComplete:{writable:!0,value:function(){return"complete"===this.peerConnection.iceGatheringState||this.iceGatheringTimeout}},resetIceGatheringComplete:{writable:!0,value:function(){this.iceGatheringTimeout=!1,this.logger.log("resetIceGatheringComplete"),this.iceGatheringTimer&&(clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.reject(),this.iceGatheringDeferred=null)}},setDirection:{writable:!0,value:function(e){var t=e.match(/a=(sendrecv|sendonly|recvonly|inactive)/);if(null===t)return this.direction=this.C.DIRECTION.NULL,void this.observer.directionChanged();var i=t[1];switch(i){case this.C.DIRECTION.SENDRECV:case this.C.DIRECTION.SENDONLY:case this.C.DIRECTION.RECVONLY:case this.C.DIRECTION.INACTIVE:this.direction=i;break;default:this.direction=this.C.DIRECTION.NULL}this.observer.directionChanged()}},triggerIceGatheringComplete:{writable:!0,value:function(){this.isIceGatheringComplete()&&(this.emit("iceGatheringComplete",this),this.iceGatheringTimer&&(clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.resolve(),this.iceGatheringDeferred=null))}},waitForIceGatheringComplete:{writable:!0,value:function(){return this.logger.log("waitForIceGatheringComplete"),this.isIceGatheringComplete()?(this.logger.log("ICE is already complete. Return resolved."),Promise.resolve()):(this.isIceGatheringDeferred||(this.iceGatheringDeferred=e.Utils.defer()),this.logger.log("ICE is not complete. Returning promise"),this.iceGatheringDeferred.promise)}}}),r}}).call(t,i(19))},778:function(e,t,i){"use strict";var r=function(e,t){this.session=e||{},this.options=t||{}};r.prototype={trackAdded:function(){this.session.emit("trackAdded")},directionChanged:function(){this.session.emit("directionChanged")}},e.exports=r},779:function(e,t,i){"use strict";e.exports=function(e){function t(t,i,r){var s,n=e.Utils.buildStatusLine(t),a=i.getHeaders("via"),o=a.length,u=0;for(u;u<o;u++)n+="Via: "+a[u]+"\r\n";s=i.getHeader("To"),i.to_tag||(s+=";tag="+e.Utils.newTag()),n+="To: "+s+"\r\n",n+="From: "+i.getHeader("From")+"\r\n",n+="Call-ID: "+i.call_id+"\r\n",n+="CSeq: "+i.cseq+" "+i.method+"\r\n",n+="\r\n",r.send(n)}function i(e,i,r){if(!e.ruri||"sip"!==e.ruri.scheme)return t(416,e,r),!1}function r(e,i,r){if(!e.to_tag&&e.call_id.substr(0,5)===i.configuration.sipjsId)return t(482,e,r),!1}function s(i,r,s){if(e.Utils.str_utf8_length(i.body)<i.getHeader("content-length"))return t(400,i,s),!1}function n(i,r,s){var n,a,o=i.from_tag,u=i.call_id,c=i.cseq;if(!i.to_tag)if(i.method===e.C.INVITE){if(n=r.transactions.ist[i.via_branch])return;for(a in r.transactions.ist)if(n=r.transactions.ist[a],n.request.from_tag===o&&n.request.call_id===u&&n.request.cseq===c)return t(482,i,s),!1}else{if(n=r.transactions.nist[i.via_branch])return;for(a in r.transactions.nist)if(n=r.transactions.nist[a],n.request.from_tag===o&&n.request.call_id===u&&n.request.cseq===c)return t(482,i,s),!1}}function a(e,t){if(e.getHeaders("via").length>1)return t.getLogger("sip.sanitycheck").warn("More than one Via header field present in the response. Dropping the response"),!1}function o(e,t){var i=t.configuration.viaHost;if(e.via.host!==i||void 0!==e.via.port)return t.getLogger("sip.sanitycheck").warn("Via sent-by in the response does not match UA Via host value. Dropping the response"),!1}function u(t,i){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return i.getLogger("sip.sanitycheck").warn("Message body length is lower than the value in Content-Length header field. Dropping the response"),!1}function c(e,t){for(var i=["from","to","call_id","cseq","via"],r=i.length;r--;)if(!e.hasHeader(i[r]))return t.getLogger("sip.sanitycheck").warn("Missing mandatory header field : "+i[r]+". Dropping the response"),!1}var l,h=[],d=[],p=[];h.push(i),h.push(r),h.push(s),h.push(n),d.push(a),d.push(o),d.push(u),p.push(c),l=function(t,i,r){var s;for(s=p.length;s--;)if(!1===p[s](t,i,r))return!1;if(t instanceof e.IncomingRequest){for(s=h.length;s--;)if(!1===h[s](t,i,r))return!1}else if(t instanceof e.IncomingResponse)for(s=d.length;s--;)if(!1===d[s](t,i,r))return!1;return!0},e.sanityCheck=l}},780:function(e,t,i){"use strict";var r=i(196);e.exports=function(e){var t;return t=function(e){this.logger=e.getLogger("sipjs.digestauthentication"),this.username=e.configuration.authorizationUser,this.password=e.configuration.password,this.cnonce=null,this.nc=0,this.ncHex="00000000",this.response=null},t.prototype.authenticate=function(t,i){if(this.algorithm=i.algorithm,this.realm=i.realm,this.nonce=i.nonce,this.opaque=i.opaque,this.stale=i.stale,this.algorithm){if("MD5"!==this.algorithm)return this.logger.warn('challenge with Digest algorithm different than "MD5", authentication aborted'),!1}else this.algorithm="MD5";if(!this.realm)return this.logger.warn("challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return this.logger.warn("challenge without Digest nonce, authentication aborted"),!1;if(i.qop)if(i.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(i.qop.indexOf("auth-int")>-1))return this.logger.warn('challenge without Digest qop different than "auth" or "auth-int", authentication aborted'),!1;this.qop="auth-int"}else this.qop=null;return this.method=t.method,this.uri=t.ruri,this.cnonce=e.createRandomToken(12),this.nc+=1,this.updateNcHex(),4294967296===this.nc&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(),!0},t.prototype.calculateResponse=function(){var e,t;e=r(this.username+":"+this.realm+":"+this.password),"auth"===this.qop?(t=r(this.method+":"+this.uri),this.response=r(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+t)):"auth-int"===this.qop?(t=r(this.method+":"+this.uri+":"+r(this.body?this.body:"")),this.response=r(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+t)):null===this.qop&&(t=r(this.method+":"+this.uri),this.response=r(e+":"+this.nonce+":"+t))},t.prototype.toString=function(){var e=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return e.push("algorithm="+this.algorithm),e.push('username="'+this.username+'"'),e.push('realm="'+this.realm+'"'),e.push('nonce="'+this.nonce+'"'),e.push('uri="'+this.uri+'"'),e.push('response="'+this.response+'"'),this.opaque&&e.push('opaque="'+this.opaque+'"'),this.qop&&(e.push("qop="+this.qop),e.push('cnonce="'+this.cnonce+'"'),e.push("nc="+this.ncHex)),"Digest "+e.join(", ")},t.prototype.updateNcHex=function(){var e=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-e.length)+e},t}},781:function(e,t,i){"use strict";var r=i(782);e.exports=function(e){return{parse:function(t,i){var s={startRule:i,SIP:e};try{r.parse(t,s)}catch(e){s.data=-1}return s.data}}}},782:function(e,t,i){var r,s,n;!function(i,a){s=[],r=a,void 0!==(n="function"==typeof r?r.apply(t,s):r)&&(e.exports=n)}(0,function(){"use strict";function e(t,i,r,s){this.message=t,this.expected=i,this.found=r,this.location=s,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function t(t,i){function r(){return t.substring(S,C)}function s(){return c(S,C)}function n(e,t){return{type:"literal",text:e,ignoreCase:t}}function a(e,t,i){return{type:"class",parts:e,inverted:t,ignoreCase:i}}function o(e){return{type:"other",description:e}}function u(e){var i,r=y[e];if(r)return r;for(i=e-1;!y[i];)i--;for(r=y[i],r={line:r.line,column:r.column};i<e;)10===t.charCodeAt(i)?(r.line++,r.column=1):r.column++,i++;return y[e]=r,r}function c(e,t){var i=u(e),r=u(t);return{start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:r.line,column:r.column}}}function l(e){C<A||(C>A&&(A=C,R=[]),R.push(e))}function h(t,i,r){return new e(e.buildMessage(t,i),t,i,r)}function d(e){var t,i=new Array(e.length);for(t=0;t<e.length;t++)i[t]=e.charCodeAt(t)-32;return i}function p(e){for(var i,r,s=E[e],n=0,a=[],o=s.length,u=[],c=[];;){for(;n<o;)switch(s[n]){case 0:c.push(_[s[n+1]]),n+=2;break;case 1:c.push(void 0),n++;break;case 2:c.push(null),n++;break;case 3:c.push(m),n++;break;case 4:c.push([]),n++;break;case 5:c.push(C),n++;break;case 6:c.pop(),n++;break;case 7:C=c.pop(),n++;break;case 8:c.length-=s[n+1],n+=2;break;case 9:c.splice(-2,1),n++;break;case 10:c[c.length-2].push(c.pop()),n++;break;case 11:c.push(c.splice(c.length-s[n+1],s[n+1])),n+=2;break;case 12:c.push(t.substring(c.pop(),C)),n++;break;case 13:u.push(o),a.push(n+3+s[n+1]+s[n+2]),c[c.length-1]?(o=n+3+s[n+1],n+=3):(o=n+3+s[n+1]+s[n+2],n+=3+s[n+1]);break;case 14:u.push(o),a.push(n+3+s[n+1]+s[n+2]),c[c.length-1]===m?(o=n+3+s[n+1],n+=3):(o=n+3+s[n+1]+s[n+2],n+=3+s[n+1]);break;case 15:u.push(o),a.push(n+3+s[n+1]+s[n+2]),c[c.length-1]!==m?(o=n+3+s[n+1],n+=3):(o=n+3+s[n+1]+s[n+2],n+=3+s[n+1]);break;case 16:c[c.length-1]!==m?(u.push(o),a.push(n),o=n+2+s[n+1],n+=2):n+=2+s[n+1];break;case 17:u.push(o),a.push(n+3+s[n+1]+s[n+2]),t.length>C?(o=n+3+s[n+1],n+=3):(o=n+3+s[n+1]+s[n+2],n+=3+s[n+1]);break;case 18:u.push(o),a.push(n+4+s[n+2]+s[n+3]),t.substr(C,_[s[n+1]].length)===_[s[n+1]]?(o=n+4+s[n+2],n+=4):(o=n+4+s[n+2]+s[n+3],n+=4+s[n+2]);break;case 19:u.push(o),a.push(n+4+s[n+2]+s[n+3]),t.substr(C,_[s[n+1]].length).toLowerCase()===_[s[n+1]]?(o=n+4+s[n+2],n+=4):(o=n+4+s[n+2]+s[n+3],n+=4+s[n+2]);break;case 20:u.push(o),a.push(n+4+s[n+2]+s[n+3]),_[s[n+1]].test(t.charAt(C))?(o=n+4+s[n+2],n+=4):(o=n+4+s[n+2]+s[n+3],n+=4+s[n+2]);break;case 21:c.push(t.substr(C,s[n+1])),C+=s[n+1],n+=2;break;case 22:c.push(_[s[n+1]]),C+=_[s[n+1]].length,n+=2;break;case 23:c.push(m),0===b&&l(_[s[n+1]]),n+=2;break;case 24:S=c[c.length-1-s[n+1]],n+=2;break;case 25:S=C,n++;break;case 26:for(i=s.slice(n+4,n+4+s[n+3]),r=0;r<s[n+3];r++)i[r]=c[c.length-1-i[r]];c.splice(c.length-s[n+2],s[n+2],_[s[n+1]].apply(null,i)),n+=4+s[n+3];break;case 27:c.push(p(s[n+1])),n+=2;break;case 28:b++,n++;break;case 29:b--,n++;break;default:throw new Error("Invalid opcode: "+s[n]+".")}if(!(u.length>0))break;o=u.pop(),n=a.pop()}return c[0]}function f(e,t){return[e].concat(t)}i=void 0!==i?i:{};var g,m={},v={Contact:120,Name_Addr_Header:157,Record_Route:177,Request_Response:82,SIP_URI:45,Subscription_State:187,Supported:192,Require:183,Via:195,absoluteURI:85,Call_ID:119,Content_Disposition:131,Content_Length:136,Content_Type:137,CSeq:147,displayName:123,Event:150,From:152,host:53,Max_Forwards:155,Min_SE:214,Proxy_Authenticate:158,quoted_string:40,Refer_To:179,Replaces:180,Session_Expires:211,stun_URI:218,To:193,turn_URI:224,uuid:227,WWW_Authenticate:210,challenge:159,sipfrag:231,Referred_By:232},T=120,_=["\r\n",n("\r\n",!1),/^[0-9]/,a([["0","9"]],!1,!1),/^[a-zA-Z]/,a([["a","z"],["A","Z"]],!1,!1),/^[0-9a-fA-F]/,a([["0","9"],["a","f"],["A","F"]],!1,!1),/^[\0-\xFF]/,a([["\0",""]],!1,!1),/^["]/,a(['"'],!1,!1)," ",n(" ",!1),"\t",n("\t",!1),/^[a-zA-Z0-9]/,a([["a","z"],["A","Z"],["0","9"]],!1,!1),";",n(";",!1),"/",n("/",!1),"?",n("?",!1),":",n(":",!1),"@",n("@",!1),"&",n("&",!1),"=",n("=",!1),"+",n("+",!1),"$",n("$",!1),",",n(",",!1),"-",n("-",!1),"_",n("_",!1),".",n(".",!1),"!",n("!",!1),"~",n("~",!1),"*",n("*",!1),"'",n("'",!1),"(",n("(",!1),")",n(")",!1),"%",n("%",!1),function(){return" "},function(){return":"},/^[!-~]/,a([["!","~"]],!1,!1),/^[\x80-\uFFFF]/,a([["",""]],!1,!1),/^[\x80-\xBF]/,a([["",""]],!1,!1),/^[a-f]/,a([["a","f"]],!1,!1),"`",n("`",!1),"<",n("<",!1),">",n(">",!1),"\\",n("\\",!1),"[",n("[",!1),"]",n("]",!1),"{",n("{",!1),"}",n("}",!1),function(){return"*"},function(){return"/"},function(){return"="},function(){return"("},function(){return")"},function(){return">"},function(){return"<"},function(){return","},function(){return";"},function(){return":"},function(){return'"'},/^[!-']/,a([["!","'"]],!1,!1),/^[*-[]/,a([["*","["]],!1,!1),/^[\]-~]/,a([["]","~"]],!1,!1),function(e){return e},/^[#-[]/,a([["#","["]],!1,!1),/^[\0-\t]/,a([["\0","\t"]],!1,!1),/^[\x0B-\f]/,a([["\v","\f"]],!1,!1),/^[\x0E-\x7F]/,a([["",""]],!1,!1),function(){i.data.uri=new i.SIP.URI(i.data.scheme,i.data.user,i.data.host,i.data.port),delete i.data.scheme,delete i.data.user,delete i.data.host,delete i.data.host_type,delete i.data.port},function(){i.data.uri=new i.SIP.URI(i.data.scheme,i.data.user,i.data.host,i.data.port,i.data.uri_params,i.data.uri_headers),delete i.data.scheme,delete i.data.user,delete i.data.host,delete i.data.host_type,delete i.data.port,delete i.data.uri_params,"SIP_URI"===i.startRule&&(i.data=i.data.uri)},function(){i.data.user=decodeURIComponent(r())},"sips",n("sips",!0),"sip",n("sip",!0),"tel",n("tel",!0),function(e){i.data.scheme=e},function(){i.data.user=decodeURIComponent(r().slice(0,-1))},function(){i.data.password=r()},function(){return i.data.host=r(),i.data.host},function(){return i.data.host_type="domain",r()},/^[a-zA-Z0-9_\-]/,a([["a","z"],["A","Z"],["0","9"],"_","-"],!1,!1),/^[a-zA-Z0-9\-]/,a([["a","z"],["A","Z"],["0","9"],"-"],!1,!1),function(){return i.data.host_type="IPv6",r()},"::",n("::",!1),function(){return i.data.host_type="IPv6",r()},function(){return i.data.host_type="IPv4",r()},"25",n("25",!1),/^[0-5]/,a([["0","5"]],!1,!1),"2",n("2",!1),/^[0-4]/,a([["0","4"]],!1,!1),"1",n("1",!1),/^[1-9]/,a([["1","9"]],!1,!1),function(e){return e=parseInt(e.join("")),i.data.port=e,e},"transport=",n("transport=",!0),"udp",n("udp",!0),"tcp",n("tcp",!0),"sctp",n("sctp",!0),"tls",n("tls",!0),function(e){i.data.uri_params||(i.data.uri_params={}),i.data.uri_params.transport=e.toLowerCase()},"user=",n("user=",!0),"phone",n("phone",!0),"ip",n("ip",!0),function(e){i.data.uri_params||(i.data.uri_params={}),i.data.uri_params.user=e.toLowerCase()},"method=",n("method=",!0),function(e){i.data.uri_params||(i.data.uri_params={}),i.data.uri_params.method=e},"ttl=",n("ttl=",!0),function(e){i.data.params||(i.data.params={}),i.data.params.ttl=e},"maddr=",n("maddr=",!0),function(e){i.data.uri_params||(i.data.uri_params={}),i.data.uri_params.maddr=e},"lr",n("lr",!0),function(){i.data.uri_params||(i.data.uri_params={}),i.data.uri_params.lr=void 0},function(e,t){i.data.uri_params||(i.data.uri_params={}),t=null===t?void 0:t[1],i.data.uri_params[e.toLowerCase()]=t},function(e,t){e=e.join("").toLowerCase(),t=t.join(""),i.data.uri_headers||(i.data.uri_headers={}),i.data.uri_headers[e]?i.data.uri_headers[e].push(t):i.data.uri_headers[e]=[t]},function(){"Refer_To"===i.startRule&&(i.data.uri=new i.SIP.URI(i.data.scheme,i.data.user,i.data.host,i.data.port,i.data.uri_params,i.data.uri_headers),delete i.data.scheme,delete i.data.user,delete i.data.host,delete i.data.host_type,delete i.data.port,delete i.data.uri_params)},"//",n("//",!1),function(){i.data.scheme=r()},n("SIP",!0),function(){i.data.sip_version=r()},"INVITE",n("INVITE",!1),"ACK",n("ACK",!1),"VXACH",n("VXACH",!1),"OPTIONS",n("OPTIONS",!1),"BYE",n("BYE",!1),"CANCEL",n("CANCEL",!1),"REGISTER",n("REGISTER",!1),"SUBSCRIBE",n("SUBSCRIBE",!1),"NOTIFY",n("NOTIFY",!1),"REFER",n("REFER",!1),"PUBLISH",n("PUBLISH",!1),function(){return i.data.method=r(),i.data.method},function(e){i.data.status_code=parseInt(e.join(""))},function(){i.data.reason_phrase=r()},function(){i.data=r()},function(){var e,t;for(t=i.data.multi_header.length,e=0;e<t;e++)if(null===i.data.multi_header[e].parsed){i.data=null;break}null!==i.data?i.data=i.data.multi_header:i.data=-1},function(){var e;i.data.multi_header||(i.data.multi_header=[]);try{e=new i.SIP.NameAddrHeader(i.data.uri,i.data.displayName,i.data.params),delete i.data.uri,delete i.data.displayName,delete i.data.params}catch(t){e=null}i.data.multi_header.push({position:C,offset:s().start.offset,parsed:e})},function(e){e=r().trim(),'"'===e[0]&&(e=e.substring(1,e.length-1)),i.data.displayName=e},"q",n("q",!0),function(e){i.data.params||(i.data.params={}),i.data.params.q=e},"expires",n("expires",!0),function(e){i.data.params||(i.data.params={}),i.data.params.expires=e},function(e){return parseInt(e.join(""))},"0",n("0",!1),function(){return parseFloat(r())},function(e,t){i.data.params||(i.data.params={}),t=null===t?void 0:t[1],i.data.params[e.toLowerCase()]=t},"render",n("render",!0),"session",n("session",!0),"icon",n("icon",!0),"alert",n("alert",!0),function(){"Content_Disposition"===i.startRule&&(i.data.type=r().toLowerCase())},"handling",n("handling",!0),"optional",n("optional",!0),"required",n("required",!0),function(e){i.data=parseInt(e.join(""))},function(){i.data=r()},"text",n("text",!0),"image",n("image",!0),"audio",n("audio",!0),"video",n("video",!0),"application",n("application",!0),"message",n("message",!0),"multipart",n("multipart",!0),"x-",n("x-",!0),function(e){i.data.value=parseInt(e.join(""))},function(e){i.data=e},function(e){i.data.event=e.toLowerCase()},function(){var e=i.data.tag;i.data=new i.SIP.NameAddrHeader(i.data.uri,i.data.displayName,i.data.params),e&&i.data.setParam("tag",e)},"tag",n("tag",!0),function(e){i.data.tag=e},function(e){i.data=parseInt(e.join(""))},function(e){i.data=e},function(){i.data=new i.SIP.NameAddrHeader(i.data.uri,i.data.displayName,i.data.params)},"digest",n("Digest",!0),"realm",n("realm",!0),function(e){i.data.realm=e},"domain",n("domain",!0),"nonce",n("nonce",!0),function(e){i.data.nonce=e},"opaque",n("opaque",!0),function(e){i.data.opaque=e},"stale",n("stale",!0),"true",n("true",!0),function(){i.data.stale=!0},"false",n("false",!0),function(){i.data.stale=!1},"algorithm",n("algorithm",!0),"md5",n("MD5",!0),"md5-sess",n("MD5-sess",!0),function(e){i.data.algorithm=e.toUpperCase()},"qop",n("qop",!0),"auth-int",n("auth-int",!0),"auth",n("auth",!0),function(e){i.data.qop||(i.data.qop=[]),i.data.qop.push(e.toLowerCase())},function(e){i.data.value=parseInt(e.join(""))},function(){var e,t;for(t=i.data.multi_header.length,e=0;e<t;e++)if(null===i.data.multi_header[e].parsed){i.data=null;break}null!==i.data?i.data=i.data.multi_header:i.data=-1},function(){var e;i.data.multi_header||(i.data.multi_header=[]);try{e=new i.SIP.NameAddrHeader(i.data.uri,i.data.displayName,i.data.params),delete i.data.uri,delete i.data.displayName,delete i.data.params}catch(t){e=null}i.data.multi_header.push({position:C,offset:s().start.offset,parsed:e})},function(){i.data=new i.SIP.NameAddrHeader(i.data.uri,i.data.displayName,i.data.params)},function(){i.data.replaces_from_tag&&i.data.replaces_to_tag||(i.data=-1)},function(){i.data={call_id:i.data}},"from-tag",n("from-tag",!0),function(e){i.data.replaces_from_tag=e},"to-tag",n("to-tag",!0),function(e){i.data.replaces_to_tag=e},"early-only",n("early-only",!0),function(){i.data.early_only=!0},function(e,t){return t},function(e,t){return f(e,t)},function(e){"Require"===i.startRule&&(i.data=e||[])},function(e){i.data.value=parseInt(e.join(""))},"active",n("active",!0),"pending",n("pending",!0),"terminated",n("terminated",!0),function(){i.data.state=r()},"reason",n("reason",!0),function(e){void 0!==e&&(i.data.reason=e)},function(e){void 0!==e&&(i.data.expires=e)},"retry_after",n("retry_after",!0),function(e){void 0!==e&&(i.data.retry_after=e)},"deactivated",n("deactivated",!0),"probation",n("probation",!0),"rejected",n("rejected",!0),"timeout",n("timeout",!0),"giveup",n("giveup",!0),"noresource",n("noresource",!0),"invariant",n("invariant",!0),function(e){"Supported"===i.startRule&&(i.data=e||[])},function(){var e=i.data.tag;i.data=new i.SIP.NameAddrHeader(i.data.uri,i.data.displayName,i.data.params),e&&i.data.setParam("tag",e)},"ttl",n("ttl",!0),function(e){i.data.ttl=e},"maddr",n("maddr",!0),function(e){i.data.maddr=e},"received",n("received",!0),function(e){i.data.received=e},"branch",n("branch",!0),function(e){i.data.branch=e},"rport",n("rport",!0),function(){"undefined"!=typeof response_port&&(i.data.rport=response_port.join(""))},function(e){i.data.protocol=e},n("UDP",!0),n("TCP",!0),n("TLS",!0),n("SCTP",!0),function(e){i.data.transport=e},function(){i.data.host=r()},function(e){i.data.port=parseInt(e.join(""))},function(e){return parseInt(e.join(""))},function(e){"Session_Expires"===i.startRule&&(i.data.deltaSeconds=e)},"refresher",n("refresher",!1),"uas",n("uas",!1),"uac",n("uac",!1),function(e){"Session_Expires"===i.startRule&&(i.data.refresher=e)},function(e){"Min_SE"===i.startRule&&(i.data=e)},"stuns",n("stuns",!0),"stun",n("stun",!0),function(e){i.data.scheme=e},function(e){i.data.host=e},"?transport=",n("?transport=",!1),"turns",n("turns",!0),"turn",n("turn",!0),function(){i.data.transport=transport},function(){i.data=r()},"Referred-By",n("Referred-By",!1),"b",n("b",!1),"cid",n("cid",!1)],E=[d('2 ""6 7!'),d('4"""5!7#'),d('4$""5!7%'),d('4&""5!7\''),d(";'.# &;("),d('4(""5!7)'),d('4*""5!7+'),d('2,""6,7-'),d('2.""6.7/'),d('40""5!71'),d('22""6273. &24""6475.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),d(";).# &;,"),d('2F""6F7G.} &2H""6H7I.q &2J""6J7K.e &2L""6L7M.Y &2N""6N7O.M &2P""6P7Q.A &2R""6R7S.5 &2T""6T7U.) &2V""6V7W'),d('%%2X""6X7Y/5#;#/,$;#/#$+#)(#\'#("\'#&\'#/"!&,)'),d('%%$;$0#*;$&/,#; /#$+")("\'#&\'#." &"/=#$;$/&#0#*;$&&&#/\'$8":Z" )("\'#&\'#'),d(';.." &"'),d("%$;'.# &;(0)*;'.# &;(&/?#28\"\"6879/0$;//'$8#:[# )(#'#(\"'#&'#"),d('%%$;2/&#0#*;2&&&#/g#$%$;.0#*;.&/,#;2/#$+")("\'#&\'#0=*%$;.0#*;.&/,#;2/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),d('4\\""5!7].# &;3'),d('4^""5!7_'),d('4`""5!7a'),d(';!.) &4b""5!7c'),d('%$;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),d('%$;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),d('2T""6T7U. &2V""6V7W. &2f""6f7g. &2h""6h7i. &2:""6:7;. &2D""6D7E. &22""6273. &28""6879. &2j""6j7k. &;&.} &24""6475.q &2l""6l7m.e &2n""6n7o.Y &26""6677.M &2>""6>7?.A &2p""6p7q.5 &2r""6r7s.) &;\'.# &;('),d('%$;). &2F""6F7G. &2J""6J7K. &2L""6L7M. &2X""6X7Y. &2P""6P7Q. &2H""6H7I. &2@""6@7A. &2d""6d7e. &2R""6R7S. &2N""6N7O. &2T""6T7U. &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s/#0*;). &2F""6F7G. &2J""6J7K. &2L""6L7M. &2X""6X7Y. &2P""6P7Q. &2H""6H7I. &2@""6@7A. &2d""6d7e. &2R""6R7S. &2N""6N7O. &2T""6T7U. &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s&&&#/"!&,)'),d("%;//?#2P\"\"6P7Q/0$;//'$8#:t# )(#'#(\"'#&'#"),d("%;//?#24\"\"6475/0$;//'$8#:u# )(#'#(\"'#&'#"),d("%;//?#2>\"\"6>7?/0$;//'$8#:v# )(#'#(\"'#&'#"),d("%;//?#2T\"\"6T7U/0$;//'$8#:w# )(#'#(\"'#&'#"),d("%;//?#2V\"\"6V7W/0$;//'$8#:x# )(#'#(\"'#&'#"),d('%2h""6h7i/0#;//\'$8":y" )("\'#&\'#'),d('%;//6#2f""6f7g/\'$8":z" )("\'#&\'#'),d("%;//?#2D\"\"6D7E/0$;//'$8#:{# )(#'#(\"'#&'#"),d("%;//?#22\"\"6273/0$;//'$8#:|# )(#'#(\"'#&'#"),d("%;//?#28\"\"6879/0$;//'$8#:}# )(#'#(\"'#&'#"),d("%;//0#;&/'$8\":~\" )(\"'#&'#"),d("%;&/0#;//'$8\":~\" )(\"'#&'#"),d("%;=/T#$;G.) &;K.# &;F0/*;G.) &;K.# &;F&/,$;>/#$+#)(#'#(\"'#&'#"),d('4""5!7.A &4""5!7.5 &4""5!7.) &;3.# &;.'),d("%%;//Q#;&/H$$;J.# &;K0)*;J.# &;K&/,$;&/#$+$)($'#(#'#(\"'#&'#/\"!&,)"),d("%;//]#;&/T$%$;J.# &;K0)*;J.# &;K&/\"!&,)/1$;&/($8$:$!!)($'#(#'#(\"'#&'#"),d(';..G &2L""6L7M.; &4""5!7./ &4""5!7.# &;3'),d('%2j""6j7k/J#4""5!7.5 &4""5!7.) &4""5!7/#$+")("\'#&\'#'),d("%;O/S#28\"\"6879/D$;P.# &;N.\" &\"/0$;T/'$8$:$ )($'#(#'#(\"'#&'#"),d('%;O/t#28""6879/e$;P.# &;N." &"/Q$;T." &"/C$;`." &"/5$;m." &"/\'$8&:& )(&\'#(%\'#($\'#(#\'#("\'#&\'#'),d('%2@""6@7A/7#$;!0#*;!&/\'$8":" )("\'#&\'#'),d('%3""5$7.5 &3""5#7.) &3""5#7/\' 8!:!! )'),d('%;Q/]#%28""6879/,#;S/#$+")("\'#&\'#." &"/6$2:""6:7;/\'$8#:# )(#\'#("\'#&\'#'),d("$;+.) &;-.# &;R/2#0/*;+.) &;-.# &;R&&&#"),d('2<""6<7=.q &2>""6>7?.e &2@""6@7A.Y &2B""6B7C.M &2D""6D7E.A &22""6273.5 &26""6677.) &24""6475'),d('%$;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E0e*;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E&/& 8!:! )'),d('%;U/J#%28""6879/,#;_/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),d("%;V.) &;].# &;Y/& 8!:! )"),d('%$%;W/2#2J""6J7K/#$+")("\'#&\'#0<*%;W/2#2J""6J7K/#$+")("\'#&\'#&/D#;X/;$2J""6J7K." &"/\'$8#:# )(#\'#("\'#&\'#'),d('$4""5!7/,#0)*4""5!7&&&#'),d('%4$""5!7%/?#$4""5!70)*4""5!7&/#$+")("\'#&\'#'),d('%2l""6l7m/?#;Z/6$2n""6n7o/\'$8#:# )(#\'#("\'#&\'#'),d('%%;[/#28""6879/$;[/$28""6879/$;[/$28""6879/t$;[/k$28""6879/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+-)(-\'#(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%2""67/#;[/$28""6879/$;[/$28""6879/t$;[/k$28""6879/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+,)(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%2""67/#;[/$28""6879/t$;[/k$28""6879/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%2""67/t#;[/k$28""6879/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%2""67/\\#;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+&)(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%2""67/D#;[/;$28""6879/,$;\\/#$+$)($\'#(#\'#("\'#&\'#. &%2""67/,#;\\/#$+")("\'#&\'#. &%2""67/,#;[/#$+")("\'#&\'#. &%;[/#2""67/$;[/$28""6879/t$;[/k$28""6879/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$++)(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%;[/#%28""6879/,#;[/#$+")("\'#&\'#." &"/$2""67/t$;[/k$28""6879/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%;[/#%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/k$2""67/\\$;[/S$28""6879/D$;[/;$28""6879/,$;\\/#$+))()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%;[/#%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/z$%28""6879/,#;[/#$+")("\'#&\'#." &"/S$2""67/D$;[/;$28""6879/,$;\\/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%;[/#%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/b$%28""6879/,#;[/#$+")("\'#&\'#." &"/;$2""67/,$;\\/#$+\')(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%;[/#%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/b$%28""6879/,#;[/#$+")("\'#&\'#." &"/;$2""67/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#. &%;[/#%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/$%28""6879/,#;[/#$+")("\'#&\'#." &"/Y$%28""6879/,#;[/#$+")("\'#&\'#." &"/2$2""67/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#/& 8!:! )'),d('%;#/M#;#." &"/?$;#." &"/1$;#." &"/#$+$)($\'#(#\'#("\'#&\'#'),d("%;[/;#28\"\"6879/,$;[/#$+#)(#'#(\"'#&'#.# &;]"),d("%;^/o#2J\"\"6J7K/`$;^/W$2J\"\"6J7K/H$;^/?$2J\"\"6J7K/0$;^/'$8':' )(''#(&'#(%'#($'#(#'#(\"'#&'#"),d('%2""67/2#4""5!7/#$+")("\'#&\'#. &%2""67/;#4""5!7/,$;!/#$+#)(#\'#("\'#&\'#.j &%2""67/5#;!/,$;!/#$+#)(#\'#("\'#&\'#.B &%4""5!7/,#;!/#$+")("\'#&\'#.# &;!'),d('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:!! )'),d('$%22""6273/,#;a/#$+")("\'#&\'#0<*%22""6273/,#;a/#$+")("\'#&\'#&'),d(";b.A &;c.; &;d.5 &;e./ &;f.) &;g.# &;h"),d('%3""5*7/a#3""5#7.G &3""5#7.; &3""5$7./ &3""5#7.# &;6/($8":"! )("\'#&\'#'),d('%3""5%7/I#3""5%7./ &3""5"7.# &;6/($8":"! )("\'#&\'#'),d('%3""5\'7/1#;/($8":"! )("\'#&\'#'),d('%3""5$7/1#;/($8":"! )("\'#&\'#'),d('%3""5&7/1#;U/($8":"! )("\'#&\'#'),d('%3""5"7/N#%2>""6>7?/,#;6/#$+")("\'#&\'#." &"/\'$8":" )("\'#&\'#'),d('%;i/P#%2>""6>7?/,#;j/#$+")("\'#&\'#." &"/)$8":""! )("\'#&\'#'),d('%$;k/&#0#*;k&&&#/"!&,)'),d('%$;k/&#0#*;k&&&#/"!&,)'),d(";l.) &;+.# &;-"),d('2l""6l7m.e &2n""6n7o.Y &24""6475.M &28""6879.A &2<""6<7=.5 &2@""6@7A.) &2B""6B7C'),d('%26""6677/n#;n/e$$%2<""6<7=/,#;n/#$+")("\'#&\'#0<*%2<""6<7=/,#;n/#$+")("\'#&\'#&/#$+#)(#\'#("\'#&\'#'),d('%;o/A#2>""6>7?/2$;p/)$8#:#"" )(#\'#("\'#&\'#'),d("$;q.) &;+.# &;-/2#0/*;q.) &;+.# &;-&&&#"),d("$;q.) &;+.# &;-0/*;q.) &;+.# &;-&"),d('2l""6l7m.e &2n""6n7o.Y &24""6475.M &26""6677.A &28""6879.5 &2@""6@7A.) &2B""6B7C'),d(";.# &;s"),d("%;/G#;'/>$;t/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),d(";M.# &;u"),d("%;/E#28\"\"6879/6$;v.# &;y/'$8#:# )(#'#(\"'#&'#"),d('%;w.# &;x/J#%26""6677/,#;/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),d('%2""67/:#;/1$;x." &"/#$+#)(#\'#("\'#&\'#'),d('%24""6475/,#;|/#$+")("\'#&\'#'),d("%;{/3#$;z0#*;z&/#$+\")(\"'#&'#"),d(";*.) &;+.# &;-"),d(';+. &;-. &22""6273.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),d('%;}/e#$%24""6475/,#;}/#$+")("\'#&\'#0<*%24""6475/,#;}/#$+")("\'#&\'#&/#$+")("\'#&\'#'),d('%$;0#*;&/e#$%22""6273/,#;~/#$+")("\'#&\'#0<*%22""6273/,#;~/#$+")("\'#&\'#&/#$+")("\'#&\'#'),d("$;0#*;&"),d(';+.w &;-.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),d('%%;"/#$;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K0M*;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K&/#$+")("\'#&\'#/& 8!:! )'),d(";.# &;"),d('%%;P/2#2:""6:7;/#$+")("\'#&\'#." &"/,#;T/#$+")("\'#&\'#." &"'),d('$;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A/#0*;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A&&&#'),d("$;z0#*;z&"),d('%3""5#7/q#24""6475/b$$;!/&#0#*;!&&&#/L$2J""6J7K/=$$;!/&#0#*;!&&&#/\'$8%:% )(%\'#($\'#(#\'#("\'#&\'#'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d('2""67'),d("%;.Y &;.S &;.M &;.G &;.A &;.; &;.5 &;./ &;.) &;.# &;6/& 8!:! )"),d("%;/G#;'/>$;/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),d("%;/' 8!:!! )"),d("%;!/5#;!/,$;!/#$+#)(#'#(\"'#&'#"),d("%$;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(0G*;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(&/& 8!:! )"),d("%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d('%;9/N#%2:""6:7;/,#;9/#$+")("\'#&\'#." &"/\'$8":" )("\'#&\'#'),d("%;:.c &%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#/& 8!:! )"),d("%;L.# &;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":\" )(\"'#&'#"),d("%;.\" &\"/>#;@/5$;M/,$;?/#$+$)($'#(#'#(\"'#&'#"),d("%%;6/Y#$%;./,#;6/#$+\")(\"'#&'#06*%;./,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#.# &;H/' 8!:!! )"),d(";.) &;.# &;"),d("%3\"\"5!7/:#;</1$;/($8#:#! )(#'#(\"'#&'#"),d("%3\"\"5'7/:#;</1$;/($8#:#! )(#'#(\"'#&'#"),d("%$;!/&#0#*;!&&&#/' 8!:!! )"),d('%2""67/o#%2J""6J7K/M#;!." &"/?$;!." &"/1$;!." &"/#$+$)($\'#(#\'#("\'#&\'#." &"/\'$8":" )("\'#&\'#'),d('%;6/J#%;</,#;/#$+")("\'#&\'#." &"/)$8":""! )("\'#&\'#'),d(";6.) &;U.# &;H"),d("%;/Y#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d('%3""5&7.G &3""5\'7.; &3""5$7./ &3""5%7.# &;6/& 8!:! )'),d(";.# &;"),d('%3""5(7/M#;</D$3""5(7./ &3""5(7.# &;6/#$+#)(#\'#("\'#&\'#'),d("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d("%$;!/&#0#*;!&&&#/' 8!:!! )"),d("%;/& 8!:! )"),d("%;/k#;;/b$;/Y$$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),d(";.# &;"),d('3""5$7.S &3""5%7.G &3""5%7.; &3""5%7./ &3""5+7.# &;'),d('3""5\'7./ &3""5)7.# &;'),d(";6.# &;"),d('%3""5"7/,#;6/#$+")("\'#&\'#'),d(";.# &;6"),d("%;6/5#;</,$;/#$+#)(#'#(\"'#&'#"),d(";6.# &;H"),d("%;/5#;./,$;/#$+#)(#'#(\"'#&'#"),d("%$;!/&#0#*;!&&&#/' 8!:!! )"),d("%;/' 8!:!! )"),d('%;/^#$%;B/,#;/#$+")("\'#&\'#06*%;B/,#;/#$+")("\'#&\'#&/($8":"!!)("\'#&\'#'),d('%%;7/e#$%2J""6J7K/,#;7/#$+")("\'#&\'#0<*%2J""6J7K/,#;7/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),d("%;L.# &;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":\" )(\"'#&'#"),d(";.# &;"),d("%3\"\"5#7/:#;</1$;6/($8#:#! )(#'#(\"'#&'#"),d("%$;!/&#0#*;!&&&#/' 8!:!! )"),d("%;/' 8!:!! )"),d("%$;0#*;&/x#;@/o$;M/f$;?/]$$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8%:% )(%'#($'#(#'#(\"'#&'#"),d(";"),d("%3\"\"5&7/k#;./b$;/Y$$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#.# &;"),d("%;6/k#;./b$;/Y$$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),d("%;6/;#;</2$;6.# &;H/#$+#)(#'#(\"'#&'#"),d(";.G &;.A &;.; &;.5 &;./ &;.) &;.# &;"),d("%3\"\"5%7/5#;</,$;/#$+#)(#'#(\"'#&'#"),d("%;I/' 8!:!! )"),d("%3\"\"5&7/#;</$;D/$;/|$$%$;'/&#0#*;'&&&#/,#;/#$+\")(\"'#&'#0C*%$;'/&#0#*;'&&&#/,#;/#$+\")(\"'#&'#&/,$;E/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),d(";u.# &;x"),d("%3\"\"5%7/5#;</,$;/#$+#)(#'#(\"'#&'#"),d("%;I/' 8!:!! )"),d("%3\"\"5&7/:#;</1$;I/($8#:#! )(#'#(\"'#&'#"),d('%3""5%7/]#;</T$%3""5$7/& 8!:! ).4 &%3""5%7/& 8!:! )/#$+#)(#\'#("\'#&\'#'),d('%3""5)7/R#;</I$3""5#7./ &3""5(7.# &;6/($8#:#! )(#\'#("\'#&\'#'),d('%3""5#7/#;</$;D/$%;/e#$%2D""6D7E/,#;/#$+")("\'#&\'#0<*%2D""6D7E/,#;/#$+")("\'#&\'#&/#$+")("\'#&\'#/,$;E/#$+%)(%\'#($\'#(#\'#("\'#&\'#'),d('%3""5(7./ &3""5$7.# &;6/\' 8!:!! )'),d("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d("%;/G#;./>$;/5$;./,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),d("%$;!/&#0#*;!&&&#/' 8!:!! )"),d("%;/]#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/'$8\":\" )(\"'#&'#"),d("%;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":\" )(\"'#&'#"),d('%;L.O &;.I &%;@." &"/:#;u/1$;?." &"/#$+#)(#\'#("\'#&\'#/]#$%;B/,#;/#$+")("\'#&\'#06*%;B/,#;/#$+")("\'#&\'#&/\'$8":" )("\'#&\'#'),d("%;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":\" )(\"'#&'#"),d("%;/& 8!:! )"),d('%3""5(7/:#;</1$;6/($8#:#! )(#\'#("\'#&\'#.g &%3""5&7/:#;</1$;6/($8#:#! )(#\'#("\'#&\'#.: &%3""5*7/& 8!:! ).# &;'),d('%%;6/k#$%;A/2#;6/)$8":""$ )("\'#&\'#0<*%;A/2#;6/)$8":""$ )("\'#&\'#&/)$8":""! )("\'#&\'#." &"/\' 8!:!! )'),d("%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d("%;/Y#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d("%$;!/&#0#*;!&&&#/' 8!:!! )"),d("%;/Y#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d('%3""5&7.; &3""5\'7./ &3""5*7.# &;6/& 8!:! )'),d("%3\"\"5&7/:#;</1$;/($8#:#! )(#'#(\"'#&'#.} &%3\"\"5'7/:#;</1$;/($8#:#! )(#'#(\"'#&'#.P &%3\"\"5+7/:#;</1$;/($8#:#! )(#'#(\"'#&'#.# &;"),d('3""5+7.k &3""5)7._ &3""5(7.S &3""5\'7.G &3""5&7.; &3""5*7./ &3""5)7.# &;6'),d(';1." &"'),d('%%;6/k#$%;A/2#;6/)$8":""$ )("\'#&\'#0<*%;A/2#;6/)$8":""$ )("\'#&\'#&/)$8":""! )("\'#&\'#." &"/\' 8!:!! )'),d("%;L.# &;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":\" )(\"'#&'#"),d(";.# &;"),d("%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),d("%;/k#;./b$;/Y$$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),d(";.; &;.5 &;./ &;.) &;.# &;"),d("%3\"\"5#7/:#;</1$;/($8#:#! )(#'#(\"'#&'#"),d("%3\"\"5%7/:#;</1$;U/($8#:#! )(#'#(\"'#&'#"),d("%3\"\"5(7/F#;</=$;].) &;Z.# &;Y/($8#:#! )(#'#(\"'#&'#"),d("%3\"\"5&7/:#;</1$;6/($8#:#! )(#'#(\"'#&'#"),d('%3""5%7/O#%;</3#$;!0#*;!&/#$+")("\'#&\'#." &"/\'$8":" )("\'#&\'#'),d("%;/G#;;/>$;6/5$;;/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),d('%3""5#7.# &;6/\' 8!:!! )'),d('%3""5#7.G &3""5#7.; &3""5#7./ &3""5$7.# &;6/\' 8!:!! )'),d('%;/D#%;C/,#;/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),d("%;V.) &;].# &;Y/& 8!:! )"),d('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:!! )'),d('%%;!/?#;!." &"/1$;!." &"/#$+#)(#\'#("\'#&\'#/\' 8!:!! )'),d(";"),d('%;/^#$%;B/,#;/#$+")("\'#&\'#06*%;B/,#;/#$+")("\'#&\'#&/($8":"!!)("\'#&\'#'),d(";.# &;"),d('%2""67/L#;</C$2""67.) &2""67/($8#:#! )(#\'#("\'#&\'#'),d('%;/^#$%;B/,#;/#$+")("\'#&\'#06*%;B/,#;/#$+")("\'#&\'#&/($8":"!!)("\'#&\'#'),d("%;6/5#;0/,$;/#$+#)(#'#(\"'#&'#"),d("$;2.) &;4.# &;.0/*;2.) &;4.# &;.&"),d("$;%0#*;%&"),d("%;/;#28\"\"6879/,$;/#$+#)(#'#(\"'#&'#"),d('%3""5%7.) &3""5$7/\' 8!:!! )'),d('%;/J#%28""6879/,#;_/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),d("%;].) &;Y.# &;/' 8!:!! )"),d(';".S &;!.M &2F""6F7G.A &2J""6J7K.5 &2H""6H7I.) &2N""6N7O'),d('2L""6L7M. &2B""6B7C. &2<""6<7=.} &2R""6R7S.q &2T""6T7U.e &2V""6V7W.Y &2P""6P7Q.M &2@""6@7A.A &2D""6D7E.5 &22""6273.) &2>""6>7?'),d('%;/b#28""6879/S$;/J$%2""67/,#;/#$+")("\'#&\'#." &"/#$+$)($\'#(#\'#("\'#&\'#'),d('%3""5%7.) &3""5$7/\' 8!:!! )'),d('%;/O#3""5#7.6 &3""5#7.* &$;+0#*;+&/\'$8":" )("\'#&\'#'),d("%;/#2F\"\"6F7G/x$;/o$2F\"\"6F7G/`$;/W$2F\"\"6F7G/H$;/?$2F\"\"6F7G/0$;/'$8):) )()'#(('#(''#(&'#(%'#($'#(#'#(\"'#&'#"),d("%;#/>#;#/5$;#/,$;#/#$+$)($'#(#'#(\"'#&'#"),d("%;/,#;/#$+\")(\"'#&'#"),d("%;/5#;/,$;/#$+#)(#'#(\"'#&'#"),d("%;r/T#$;n0#*;n&/D$%; /,#;/#$+\")(\"'#&'#.\" &\"/#$+#)(#'#(\"'#&'#"),d('%2""67.) &2""67/w#;0/n$;/e$$%;B/2#;.# &;/#$+")("\'#&\'#0<*%;B/2#;.# &;/#$+")("\'#&\'#&/#$+$)($\'#(#\'#("\'#&\'#'),d(";.# &;L"),d("%2\"\"67/5#;</,$;/#$+#)(#'#(\"'#&'#"),d("%;D/S#;,/J$2:\"\"6:7;/;$;,.# &;U/,$;E/#$+%)(%'#($'#(#'#(\"'#&'#")],C=0,S=0,y=[{line:1,column:1}],A=0,R=[],b=0;if("startRule"in i){if(!(i.startRule in v))throw new Error("Can't start parsing from rule \""+i.startRule+'".');T=v[i.startRule]}if(i.data={},(g=p(T))!==m&&C===t.length)return g;throw g!==m&&C<t.length&&l(function(){return{type:"end"}}()),h(R,A<t.length?t.charAt(A):null,A<t.length?c(A,A+1):c(A,A))}return function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(e,Error),e.buildMessage=function(e,t){function i(e){return e.charCodeAt(0).toString(16).toUpperCase()}function r(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}function s(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}function n(e){return a[e.type](e)}var a={literal:function(e){return'"'+r(e.text)+'"'},class:function(e){var t,i="";for(t=0;t<e.parts.length;t++)i+=e.parts[t]instanceof Array?s(e.parts[t][0])+"-"+s(e.parts[t][1]):s(e.parts[t]);return"["+(e.inverted?"^":"")+i+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};return"Expected "+function(e){var t,i,r=new Array(e.length);for(t=0;t<e.length;t++)r[t]=n(e[t]);if(r.sort(),r.length>0){for(t=1,i=1;t<r.length;t++)r[t-1]!==r[t]&&(r[i]=r[t],i++);r.length=i}switch(r.length){case 1:return r[0];case 2:return r[0]+" or "+r[1];default:return r.slice(0,-1).join(", ")+", or "+r[r.length-1]}}(e)+" but "+function(e){return e?'"'+r(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:t}})},783:function(e,t,i){"use strict";e.exports=function(){function e(e,t){var i,r,s=[],n=e.split(/\r\n/);for(i=0;i<n.length;){var a=n[i];if(/^m=(?:audio|video)/.test(a))r={index:i,stripped:[]},s.push(r);else if(r){var o=/^a=rtpmap:(\d+) ([^\/]+)\//.exec(a);if(o&&t===o[2]){n.splice(i,1),r.stripped.push(o[1]);continue}}i++}for(i=0;i<s.length;i++){for(var u=n[s[i].index].split(" "),c=3;c<u.length;)-1===s[i].stripped.indexOf(u[c])?c++:u.splice(c,1);n[s[i].index]=u.join(" ")}return n.join("\r\n")}function t(e,t){var i=new RegExp("m="+t+".*$","gm"),r=new RegExp("^a=group:.*$","gm");if(i.test(e)){var s;e=e.split(/^m=/gm).filter(function(e){return e.substr(0,t.length)!==t||(s=e.match(/^a=mid:.*$/gm),s&&(s=s[0].match(/:.+$/g)[0].substr(1)),!1)}).join("m=");var n=e.match(r);if(n&&1===n.length){n=n[0];var a=new RegExp(" *"+s+"[^ ]*","g");n=n.replace(a,""),e=e.split(r).join(n)}}return e}return{stripTcpCandidates:function(e){return e.sdp=e.sdp.replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/gim,""),Promise.resolve(e)},stripTelephoneEvent:function(t){return t.sdp=e(t.sdp,"telephone-event"),Promise.resolve(t)},cleanJitsiSdpImageattr:function(e){return e.sdp=e.sdp.replace(/^(a=imageattr:.*?)(x|y)=\[0-/gm,"$1$2=[1:"),Promise.resolve(e)},stripG722:function(t){return t.sdp=e(t.sdp,"G722"),Promise.resolve(t)},stripRtpPayload:function(t){return function(i){return i.sdp=e(i.sdp,t),Promise.resolve(i)}},stripVideo:function(e){return e.sdp=t(e.sdp,"video"),Promise.resolve(e)},addMidLines:function(e){var t=e.sdp;if(-1===t.search(/^a=mid.*$/gm)){var i=t.match(/^m=.*$/gm);t=t.split(/^m=.*$/gm),i.forEach(function(e,t){i[t]=e+"\na=mid:"+t}),t.forEach(function(e,r){i[r]&&(t[r]=e+i[r])}),t=t.join(""),e.sdp=t}return Promise.resolve(e)}}}},784:function(e,t,i){"use strict";(function(t){e.exports=function(e){var i={STATUS_NULL:0,STATUS_NEW:1,STATUS_CONNECTING:2,STATUS_CONNECTED:3,STATUS_COMPLETED:4},r=function(r){if(r.media.remote.video?this.video=!0:this.video=!1,r.media.remote.audio?this.audio=!0:this.audio=!1,!this.audio&&!this.video)throw new Error("At least one remote audio or video element is required for Simple.");this.options=r;var s=t.navigator.userAgent.toLowerCase(),n=!1,a=!1;s.indexOf("safari")>-1&&s.indexOf("chrome")<0?n=!0:s.indexOf("firefox")>-1&&s.indexOf("chrome")<0&&(a=!0);var o={};return n&&(o.modifiers=[e.Web.Modifiers.stripG722]),a&&(o.alwaysAcquireMediaFirst=!0),this.options.ua.uri||(this.anonymous=!0),this.ua=new e.UA({uri:this.options.ua.uri,authorizationUser:this.options.ua.authorizationUser,password:this.options.ua.password,displayName:this.options.ua.displayName,userAgentString:this.options.ua.userAgentString,register:!0,sessionDescriptionHandlerFactoryOptions:o,transportOptions:{traceSip:this.options.ua.traceSip,wsServers:this.options.ua.wsServers}}),this.state=i.STATUS_NULL,this.logger=this.ua.getLogger("sip.simple"),this.ua.on("registered",function(){this.emit("registered",this.ua)}.bind(this)),this.ua.on("unregistered",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("failed",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("invite",function(e){if(this.state!==i.STATUS_NULL&&this.state!==i.STATUS_COMPLETED)return this.logger.warn("Rejecting incoming call. Simple only supports 1 call at a time"),void e.reject();this.session=e,this.setupSession(),this.emit("ringing",this.session)}.bind(this)),this.ua.on("message",function(e){this.emit("message",e)}.bind(this)),this};return r.prototype=Object.create(e.EventEmitter.prototype),r.C=i,r.prototype.call=function(e){return this.ua&&this.checkRegistration()?this.state!==i.STATUS_NULL&&this.state!==i.STATUS_COMPLETED?void this.logger.warn("Cannot make more than a single call with Simple"):(this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.autoplay=!0,this.options.media.local.video.volume=0),this.session=this.ua.invite(e,{sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}}),this.setupSession(),this.session):void this.logger.warn("A registered UA is required for calling")},r.prototype.answer=function(){return this.state!==i.STATUS_NEW&&this.state!==i.STATUS_CONNECTING?void this.logger.warn("No call to answer"):(this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.session.accept({sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}}))},r.prototype.reject=function(){return this.state!==i.STATUS_NEW&&this.state!==i.STATUS_CONNECTING?void this.logger.warn("Call is already answered"):this.session.reject()},r.prototype.hangup=function(){return this.state!==i.STATUS_CONNECTED&&this.state!==i.STATUS_CONNECTING&&this.state!==i.STATUS_NEW?void this.logger.warn("No active call to hang up on"):this.state!==i.STATUS_CONNECTED?this.session.cancel():this.session.bye()},r.prototype.hold=function(){return this.state!==i.STATUS_CONNECTED||this.session.local_hold?void this.logger.warn("Cannot put call on hold"):(this.mute(),this.logger.log("Placing session on hold"),this.session.hold())},r.prototype.unhold=function(){return this.state===i.STATUS_CONNECTED&&this.session.local_hold?(this.unmute(),this.logger.log("Placing call off hold"),this.session.unhold()):void this.logger.warn("Cannot unhold a call that is not on hold")},r.prototype.mute=function(){if(this.state!==i.STATUS_CONNECTED)return void this.logger.warn("An acitve call is required to mute audio");this.logger.log("Muting Audio"),this.toggleMute(!0),this.emit("mute",this)},r.prototype.unmute=function(){if(this.state!==i.STATUS_CONNECTED)return void this.logger.warn("An active call is required to unmute audio");this.logger.log("Unmuting Audio"),this.toggleMute(!1),this.emit("unmute",this)},r.prototype.sendDTMF=function(e){if(this.state!==i.STATUS_CONNECTED)return void this.logger.warn("An active call is required to send a DTMF tone");this.logger.log("Sending DTMF tone: "+e),this.session.dtmf(e)},r.prototype.message=function(e,t){return this.ua&&this.checkRegistration()?e&&t?void this.ua.message(e,t):void this.logger.warn("A destination and message are required to send a message"):void this.logger.warn("A registered UA is required to send a message")},r.prototype.checkRegistration=function(){return this.anonymous||this.ua&&this.ua.isRegistered()},r.prototype.setupRemoteMedia=function(){var e,i=this.session.sessionDescriptionHandler.peerConnection;i.getReceivers?(e=new t.window.MediaStream,i.getReceivers().forEach(function(t){var i=t.track;i&&e.addTrack(i)})):e=i.getRemoteStreams()[0],this.video?(this.options.media.remote.video.srcObject=e,this.options.media.remote.video.play().catch(function(){this.logger.log("play was rejected")}.bind(this))):this.audio&&(this.options.media.remote.audio.srcObject=e,this.options.media.remote.audio.play().catch(function(){this.logger.log("play was rejected")}.bind(this)))},r.prototype.setupLocalMedia=function(){if(this.video&&this.options.media.local&&this.options.media.local.video){var e,i=this.session.sessionDescriptionHandler.peerConnection;i.getSenders?(e=new t.window.MediaStream,i.getSenders().forEach(function(t){var i=t.track;i&&"video"===i.kind&&e.addTrack(i)})):e=i.getLocalStreams()[0],this.options.media.local.video.srcObject=e,this.options.media.local.video.volume=0,this.options.media.local.video.play()}},r.prototype.cleanupMedia=function(){this.video&&(this.options.media.remote.video.srcObject=null,this.options.media.remote.video.pause(),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.srcObject=null,this.options.media.local.video.pause())),this.audio&&(this.options.media.remote.audio.srcObject=null,this.options.media.remote.audio.pause())},r.prototype.setupSession=function(){this.state=i.STATUS_NEW,this.emit("new",this.session),this.session.on("progress",this.onProgress.bind(this)),this.session.on("accepted",this.onAccepted.bind(this)),this.session.on("rejected",this.onEnded.bind(this)),this.session.on("failed",this.onFailed.bind(this)),this.session.on("terminated",this.onEnded.bind(this))},r.prototype.destroyMedia=function(){this.session.sessionDescriptionHandler.close()},r.prototype.toggleMute=function(e){var t=this.session.sessionDescriptionHandler.peerConnection;t.getSenders?t.getSenders().forEach(function(t){t.track&&(t.track.enabled=!e)}):t.getLocalStreams().forEach(function(t){t.getAudioTracks().forEach(function(t){t.enabled=!e}),t.getVideoTracks().forEach(function(t){t.enabled=!e})})},r.prototype.onAccepted=function(){this.state=i.STATUS_CONNECTED,this.emit("connected",this.session),this.setupLocalMedia(),this.setupRemoteMedia(),this.session.sessionDescriptionHandler.on("addTrack",function(){this.logger.log("A track has been added, triggering new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.sessionDescriptionHandler.on("addStream",function(){this.logger.log("A stream has been added, trigger new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.on("hold",function(){this.emit("hold",this.session)}.bind(this)),this.session.on("unhold",function(){this.emit("unhold",this.session)}.bind(this)),this.session.on("dtmf",function(e){this.emit("dtmf",e)}.bind(this)),this.session.on("bye",this.onEnded.bind(this))},r.prototype.onProgress=function(){this.state=i.STATUS_CONNECTING,this.emit("connecting",this.session)},r.prototype.onFailed=function(){this.onEnded()},r.prototype.onEnded=function(){this.state=i.STATUS_COMPLETED,this.emit("ended",this.session),this.cleanupMedia()},r}}).call(t,i(19))},785:function(e,t,i){function r(e){return s(e,n|a)}var s=i(175),n=1,a=4;e.exports=r},786:function(e,t,i){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function r(s,n){try{var a=t[s](n),o=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){return d.DO_REGISTER?e.isRegistered():e.transport&&e.transport.isConnected()}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),u=i(12),c=r(u),l=i(59),h=r(l),d=i(345),p=i(131),f=i(4),g=i(0),m=f.LoggerFactory.getInstance().getLogger("call/sip/UserAgentWaker"),v=function(){function e(t,i,r){var a=this;n(this,e),this.cancelled=!1,this.started=!1,this.cleanUp=r,this.req=(0,h.default)(t).then(s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!a.cancelled){e.next=2;break}return e.abrupt("return");case 2:return a.started=!0,e.next=5,i();case 5:case"end":return e.stop()}},e,a)})))}return o(e,[{key:"cancel",value:function(){function e(){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cancelled=!0,!this.started){e.next=4;break}return e.next=4,this.req;case 4:this.cleanUp&&this.cleanUp();case 5:case"end":return e.stop()}},e,this)}));return e}()}]),e}(),T=function(){function e(t){n(this,e),this._userAgent=t,this._upCount=0}return o(e,[{key:"wake",value:function(){function e(){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._upCount++,!this._requestToStopUA){e.next=5;break}return e.next=4,this._requestToStopUA.cancel();case 4:this._requestToStopUA=null;case 5:if(!a(this._userAgent)){e.next=7;break}return e.abrupt("return",Promise.resolve(this._userAgent));case 7:return e.abrupt("return",this._connect().catch(function(e){throw t._upCount--,e}));case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"_connect",value:function(){var e=this;m.info("starting userAgent as waken");var t=this._userAgent.transport;return new Promise(function(i,r){var s=function(){if(t){var s=function(){t.removeListener("connected",n),t.removeListener("disconnected",a),t.removeListener("transportError",o)},n=function(){m.info("SIP UA CONNECTED"),s(),d.DO_REGISTER||(e._userAgent.removeAllListeners(),i(e._userAgent))},a=function(t){e._userAgent.removeAllListeners(),s(),m.info("SIP Transport DISCONNECTED"),r(new Error("Unable to connect: "+t))},o=function(){e._userAgent.removeAllListeners(),s(),m.warn("SIP Transport ERROR"),r(new Error("Failed to connect"))};t.once("connected",n),t.once("disconnected",a),t.once("transportError",o)}};e._userAgent.removeAllListeners(),s(),e._userAgent.once("transportCreated",function(e){t=e,s()}),e._userAgent.once("registered",function(){d.DO_REGISTER&&(e._userAgent.removeAllListeners(),i(e._userAgent)),m.info("SIP UA REGISTERED")}),e._userAgent.once("unregistered",function(t){e._userAgent.removeAllListeners(),r(new Error("Unable to register: "+t)),m.info("SIP UA UNREGISTERED ",t)}),e._userAgent.once("registrationFailed",function(t){e._userAgent.removeAllListeners(),r(new Error("Unable to register: "+t)),m.info("SIP UA REG FAILED ",t)}),e._userAgent.start()})}},{key:"sleep",value:function(){var e=this;if(!(--this._upCount>0)){this._upCount=0,m.info("stopping userAgent as ready to sleep");var t=this._userAgent.transport;if(t&&t.isConnected()&&!this._requestToStopUA){var i=new c.default(t),r=void 0,n=function(){var n=s(regeneratorRuntime.mark(function s(){var n;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return n=new Promise(function(e,s){r=e,i.once("disconnected",e),i.once("transportError",s),t.ws.addEventListener("close",e)}),e._userAgent.stop(),s.next=4,n;case 4:e._requestToStopUA=null,m.info("UserAgent stopped due to inactivity");case 6:case"end":return s.stop()}},s,e)}));return function(){return n.apply(this,arguments)}}();n=(0,p.timeout)(n),this._requestToStopUA=new v(1e4,s(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,n();case 3:t.next=12;break;case 5:if(t.prev=5,t.t0=t.catch(0),e._requestToStopUA=null,!(t.t0 instanceof g.TimeoutError)){t.next=11;break}return m.warn("request to stop UA timeout",t.t0),t.abrupt("return");case 11:m.warn("error when stopping UA",t.t0);case 12:case"end":return t.stop()}},t,e,[[0,5]])})),function(){t.ws.removeEventListener("close",r),i.reset()})}}}}]),e}();t.default=T,e.exports=t.default},787:function(e,t,i){"use strict";function r(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),a=i(58),o=function(){function e(){s(this,e),this._providers=[]}return n(e,[{key:"addProvider",value:function(e){this._providers.includes(e)||(this._providers=[].concat(r(this._providers),[e]))}},{key:"removeProvider",value:function(e){var t=this._providers.indexOf(e);t<0||(this._providers=(0,a.remove)(this._providers,t))}},{key:"getProviders",value:function(){return[].concat(r(this._providers))}}]),e}();t.default=o,e.exports=t.default}},[726])});