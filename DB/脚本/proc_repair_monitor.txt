ALTER procedure [dbo].[proc_repair_monitor]
	@sdate datetime,
	@edate datetime
as
begin

declare @table as table (
	comp_code varchar(20),
	comp_name varchar(50),
	quote_count int,
	no_mt_count int,
	repair_count int,
	accident_count int,
	finished_count int,
	settle_count int,
	settle_amt money,
	first_guest_count int,
	big_accident_count int,
	big_accident_amt money,
	big_verhaul_count int,
	big_verhaul_amt money,
	gross_profit money,
	gross_profit_rate float
)

insert into @table(comp_code, comp_name)
select id, shortname from WBSystem..WB_Companies

declare @tmp as table (
	comp_code varchar(20),
	value float
)

--报价车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where quote_date between @sdate and @edate
group by comp_code

update @table set quote_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--报价未修车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where no_mt_file_date between @sdate and @edate
group by comp_code

update @table set no_mt_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--维修车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where sure_mt_date between @sdate and @edate
group by comp_code

update @table set repair_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--事故车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where sure_mt_date between @sdate and @edate and service_type_id = '040502'
group by comp_code

update @table set accident_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--完工车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where check_date between @sdate and @edate
group by comp_code

update @table set finished_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--结算车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where out_date between @sdate and @edate and status = 6
group by comp_code

update @table set settle_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--结算金额
delete from @tmp
insert into @tmp(comp_code, value)
select a.comp_code, value = sum(b.bala_amt)
from wb_repair..rps_maintain a inner join wb_repair..rps_settlement  b on a.service_id = b.service_id
where out_date between @sdate and @edate and a.status = 6
group by a.comp_code

update @table set settle_amt = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--首次到店客户
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_guest_file
where record_date between @sdate and @edate
group by comp_code

update @table set first_guest_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--事故车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where status < 6 and service_type_id = '040502'
group by comp_code

update @table set big_accident_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--事故金额
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = SUM(item_amt + part_amt)
from wb_repair..rps_maintain
where status < 6 and service_type_id = '040502'
group by comp_code

update @table set big_accident_amt = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--普通车次
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = COUNT(1)
from wb_repair..rps_maintain
where status < 6 and service_type_id = '040501'
group by comp_code

update @table set big_verhaul_count = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--普通金额
delete from @tmp
insert into @tmp(comp_code, value)
select comp_code, value = SUM(item_amt + part_amt)
from wb_repair..rps_maintain
where status < 6 and service_type_id = '040501'
group by comp_code

update @table set big_verhaul_amt = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code


--毛利
delete from @tmp
insert into @tmp(comp_code, value)
select a.comp_code, value = sum(b.gross_profit)
from wb_repair..rps_maintain a inner join wb_repair..rps_settlement  b on a.service_id = b.service_id
where out_date between @sdate and @edate and a.status = 6
group by a.comp_code

update @table set gross_profit = b.value
from @table a inner join @tmp b on a.comp_code = b.comp_code

--毛利率
update @table set gross_profit_rate = 100.0 * case when settle_amt = 0 then 0 else gross_profit / settle_amt end


select * from @table
end
