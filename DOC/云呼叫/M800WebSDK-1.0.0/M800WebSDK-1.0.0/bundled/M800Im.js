!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.M800Im=t():e.M800Im=t()}("undefined"!=typeof self?self:this,function(){return webpackJsonpM800_name_([0],{137:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t,r,n,i){var a=(0,u.default)(n,["content","recordId","prevRecordId","target","roomId"]),s=new _.default(e,t,r,i);return Object.assign(s,a,{type:f.TEXT}),s}function a(e){var t=void 0,r=void 0,n=void 0,a=(0,d.default)(e),o=s.Strophe.getBareJidFromJid(a.attr("from")),u=a.attr("id"),c=a.find("body")[0].content(),f=new Date(a.attr("ts")||Date.now()).getTime();"groupchat"===a.attr("type")?(t=p.GROUP,r=a.find("thread")[0].content(),n=r):(t=p.USER,r=o,n=s.Strophe.getBareJidFromJid(a.attr("to")));var h=(0,l.getRecordInfo)(e);return i(u,o,n,{content:c,target:t,roomId:r,recordId:h.recordId,prevRecordId:h.prevRecordId},f)}Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(71),u=n(o),c=r(5),d=n(c),l=r(7),f=r(48),p=r(24),h=r(77),_=n(h);t.default={create:i,parseStanza:a},e.exports=t.default},138:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t,r,n,i){var a=n.url,s=n.name,o=n.type,c=n.size,d=n.duration,l=n.thumbnail,f=n.recordId,h=n.prevRecordId,_=n.target,v=n.roomId,g=new u.default(e,t,r,i);return Object.assign(g,{type:p.FILE,content:a,target:_,roomId:v,recordId:f,prevRecordId:h,file:{name:s,type:o,size:c,thumbnail:l,duration:d}}),g}function a(e){var t=void 0,r=void 0,n=void 0,a=(0,d.default)(e),o=a.attr("id"),u=s.Strophe.getBareJidFromJid(a.attr("from")),c=new Date(a.attr("ts")||Date.now()).getTime();"groupchat"===a.attr("type")?(t=h.GROUP,r=a.find("thread")[0].content(),n=r):(t=h.USER,r=u,n=s.Strophe.getBareJidFromJid(a.attr("to")));var p=(0,l.getRecordInfo)(e),v=p.recordId,g=p.prevRecordId,m=a.findFirst("file"),y=m.findFirst("url").content(),E=m.attr("mime-type"),b=m.attr("name"),S=parseInt(m.attr("size"),10),I=_(E)?parseFloat(m.attr("duration")):void 0,R=a.findFirst("data");return i(o,u,n,{name:b,url:y,type:E,size:S,thumbnail:R?(0,f.addImageDataPrefix)(R.content()):void 0,duration:I,target:t,roomId:r,recordId:v,prevRecordId:g},c)}Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(77),u=n(o),c=r(5),d=n(c),l=r(7),f=r(206),p=r(48),h=r(24),_=function(e){return/^(audio|video)\//.test(e)};t.default={create:i,parseStanza:a},e.exports=t.default},205:function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e){var t;return(t={},s(t,x.TEXT,R.create),s(t,x.FILE,M.create),s(t,x.AUDIO,P.create),t)[e]}function u(e,t){return e.find(function(e){return e.jid===t})?e.slice(0):e.concat({jid:t,role:H.MEMBER})}Object.defineProperty(t,"__esModule",{value:!0});var c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},d=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(4),f=i(l),p=r(75),h=i(p),_=r(12),v=i(_),g=r(3),m=r(679),y=i(m),E=r(680),b=i(E),S=r(10),I=r(34),R=r(137),M=r(138),P=r(331),k=r(16),O=r(30),A=r(188),C=n(A),w=r(11),T=r(58),G=n(T),D=r(92),j=n(D),N=r(78),U=n(N),x=r(48),L=r(24),H=r(93),F=r(76),J=n(F),B=r(683),V=r(0),q=g.LoggerFactory.getInstance().getLogger("im/Room"),z=["audio/mpeg","audio/mp4"],W=function(){function e(t,r,n,i,s,o,c,d,l){a(this,e),(0,f.default)(this),this._id=t,this._jid=r,this._participants=u(n.participants,r),this._pm=i,this._ss=s,this._imService=o,this._fileMgr=c,this._messageStore=d,this._upload=new Map,this._uploadController=new b.default(c,l),this._hasPreviousFileQueued=Promise.resolve(),this._composingTimeout=l.composingTimeout,this._composingFrequency=l.composingFrequency,this._lastUpdateTime=n.lastUpdateTime,this._readonly=n.readonly||!1,this._hasInited=!1,this._initDeferred=null,this._resetMessageEventHandlers=function(){},this._participantChatStateHandlers=new Map,this._participantChatStateEventHandlers=new Map,this._handleNewMessage=this._handleNewMessage.bind(this),this._handleDeliveryReceipt=this._handleDeliveryReceipt.bind(this),this._handleDisplayReceipt=this._handleDisplayReceipt.bind(this),this._handleMessageRemoval=this._handleMessageRemoval.bind(this),this._handleRoomCleared=this._handleRoomCleared.bind(this),this._setupStateHandler(),this._setupImServiceEventHandlers(),this._setupChatStateHandlers(),this._decorateMethodsWithWritableCheck()}return d(e,[{key:"init",value:function(){var e=this;return this._initDeferred?this._initDeferred:(this._initDeferred=Promise.resolve(),this._setupPeerEventHandlers(),this._messageStore.on(G.INCOMING_MESSAGE,this._id,this._handleNewMessage),this._messageStore.on(G.OUTGOING_MESSAGE,this._id,this._handleNewMessage),this._messageStore.on(G.MESSAGE_DELIVERED,this._id,this._handleDeliveryReceipt),this._messageStore.on(G.MESSAGE_DISPLAYED,this._id,this._handleDisplayReceipt),this._messageStore.on(G.MESSAGE_REMOVED,this._id,this._handleMessageRemoval),this._messageStore.on(G.ROOM_CLEARED,this._id,this._handleRoomCleared),this._resetMessageEventHandlers=function(){e._messageStore.off(G.INCOMING_MESSAGE,e._handleNewMessage),e._messageStore.off(G.OUTGOING_MESSAGE,e._handleNewMessage),e._messageStore.off(G.MESSAGE_DELIVERED,e._handleDeliveryReceipt),e._messageStore.off(G.MESSAGE_DISPLAYED,e._handleDisplayReceipt),e._messageStore.off(G.MESSAGE_REMOVED,e._handleMessageRemoval),e._messageStore.off(G.ROOM_CLEARED,e._handleRoomCleared)},this._uploadController.start(),this._hasInited=!0,this._initDeferred)}},{key:"sendTextMessage",value:function(e){if(!(0,I.isNonEmptyString)(e))return Promise.reject(new V.ArgumentError("Expect message content to be a non-empty string."));var t=this._composeMessage(x.TEXT,{content:e});return this._skipActiveChatState(),this.activate(),this._sendMessage(t)}},{key:"sendAudioMessage",value:function(e){var t=this;if(z.indexOf(e.type)<0)return Promise.reject(new V.ArgumentError("Type of blob is not supported.\n        Accepted types: "+z.join(", ")));var r=this._composeMessage(x.AUDIO,{name:"audio-"+(new Date).toISOString()+"."+(0,B.ext)(e.type),type:e.type,size:e.size});return this.addMessage(r).then(function(){return t._uploadFileForMessage(r,e),r})}},{key:"sendFile",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.max,i=r.quality,a=this._composeMessage(x.FILE,{name:e.name,type:e.type,size:e.size}),s={max:n||300,quality:i||.7};return this.addMessage(a).then(function(){return t._uploadFileForMessage(a,e,s),a})}},{key:"resendMessage",value:function(e){var t=this;return new Promise(function(r){var n=t._getUpload(e);if(!n)throw new V.NotFoundError("Cannot found the associated message.");var i=n.message,a=n.file,s=n.options;if(i.status!==U.FAILURE)throw new V.InvalidOperationError("The message cannot be resent due to incorrect status.");var o=(0,S.clone)(i,{status:U.SENDING});t._updateMessage(o),t._uploadFileForMessage(o,a,s),r()})}},{key:"cancelMessage",value:function(e){var t=this,r=this._getUpload(e);return r?new Promise(function(n){t._uploadEventHandler.once(J.UPLOAD_CANCEL,n);var i=t._uploadController.cancel(e),a=t._deleteUpload(e);if(!i){if(!a)throw new V.InvalidOperationError("The message cannot be cancelled.");var s=r.message;t._cancelMessage(s).then(n)}}):Promise.reject(new V.InvalidOperationError("The message cannot be cancelled."))}},{key:"markMessageAsRead",value:function(e){return this._pm.isActive()?this._delegateMarkMessageAsRead(e):this._pm.request({command:"Room:markMessageAsRead",args:[this.getId(),e]}).then(function(e){var t=e.event,r=e.payload,n=e.error;if("Room:markMessageAsRead:success"===t)return r;throw(0,O.deserializeError)(n)})}},{key:"_delegateMarkMessageAsRead",value:function(e){var t=this;return new Promise(function(r,n){var i=function n(i){var a=i.roomId,s=i.message;if(a===t.getId()&&s.id===e&&s.displayTs){var o=c({},s,{roomId:a});t._pm.broadcast({event:"Room:messageDisplayed",payload:o}),t.off(G.MESSAGE_UPDATED,n),r()}};t.on(G.MESSAGE_UPDATED,i),t._messageStore.getMessage(t.getId(),e).then(function(r){return t._isIncomingMessage(r)?r:t._findLastIncomingMessage(e)}).then(function(e){if(e.displayTs)return void r();t._imService.sendDisplayedReceipt(t.getId(),e.id)}).catch(n)})}},{key:"setChatState",value:function(e){switch(e){case j.COMPOSING:this._chatStateHandler.typing();break;case j.ACTIVE:this._chatStateHandler.stopTyping();break;default:throw new V.ArgumentError("Expect a state defined in ChatState.")}}},{key:"activate",value:function(){this._chatStateHandler.stopTyping()}},{key:"composing",value:function(){this._chatStateHandler.typing()}},{key:"getCurrentChatState",value:function(){return this._participantChatStateHandlers.get(this.getId()).getState()}},{key:"getMessages",value:function(e){return this._messageStore.getMessages(this.getId(),e).catch(function(e){if(e instanceof V.NotFoundError)return[];throw e})}},{key:"getMessage",value:function(e){return this._messageStore.getMessage(this.getId(),e).catch(function(e){if(!(e instanceof V.NotFoundError))throw e})}},{key:"getLastMessage",value:function(){return this._messageStore.getMessages(this.getId(),{count:1}).then(function(e){if(0!==e.length)return e[0]}).catch(function(e){if(!(e instanceof V.NotFoundError))throw e})}},{key:"getLastUpdateTime",value:function(){return this._lastUpdateTime}},{key:"getMessageCount",value:function(){return this._messageStore.getMessageCount(this.getId()).catch(function(e){if(e instanceof V.NotFoundError)return 0;throw e})}},{key:"getUnreadCount",value:function(){return this._messageStore.getUnreadCount(this.getId()).catch(function(e){if(e instanceof V.NotFoundError)return 0;throw e})}},{key:"hasUnreadMessage",value:function(){return this._messageStore.hasUnreadMessage(this.getId()).catch(function(e){if(e instanceof V.NotFoundError)return!1;throw e})}},{key:"addMessage",value:function(e){var t=this;return this._messageStore.putMessages(this.getId(),e).then(function(){t._emitNewMessageEvent(e),t._emitRoomUpdated()})}},{key:"deleteMessages",value:function(e){return Array.isArray(e)||(e=[e]),this._messageStore.deleteMessages(this.getId(),e)}},{key:"clear",value:function(){return this._messageStore.clearRoom(this.getId())}},{key:"getParticipants",value:function(){return this._participants}},{key:"getId",value:function(){return this._id}},{key:"getType",value:function(){return L.USER}},{key:"isReadonly",value:function(){return this._readonly}},{key:"getState",value:function(){return{id:this.getId(),type:this.getType(),readonly:this.isReadonly(),participants:this.getParticipants(),lastUpdateTime:this.getLastUpdateTime()}}},{key:"deinit",value:function(){this._uploadController.stop().then(this._tearDownFileUploadHandler.bind(this)),this._resetMessageEventHandlers(),this._imEventHandler.reset(),this._stateChangeHandler.reset(),this._peerEventHandler.reset(),this._chatStateEventHandler.reset(),this._participantChatStateEventHandlers.forEach(function(e){e.reset()})}},{key:"_decorateMethodsWithWritableCheck",value:function(){this._decorateMethodWithWritableCheck("sendTextMessage"),this._decorateMethodWithWritableCheck("setChatState"),this._decorateMethodWithWritableCheck("activate"),this._decorateMethodWithWritableCheck("composing"),this._decorateMethodWithWritableCheck("sendFile"),this._decorateMethodWithWritableCheck("sendAudioMessage"),this._decorateMethodWithWritableCheck("cancelMessage"),this._decorateMethodWithWritableCheck("resendMessage"),this._decorateMethodWithWritableCheck("deleteMessages",!0),this._decorateMethodWithWritableCheck("clear",!0)}},{key:"_decorateMethodWithWritableCheck",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this[e].bind(this);if(!r)return void(this[e]=function(){return t._checkWritable(),n.apply(void 0,arguments)});this[e]=function(){for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];return Promise.resolve().then(function(){return t._checkWritable(),n.apply(void 0,r)})}}},{key:"_setupStateHandler",value:function(){var e=this;this._stateChangeHandler=new v.default(this._ss),this._stateChangeHandler.add(C.STATE_CHANGED,function(t){var r=e.getId();if(t.chatState&&t.chatState[r]){var n=t.chatState[r],i=n.type,a=n.jid;e._handleChatStateUpdate({roomId:r,type:i,jid:a})}})}},{key:"_setupPeerEventHandlers",value:function(){var e=this;this._peerEventHandler=new v.default(this._pm),this._peerEventHandler.add(w.REQUEST_RECEIVED,function(t){var r=t.requestId,n=t.message,i=n.command,a=n.args;switch(i){case"Room:sendMessage":var s=a[0];s.roomId===e.getId()&&e._sendMessage(s).then(function(t){e._pm.respond(r,{event:"Room:sendMessage:success",payload:t})}).catch(function(t){e._pm.respond(r,{event:"Room:sendMessage:failure",error:(0,O.serializeError)(t)})});break;case"Room:markMessageAsRead":var o=a[0],u=a[1];if(e.getId()!==o)return;e._delegateMarkMessageAsRead(u).then(function(){e._pm.respond(r,{event:"Room:markMessageAsRead:success"})}).catch(function(t){e._pm.respond(r,{event:"Room:markMessageAsRead:failure",error:(0,O.serializeError)(t)})})}}),this._peerEventHandler.add(w.MESSAGE_RECEIVED,function(t){var r=t.message,n=r.event,i=r.payload;if(i&&i.roomId===e.getId())switch(n){case"Room:messageDisplayed":e._emitMessageUpdated(i)}})}},{key:"_setupImServiceEventHandlers",value:function(){var e=this;this._imEventHandler=new v.default(this._imService),this._imEventHandler.add(G.CHAT_STATE_UPDATED,function(t){e._handleChatStateUpdate(t)})}},{key:"_setupChatStateHandlers",value:function(){this._setupCurrentUserChatStateHandlers(),this._setupParticipantChatStateHandlers()}},{key:"_setupCurrentUserChatStateHandlers",value:function(){var e=this;this._chatStateHandler=new y.default({composingTimeout:this._composingTimeout}),this._chatStateEventHandler=new v.default(this._chatStateHandler),this._chatStateEventHandler.add(j.COMPOSING,function(){e._sendComposingState(),e._composingFrequencyHandler||(e._composingFrequencyHandler=setInterval(function(){e._sendComposingState()},e._composingFrequency))}),this._chatStateEventHandler.add(j.ACTIVE,function(){if(e._resetComposingTimers(),e._shouldSkipActiveChatState)return void(e._shouldSkipActiveChatState=!1);e._sendActiveState()})}},{key:"_setupParticipantChatStateHandlers",value:function(){var e=this;this._getOtherParticipants().forEach(function(t){var r=t.jid;e._addParticipantChatStateHandler(r)})}},{key:"_addParticipantChatStateHandler",value:function(e){var t=this,r=new y.default({composingTimeout:this._composingTimeout}),n=new v.default(r);[j.COMPOSING,j.ACTIVE].forEach(function(r){n.add(r,function(){var n=t.getId(),i={roomId:n,type:r,jid:e};t.emit(G.CHAT_STATE_UPDATED,i),t._ss.setState({chatState:(0,S.clone)(t._ss.getState("chatState"),s({},n,{type:r,jid:e}))})})}),this._participantChatStateHandlers.set(e,r),this._participantChatStateEventHandlers.set(e,n)}},{key:"_composeMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:x.TEXT,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=o(e),n=this.getId(),i=(0,k.generateMessageId)(n),a=(0,S.clone)({target:this.getType(),roomId:n},t),s=r(i,this._jid,n,a);return s.status=U.SENDING,s}},{key:"_sendMessage",value:function(e){var t=this;return this._pm.isActive()?new Promise(function(r){var n=new v.default(t._messageStore);if(n.add(G.OUTGOING_MESSAGE,function(e){var i=e.roomId,a=e.message;i===t.getId()&&(n.reset(),r(a))}),e.type===x.TEXT)return void t._imService.sendTextMessage(e);t._imService.sendFileMessage(e)}):this._pm.request({command:"Room:sendMessage",args:[e]}).then(function(e){var t=e.event,r=e.payload,n=e.error;if("Room:sendMessage:success"===t)return r;throw(0,O.deserializeError)(n)})}},{key:"_skipActiveChatState",value:function(){this._shouldSkipActiveChatState=!0}},{key:"_checkWritable",value:function(){if(this.isReadonly())throw new V.InvalidOperationError("Write action is not allowed in readonly room.")}},{key:"_setReadonly",value:function(){this._readonly=!0}},{key:"_unsetReadonly",value:function(){this._readonly=!1}},{key:"_updateMessage",value:function(e){var t=this;return this._messageStore.putMessages(this.getId(),e).then(function(){t._emitMessageUpdated(e)})}},{key:"_emitMessageUpdated",value:function(e){this.emit(G.MESSAGE_UPDATED,{roomId:this._id,message:e})}},{key:"_emitNewMessageEvent",value:function(e){var t={roomId:this.getId(),message:e};e.from===this._jid?this.emit(G.OUTGOING_MESSAGE,t):this.emit(G.INCOMING_MESSAGE,t)}},{key:"_emitRoomUpdated",value:function(){this.emit(G.ROOM_UPDATED,{roomId:this.getId()})}},{key:"_uploadFileForMessage",value:function(e,t,r){var n=this;this._hasPendingUpload()||this._setupFileUploadHandler(),this._addUpload(e,t,r),this._hasPreviousFileQueued=this._hasPreviousFileQueued.then(function(){return n._fileMgr.loadMetadata(t,r)}).then(function(r){var i=r.thumbnail,a=r.duration;if(n._getUpload(e.id)){var s=(0,S.clone)(e,{file:(0,S.clone)(e.file,{thumbnail:i,duration:a})});n._updateUpload(s),n._updateMessage(s),n._uploadController.enqueue(e.id,t)}}).catch(function(t){n._uploadController.cancel(e.id);var r=(0,S.clone)(e,{status:U.FAILURE,error:t.message});n._updateUpload(r),n._updateMessage(r)}).then(function(){return(0,h.default)(101)})}},{key:"_hasPendingUpload",value:function(){return this._upload.size>0}},{key:"_addUpload",value:function(e,t,r){this._upload.set(e.id,{message:e,file:t,options:r})}},{key:"_getUpload",value:function(e){return this._upload.get(e)}},{key:"_updateUpload",value:function(e){this._upload.set(e.id,(0,S.clone)(this._upload.get(e.id),{message:e}))}},{key:"_deleteUpload",value:function(e){var t=this._upload.delete(e);return this._hasPendingUpload()||this._tearDownFileUploadHandler(),t}},{key:"_resetComposingTimers",value:function(){this._composingFrequencyHandler&&(clearInterval(this._composingFrequencyHandler),this._composingFrequencyHandler=null)}},{key:"_sendComposingState",value:function(){this._pm.isActive()&&this._imService.sendComposingState(this.getId())}},{key:"_sendActiveState",value:function(){this._pm.isActive()&&this._imService.sendActiveState(this.getId())}},{key:"_findLastIncomingMessage",value:function(e){var t=this,r={count:20,ref:e};return this._messageStore.getMessages(this.getId(),r).then(function(e){if(0===e.length)throw new V.NotFoundError("No incoming messages can be found.");for(var r=e.length-1;r>=0&&!t._isIncomingMessage(e[r]);)r--;return r>=0?e[r]:t._findLastIncomingMessage(e[0].id)})}},{key:"_setupFileUploadHandler",value:function(){var e=this;this._uploadEventHandler=new v.default(this._uploadController),this._uploadEventHandler.add(J.UPLOAD_SUCCESS,function(t){var r=t.id,n=t.url,i=t.expires,a=e._getUpload(r),s=a.message,o=(0,S.clone)(s,{content:n,expires:i});e._updateUpload(o),e._updateMessage(o).then(function(){return e._sendMessage(o)}).then(function(){e._deleteUpload(o.id)})}),this._uploadEventHandler.add(J.UPLOAD_FAILURE,function(t){var r=t.id,n=t.error,i=e._getUpload(r),a=i.message,s=(0,S.clone)(a,{status:U.FAILURE,error:n.message});e._updateUpload(s),e._updateMessage(s)}),this._uploadEventHandler.add(J.UPLOAD_PROGRESS,function(t){var r=t.id,n=t.progress,i=e._getUpload(r),a=i.message,s=(0,S.clone)(a,{progress:n});e._updateUpload(s),e._updateMessage(s)}),this._uploadEventHandler.add(J.UPLOAD_CANCEL,function(t){var r=t.id,n=e._getUpload(r),i=n.message;e._cancelMessage(i),e._deleteUpload(i.id)})}},{key:"_cancelMessage",value:function(e){var t=this;return e=(0,S.clone)(e,{status:U.CANCELLED}),this._updateMessage(e).then(function(){return t.deleteMessages(e.id)}).then(function(){return t._emitRoomUpdated()})}},{key:"_tearDownFileUploadHandler",value:function(){this._uploadEventHandler&&(this._uploadEventHandler.reset(),this._uploadEventHandler=null)}},{key:"_handleNewMessage",value:function(e){var t=e.message;this._lastUpdateTime=t.ts,this._emitNewMessageEvent(t)}},{key:"_handleChatStateUpdate",value:function(e){var t=e.roomId,r=e.type,n=e.jid;if(t===this.getId()&&this._isOtherUserInRoom(n)){var i=this._participantChatStateHandlers.get(n);r===j.COMPOSING?i.typing():i.stopTyping()}}},{key:"_handleDeliveryReceipt",value:function(e){var t=this,r=e.messageId;this._messageStore.getMessage(this.getId(),r).then(function(e){t._emitMessageUpdated(e)}).catch(function(e){q.warn("DR for a non-exist message received",e.message)})}},{key:"_handleDisplayReceipt",value:function(e){var t=this,r=e.messageId;this._messageStore.getMessage(this.getId(),r).then(function(e){t._emitMessageUpdated(e)}).catch(function(e){q.warn("Displayed receipt for non-exist message received",e.message)})}},{key:"_handleMessageRemoval",value:function(e){var t=e.roomId,r=e.message;this.emit(G.MESSAGE_REMOVED,{roomId:t,message:r})}},{key:"_handleRoomCleared",value:function(e){var t=e.roomId;this._lastUpdateTime=Date.now(),this.emit(G.ROOM_CLEARED,{roomId:t}),this._emitRoomUpdated()}},{key:"_isIncomingMessage",value:function(e){return e.from!==this._jid}},{key:"_isOutgoingMessage",value:function(e){return e.from===this._jid}},{key:"_isUserInRoom",value:function(e){return this.getParticipants().some(function(t){return t.jid===e})}},{key:"_isOtherUserInRoom",value:function(e){return e!==this._jid&&this._isUserInRoom(e)}},{key:"_getOtherParticipants",value:function(){var e=this;return this.getParticipants().filter(function(t){return t.jid!==e._jid})}}]),e}();t.default=W,e.exports=t.default},206:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){return(0,o.default)("imgData",e,c.default,"Expect string type for base64 image data."),""===e||e.startsWith("data:image/")?e:"data:image/jpeg;base64,"+e}function a(e){return(0,o.default)("imgData",e,c.default,"Expect string type for base64 image data."),e.startsWith("data:image/")?e.split(/data:image\/[\d\w.-]+;base64,/)[1]:e}Object.defineProperty(t,"__esModule",{value:!0}),t.addImageDataPrefix=i,t.removeImageDataPrefix=a;var s=r(6),o=n(s),u=r(8),c=n(u)},207:function(e,t,r){"use strict";function n(e){(0,o.sortBy)(e,"ts")}function i(e){(0,s.default)("array",e,u.isArray,"Expect parameter 1 as an array"),e.sort(function(e,t){return!e.serverTs&&t.serverTs?1:e.serverTs&&!t.serverTs?-1:e.serverTs||t.serverTs?e.serverTs-t.serverTs:e.ts-t.ts})}Object.defineProperty(t,"__esModule",{value:!0}),t.sortByClientTime=n,t.sortByServerTime=i;var a=r(6),s=function(e){return e&&e.__esModule?e:{default:e}}(a),o=r(57),u=r(10)},208:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){var r=e.length-1,n=0,i=void 0;if(e[n][l]>=t)return[];if(e[r][l]<t)return e.slice(0);for(;r-n>1;)i=Math.floor((r+n)/2),e[i][l]>=t?r=i:n=i;return e[i][l]<=t&&i++,e.slice(0,i)}function a(e,t){var r=e.length-1,n=0,i=void 0;if(e[n][l]>t)return e.slice(0);if(e[r][l]<=t)return[];for(;r-n>1;)i=Math.floor((r+n)/2),e[i][l]<=t?n=i:r=i;return e[i][l]<=t&&i++,e.slice(i)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(79),u=r(207),c=r(10),d=r(0),l=void 0,f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e),this._messages=[],this._sortMessage=t.messageSortingCriteria===o.CLIENT_TIME?u.sortByClientTime:u.sortByServerTime,l=t.messageSortingCriteria===o.CLIENT_TIME?"ts":"serverTs"}return s(e,[{key:"put",value:function(e){var t=this;if(!(0,c.isArray)(e))return void this._insertOrUpdate(e);e.forEach(function(e){t._insertOrUpdate(e)})}},{key:"delete",value:function(e){var t=this;((0,c.isArray)(e)?e:[e]).forEach(function(e){t._remove(e)})}},{key:"getOne",value:function(e){return this._messages.find(function(t){return t.id===e})}},{key:"getSome",value:function(e,t,r,n){var s=this._messages.slice(0);if(r)if((0,c.isNumber)(r))s=n?a(s,r):i(s,r);else{var o=this._messages.findIndex(function(e){return e.id===r});if(o<0)throw new d.NotFoundError("message with id "+r+" does not exist");s=n?s.slice(o+1):s.slice(0,o)}if(t){var u=Object.keys(t);u.length>0&&(s=s.filter(function(e){return u.every(function(r){return e[r]===t[r]})}))}if(n)return s.slice(0,e);var l=Math.max(s.length-e,0);return s.slice(l,s.length)}},{key:"getAll",value:function(){return this._messages.slice(0)}},{key:"getCount",value:function(){return this._messages.length}},{key:"_insert",value:function(e){this._messages.push(e),this._sortMessage(this._messages)}},{key:"_update",value:function(e){var t=this._messages.findIndex(function(t){return e.id===t.id});this._messages.splice(t,1,e)}},{key:"_remove",value:function(e){if(this._exists(e)){var t=this._messages.findIndex(function(t){return e===t.id});this._messages.splice(t,1)}}},{key:"_exists",value:function(e){var t=(0,c.isString)(e)?e:e.id;return!!this._messages.find(function(e){return t===e.id})}},{key:"_insertOrUpdate",value:function(e){if(!this._exists(e))return void this._insert(e);this._update(e)}}]),e}();t.default=f,e.exports=t.default},209:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t,r,i){n(this,e),this._parser=t,this._pubsub=r,this._topic=i}return i(e,[{key:"canHandle",value:function(e){return this._parser.canParse(e)}},{key:"handle",value:function(e){var t=this._parser.parse(e);return t?(this.publish(t),t):null}},{key:"publish",value:function(e){this._pubsub.publish(this._topic,[e])}}]),e}();t.default=a,e.exports=t.default},210:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(705),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=r(7),c=r(36),d=r(24),l=function(){function e(t){n(this,e);var r=new o.default(t);this._forwardedMessageParser=r}return a(e,[{key:"canParse",value:function(e){var t=(0,u.unwrap)(e,"message"),r=i(t,1),n=r[0],a=(0,u.unwrap)(n),s=i(a,1),o=s[0];return("sent"===n.name()||"received"===n.name())&&n.attr("xmlns")===c.CARBONS&&this._forwardedMessageParser.canParse(o)}},{key:"parse",value:function(e){var t=(0,u.unwrap)(e,"message"),r=i(t,1),n=r[0],a=(0,u.unwrap)(n),s=i(a,1),o=s[0],c=this._forwardedMessageParser.parse(o);return"sent"===n.name()&&c.target===d.USER&&c.to&&(c.roomId=c.to),c}}]),e}();t.default=l,e.exports=t.default},24:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.GROUP="group",t.USER="user"},330:function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function o(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(i,a){try{var s=t[i](a),o=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}return n("next")})}}function u(e){return Object.keys(e).reduce(function(t,r){var n=e[r];return"user"===n.scope?t.personalProperties[r]=n.value:t.properties[r]=n.value,t},{properties:{},personalProperties:{}})}function c(e){var t=e.groupId,r=e.version,n=e.subject,i=e.participants,a=e.owner.jid,s=u(e.properties);return{id:t,version:r,subject:n,participants:i,owner:a,properties:s.properties,personalProperties:s.personalProperties}}function d(e,t){var r=e.slice();return t.forEach(function(e){var t=e.id;if(e.type===W.GROUP&&r.findIndex(function(e){return e.id===t})>-1)return;r.push(e)}),r}function l(e){var t=this,r=new Map,n=function(){var n=o(regeneratorRuntime.mark(function n(i){var a,o,u,c,d,l,f=i.requestId,p=i.message;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=p.command,o=p.args,u=void 0===o?[]:o,r.has(a)){t.next=3;break}return t.abrupt("return");case 3:return c=r.get(a),t.prev=4,t.next=7,c.apply(void 0,s(u));case 7:d=t.sent,l={event:a+":success"},d&&(l.payload=d),e.respond(f,l),t.next=16;break;case 13:t.prev=13,t.t0=t.catch(4),e.respond(f,{event:a+":failure",error:(0,V.serializeError)(t.t0)});case 16:case"end":return t.stop()}},n,t,[[4,13]])}));return function(e){return n.apply(this,arguments)}}(),i=function(e,t){if(r.has(e))throw new te.ConflictError("Cannot register handler for a command twice.");r.set(e,t)},a=function(){r.clear(),e.off(X.REQUEST_RECEIVED,n)};return e.on(X.REQUEST_RECEIVED,n),{register:i,deinit:a}}Object.defineProperty(t,"__esModule",{value:!0});var f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},p=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_=r(4),v=i(_),g=r(1),m=r(2),y=i(m),E=r(8),b=i(E),S=r(193),I=i(S),R=r(312),M=i(R),P=r(55),k=i(P),O=r(12),A=i(O),C=r(6),w=i(C),T=r(205),G=i(T),D=r(332),j=i(D),N=r(684),U=i(N),x=r(685),L=i(x),H=r(333),F=r(7),J=r(135),B=r(3),V=r(30),q=r(58),z=n(q),W=r(24),Q=r(93),Y=r(79),X=r(11),Z=r(41),K=n(Z),$=r(37),ee=n($),te=r(0),re=r(14),ne=r(697),ie=r(698),ae=B.LoggerFactory.getInstance().getLogger("im/ImManager"),se=function(){function e(t,r,n,i,s,o,u,c,d){a(this,e),(0,v.default)(this),this._pm=t,this._stateSync=r,this._connection=n,this._imService=i,this._groupService=s,this._fileMgr=o,this._storage=u,this._history=c,this._configMgr=d,this._chatrooms={},this._roomEventListeners={},this._depsEventListeners={},this._tempGroups={},this._restoreGroupPromises=new Map,this._peerCommandHandler=l(this._pm),n.getStatus()===ee.CONNECTED&&this._restoreChatrooms(),this._setupMessageStoreEventHandlers(),this._setupEventHandlers(),this._setupPeerEventHandlers()}return h(e,[{key:"createRoom",value:function(e){var t=this;return Promise.resolve().then(function(){return(0,w.default)("bareJid",e,F.isBareJid,"Room should be created using bare JID"),t._createRoom(e)})}},{key:"createGroup",value:function(){function e(e,r){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r){var n,i,a,s,o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(0,w.default)("participants",t,function(e){return(0,y.default)(e)&&e.length>0},"Group requires at least one participant"),t.forEach(function(e){(0,w.default)("participant",e,F.isBareJid,"Group requires participants to be bare jid")}),(0,w.default)("subject",r,function(e){return(0,b.default)(e)&&e.length>0},"Group requires non-empty string for subject"),e.next=5,this._delegateCreateGroup(t,r);case 5:return n=e.sent,i=n.id,a=n.version,s=g.Strophe.getBareJidFromJid(this._connection.getJid()),o=t.map(function(e){return{jid:e,role:Q.MEMBER}}),o.push({jid:s,role:Q.ADMIN}),u={id:i,version:a,subject:r,participants:o,owner:s,lastUpdateTime:Date.now()},e.abrupt("return",this._createGroup(i,u));case 13:case"end":return e.stop()}},e,this)}));return e}()},{key:"getRoom",value:function(e){return this._chatrooms[e]||null}},{key:"getRooms",value:function(e){return(0,M.default)(this._chatrooms,function(t){return!e||t.getType()===e})}},{key:"deleteRoom",value:function(e){return this._delegateDeleteRoom(e)}},{key:"getTotalUnreadCount",value:function(){function e(){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all((0,I.default)(this._chatrooms,function(e){return e.getUnreadCount()}));case 2:return t=e.sent,e.abrupt("return",t.reduce(function(e,t){return e+t},0));case 4:case"end":return e.stop()}},e,this)}));return e}()},{key:"getUnreadRoomCount",value:function(){function e(){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,J.filterAsync)(this._chatrooms,function(e){return e.hasUnreadMessage()});case 2:return t=e.sent,r=t.length,e.abrupt("return",r);case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"getMaxParticipants",value:function(){return this._configMgr.get(ne.IM_GROUP_PARTICIPANTS_MAX,ie.GROUP_MAX_PARTICIPANTS)}},{key:"deinit",value:function(){var e=this;this._restoreGroupPromises.clear(),this._peerCommandHandler.deinit(),Object.keys(this._depsEventListeners).forEach(function(t){e._depsEventListeners[t].reset()}),this._depsEventListeners={},Object.keys(this._roomEventListeners).forEach(function(t){e._roomEventListeners[t].reset()}),this._roomEventListeners={}}},{key:"_restoreChatrooms",value:function(){function e(){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(){var t,r,n,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this._syncGroups(ie.SYNC_GROUPS_PAGE_SIZE),this._getChatroomsFromStorage()]);case 2:t=e.sent,r=p(t,2),n=r[0],i=r[1],a=d(n,i),this._doRestoreChatrooms(a);case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"_getChatroomsFromStorage",value:function(){function e(){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._storage.getItem(re.IM_ROOM_LIST);case 3:if(t=e.sent){e.next=6;break}return e.abrupt("return",[]);case 6:if(r=t.jid,n=t.items,r===this._connection.getJid()){e.next=9;break}return e.abrupt("return",[]);case 9:return e.abrupt("return",n);case 12:return e.prev=12,e.t0=e.catch(0),e.t0 instanceof te.CryptoError||ae.warn("Cannot fully restore chat rooms.",e.t0),e.abrupt("return",[]);case 16:case"end":return e.stop()}},e,this,[[0,12]])}));return e}()},{key:"_syncGroups",value:function(){function e(e){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t){var r,n,i,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._pm.isActive()){e.next=2;break}return e.abrupt("return",this._delegateSyncGroups(t));case 2:return r={command:"ImManager:syncGroups",args:[t]},e.next=5,this._pm.request(r);case 5:if(n=e.sent,i=n.event,a=n.payload,s=n.error,"ImManager:syncGroups:failure"!==i){e.next=11;break}throw(0,V.deserializeError)(s);case 11:return e.abrupt("return",a);case 12:case"end":return e.stop()}},e,this)}));return e}()},{key:"_delegateSyncGroups",value:function(){function e(e){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t){var r,n,i=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=function(){var e=o(regeneratorRuntime.mark(function e(n){var a,s,o,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=function(){return i._groupService.fetchGroupMembership(t,n)},e.next=3,a().catch(function(){return a()});case 3:if(s=e.sent,!((o=s.length)<t)){e.next=7;break}return e.abrupt("return",s);case 7:return u=s[o-1].id,e.next=10,r(u);case 10:return c=e.sent,e.abrupt("return",s.concat(c));case 12:case"end":return e.stop()}},e,i)}));return function(t){return e.apply(this,arguments)}}(),n=void 0,e.prev=2,e.next=5,r();case 5:n=e.sent,e.next=12;break;case 8:return e.prev=8,e.t0=e.catch(2),ae.warn("Cannot fully restore chat rooms.",e.t0),e.abrupt("return",[]);case 12:return e.abrupt("return",n.map(function(e){return f({},e,{type:W.GROUP,lastUpdateTime:Date.now(),properties:(0,H.transformGroupProperties)(e.properties),personalProperties:(0,H.transformGroupProperties)(e.personalProperties)})}));case 13:case"end":return e.stop()}},e,this,[[2,8]])}));return e}()},{key:"_doRestoreChatrooms",value:function(e){var t=this;if(e.length){var r=e.reduce(function(e,r){var n=r.id;if(t.getRoom(n))return e;var i=void 0;return i=r.type===W.GROUP?t._doCreateGroup(n,r):t._doCreateRoom(n,r.lastUpdateTime),t._chatrooms[n]=i,i.init(),e.push(n),e},[]);this.emit(z.ROOM_LIST_UPDATED,{type:"add",ids:r})}}},{key:"_createRoom",value:function(){function e(e,r){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.getRoom(t))){e.next=3;break}return e.abrupt("return",n);case 3:return n=this._doCreateRoom(t,Date.now()),this._putRoomToList(n),r||(this._saveRoomListToStorage(),this._broadcastUpdate("ImManager:RoomCreated",{bareJid:t})),this.emit(z.ROOM_LIST_UPDATED,{type:"add",ids:[t]}),e.next=9,n.init();case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"_doCreateRoom",value:function(e,t){var r=g.Strophe.getBareJidFromJid(this._connection.getJid()),n={lastUpdateTime:t,participants:[{jid:e},{jid:r}]},i=this._getRoomConfig(),a=new G.default(e,r,n,this._pm,this._stateSync,this._imService,this._fileMgr,this._messageStore,i);return this._setupRoomEventHandlers(a),a}},{key:"_delegateCreateGroup",value:function(){function e(e,r){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r){var n,i,a,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._pm.isActive()){e.next=2;break}return e.abrupt("return",this._groupService.createGroup(t,r));case 2:return n={command:"ImManager:createGroup",args:[t,r]},e.next=5,this._pm.request(n);case 5:if(i=e.sent,a=i.event,s=i.payload,o=i.error,"ImManager:createGroup:failure"!==a){e.next=11;break}throw(0,V.deserializeError)(o);case 11:return e.abrupt("return",s);case 12:case"end":return e.stop()}},e,this)}));return e}()},{key:"_createGroup",value:function(){function e(e,r){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._doCreateGroup(t,r),this._putRoomToList(n),this._saveRoomListToStorage(),this._broadcastUpdate("ImManager:GroupJoined",r),this.emit(z.ROOM_LIST_UPDATED,{type:"add",ids:[t]}),e.next=7,n.init();case 7:return this.emit(z.GROUP_JOINED,(0,k.default)(r,["version","lastUpdateTime"])),e.abrupt("return",n);case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"_doCreateGroup",value:function(e,t){var r=g.Strophe.getBareJidFromJid(this._connection.getJid()),n=this._getRoomConfig(),i=new j.default(e,r,t,this._pm,this._stateSync,this._imService,this._groupService,this._fileMgr,this._messageStore,n);return this._setupGroupEventHandlers(i),i}},{key:"_delegateDeleteRoom",value:function(){function e(e,r){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._chatrooms[t].deinit(),delete this._chatrooms[t],delete this._tempGroups[t],r||(this._saveRoomListToStorage(),this._broadcastUpdate("ImManager:RoomDeleted",{id:t})),this._roomEventListeners[t].reset(),e.next=7,this._messageStore.deleteRoom(t);case 7:this.emit(z.ROOM_LIST_UPDATED,{type:"remove",ids:[t]});case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"_putRoomToList",value:function(e){var t=e.getId();this._chatrooms[t]=e}},{key:"_saveRoomListToStorage",value:function(){var e=Object.values(this._chatrooms).map(function(e){return e.getState()}),t={jid:this._connection.getJid(),items:e};this._storage.setItem(re.IM_ROOM_LIST,t)}},{key:"_setupRoomEventHandlers",value:function(e){var t=this,r=e.getId(),n=new A.default(e);n.add(z.INCOMING_MESSAGE,function(r){var n=r.roomId,i=r.message;t._putRoomToList(e),t._saveRoomListToStorage(),t.emit(z.INCOMING_MESSAGE,{roomId:n,message:i})}),n.add(z.OUTGOING_MESSAGE,function(r){var n=r.roomId,i=r.message;t._putRoomToList(e),t._saveRoomListToStorage(),t.emit(z.OUTGOING_MESSAGE,{roomId:n,message:i})}),n.add(z.CHAT_STATE_UPDATED,function(e){t.emit(z.CHAT_STATE_UPDATED,e)}),n.add(z.MESSAGE_UPDATED,function(e){var r=e.roomId,n=e.message;t.emit(z.MESSAGE_UPDATED,{roomId:r,message:n})}),n.add(z.MESSAGE_REMOVED,function(e){var r=e.roomId,n=e.message;t.emit(z.MESSAGE_REMOVED,{roomId:r,message:n})}),this._roomEventListeners[r]=n}},{key:"_createTempGroup",value:function(e){var t=new U.default(e);return this._tempGroups[e]=t,t}},{key:"_removeTempGroup",value:function(e){delete this._tempGroups[e]}},{key:"_addMessageToTempGroup",value:function(e,t){var r=this._getTempGroup(e);r||(r=this._createTempGroup(e)),r.addMessage(t)}},{key:"_getTempGroup",value:function(e){return this._tempGroups[e]||null}},{key:"_setTempGroupVersion",value:function(e,t){this._tempGroups[e]=this._getTempGroup(e)||this._createTempGroup(e),this._tempGroups[e].setVersion(t)}},{key:"_createGroupOnGroupJoin",value:function(){function e(e,r,n){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r,n){var i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._doCreateGroup(t,r),this._putRoomToList(i),n||(this._saveRoomListToStorage(),this._broadcastUpdate("ImManager:GroupJoined",(0,k.default)(r,"messages"))),this.emit(z.ROOM_LIST_UPDATED,{type:"add",ids:[t]}),e.next=6,i.init();case 6:a=(0,k.default)(r,["messages","version","lastUpdateTime"]),this.emit(z.GROUP_JOINED,a);case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"_restoreGroup",value:function(){function e(e){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t){var r,n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._restoreGroupPromises.has(t)){e.next=2;break}return e.abrupt("return",this._restoreGroupPromises.get(t));case 2:return r=o(regeneratorRuntime.mark(function e(){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n._fetchGroupState(t);case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,n._doRestoreGroup(t,r);case 7:case"end":return e.stop()}},e,n)}))(),this._restoreGroupPromises.set(t,r),e.next=6,r;case 6:this._restoreGroupPromises.delete(t);case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"_fetchGroupState",value:function(){function e(e){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,e.prev=1,e.next=4,this._groupService.fetchGroupDetails(t);case 4:r=e.sent,e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(1),ae.warn("Failed to fetch group details. "+e.t0),e.abrupt("return");case 11:return n=this._getTempGroup(t),r.messages=n.getMessages(),r.properties=(0,H.transformGroupProperties)(r.properties),r.personalProperties=(0,H.transformGroupProperties)(r.personalProperties),e.abrupt("return",r);case 16:case"end":return e.stop()}},e,this,[[1,7]])}));return e}()},{key:"_doRestoreGroup",value:function(){function e(e,r,n){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r,n){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.getRoom(t)){e.next=2;break}return e.abrupt("return");case 2:return i=this._doCreateGroup(t,r),this._putRoomToList(i),this._removeTempGroup(t),n||(this._saveRoomListToStorage(),this._broadcastUpdate("ImManager:GroupRestored",{id:t,state:r})),this.emit(z.ROOM_LIST_UPDATED,{type:"add",ids:[t]}),e.next=9,i.init();case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"_clearRooms",value:function(){var e=this;Object.keys(this._chatrooms).forEach(function(t){e._chatrooms[t].deinit(),e._roomEventListeners[t].reset()}),this._chatrooms={},this._tempGroups={},this._roomEventListeners={}}},{key:"_setupEventHandlers",value:function(){var e=this,t=new A.default(this._connection),r=new A.default(this._groupService);t.add(K.STATUS_CHANGED,function(t){var r=t.status,n=t.reconnect;r===ee.CONNECTED&&(n||e._clearRooms(),e._restoreChatrooms())}),r.add(z.GROUP_JOINED,function(){var t=o(regeneratorRuntime.mark(function t(r){var n,i,a,s,o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=r.groupId,!e.getRoom(r.groupId)){t.next=3;break}return t.abrupt("return");case 3:if(i=e._getTempGroup(n),a=Object.assign(c(r),{lastUpdateTime:Date.now()}),i){t.next=8;break}return e._createGroupOnGroupJoin(n,a),t.abrupt("return");case 8:if(s=i.getMessages(),r.version!==i.getVersion()){t.next=13;break}return a.messages=s,e._createGroupOnGroupJoin(n,a),t.abrupt("return");case 13:return t.next=15,e._fetchGroupState(n);case 15:o=t.sent,e._createGroupOnGroupJoin(n,o);case 17:case"end":return t.stop()}},t,e)}));return function(e){return t.apply(this,arguments)}}()),r.add(z.PARTICIPANTS_JOINED,function(t){e.getRoom(t.groupId)||e._setTempGroupVersion(t.groupId,t.version)}),r.add(z.PARTICIPANTS_LEFT,function(t){e.getRoom(t.groupId)||e._setTempGroupVersion(t.groupId,t.version)}),r.add(z.SUBJECT_CHANGED,function(t){e.getRoom(t.groupId)||e._setTempGroupVersion(t.groupId,t.version)}),r.add(z.PROPERTIES_CHANGED,function(t){e.getRoom(t.groupId)||e._setTempGroupVersion(t.groupId,t.version)}),r.add(z.ROLES_CHANGED,function(t){e.getRoom(t.groupId)||e._setTempGroupVersion(t.groupId,t.version)}),this._depsEventListeners.connection=t,this._depsEventListeners.groupService=r}},{key:"_setupMessageStoreEventHandlers",value:function(){var e=this,t=this._configMgr.get("messageSortingCriteria",Y.SERVER_TIME);this._messageStore=new L.default(this._pm,this._connection,this._imService,this._storage,this._history,{messageSortingCriteria:t});var r=new A.default(this._messageStore);r.add(z.INCOMING_MESSAGE,function(){var t=o(regeneratorRuntime.mark(function t(r){var n=r.roomId,i=r.message;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.getRoom(n)){t.next=2;break}return t.abrupt("return");case 2:if(i.target===W.GROUP){t.next=5;break}return e._emitNewMessage(z.INCOMING_MESSAGE,n,i),t.abrupt("return");case 5:if(e._addMessageToTempGroup(n,i),!e._pm.isActive()){t.next=9;break}return t.next=9,e._restoreGroup(n);case 9:case"end":return t.stop()}},t,e)}));return function(e){return t.apply(this,arguments)}}()),r.add(z.OUTGOING_MESSAGE,function(){var t=o(regeneratorRuntime.mark(function t(r){var n=r.roomId,i=r.message;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.getRoom(n)){t.next=2;break}return t.abrupt("return");case 2:if(i.target===W.GROUP){t.next=5;break}return e._emitNewMessage(z.OUTGOING_MESSAGE,n,i),t.abrupt("return");case 5:if(e._addMessageToTempGroup(n,i),!e._pm.isActive()){t.next=9;break}return t.next=9,e._restoreGroup(n);case 9:case"end":return t.stop()}},t,e)}));return function(e){return t.apply(this,arguments)}}()),this._depsEventListeners.messageStore=r}},{key:"_setupGroupEventHandlers",value:function(e){var t=this,r=new A.default(e),n=function(r,n){t._putRoomToList(e),t._saveRoomListToStorage(),t.emit(r,n)};r.add(z.INCOMING_MESSAGE,function(e){var r=e.roomId,n=e.message;t.emit(z.INCOMING_MESSAGE,{roomId:r,message:n})}),r.add(z.OUTGOING_MESSAGE,function(e){var r=e.roomId,n=e.message;t.emit(z.OUTGOING_MESSAGE,{roomId:r,message:n})}),r.add(z.MESSAGE_UPDATED,function(e){var r=e.roomId,n=e.message;t.emit(z.MESSAGE_UPDATED,{roomId:r,message:n})}),r.add(z.MESSAGE_REMOVED,function(e){var r=e.roomId,n=e.message;t.emit(z.MESSAGE_REMOVED,{roomId:r,message:n})}),r.add(z.CHAT_STATE_UPDATED,function(e){t.emit(z.CHAT_STATE_UPDATED,e)}),r.add(z.GROUP_JOINED,function(r){t._putRoomToList(e),t._saveRoomListToStorage();var n=c(r);t.emit(z.GROUP_JOINED,(0,k.default)(n,"version"))}),[z.PARTICIPANTS_JOINED,z.PARTICIPANTS_LEFT,z.GROUP_LEFT,z.ROLES_CHANGED,z.SUBJECT_CHANGED,z.PROPERTIES_CHANGED,z.PERSONAL_PROPERTIES_CHANGED,z.ERROR].forEach(function(e){r.add(e,n.bind(t,e))}),this._roomEventListeners[e.getId()]=r}},{key:"_setupPeerEventHandlers",value:function(){var e=this;this._peerCommandHandler.register("ImManager:createGroup",function(t,r){return e._groupService.createGroup(t,r)}),this._peerCommandHandler.register("ImManager:syncGroups",function(t){return e._delegateSyncGroups(t)});var t=new A.default(this._pm);t.add(X.MESSAGE_RECEIVED,function(t){var r=t.message,n=r.event,i=r.payload;if(n&&i)switch(n){case"ImManager:RoomCreated":e._createRoom(i.bareJid,!0);break;case"ImManager:RoomDeleted":e._delegateDeleteRoom(i.id,!0);break;case"ImManager:GroupJoined":if(e.getRoom(i.id))return;e._createGroupOnGroupJoin(i.id,i,!0);break;case"ImManager:GroupRestored":if(e.getRoom(i.id))return;e._doRestoreGroup(i.id,i.state,!0)}}),this._depsEventListeners.pm=t}},{key:"_emitNewMessage",value:function(){function e(e,r,n){return t.apply(this,arguments)}var t=o(regeneratorRuntime.mark(function e(t,r,n){var i,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=function(){a.emit(t,{roomId:r,message:n})},!this.getRoom(r)){e.next=4;break}return i(),e.abrupt("return");case 4:return e.next=6,this.createRoom(r);case 6:i();case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"_broadcastUpdate",value:function(e,t){this._pm.broadcast({event:e,payload:t})}},{key:"_getRoomConfig",value:function(){return{composingTimeout:this._configMgr.get("composing-timeout",ie.COMPOSING_TIMEOUT),composingFrequency:this._configMgr.get("composing-frequency",ie.COMPOSING_FREQUENCY),maxConcurrency:this._configMgr.get("maxConcurrency",ie.MAX_CONCURRENCY)}}}]),e}();t.default=se,e.exports=t.default},331:function(e,t,r){"use strict";function n(e,t,r,n,i){var o=n.url,u=n.name,c=n.type,d=n.size,l=n.duration,f=n.target,p=n.roomId,h=n.recordId,_=n.prevRecordId,v=new a.default(e,t,r,i);return Object.assign(v,{type:s.FILE,content:o,target:f,roomId:p,recordId:h,prevRecordId:_,file:{name:u,type:c,size:d,duration:l}}),v}Object.defineProperty(t,"__esModule",{value:!0});var i=r(77),a=function(e){return e&&e.__esModule?e:{default:e}}(i),s=r(48);t.default={create:n},e.exports=t.default},332:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function u(e){return Array.isArray(e)?e:Array.from(e)}function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e){return e instanceof Blob&&e.type.includes("image")}function l(e){var t=new FileReader;return new Promise(function(r,n){t.onloadend=function(e){var t=e.target,i=t.result,a=t.error;if(a)return void n(a);r(i)},t.onerror=function(e){var t=e.target;n(t.error)},t.readAsDataURL(e)})}function f(e){return e===N.MEMBER||e===N.ADMIN}function p(e,t){return t.some(function(t){return t.jid===e})}function h(e,t){return t.find(function(t){return t.jid===e}).role}function _(e){return e.reduce(function(e,t){return Object.assign(e,c({},t.jid,t.role))},{})}function v(e){return e.endsWith(":failure")}function g(e,t){var r=new Map,n=function(e,t){if(r.has(e))throw new J.ConflictError("Cannot register handler for a command twice.");r.set(e,t)};return t.on(j.REQUEST_RECEIVED,function(n){var i=n.requestId,a=n.message,s=a.command,c=a.args;if(r.has(s)){var d=u(c),l=d[0],f=d.slice(1);if(l===e){r.get(s).apply(void 0,o(f)).then(function(r){t.respond(i,{event:s+":success",payload:Object.assign({},{groupId:e},r)})}).catch(function(r){t.respond(i,{event:s+":failure",payload:{groupId:e},error:(0,L.serializeError)(r)})})}}}),{register:n}}Object.defineProperty(t,"__esModule",{value:!0});var m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},y=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),E=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(n)},b=r(200),S=n(b),I=r(61),R=n(I),M=r(12),P=n(M),k=r(6),O=n(k),A=r(205),C=n(A),w=r(24),T=r(58),G=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(T),D=r(48),j=r(11),N=r(93),U=r(333),x=r(3),L=r(30),H=r(10),F=r(7),J=r(0),B=x.LoggerFactory.getInstance().getLogger("im/Group"),V=function(e){function t(e,r,n,s,o,u,c,d,l,f){i(this,t);var p=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,n,s,o,u,d,l,f));return p._groupService=c,p._subject=n.subject,p._version=n.version,p._owner=n.owner,p._properties=n.properties||{},p._personalProperties=n.personalProperties||{},p._readonly=n.readonly||!1,p._syncRequestDeferred=null,p._shouldDoubleSync=!1,p._changes=new Map,p._peerCommandHandler=g(e,p._pm),p._setupGroupServiceEventHandlers(),p._setupErrorHandlers(),n.messages&&n.messages.length>0&&n.messages.forEach(function(e){p.addMessage(e)}),p}return s(t,e),y(t,[{key:"inviteParticipants",value:function(e){var t=this;return Promise.resolve().then(function(){(0,O.default)("bareJids",e,function(e){return(0,H.isArray)(e)&&e.length>0},"Expect bareJids to be non-empty array"),(0,O.default)("bareJids",e,function(e){return e.every(function(e){return(0,F.isBareJid)(e)})},"Expect entries in bareJids to be bare JID");var r=t._ensureNewParticipants(e);return 0===r.length?Promise.resolve():t._delegateInviteParticipants(r).then(function(e){var n=e.version,i=r.map(function(e){return{jid:e,role:N.MEMBER}});t._handleParticipantsAdded(i,n)})})}},{key:"kickParticipants",value:function(e){var t=this;return Promise.resolve().then(function(){(0,O.default)("bareJids",e,function(e){return(0,H.isArray)(e)&&e.length>0},"Expect bareJids to be non-empty array"),(0,O.default)("bareJids",e,function(e){return e.every(function(e){return(0,F.isBareJid)(e)})},"Expect entries in bareJids to be bare JID")}).then(function(){return t._delegateKickParticipants(e)}).then(function(r){var n=r.version;t._handleParticipantsRemoved(e,n)})}},{key:"changeParticipantRoles",value:function(e){var t=this;return Promise.resolve().then(function(){(0,O.default)("roles",e,function(e){return e&&Object.keys(e).length>0},"Expect roles to be non-empty object"),(0,O.default)("roles",e,function(r){return Object.keys(r).every(function(r){return(0,F.isBareJid)(r)&&t._isUserInRoom(r)&&f(e[r])})},"Expect bare JID of group member as the key and a valid role as value")}).then(function(){return t._delegateChangeParticipantRoles(e)}).then(function(r){var n=r.version;t._handleRolesChanged(e,n)})}},{key:"leave",value:function(){var e=this;return this._delegateLeaveGroup().then(function(t){var r=t.version;e._handleGroupLeft(r)})}},{key:"mute",value:function(){if(this.isMuted())return Promise.resolve();var e={notification:"off"};return this._changePersonalProperties(e)}},{key:"unmute",value:function(){if(!this.isMuted())return Promise.resolve();var e={notification:"on"};return this._changePersonalProperties(e)}},{key:"enableSmartNotification",value:function(){if(this.isSmartNotificationEnabled())return Promise.resolve();var e={"smart-notification":"on"};return this._changePersonalProperties(e)}},{key:"disableSmartNotification",value:function(){if(!this.isSmartNotificationEnabled())return Promise.resolve();var e={"smart-notification":"off"};return this._changePersonalProperties(e)}},{key:"changeSubject",value:function(e){var t=this,r={action:"changeSubject",oldValue:this._subject,newValue:e};return this._delegateChangeSubject(e).then(function(n){var i=n.messageId,a=n.version;t._changes.set(i,r),t._handleSubjectChanged(e,a)})}},{key:"setGroupImage",value:function(e){var t=this;return Promise.resolve().then(function(){return(0,O.default)("param",e,d,"Group image requires image file"),(0,O.default)("param",e,function(e){return e.size<6e4},"The image file size exceeds the limit of 60000 bytes."),l(e).then(function(e){var r={groupImage:e};return t._changeProperties(r)})})}},{key:"sendTextMessage",value:function(e){if(!(0,H.isString)(e))return null;var t=this._composeMessage(D.TEXT,{content:e});return this._sendMessage(t),t}},{key:"getCurrentChatState",value:function(e){if(!this._participantChatStateHandlers.has(e))throw new J.NotFoundError("Cannot find the chat state of the specified participant in the group");return this._participantChatStateHandlers.get(e).getState()}},{key:"getType",value:function(){return w.GROUP}},{key:"getSubject",value:function(){return this._subject}},{key:"getVersion",value:function(){return this._version}},{key:"getOwner",value:function(){return this._owner}},{key:"getProperties",value:function(){return this._properties}},{key:"isMuted",value:function(){return"off"===this._personalProperties.notification}},{key:"isSmartNotificationEnabled",value:function(){return"on"===this._personalProperties["smart-notification"]}},{key:"getState",value:function(){var e={owner:this.getOwner(),version:this.getVersion(),subject:this.getSubject(),properties:this.getProperties(),personalProperties:this._personalProperties};return Object.assign({},E(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getState",this).call(this),e)}},{key:"_decorateMethods",value:function(){E(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_decorateMethods",this).call(this),this._decorateMethodWithWritableCheck("inviteParticipants",!0),this._decorateMethodWithWritableCheck("kickParticipants",!0),this._decorateMethodWithWritableCheck("changeParticipantRoles",!0),this._decorateMethodWithWritableCheck("leave",!0),this._decorateMethodWithWritableCheck("changeSubject",!0),this._decorateMethodWithWritableCheck("setGroupImage",!0)}},{key:"_setupGroupServiceEventHandlers",value:function(){var e=this;this._groupServiceEventHandler=new P.default(this._groupService),this._groupServiceEventHandler.add(G.GROUP_JOINED,function(t){t.groupId===e.getId()&&(e._isUserInRoom(e._jid)||e._handleGroupJoined(t,!0))}),this._groupServiceEventHandler.add(G.PARTICIPANTS_JOINED,function(t){if(t.groupId===e.getId()){var r=t.version,n=t.participants,i=e._ensureNewParticipants(n);e._handleParticipantsAdded(i,r)}}),this._groupServiceEventHandler.add(G.PARTICIPANTS_LEFT,function(t){if(t.groupId===e.getId()){var r=t.version,n=t.participants;e._handleParticipantsRemoved(n,r)}}),this._groupServiceEventHandler.add(G.ROLES_CHANGED,function(t){if(t.groupId===e.getId()){var r=t.version,n=t.participants;e._handleRolesChanged(n,r)}}),this._groupServiceEventHandler.add(G.GROUP_LEFT,function(t){t.groupId===e.getId()&&e._handleGroupLeft(t.version)}),this._groupServiceEventHandler.add(G.PROPERTIES_CHANGED,function(t){if(t.groupId===e.getId()){var r=t.properties,n=t.version,i=m({},e._properties,(0,U.transformGroupProperties)(r));e._handlePropertiesChanged(i,n)}}),this._groupServiceEventHandler.add(G.SUBJECT_CHANGED,function(t){if(t.groupId===e.getId()){var r=t.subject,n=t.version;e._handleSubjectChanged(r,n)}}),this._groupServiceEventHandler.add(G.GROUP_VERSION,function(t){var r=t.groupId,n=t.version;r===e.getId()&&n!==e.getVersion()&&e._syncGroupDetails().catch(function(e){B.error("Cannot sync group details: "+e.message)})})}},{key:"_setupErrorHandlers",value:function(){var e=this;this._groupService.on(G.ERROR,function(t){var r=t.groupId,n=t.messageId,i=t.error;if(!e._changes.has(n))return void e._pm.broadcast({event:G.ERROR,payload:{groupId:r,messageId:n},error:(0,L.serializeError)(i)});e._syncGroupDetails().then(function(){var t=e._changes.get(n);t.error=i,e._changes.delete(n),e.emit(G.ERROR,t)}).catch(function(e){B.error("Cannot sync group details: "+e.message)})})}},{key:"_setupPeerEventHandlers",value:function(){var e=this;E(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setupPeerEventHandlers",this).call(this),this._peerCommandHandler.register("Group:inviteParticipants",function(t){return e._groupService.addParticipants(e.getId(),t)}),this._peerCommandHandler.register("Group:kickParticipants",function(t){return e._groupService.removeParticipants(e.getId(),t)}),this._peerCommandHandler.register("Group:changeParticipantRoles",function(t){return e._groupService.changeParticipantRoles(e.getId(),t)}),this._peerCommandHandler.register("Group:leave",function(){return e._groupService.leaveGroup(e.getId())}),this._peerCommandHandler.register("Group:changePersonalProperties",function(t){return e._groupService.changePersonalProperties(e.getId(),t)}),this._peerCommandHandler.register("Group:changeSubject",function(t){return e._handleChangeSubjectRequest(t)}),this._peerCommandHandler.register("Group:changeProperties",function(t){return e._groupService.changeGroupProperties(e.getId(),t)}),this._peerCommandHandler.register("Group:fetchDetails",function(){return e._fetchDetails()}),this._pm.on(j.MESSAGE_RECEIVED,function(t){var r=t.message,n=r.event,i=r.payload,a=r.error;if(i&&i.groupId===e.getId())switch(n){case G.PARTICIPANTS_JOINED:e._addParticipantsAndEmitEvent(i.participants,i.version);break;case G.PARTICIPANTS_LEFT:e._removeParticipantsAndEmitEvent(i.participants,i.version);break;case G.ROLES_CHANGED:e._updateRolesAndEmitEvent(i.participants,i.version);break;case G.GROUP_JOINED:e._handleGroupJoined(i);break;case G.GROUP_LEFT:e._leaveGroupAndEmitEvent(i.version);break;case G.PERSONAL_PROPERTIES_CHANGED:e._updatePersonalPropertiesAndEmitEvent(i.personalProperties,i.version);break;case G.SUBJECT_CHANGED:e._updateSubjectAndEmitEvent(i.subject,i.version);break;case G.PROPERTIES_CHANGED:e._updatePropertiesAndEmitEvent(i.properties,i.version);break;case G.ERROR:e._handleMessageStanzaRequestError(i.messageId,a)}})}},{key:"_removeParticipantChatStateHandler",value:function(e){this._participantChatStateHandlers.has(e)&&(this._participantChatStateHandlers.delete(e),this._participantChatStateEventHandlers.get(e).reset(),this._participantChatStateEventHandlers.delete(e))}},{key:"_sendComposingState",value:function(){this._pm.isActive()&&this._imService.sendComposingState(this.getId(),w.GROUP)}},{key:"_sendActiveState",value:function(){this._pm.isActive()&&this._imService.sendActiveState(this.getId(),w.GROUP)}},{key:"_handleChangeSubjectRequest",value:function(e){return this._groupService.changeGroupSubject(this.getId(),e).then(function(t){var r=t.messageId;return{subject:e,messageId:r}})}},{key:"_handleParticipantsAdded",value:function(e,t){var r=this;if(t>this.getVersion()+1)return void this._syncGroupDetails().catch(function(t){B.error("Cannot sync group details: "+t.message),r._addParticipantsAndEmitEvent(e,r.getVersion(),!0)});this._addParticipantsAndEmitEvent(e,t,!0)}},{key:"_addParticipantsAndEmitEvent",value:function(e,t,r){var n=this;this._addParticipants(e,t),e.forEach(function(e){var t=e.jid;n._addParticipantChatStateHandler(t)});var i=this._buildEventPayload({participants:e});this.emit(G.PARTICIPANTS_JOINED,i),r&&this._broadcastUpdate(G.PARTICIPANTS_JOINED,i)}},{key:"_handleParticipantsRemoved",value:function(e,t){var r=this;if(t>this.getVersion()+1)return void this._syncGroupDetails().catch(function(t){B.error("Cannot sync group details: "+t.message),r._removeParticipantsAndEmitEvent(e,r.getVersion(),!0)});this._removeParticipantsAndEmitEvent(e,t,!0)}},{key:"_removeParticipantsAndEmitEvent",value:function(e,t,r){this._removeParticipants(e,t),e.forEach(this._removeParticipantChatStateHandler.bind(this));var n=this._buildEventPayload({participants:e});this.emit(G.PARTICIPANTS_LEFT,n),r&&this._broadcastUpdate(G.PARTICIPANTS_LEFT,n)}},{key:"_handleRolesChanged",value:function(e,t){var r=this;if(t>this.getVersion()+1)return void this._syncGroupDetails().catch(function(t){B.error("Cannot sync group details: "+t.message),r._updateRolesAndEmitEvent(e,r.getVersion(),!0)});this._updateRolesAndEmitEvent(e,t,!0)}},{key:"_updateRolesAndEmitEvent",value:function(e,t,r){this._updateRoles(e,t);var n=this._buildEventPayload({participants:e});this.emit(G.ROLES_CHANGED,n),r&&this._broadcastUpdate(G.ROLES_CHANGED,n)}},{key:"_handleParticipantsChanged",value:function(e,t,r){var n=this,i=this.getParticipants(),a=_(i),s=[],o=[],u={};e.forEach(function(e){var t=e.jid,r=e.role;p(t,i)&&r!==a[t]&&(u[t]=r),t===n._jid||p(t,i)||s.push({jid:t,role:r})}),i.forEach(function(t){var r=t.jid;r===n._jid||p(r,e)||o.push(r)}),s.length>0&&this._addParticipantsAndEmitEvent(s,t,r),o.length>0&&this._removeParticipantsAndEmitEvent(o,t,r),Object.keys(u).length>0&&this._updateRolesAndEmitEvent(u,t,r)}},{key:"_handleGroupJoined",value:function(e,t){var r=e.participants,n=e.version,i=h(this._jid,r),a={jid:this._jid,role:i};this._addParticipants([a],n),this._unsetReadonly(),this._handleGroupDetailSync(e,t),this.emit(G.GROUP_JOINED,e),t&&this._broadcastUpdate(G.GROUP_JOINED,e)}},{key:"_handleGroupLeft",value:function(e){var t=this;if(e>this.getVersion()+1)return void this._syncGroupDetails().catch(function(e){B.error("Cannot sync group details: "+e.message),t._leaveGroupAndEmitEvent(t.getVersion(),!0)});this._leaveGroupAndEmitEvent(e,!0)}},{key:"_leaveGroupAndEmitEvent",value:function(e,t){this._removeParticipants([this._jid],e),this._setReadonly();var r=this._buildEventPayload();this.emit(G.GROUP_LEFT,r),t&&this._broadcastUpdate(G.GROUP_LEFT,r)}},{key:"_handleSubjectChanged",value:function(e,t){var r=this;if(t>this.getVersion()+1)return void this._syncGroupDetails().catch(function(t){B.error("Cannot sync group details: "+t.message),r._updateSubjectAndEmitEvent(e,r.getVersion(),!0)});this._updateSubjectAndEmitEvent(e,t,!0)}},{key:"_updateSubjectAndEmitEvent",value:function(e,t,r){this._updateSubject(e,t);var n=this._buildEventPayload({subject:e});this.emit(G.SUBJECT_CHANGED,n),r&&this._broadcastUpdate(G.SUBJECT_CHANGED,n)}},{key:"_handlePersonalPropertiesChanged",value:function(e,t){var r=this;if(t>this.getVersion()+1)return void this._syncGroupDetails().catch(function(t){B.error("Cannot sync group details: "+t.message),r._updatePersonalPropertiesAndEmitEvent(e,r.getVersion(),!0)});this._updatePersonalPropertiesAndEmitEvent(e,t,!0)}},{key:"_updatePersonalPropertiesAndEmitEvent",value:function(e,t,r){this._updatePersonalProperties(e,t);var n=this._buildEventPayload({personalProperties:e});this.emit(G.PERSONAL_PROPERTIES_CHANGED,n),r&&this._broadcastUpdate(G.PERSONAL_PROPERTIES_CHANGED,n)}},{key:"_handlePropertiesChanged",value:function(e,t){var r=this;if(t>this.getVersion()+1)return void this._syncGroupDetails().catch(function(t){B.error("Cannot sync group details: "+t.message),r._updatePropertiesAndEmitEvent(e,r.getVersion(),!0)});this._updatePropertiesAndEmitEvent(e,t,!0)}},{key:"_updatePropertiesAndEmitEvent",value:function(e,t,r){this._updateProperties(e,t);var n=this._buildEventPayload({properties:e});this.emit(G.PROPERTIES_CHANGED,n),r&&this._broadcastUpdate(G.PROPERTIES_CHANGED,n)}},{key:"_handleGroupDetailSync",value:function(e,t){var r=e.version,n=e.subject,i=e.properties,a=e.personalProperties,s=e.participants,o=this.getParticipants();this._subject!==n&&this._updateSubjectAndEmitEvent(n,r,t);var u=(0,U.transformGroupProperties)(i);(0,S.default)(this._properties,u)||this._updatePropertiesAndEmitEvent(u,r,t);var c=(0,U.transformGroupProperties)(a);(0,S.default)(this._personalProperties,c)||this._updatePersonalPropertiesAndEmitEvent(c,r,t);var d=p(this._jid,o),l=p(this._jid,s);this._handleParticipantsChanged(s,r,t),!l&&d&&this._leaveGroupAndEmitEvent(r,t),l&&!d&&this._handleGroupJoined(e,t),this._version!==r&&this._updateVersion(r)}},{key:"_handleMessageStanzaRequestError",value:function(e,t){var r=this;return this._changes.has(e)?this._syncGroupDetails().then(function(){var n=r._changes.get(e);n.error=(0,L.deserializeError)(t),r._changes.delete(e),r.emit(G.ERROR,n)}).catch(function(e){B.error("Cannot sync group details: "+e.message)}):Promise.resolve()}},{key:"_delegateInviteParticipants",value:function(e){return this._pm.isActive()?this._groupService.addParticipants(this.getId(),e):this._requestPeer("Group:inviteParticipants",[e])}},{key:"_delegateKickParticipants",value:function(e){return this._pm.isActive()?this._groupService.removeParticipants(this.getId(),e):this._requestPeer("Group:kickParticipants",[e])}},{key:"_delegateChangeParticipantRoles",value:function(e){return this._pm.isActive()?this._groupService.changeParticipantRoles(this.getId(),e):this._requestPeer("Group:changeParticipantRoles",[e])}},{key:"_delegateLeaveGroup",value:function(){var e=this;return this._pm.isActive()?this._groupService.leaveGroup(this.getId()).then(function(){return{version:e.getVersion()+1}}):this._requestPeer("Group:leave").then(function(){return{version:e.getVersion()+1}})}},{key:"_delegateChangeSubject",value:function(e){var t=this;return this._pm.isActive()?this._groupService.changeGroupSubject(this.getId(),e).then(function(e){var r=e.messageId;return{version:t.getVersion()+1,messageId:r}}):this._requestPeer("Group:changeSubject",[e]).then(function(e){var r=e.messageId;return{version:t.getVersion()+1,messageId:r}})}},{key:"_changeProperties",value:function(e){var t=this,r=Object.assign({},this._properties),n=Object.assign({},r,e),i={action:"changeProperties",oldValue:r,newValue:n};return this._delegateChangeProperties(e).then(function(e){var r=e.messageId;t._changes.set(r,i),t._handlePropertiesChanged(n,t.getVersion()+1)})}},{key:"_delegateChangeProperties",value:function(e){return this._pm.isActive()?this._groupService.changeGroupProperties(this.getId(),e):this._requestPeer("Group:changeProperties",[e])}},{key:"_changePersonalProperties",value:function(e){var t=this;return this._delegateChangePersonalProperties(e).then(function(r){var n=r.version;t._handlePersonalPropertiesChanged(e,n)})}},{key:"_delegateChangePersonalProperties",value:function(e){return this._pm.isActive()?this._groupService.changePersonalProperties(this.getId(),e):this._requestPeer("Group:changePersonalProperties",[e])}},{key:"_syncGroupDetails",value:function(){return this._syncRequestDeferred?(this._shouldDoubleSync=!0,Promise.resolve(this._syncRequestDeferred)):this._delegateSyncGroupDetails()}},{key:"_delegateSyncGroupDetails",value:function(){var e=this;return this._syncRequestDeferred=this._fetchDetails().then(function(t){if(e._syncRequestDeferred=null,e._handleGroupDetailSync(t,!0),e._shouldDoubleSync)return e._shouldDoubleSync=!1,e._delegateSyncGroupDetails()}).catch(function(t){if(e._syncRequestDeferred=null,e._shouldDoubleSync)return e._shouldDoubleSync=!1,e._delegateSyncGroupDetails();throw t}),this._syncRequestDeferred}},{key:"_fetchDetails",value:function(){return this._pm.isActive()?this._groupService.fetchGroupDetails(this.getId()):this._requestPeer("Group:fetchDetails")}},{key:"_addParticipants",value:function(e,t){this._participants=this._participants.concat(e),this._updateVersion(t)}},{key:"_removeParticipants",value:function(e,t){this._participants=this._participants.filter(function(t){return!e.includes(t.jid)}),this._updateVersion(t)}},{key:"_updateRoles",value:function(e,t){var r=Object.keys(e).map(function(t){return{jid:t,role:e[t]}});this._participants=this._participants.filter(function(t){return!e[t.jid]}).concat(r),this._updateVersion(t)}},{key:"_updatePersonalProperties",value:function(e,t){this._personalProperties=Object.assign({},this._personalProperties,e),this._updateVersion(t)}},{key:"_updateSubject",value:function(e,t){this._subject=e,this._updateVersion(t)}},{key:"_updateVersion",value:function(e){this._version=e}},{key:"_updateProperties",value:function(e,t){this._properties=e,this._updateVersion(t)}},{key:"_requestPeer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return this._pm.request({command:e,args:[this.getId()].concat(o(t))}).catch(function(t){return B.warn("Encounter error while sending "+e+": "+t.message),{event:e+":failure",error:{name:"TimeoutError",message:"Request timeout. Please retry later."}}}).then(function(e){var t=e.event,r=e.payload,n=e.error;if(v(t))throw(0,L.deserializeError)(n);return r})}},{key:"_broadcastUpdate",value:function(e,t){this._pm.broadcast({event:e,payload:t})}},{key:"_buildEventPayload",value:function(e){var t={groupId:this.getId(),version:this.getVersion()};return Object.assign({},t,e)}},{key:"_ensureNewParticipants",value:function(e){var t=this;return e.filter(function(e){return(0,R.default)(e)?!t._isUserInRoom(e.jid):!t._isUserInRoom(e)})}}]),t}(C.default);t.default=V,e.exports=t.default},333:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,c.default)("properties",e,o.default,"Expect group properties to be Object type.");var t={};return Object.entries(e).forEach(function(e){var r=a(e,2),n=r[0],i=r[1],s=i.value,o=i.content;if("groupImage"===n){var u=o||"";return void(t[n]=(0,d.addImageDataPrefix)(u))}t[n]=s}),t}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();t.transformGroupProperties=i;var s=r(9),o=n(s),u=r(6),c=n(u),d=r(206)},334:function(e,t){function r(e,t,r){for(var n=-1,i=null==e?0:e.length;++n<i;)if(r(t,e[n]))return!0;return!1}e.exports=r},335:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return"history:"+e}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(2),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=r(79),c=r(207),d=r(3),l=r(14),f=r(0),p=d.LoggerFactory.getInstance().getLogger("im/history/MessageCache"),h=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,e),this._storage=t,this._sortMessage=r.messageSortingCriteria===u.CLIENT_TIME?c.sortByClientTime:c.sortByServerTime,this._writingAction=Promise.resolve()}return a(e,[{key:"read",value:function(e){var t=this,r=i(e);return this._storage.getItem(r).then(function(e){return e=e||[],{history:e}}).catch(function(e){return e instanceof f.CryptoError&&t._storage.removeItem(r),{history:[]}})}},{key:"put",value:function(e,t){var r=this,n=(0,o.default)(t)?t:[t];return this._writingAction=this._writingAction.then(function(){return r.read(e)}).then(function(t){var i=t.history;return r._doPut(e,i,n)}),this._writingAction}},{key:"delete",value:function(e,t){var r=this,n=(0,o.default)(t)?t:[t];return this._writingAction=this._writingAction.then(function(){return r.read(e)}).then(function(t){var i=t.history;return r._doDelete(e,i,n)}),this._writingAction}},{key:"clearRoom",value:function(e){var t=this;return this._writingAction=this._writingAction.then(function(){return t._storage.setItem(i(e),[])}),this._writingAction}},{key:"deleteRoom",value:function(e){var t=this;return this._writingAction=this._writingAction.then(function(){return t._removeFromRoomList(e).then(function(){return t._storage.removeItem(i(e))})}),this._writingAction}},{key:"getRoomList",value:function(){return this._storage.getItem(l.ROOM_LIST).then(function(e){return e||[]}).catch(function(e){return p.warn("Cannot get room list from storage, empty list is used. ",e.message),[]})}},{key:"_doPut",value:function(e,t,r){var n=t.slice(0);return r.forEach(function(e){var t=e.id,r=n.findIndex(function(e){return t===e.id});r<0?n.push(e):n.splice(r,1,e)}),this._sortMessage(n),this._storage.setItem(i(e),n)}},{key:"_doDelete",value:function(e,t,r){var n=t.slice(0),a=!1;return r.forEach(function(e){var t=n.findIndex(function(t){return e===t.id});t>=0&&(n.splice(t,1),a=!0)}),a?this._storage.setItem(i(e),n):Promise.resolve()}},{key:"_removeFromRoomList",value:function(e){var t=this;return this.getRoomList().then(function(r){var n=r.indexOf(e);n<0||(r.splice(n,1),t._storage.setItem(l.ROOM_LIST,r))})}}]),e}();t.default=h,e.exports=t.default},336:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){return e<10?"0"+e:""+e}function s(e){if(!e)return _;var t=new Date(e),r=t.getFullYear(),n=t.getMonth()+1,i=t.getDate(),s=t.getHours();return""+r%100+a(n)+a(i)+a(s)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(71),c=n(u),d=r(79),l=r(208),f=n(l),p=r(10),h=r(0),_="no-ts",v=void 0,g=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this._buckets={},this._head=void 0,this._idHashes={},this._opts=(0,c.default)(t,["messageSortingCriteria"]),v=this._opts.messageSortingCriteria===d.CLIENT_TIME?"ts":"serverTs"}return o(e,[{key:"put",value:function(e){var t=this;((0,p.isArray)(e)?e:[e]).forEach(function(e){t._insertOrUpdate(e)})}},{key:"delete",value:function(e){var t=this;((0,p.isArray)(e)?e:[e]).forEach(function(e){t._deleteOneFromBucket(e)})}},{key:"getOne",value:function(e){var t=this._idHashes[e];if(t)return this._buckets[t].bucket.getOne(e)}},{key:"getSome",value:function(e,t,r,n){return r?this._getSomeByReference(e,t,r,n):!this._head||n?[]:this._getSomeWithoutReference(e,t)}},{key:"getAll",value:function(){for(var e=this._head,t=[];e;)t=e.bucket.getAll().concat(t),e=this._buckets[e.nextId];return t}},{key:"getCount",value:function(){for(var e=this._head,t=0;e;)t+=e.bucket.getCount(),e=this._buckets[e.nextId];return t}},{key:"getBucket",value:function(e){if(this._buckets[e])return this._buckets[e].bucket}},{key:"getBucketIds",value:function(){for(var e=[],t=this._head;t;)e.push(t.id),t=this._buckets[t.nextId];return e}},{key:"_getSomeByReference",value:function(e,t,r,n){if(!(0,p.isNumber)(r)){if(!this._idHashes[r])throw new h.NotFoundError("message with id "+r+" does not exist");return this._getSomeFromBucketsById(e,t,r,this._idHashes[r],n)}return this._getSomeFromBucketsByTime(e,t,r,s(r),n)}},{key:"_getSomeWithoutReference",value:function(e,t){for(var r=[],n=e,i=this._head;n>0&&i;){var a=i.bucket.getSome(n,t);r=a.concat(r),n-=a.length,i=this._buckets[i.nextId]}return r}},{key:"_getSomeFromBucketsById",value:function(e,t,r,n,i){var a=[],s=e,o=this._buckets[n],u=void 0,c=o.bucket.getSome(s,t,r,i);if(a=c,0===(s-=c.length))return a;if(0===a.length){u=o.bucket.getOne(r)[v]}else u=a[0][v];return(o=this._buckets[i?o.prevId:o.nextId])?a=i?a.concat(this._getSomeFromBucketsByTime(s,t,u,o.id,i)):this._getSomeFromBucketsByTime(s,t,u,o.id,i).concat(a):a}},{key:"_getSomeFromBucketsByTime",value:function(e,t,r,n,i){for(var a=[],s=e,o=this._buckets[n];s>0&&o;){var u=o.bucket.getSome(s,t,r,i);s-=u.length,i?(a=a.concat(u),o=this._buckets[o.prevId]):(a=u.concat(a),o=this._buckets[o.nextId])}return a}},{key:"_insertOrUpdate",value:function(e){this._deleteOneFromBucket(e.id);var t=s(e[v]),r=this.getBucket(t);r||(r=this._createBucket(t)),r.put(e),this._idHashes[e.id]=t}},{key:"_deleteOneFromBucket",value:function(e){var t=this._idHashes[e];t&&this._buckets[t].bucket.delete(e)}},{key:"_createBucket",value:function(e){if(!this._head)return this._createBucketAsHead(e);if(this._head.id<e)return this._createBucketAsHead(e,this._head.id);for(var t=this._head;t.nextId>e;)t=this._buckets[t.nextId];return this._createBucketInMiddle(e,t.id,t.nextId)}},{key:"_createBucketAsHead",value:function(e,t){var r=new f.default(this._opts);return this._head=this._buckets[e]={bucket:r,id:e,nextId:t,prevId:void 0},this._buckets[t]&&(this._buckets[t].prevId=e),r}},{key:"_createBucketInMiddle",value:function(e,t,r){var n=new f.default(this._opts);return this._buckets[e]={bucket:n,id:e,nextId:r,prevId:t},this._buckets[t].nextId=e,this._buckets[r]&&(this._buckets[r].prevId=e),n}}]),e}();t.default=g,e.exports=t.default},337:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BEFORE="before",t.AFTER="after"},338:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1),s=r(16),o=r(5),u=function(e){return e&&e.__esModule?e:{default:e}}(o),c=r(3),d=r(56),l=c.LoggerFactory.getInstance().getLogger("core/xmpp/strophe/plugin/BufferedStrophePlugin"),f=function(){function e(t,r){n(this,e),this._stanzaProps=t,this._fallbackHandler=r,this._handlers=[]}return i(e,[{key:"init",value:function(e){this._conn=e}},{key:"register",value:function(e){this._handlers.push(e)}},{key:"statusChanged",value:function(e){var t=void 0;switch(e){case a.Strophe.Status.CONNECTED:t=s.addStanzaHandler;break;case a.Strophe.Status.ATTACHED:t=s.addDelayedStanzaHandler;break;default:return}t(this._conn,this._stanzaProps,this.handleStanza.bind(this),d.STANZA_DELAY_MS)}},{key:"handleStanza",value:function(e){var t=!1;return this._handlers.forEach(function(r){try{r.canHandle(e)&&(t=r.handle(e)||t)}catch(e){l.warn("Failed to handle the stanza: "+e)}}),t||(l.warn("Unsupported stanza <"+(0,u.default)(e).name()+">"),this._fallbackHandler&&this._fallbackHandler.handle(e)),!0}}]),e}();t.default=f,e.exports=t.default},339:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(704),s=function(e){return e&&e.__esModule?e:{default:e}}(a),o=r(7),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,o.isTextMessage)(e)||(0,o.isFileMessage)(e)}},{key:"parse",value:function(e){return(0,s.default)(e)}}]),e}();t.default=u,e.exports=t.default},340:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!!e.children().find(function(e){return e.name()===t})}function a(e){var t=void 0;if(i(e,p.COMPOSING))t=p.COMPOSING;else{if(!i(e,p.ACTIVE))return null;t=p.ACTIVE}return t}function s(e){var t=e.findFirst("thread");return t?t.content():null}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(1),c=r(3),d=r(5),l=function(e){return e&&e.__esModule?e:{default:e}}(d),f=r(92),p=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(f),h=c.LoggerFactory.getInstance().getLogger("im/message/parser/ChatStateParser"),_=function(){function e(){n(this,e)}return o(e,[{key:"parse",value:function(e){var t=(0,l.default)(e),r=a(t);if(!r)return h.error("Unknown Chat States notification received: ",e),null;var n=u.Strophe.getBareJidFromJid(t.attr("from")),i=n;return"groupchat"!==t.attr("type")||(i=s(t))?{roomId:i,type:r,jid:n}:(h.warn("No group id from the group Chat States notification received: ",e),null)}},{key:"canParse",value:function(e){var t=(0,l.default)(e);return!(!a(t)||"groupchat"===t.attr("type")&&!s(t)&&(h.warn("No group id from the group Chat States notification received: ",e),1))}}]),e}();t.default=_,e.exports=t.default},341:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(706),s=r(78),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(s),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(){return!0}},{key:"parse",value:function(e){e.getAttribute("ts")||e.setAttribute("ts",(new Date).toISOString());var t=(0,a.parseStanza)(e);return Object.assign({},t,{status:o.SUCCESS,serverTs:t.ts,deliveryTs:Date.now()})}}]),e}();t.default=u,e.exports=t.default},342:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e){var t=e.messageId,r=e.recordId,n=e.prevRecordId,i=e.type,a=Date.now();p.default.publish("plugin.im.delivery-receipt",[{type:i,messageId:t,recordId:r,prevRecordId:n,time:a}])}Object.defineProperty(t,"__esModule",{value:!0});var u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},c=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),d=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(n)},f=r(27),p=n(f),h=r(209),_=n(h),v=r(210),g=n(v),m=r(7),y=r(24),E=function(e){function t(e){i(this,t);var r=new g.default(e);return a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,p.default,"plugin.im.message"))}return s(t,e),d(t,[{key:"handle",value:function(e){var r=l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"handle",this).call(this,e),n=(0,m.unwrap)(e);if("sent"===c(n,1)[0].name()&&r.target===y.GROUP){var i={messageId:r.id,recordId:r.recordId,prevRecordId:r.prevRecordId};o(u({},i,{type:"server"})),o(u({},i,{type:"recipient"}))}return r}}]),t}(_.default);t.default=E,e.exports=t.default},48:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.TEXT="text",t.FILE="file",t.AUDIO="audio",t.CALL="call",t.UNKNOWN="unknown"},58:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.INCOMING_MESSAGE="IncomingMessage",t.OUTGOING_MESSAGE="OutgoingMessage",t.MESSAGE_REMOVED="MessageRemoved",t.MESSAGE_UPDATED="MessageUpdated",t.MESSAGE_DELIVERED="MessageDelivered",t.MESSAGE_DISPLAYED="MessageDisplayed",t.CHAT_STATE_UPDATED="ChatStateUpdated",t.DR_REQUEST_RECEIVED="DrRequestReceived",t.ROOM_CLEARED="RoomCleared",t.GROUP_JOINED="GroupJoined",t.PARTICIPANTS_JOINED="ParticipantsJoined",t.PARTICIPANTS_LEFT="ParticipantsLeft",t.GROUP_LEFT="GroupLeft",t.ROLES_CHANGED="RolesChanged",t.PROPERTIES_CHANGED="PropertiesChanged",t.PERSONAL_PROPERTIES_CHANGED="PersonalPropertiesChanged",t.SUBJECT_CHANGED="SubjectChanged",t.ERROR="Error",t.GROUP_VERSION="GroupVersion",t.ROOM_LIST_UPDATED="RoomListUpdated",t.ROOM_UPDATED="RoomUpdated"},676:function(e,t,r){e.exports=r(677)},677:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=new(Function.prototype.bind.apply(e,[null].concat(i(t),i(r))));return(0,m.isFunction)(n.init)&&n.init(),n}Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=r(87),u=r(678),c=n(u),d=r(330),l=n(d),f=r(703),p=n(f),h=r(710),_=n(h),v=r(722),g=n(v),m=r(10);t.default=s({},c.default,{version:o.version,name:"im",getModuleDefinitions:function(){return{im:{deps:["pm","stateSync","connection","service.im","service.group","file","storage","history","config"],factory:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return a(l.default,t)}},"service.im":{deps:["plugin.pubsub","service.connect"],factory:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return a(p.default,t)}},"service.group":{deps:["plugin.pubsub","service.connect"],factory:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return a(_.default,t)}},history:{deps:[],factory:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return a(g.default,t)}}}}}),e.exports=t.default},678:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a=r(330),s=n(a),o=r(205),u=n(o),c=r(208),d=n(c),l=r(336),f=n(l),p=r(332),h=n(p),_=r(699),v=n(_),g=r(700),m=n(g),y=r(701),E=n(y);t.default=i({ImManager:s.default,Room:u.default,MessageBucket:d.default,MessageBucketList:f.default,Group:h.default,constants:v.default},v.default,{history:m.default,message:E.default}),e.exports=t.default},679:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(4),s=function(e){return e&&e.__esModule?e:{default:e}}(a),o=r(92),u=function(){function e(t){n(this,e),(0,s.default)(this),t=t||{},this._state=o.ACTIVE,this._composingTimeout=t.composingTimeout}return i(e,[{key:"typing",value:function(){this._changeState(o.COMPOSING),this._setComposingTimer()}},{key:"stopTyping",value:function(){this._clearComposingTimer(),this._changeState(o.ACTIVE)}},{key:"getState",value:function(){return this._state}},{key:"_changeState",value:function(e){e!==this._state&&(this._state=e,this.emit(e))}},{key:"_setComposingTimer",value:function(){var e=this;this._clearComposingTimer(),this._composingTimer=setTimeout(function(){e._composingTimer=null,e._changeState(o.ACTIVE)},this._composingTimeout)}},{key:"_clearComposingTimer",value:function(){this._composingTimer&&(clearTimeout(this._composingTimer),this._composingTimer=null)}}]),e}();t.default=u,e.exports=t.default},680:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(i,a){try{var s=t[i](a),o=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}return n("next")})}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(4),u=n(o),c=r(12),d=n(c),l=r(0),f=r(76),p=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(f),h=r(3),_=r(681),v=n(_),g=r(682),m=n(g),y=h.LoggerFactory.getInstance().getLogger("im/upload/UploadController"),E=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(a(this,e),(0,u.default)(this),r.maxConcurrency<1)throw new l.ArgumentError("Concurrency cannot be lower than 1");this._fileMgr=t,this._uploadQueue=new v.default,this._workers=[],this._fileEventHandlers=[];for(var n=0;n<r.maxConcurrency;n++)this._workers.push(this._createUploadWorker());this._workerQueue=new v.default(this._workers),this._started=!1}return s(e,[{key:"start",value:function(){var e=this;if(this._started)throw new l.InvalidOperationError("Dispatcher is already running");var t=function(){var r=i(regeneratorRuntime.mark(function r(){var n,i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,e._workerQueue.dequeue();case 3:return n=r.sent,r.next=6,e._uploadQueue.dequeue();case 6:i=r.sent,n.upload(i).then(function(){e._workerQueue.enqueue(n)}).catch(function(t){y.error("Error during file upload: "+t.message,t),e._workerQueue.enqueue(n)}),r.next=16;break;case 10:if(r.prev=10,r.t0=r.catch(0),!(r.t0 instanceof l.InterruptError)){r.next=15;break}return y.debug("Queue is being cleared: "+r.t0.message),r.abrupt("return");case 15:throw r.t0;case 16:if(!e._started){r.next=19;break}return r.next=19,t();case 19:case"end":return r.stop()}},r,e,[[0,10]])}));return function(){return r.apply(this,arguments)}}();this._started=!0,this._running=t().then(function(){return y.info("UploadDispatcher is stopped")}).catch(function(e){return y.error("Error in UploadDispatcher loop: "+e.message,e)}),y.info("UploadDispatcher is started")}},{key:"stop",value:function(){function e(){return t.apply(this,arguments)}var t=i(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._started){e.next=2;break}return e.abrupt("return");case 2:for(this._started=!1,t=function(e){e.cancelUploadInFlight(),e.reset()},this._workers.forEach(function(e){return t(e)});this._uploadQueue.peek();)r=this._uploadQueue.dequeueSync(),n=r.id,this._emitFileCancel(n);return this._uploadQueue.clear(),this._workers=[],this._workerQueue.clear(),this._fileEventHandlers.forEach(function(e){return e.reset()}),this._fileEventHandlers=[],e.next=13,this._running;case 13:this._running=null;case 14:case"end":return e.stop()}},e,this)}));return e}()},{key:"enqueue",value:function(e,t){this._uploadQueue.enqueue({id:e,file:t})}},{key:"cancel",value:function(e){return this._workers.some(function(t){return t.cancel(e)})||this._removeUpload(e)}},{key:"_createUploadWorker",value:function(){var e=new m.default(this._fileMgr);return this._setupWorkerEventListener(e),e}},{key:"_setupWorkerEventListener",value:function(e){var t=this,r=new d.default(e);this._fileEventHandlers.push(r),[p.UPLOAD_SUCCESS,p.UPLOAD_FAILURE,p.UPLOAD_PROGRESS,p.UPLOAD_CANCEL].forEach(function(e){r.add(e,function(r){t.emit(e,r)})})}},{key:"_removeUpload",value:function(e){var t=this._uploadQueue.remove(function(t){return t.id===e});return t&&this._emitFileCancel(e),t}},{key:"_emitFileCancel",value:function(e){this.emit(p.UPLOAD_CANCEL,{id:e})}}]),e}();t.default=E,e.exports=t.default},681:function(e,t,r){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(0),o=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this._queue=[].concat(n(t)),this._pendingRetrievals=[]}return a(e,[{key:"enqueue",value:function(){for(var e,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];if(this._pendingRetrievals.length){(0,this._pendingRetrievals.shift().resolve)(r.shift())}(e=this._queue).push.apply(e,r)}},{key:"dequeue",value:function(){var e=this,t=this._queue.shift();return t||new Promise(function(t,r){e._pendingRetrievals.push({resolve:t,reject:r})})}},{key:"dequeueSync",value:function(){return this._queue.shift()}},{key:"peek",value:function(){return this._queue[0]}},{key:"remove",value:function(e){var t=this._queue.findIndex(e);return-1!==t&&(this._queue.splice(t,1),!0)}},{key:"size",value:function(){return this._queue.length}},{key:"clear",value:function(){this._queue=[],this._pendingRetrievals.forEach(function(e){return(0,e.reject)(new s.InterruptError("Retrieval is cancelled"))}),this._pendingRetrievals=[]}},{key:"some",value:function(e){return this._queue.some(e)}},{key:"forEach",value:function(e){this._queue.forEach(e)}},{key:"indexOf",value:function(e,t){return this._queue.indexOf(e,t)}}]),e}();t.default=o,e.exports=t.default},682:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){var r={};for(var n in e)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(4),c=n(u),d=r(12),l=n(d),f=r(0),p=r(76),h=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(p),_=r(3),v=_.LoggerFactory.getInstance().getLogger("im/upload/UploadWorker"),g=function(){function e(t){a(this,e),(0,c.default)(this),this._fileMgr=t,this._uploadInFlight={reject:null}}return o(e,[{key:"cancel",value:function(e){if(this._id!==e)return!1;if(this._token){var t=this._fileMgr.cancelUpload(this._token);return this.reset(),t}return!!this._uploadInFlight.reject&&(this._uploadInFlight.reject(new f.InterruptError("File upload for "+this._id+" is cancelled")),this._uploadInFlight.reject=null,this.emit(h.UPLOAD_CANCEL,{id:this._id}),this.reset(),!0)}},{key:"cancelUploadInFlight",value:function(){return!!this._id&&this.cancel(this._id)}},{key:"upload",value:function(e){var t=this,r=e.id,n=e.file;this._id=r;var i=new Promise(function(e,r){t._setupEventListener(e,r)});return new Promise(function(e,r){t._uploadInFlight.reject=r,t._fileMgr.shareFile(n).then(function(r){t._id&&(t._token=r,t._uploadInFlight.reject=null,e(i.then(function(){return t.reset()})))})}).catch(function(e){if(e instanceof f.InterruptError)return void v.debug("Upload is cancelled: "+e.message);throw t.reset(),e})}},{key:"reset",value:function(){this._id=null,this._token=null,this._fileEventHandler&&(this._fileEventHandler.reset(),this._fileEventHandler=null)}},{key:"_setupEventListener",value:function(e,t){var r=this;this._fileEventHandler=new l.default(this._fileMgr),[h.UPLOAD_SUCCESS,h.UPLOAD_FAILURE,h.UPLOAD_PROGRESS,h.UPLOAD_CANCEL].forEach(function(e){r._fileEventHandler.add(e,function(t){var n=t.token,a=i(t,["token"]);r._token===n&&r.emit(e,s({token:n,id:r._id},a))})}),this._fileEventHandler.add(h.UPLOAD_SUCCESS,function(t){var n=t.token,a=i(t,["token"]);r._token===n&&e(a)}),this._fileEventHandler.add(h.UPLOAD_CANCEL,function(e){var n=e.token;r._token===n&&t(new f.InterruptError("File upload for "+r._id+" is cancelled"))}),this._fileEventHandler.add(h.UPLOAD_FAILURE,function(e){var n=e.token,a=i(e,["token"]);r._token===n&&t(a.error)})}}]),e}();t.default=g,e.exports=t.default},683:function(e,t,r){"use strict";function n(e){var t=null;return(0,a.default)(s,function(r,n){return!!r.test(e)&&(t=n,!0)}),t}Object.defineProperty(t,"__esModule",{value:!0});var i=r(236),a=function(e){return e&&e.__esModule?e:{default:e}}(i),s={mp3:/^audio\/mpeg$/,m4a:/^audio\/mp4$/};t.default={ext:n},e.exports=t.default},684:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t,r){n(this,e),this._id=t,this._version=r,this._messages=[]}return i(e,[{key:"getId",value:function(){return this._id}},{key:"getVersion",value:function(){return this._version}},{key:"setVersion",value:function(e){this._version=e}},{key:"addMessage",value:function(e){this._messages.push(e)}},{key:"getMessages",value:function(){return this._messages}}]),e}();t.default=a,e.exports=t.default},685:function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},c=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),d=r(1),l=r(294),f=i(l),p=r(686),h=i(p),_=r(71),v=i(_),g=r(687),m=i(g),y=r(689),E=i(y),b=r(692),S=i(b),I=r(12),R=i(I),M=r(335),P=i(M),k=r(208),O=i(k),A=r(336),C=i(A),w=r(207),T=r(79),G=r(696),D=n(G),j=r(58),N=n(j),U=r(24),x=r(337),L=r(11),H=n(L),F=r(41),J=n(F),B=r(78),V=n(B),q=r(37),z=r(14),W=r(57),Q=r(10),Y=r(35),X=i(Y),Z=r(0),K=r(3),$=r(134),ee=r(47),te=K.LoggerFactory.getInstance().getLogger("im/MessageStore"),re=(0,X.default)(localStorage),ne={count:30,dir:x.BEFORE},ie=function(){function e(t,r,n,i,a){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};s(this,e),this._emitter=f.default.newInstance({separator:"~",recurrent:!0}),this._pm=t,this._connection=r,this._imService=n,this._storage=i,this._history=a,this._messageCache=void 0,this._roomReadyDeferred={},this._messages={},this._undeliveredMessageBuckets={},this._handlers={},this._rooms=[],this._undeliveredMessages=new Map,this._opts=(0,v.default)(o,["messageSortingCriteria"]),this._sortMessage=o.messageSortingCriteria===T.CLIENT_TIME?w.sortByClientTime:w.sortByServerTime,this._setupImEventHandlers(),this._setupPeerEventHandlers(),this._setupConnectionEventHandlers()}return c(e,[{key:"getMessage",value:function(e,t){var r=this;return this._ensureRoomReady(e).then(function(){var n=r._messages[e].getOne(t)||r._undeliveredMessageBuckets[e].getOne(t);if(!n)throw new Z.NotFoundError("The required message does not exist or is not fetched yet.");return n})}},{key:"getMessages",value:function(e,t){var r=this;return this._ensureRoomReady(e).then(function(){t=Object.assign({},ne,t);var n=t,i=n.count,a=n.ref,s="after"===t.dir,o=[];if((!a||(0,Q.isString)(a)&&r._undeliveredMessageBuckets[e].getOne(a)||(0,Q.isNumber)(a))&&(o=r._undeliveredMessageBuckets[e].getSome(i,null,a,s)),i===o.length)return o;var u=r._messages[e].getSome(i-o.length,null,0===o.length?a:null,s),c=u.length,d=u.concat(o);if(i===c+o.length)return d;var l=i-c,f=void 0;f=0!==c?s?u[c-1].id:u[0].id:a;var p={count:l,ref:f,dir:t.dir};return r._history.fetchHistory(e,p).then(function(t){var n=t.items;return r.putMessages(e,n).then(function(){return n.concat(d)})})})}},{key:"deleteMessages",value:function(e,t){var r=this;return Array.isArray(t)||(t=[t]),this._ensureRoomReady(e).then(function(){return r._messageCache.delete(e,t)}).then(function(){return r._deleteUndeliveredMessageCache(e,t)}).then(function(){var n=N.MESSAGE_REMOVED+"~"+e;t.forEach(function(t){var i=r._messages[e].getOne(t),a=r._undeliveredMessageBuckets[e].getOne(t),s=i||a;s&&(r._messages[e].delete(t),r._undeliveredMessageBuckets[e].delete(t),r._emitter.publish(n,[{roomId:e,message:s}]))}),r._pm.broadcast({event:"MessageStore:"+D.UPDATED,payload:{roomId:e}})})}},{key:"putMessages",value:function(e,t){var r=this;Array.isArray(t)||(t=[t]);var n=u({undelivered:[],delivered:[]},(0,S.default)(t,function(e){return e.serverTs?"delivered":"undelivered"}));return n.undelivered.forEach(function(e){return r._undeliveredMessages.set(e.id,e)}),this._ensureRoomReady(e).then(function(){return r._putMessagesToBucketList(e,n.delivered)}).then(function(){return r._putUndeliveredMessages(e,n.undelivered)})}},{key:"getMessageCount",value:function(e){var t=this;return this._ensureRoomReady(e).then(function(){return t._messages[e].getCount()+t._undeliveredMessageBuckets[e].getCount()})}},{key:"getUnreadCount",value:function(e){var t=this;return this._ensureRoomReady(e).then(function(){var r=t._messages[e].getAll(),n=d.Strophe.getBareJidFromJid(t._connection.getJid());return r.filter(function(e){return e.from!==n&&!e.displayTs}).length})}},{key:"hasUnreadMessage",value:function(e){var t=this;return this._ensureRoomReady(e).then(function(){var r=t._messages[e].getAll(),n=d.Strophe.getBareJidFromJid(t._connection.getJid());return!!r.find(function(e){return e.from!==n&&!e.displayTs})})}},{key:"getRoomList",value:function(){return this._rooms}},{key:"clearRoom",value:function(e){var t=this,r=[];return this._messages[e]&&(this._messages[e]=new C.default(this._opts),r.push(this._messageCache.clearRoom(e))),this._undeliveredMessageBuckets[e]&&(this._undeliveredMessageBuckets[e]=new O.default(this._opts),r.push(this._messageCache.clearRoom(e+":undelivered-msg"))),Promise.all(r).then(function(){return t._emitter.publish(N.ROOM_CLEARED+"~"+e,[{roomId:e}])})}},{key:"deleteRoom",value:function(e){var t=this;return this._rooms.includes(e)?(this._rooms=this._rooms.filter(function(t){return e!==t}),this._writeRoomList(),delete this._messages[e],delete this._undeliveredMessageBuckets[e],delete this._roomReadyDeferred[e],this._messageCache.deleteRoom(e).then(function(){return t._messageCache.deleteRoom(e+":undelivered-msg")})):Promise.resolve()}},{key:"on",value:function(e,t,r){var n=void 0;"function"==typeof t?(r=t,n=this._emitter.subscribe(e,r)):n=this._emitter.subscribe(e+"~"+t,r),this._handlers[e]||(this._handlers[e]=[]),this._handlers[e].push({handler:r,subscription:n})}},{key:"off",value:function(e,t){var r=this;this._handlers[e]=this._handlers[e].filter(function(e){return e.handler!==t||(r._emitter.unsubscribe(e.subscription),!1)})}},{key:"_setupImEventHandlers",value:function(){var e=this;this._imEventHandler=new R.default(this._imService),this._imEventHandler.add(N.INCOMING_MESSAGE,function(t){if(t.from!==e._jid)return void e._handleNewMessageEvent(N.INCOMING_MESSAGE,t.roomId,t);e._handleNewMessageEvent(N.OUTGOING_MESSAGE,t.roomId,t)}),this._imEventHandler.add(N.OUTGOING_MESSAGE,function(t){e._handleNewMessageEvent(N.OUTGOING_MESSAGE,t.roomId,t)}),this._imEventHandler.add(N.MESSAGE_DELIVERED,function(t){e._handleDeliveryReceipt(t)}),this._imEventHandler.add(N.MESSAGE_DISPLAYED,function(t){var r=t.roomId;e._handleDisplayReceipt(r,t)}),this._imEventHandler.add(N.DR_REQUEST_RECEIVED,function(t){var r=t.jid,n=t.messageId;e._imService.sendDeliveryReceipt(r,n)})}},{key:"_handleNewMessageEvent",value:function(e,t,r){var n=this;this._hasMessage(t,r)||(e===N.OUTGOING_MESSAGE&&this._undeliveredMessages.set(r.id,r),this._ensureRoomReady(t).then(function(){var i=[];return e!==N.INCOMING_MESSAGE&&r.status!==V.SUCCESS||i.push(n._putMessagesToBucketList(t,r)),e===N.OUTGOING_MESSAGE&&r.status!==V.SUCCESS&&i.push(n._putUndeliveredMessages(t,r)),Promise.all(i)}).then(function(){n._emitter.publish(e+"~"+t,[{roomId:t,message:r}]),n._pm.broadcast({event:"MessageStore:"+D.UPDATED,payload:{roomId:t}})}))}},{key:"_handleDeliveryReceipt",value:function(e){var t=this,r=e.type,n=e.messageId,i=e.recordId,a=e.prevRecordId;if(this._undeliveredMessages.has(n)){var s=this._undeliveredMessages.get(n),o=s.roomId;this._ensureRoomReady(o).then(function(){s=t._getOneMessage(o,s.id)||s;var c=s.target===U.GROUP?t._computeGroupTs(e):t._computeSingleTs(e,s);"recipient"!==r&&s.target!==U.GROUP||t._undeliveredMessages.delete(n);var d=u({},s,c,{status:V.SUCCESS,recordId:i,prevRecordId:a});t._undeliveredMessages.has(n)&&t._undeliveredMessages.set(n,d);var l=Promise.resolve();return t._undeliveredMessageBuckets[o].getOne(n)&&(l=l.then(function(){return t._deleteUndeliveredMessages(o,n)})),l.then(function(){return t._putMessagesToBucketList(o,d)}).then(function(){t._emitter.publish(N.MESSAGE_DELIVERED+"~"+o,[e]),t._pm.broadcast({event:"MessageStore:"+D.UPDATED,payload:{roomId:o}})})})}}},{key:"_computeGroupTs",value:function(e){var t=e.time;return{serverTs:t,deliveryTs:t}}},{key:"_computeSingleTs",value:function(e,t){var r=e.type,n=e.time,i={};return"server"!==r&&t.serverTs||(i.serverTs=n),"recipient"===r&&(i.deliveryTs=n),i}},{key:"_handleDisplayReceipt",value:function(e,t){var r=this,n=t.messageId,i=t.time;this._ensureRoomReady(e).then(function(){var t=r._undeliveredMessageBuckets[e].getOne(n);return t?r._markMessageDelivered(e,t,i):Promise.resolve()}).then(function(){if(r._messages[e].getOne(n)){var a=d.Strophe.getBareJidFromJid(r._connection.getJid()),s=t.jid===a?"in":"out",o=function(n){if(n&&n.length){r._pm.broadcast({event:"MessageStore:"+D.UPDATED,payload:{roomId:e}});var i=N.MESSAGE_DISPLAYED+"~"+e;n.forEach(function(e){var n=Object.assign({},t,{messageId:e.id});r._emitter.publish(i,[n])})}};r._markMessagesAsDisplayed(r._messages[e],e,s,n,i).then(o)}})}},{key:"_markMessagesAsDisplayed",value:function(e,t,r,n,i){var a=this,s=d.Strophe.getBareJidFromJid(this._connection.getJid()),o="out"===r?function(e){return e.from===s}:function(e){return e.from!==s},u=[],c=!0,l=e.getOne(n);if(!l)return Promise.resolve([]);var f=l.id,p=function(e){var t=Object.assign({},e,{displayTs:i});u.push(t)},h=function(e){o(e)&&p(e)};for(p(l);c;){var _=e.getSome(30,{displayTs:void 0},f);if(0===_.length){c=!1;break}!function(e){e.forEach(h)}(_),f=_[0].id}return this._messageCache.put(t,u).then(function(){return e.put(u),a._sortMessage(u),u})}},{key:"_markMessageDelivered",value:function(e,t,r){var n=this;if(!r)throw new Z.InvalidOperationError("Server timestamp cannot be empty",t);return t=u({},t,{serverTs:r}),this._deleteUndeliveredMessages(e,t.id).then(function(){return n._putMessagesToBucketList(e,t)})}},{key:"_putMessagesToBucketList",value:function(e,t){return this._messages[e].put(t),this._messageCache.put(e,t)}},{key:"_putUndeliveredMessages",value:function(e,t){return this._undeliveredMessageBuckets[e].put(t),this._persistUndeliveredMessages(e,t)}},{key:"_deleteUndeliveredMessages",value:function(e,t){return this._undeliveredMessageBuckets[e].delete(t),this._deleteUndeliveredMessageCache(e,t)}},{key:"_persistUndeliveredMessages",value:function(e,t){return this._messageCache.put(e+":undelivered-msg",t)}},{key:"_deleteUndeliveredMessageCache",value:function(e,t){return this._messageCache.delete(e+":undelivered-msg",t)}},{key:"_getOneMessage",value:function(e,t){return this._messages[e]&&this._messages[e].getOne(t)||this._undeliveredMessageBuckets[e]&&this._undeliveredMessageBuckets[e].getOne(t)}},{key:"_setupPeerEventHandlers",value:function(){var e=this;this._pmEventHandlers=new R.default(this._pm),this._pmEventHandlers.add(H.MESSAGE_RECEIVED,function(t){var r=t.message,n=r.event,i=r.payload;if(n==="MessageStore:"+D.UPDATED){var a=i.roomId;e._ensureRoomReady(a).then(function(){e._handleStorageUpdate(a)})}})}},{key:"_handleStorageUpdate",value:function(e){var t=this;Promise.all([this._messageCache.read(e),this._messageCache.read(e+":undelivered-msg")]).then(function(r){var n=o(r,2),i=n[0].history,s=n[1].history,u=t._messages[e],c=t._undeliveredMessageBuckets[e],d=c.getAll(),l=u.getAll(),f=(0,m.default)(d,s,function(e){return e.id}),p=(0,m.default)(s,d,function(e){return e.id}),_=(0,m.default)(i,l,function(e){return e.id}),v=(0,E.default)(f,_,function(e){return e.id});(0,m.default)(f,v,function(e){return e.id}).forEach(function(r){c.delete(r.id),t._emitter.publish(N.MESSAGE_REMOVED+"~"+e,[{roomId:e,message:r}])}),v.forEach(function(e){c.delete(e.id),u.put(e)}),l=u.getAll(),p.forEach(function(r){c.put(r),t._emitter.publish(N.OUTGOING_MESSAGE+"~"+e,[{roomId:e,message:r}])});var g=(0,m.default)(l,i,function(e){return e.id}),y=N.MESSAGE_REMOVED+"~"+e;g.forEach(function(r){u.delete(r.id);var n=l.findIndex(function(e){return e.id===r.id});l=(0,W.remove)(l,n),t._emitter.publish(y,[{roomId:e,message:r}])});var b=(0,h.default)(l,i);if(b){var S=[];if(b.forEach(function(r){if("A"===r.kind){var n=r.item.rhs;if(u.put(n),n.from===t._jid)return void t._emitter.publish(N.OUTGOING_MESSAGE+"~"+e,[{roomId:e,message:n}]);t._emitter.publish(N.INCOMING_MESSAGE+"~"+e,[{roomId:e,message:n}])}else if("N"===r.kind||"E"===r.kind){var i=o(r.path,2),s=i[0],c=i[1],d=Object.assign({},l[s],a({},c,r.rhs));l=(0,W.replace)(l,d,s),u.put(d);var f=function(t,r,n){return{roomId:e,type:r,messageId:t.id,recordId:t.recordId,prevRecordId:t.prevRecordId,time:n}};switch(c){case"serverTs":t._emitter.publish(N.MESSAGE_DELIVERED+"~"+e,[f(d,"server",r.rhs)]);break;case"deliveryTs":t._emitter.publish(N.MESSAGE_DELIVERED+"~"+e,[f(d,"recipient",r.rhs)]);break;case"displayTs":S.push({roomId:e,jid:d.to,messageId:d.id,time:r.rhs})}}}),S.length>0){var I=N.MESSAGE_DISPLAYED+"~"+e;S.forEach(function(e){t._emitter.publish(I,[e])})}}}).catch(function(e){te.error("Cannot handle the storage change",e.message)})}},{key:"_setupConnectionEventHandlers",value:function(){var e=this,t=function(){e._jid=d.Strophe.getBareJidFromJid(e._connection.getJid()),e._messageCache=new P.default(e._storage,e._opts),e._undeliveredMessageBuckets={},e._messages={},e._undeliveredMessages=new Map,e._rooms=e._readRoomList()};this._connectionEventHandler=new R.default(this._connection),this._connectionEventHandler.add(J.STATUS_CHANGED,function(r){var n=r.status,i=r.reconnect;n===q.CONNECTED&&(i||t(),e._pm.isActive()&&e._imService.retrieveOfflineMessages())}),this._connection.getStatus()===q.CONNECTED&&(t(),this._pm.isActive()&&this._imService.retrieveOfflineMessages())}},{key:"_ensureRoomReady",value:function(e){var t=this;if(this._roomReadyDeferred[e])return this._roomReadyDeferred[e];var r=[];return this._messages[e]||r.push(this._readMessage(e)),this._undeliveredMessageBuckets[e]||r.push(this._readUndeliveredMessage(e)),this._roomReadyDeferred[e]=Promise.all(r).then(function(){t._rooms.includes(e)||(t._rooms=(0,W.add)(t._rooms,e)),t._writeRoomList()}),this._roomReadyDeferred[e]}},{key:"_readMessage",value:function(e){return this._messages[e]=new C.default(this._opts),this._readFromMessageCache(e,this._messages[e])}},{key:"_readUndeliveredMessage",value:function(e){return this._undeliveredMessageBuckets[e]=new O.default(this._opts),this._readFromMessageCache(e+":undelivered-msg",this._undeliveredMessageBuckets[e])}},{key:"_readFromMessageCache",value:function(e,t){return this._messageCache.read(e).then(function(e){var r=e.history;t.put(r)})}},{key:"_hasMessage",value:function(e,t){return this._messages[e]&&!!this._messages[e].getOne(t.id)||this._undeliveredMessageBuckets[e]&&!!this._undeliveredMessageBuckets[e].getOne(t.id)}},{key:"_readRoomList",value:function(){var e=void 0;try{var t=re.getItem(z.ROOM_ID_LIST);e=(0,ee.decrypt)(t,(0,$.getUserTokenFromStorage)())}catch(e){return[]}if(!e)return[];var r=e.split(":"),n=o(r,2),i=n[0],a=n[1];return i!==this._jid?[]:a.split(";")}},{key:"_writeRoomList",value:function(){var e=this._jid+":"+this._rooms.join(";"),t=(0,ee.encrypt)(e,(0,$.getUserTokenFromStorage)());re.setItem(z.ROOM_ID_LIST,t)}}]),e}();t.default=ie,e.exports=t.default},686:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){function r(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function n(e,t){Object.defineProperty(this,"kind",{value:e,enumerable:!0}),t&&t.length&&Object.defineProperty(this,"path",{value:t,enumerable:!0})}function i(e,t,r){i.super_.call(this,"E",e),Object.defineProperty(this,"lhs",{value:t,enumerable:!0}),Object.defineProperty(this,"rhs",{value:r,enumerable:!0})}function a(e,t){a.super_.call(this,"N",e),Object.defineProperty(this,"rhs",{value:t,enumerable:!0})}function s(e,t){s.super_.call(this,"D",e),Object.defineProperty(this,"lhs",{value:t,enumerable:!0})}function o(e,t,r){o.super_.call(this,"A",e),Object.defineProperty(this,"index",{value:t,enumerable:!0}),Object.defineProperty(this,"item",{value:r,enumerable:!0})}function u(e,t,r){var n=e.slice((r||t)+1||e.length);return e.length=t<0?e.length+t:t,e.push.apply(e,n),e}function c(e){var t=typeof e;return"object"!==t?t:e===Math?"math":null===e?"null":Array.isArray(e)?"array":"[object Date]"===Object.prototype.toString.call(e)?"date":"function"==typeof e.toString&&/^\/.*\//.test(e.toString())?"regexp":"object"}function d(e,t,r,n,l,f,p){l=l||[],p=p||[];var h=l.slice(0);if(void 0!==f){if(n){if("function"==typeof n&&n(h,f))return;if("object"==typeof n){if(n.prefilter&&n.prefilter(h,f))return;if(n.normalize){var _=n.normalize(h,f,e,t);_&&(e=_[0],t=_[1])}}}h.push(f)}"regexp"===c(e)&&"regexp"===c(t)&&(e=e.toString(),t=t.toString());var v=typeof e,g=typeof t,m="undefined"!==v||p&&p[p.length-1].lhs&&p[p.length-1].lhs.hasOwnProperty(f),y="undefined"!==g||p&&p[p.length-1].rhs&&p[p.length-1].rhs.hasOwnProperty(f);if(!m&&y)r(new a(h,t));else if(!y&&m)r(new s(h,e));else if(c(e)!==c(t))r(new i(h,e,t));else if("date"===c(e)&&e-t!=0)r(new i(h,e,t));else if("object"===v&&null!==e&&null!==t)if(p.filter(function(t){return t.lhs===e}).length)e!==t&&r(new i(h,e,t));else{if(p.push({lhs:e,rhs:t}),Array.isArray(e)){var E;e.length;for(E=0;E<e.length;E++)E>=t.length?r(new o(h,E,new s(void 0,e[E]))):d(e[E],t[E],r,n,h,E,p);for(;E<t.length;)r(new o(h,E,new a(void 0,t[E++])))}else{var b=Object.keys(e),S=Object.keys(t);b.forEach(function(i,a){var s=S.indexOf(i);s>=0?(d(e[i],t[i],r,n,h,i,p),S=u(S,s)):d(e[i],void 0,r,n,h,i,p)}),S.forEach(function(e){d(void 0,t[e],r,n,h,e,p)})}p.length=p.length-1}else e!==t&&("number"===v&&isNaN(e)&&isNaN(t)||r(new i(h,e,t)))}function l(e,t,r,n){return n=n||[],d(e,t,function(e){e&&n.push(e)},r),n.length?n:void 0}function f(e,t,r){if(r.path&&r.path.length){var n,i=e[t],a=r.path.length-1;for(n=0;n<a;n++)i=i[r.path[n]];switch(r.kind){case"A":f(i[r.path[n]],r.index,r.item);break;case"D":delete i[r.path[n]];break;case"E":case"N":i[r.path[n]]=r.rhs}}else switch(r.kind){case"A":f(e[t],r.index,r.item);break;case"D":e=u(e,t);break;case"E":case"N":e[t]=r.rhs}return e}function p(e,t,r){if(e&&t&&r&&r.kind){for(var n=e,i=-1,a=r.path?r.path.length-1:0;++i<a;)void 0===n[r.path[i]]&&(n[r.path[i]]="number"==typeof r.path[i]?[]:{}),n=n[r.path[i]];switch(r.kind){case"A":f(r.path?n[r.path[i]]:n,r.index,r.item);break;case"D":delete n[r.path[i]];break;case"E":case"N":n[r.path[i]]=r.rhs}}}function h(e,t,r){if(r.path&&r.path.length){var n,i=e[t],a=r.path.length-1;for(n=0;n<a;n++)i=i[r.path[n]];switch(r.kind){case"A":h(i[r.path[n]],r.index,r.item);break;case"D":case"E":i[r.path[n]]=r.lhs;break;case"N":delete i[r.path[n]]}}else switch(r.kind){case"A":h(e[t],r.index,r.item);break;case"D":case"E":e[t]=r.lhs;break;case"N":e=u(e,t)}return e}function _(e,t,r){if(e&&t&&r&&r.kind){var n,i,a=e;for(i=r.path.length-1,n=0;n<i;n++)void 0===a[r.path[n]]&&(a[r.path[n]]={}),a=a[r.path[n]];switch(r.kind){case"A":h(a[r.path[n]],r.index,r.item);break;case"D":case"E":a[r.path[n]]=r.lhs;break;case"N":delete a[r.path[n]]}}}function v(e,t,r){if(e&&t){d(e,t,function(n){r&&!r(e,t,n)||p(e,t,n)})}}var g,m,y=[];g="object"==typeof e&&e?e:"undefined"!=typeof window?window:{},m=g.DeepDiff,m&&y.push(function(){void 0!==m&&g.DeepDiff===l&&(g.DeepDiff=m,m=void 0)}),r(i,n),r(a,n),r(s,n),r(o,n),Object.defineProperties(l,{diff:{value:l,enumerable:!0},observableDiff:{value:d,enumerable:!0},applyDiff:{value:v,enumerable:!0},applyChange:{value:p,enumerable:!0},revertChange:{value:_,enumerable:!0},isConflict:{value:function(){return void 0!==m},enumerable:!0},noConflict:{value:function(){return y&&(y.forEach(function(e){e()}),y=null),l},enumerable:!0}}),t.default=l}.call(t,r(32))},687:function(e,t,r){var n=r(688),i=r(270),a=r(26),s=r(86),o=r(144),u=r(118),c=s(function(e,t){var r=u(t);return o(r)&&(r=void 0),o(e)?n(e,i(t,1,o,!0),a(r,2)):[]});e.exports=c},688:function(e,t,r){function n(e,t,r,n){var l=-1,f=a,p=!0,h=e.length,_=[],v=t.length;if(!h)return _;r&&(t=o(t,u(r))),n?(f=s,p=!1):t.length>=d&&(f=c,p=!1,t=new i(t));e:for(;++l<h;){var g=e[l],m=null==r?g:r(g);if(g=n||0!==g?g:0,p&&m===m){for(var y=v;y--;)if(t[y]===m)continue e;_.push(g)}else f(t,m,n)||_.push(g)}return _}var i=r(154),a=r(186),s=r(334),o=r(45),u=r(84),c=r(155),d=200;e.exports=n},689:function(e,t,r){var n=r(45),i=r(690),a=r(26),s=r(86),o=r(691),u=r(118),c=s(function(e){var t=u(e),r=n(e,o);return t===u(r)?t=void 0:r.pop(),r.length&&r[0]===e[0]?i(r,a(t,2)):[]});e.exports=c},690:function(e,t,r){function n(e,t,r){for(var n=r?s:a,l=e[0].length,f=e.length,p=f,h=Array(f),_=1/0,v=[];p--;){var g=e[p];p&&t&&(g=o(g,u(t))),_=d(g.length,_),h[p]=!r&&(t||l>=120&&g.length>=120)?new i(p&&g):void 0}g=e[0];var m=-1,y=h[0];e:for(;++m<l&&v.length<_;){var E=g[m],b=t?t(E):E;if(E=r||0!==E?E:0,!(y?c(y,b):n(v,b,r))){for(p=f;--p;){var S=h[p];if(!(S?c(S,b):n(e[p],b,r)))continue e}y&&y.push(b),v.push(E)}}return v}var i=r(154),a=r(186),s=r(334),o=r(45),u=r(84),c=r(155),d=Math.min;e.exports=n},691:function(e,t,r){function n(e){return i(e)?e:[]}var i=r(144);e.exports=n},692:function(e,t,r){var n=r(100),i=r(693),a=Object.prototype,s=a.hasOwnProperty,o=i(function(e,t,r){s.call(e,r)?e[r].push(t):n(e,r,[t])});e.exports=o},693:function(e,t,r){function n(e,t){return function(r,n){var u=o(r)?i:a,c=t?t():{};return u(r,e,s(n,2),c)}}var i=r(694),a=r(695),s=r(26),o=r(2);e.exports=n},694:function(e,t){function r(e,t,r,n){for(var i=-1,a=null==e?0:e.length;++i<a;){var s=e[i];t(n,s,r(s),e)}return n}e.exports=r},695:function(e,t,r){function n(e,t,r,n){return i(e,function(e,i,a){t(n,e,r(e),a)}),n}var i=r(68);e.exports=n},696:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.UPDATED="storage:updated"},697:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.APP_CREDIT_UPPER_LIMIT="com.maaii.application.credit.upperlimit",t.APP_EARNING_ENABLED="com.maaii.application.earning.enabled",t.APP_EARNING_EMAIL_AMOUNT="com.maaii.application.earning.Email.amount",t.APP_EARNING_FB_AMOUNT="com.maaii.application.earning.FBpost.amount",t.APP_EARNING_RANDOM_ENABLED="com.maaii.application.earning.random.enabled",t.APP_EARNING_RATEUS_AMOUNT="com.maaii.application.earning.rateus.amount",t.APP_EARNING_SMS_AMOUNT="com.maaii.application.earning.smsinvite.amount",t.APP_EARNING_TWITTER_AMOUNT="com.maaii.application.earning.Twitterpost.amount",t.APP_EARNING_WB_AMOUNT="com.maaii.application.earning.WBpost.amount",t.CARRIER_SECONDARY_IDENTITY_MAX="com.maaii.carrier.secondary.identity.maximum.number",t.IM_GROUP_INVITE_OWNER_ONLY="com.maaii.im.group.invite.owner.only",t.IM_GROUP_PARTICIPANTS_MAX="com.maaii.im.group.participant.max",t.IM_OFFLINE_MESSAGE_BATCH_SIZE="com.maaii.im.offline.message.batch.size",t.MAAIIME_DEFAULT_VIDEO_URL="com.maaii.maaiime.default.video.url",t.MUMS_CLIENT_LANGUAGES="com.maaii.mums.client.languages",t.MUMS_SUCCESSFUL_MANAGEMENT_CONNECTION_ABSENCE="com.maaii.mums.successful.management.connection.absence",t.SERVICE_IM_ENABLED="com.maaii.service.im.enabled",t.SERVICE_SMS_CN_LONG_ASCII_CHARPERMSG="com.maaii.service.sms.cn.long.ascii.charpermsg",t.SERVICE_SMS_CN_LONG_UNICODE_CHARPERMSG="com.maaii.service.sms.cn.long.unicode.charpermsg",t.SERVICE_SMS_CN_SHORT_ASCII_CHARPERMSG="com.maaii.service.sms.cn.short.ascii.charpermsg",t.SERVICE_SMS_CN_SHORT_UNICODE_CHARPERMSG="com.maaii.service.sms.cn.short.unicode.charpermsg",t.SERVICE_SMS_ROW_LONG_ASCII_CHARPERMSG="com.maaii.service.sms.row.long.ascii.charpermsg",t.SERVICE_SMS_ROW_SHORT_ASCII_CHARPERMSG="com.maaii.service.sms.row.short.ascii.charpermsg",t.SERVICE_SMS_ROW_LONG_UNICODE_CHARPERMSG="com.maaii.service.sms.row.long.unicode.charpermsg",t.SERVICE_SMS_ROW_SHORT_UNICODE_CHARPERMSG="com.maaii.service.sms.row.short.unicode.charpermsg",t.SERVICE_VOIP_ENABLED="com.maaii.service.voip.enabled",t.SERVICE_VOIP_ICE_DISABLED="com.maaii.service.voip.ice.disabled",t.SERVICE_VOIP_DOMAIN_NAME="com.maaii.service.voip.domain.name",t.SERVICE_VOIP_ROUTE="com.maaii.service.voip.route",t.SERVICE_VOIP_PACKAGE_LOSS_THRESHOLD="com.maaii.service.voip.packetlossthreshold",t.USER_PIN="com.maaii.user.pin",t.USER_TYPE_PREPAID="com.maaii.user.type.preapaid",t.VOIP_SETTINGS_ICE="com.maaii.voip.settings.ice",t.VOIP_SETTINGS_DEFAULT="com.maaii.voip.settings.default"},698:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MESSAGE_SORTING_CRITERIA=t.MAX_CONCURRENCY=t.SYNC_GROUPS_PAGE_SIZE=t.COMPOSING_FREQUENCY=t.COMPOSING_TIMEOUT=t.GROUP_MAX_PARTICIPANTS=void 0;var n=r(79);t.GROUP_MAX_PARTICIPANTS=100,t.COMPOSING_TIMEOUT=3e3,t.COMPOSING_FREQUENCY=1500,t.SYNC_GROUPS_PAGE_SIZE=10,t.MAX_CONCURRENCY=2,t.MESSAGE_SORTING_CRITERIA=n.SERVER_TIME},699:function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}Object.defineProperty(t,"__esModule",{value:!0});var i=r(58),a=n(i),s=r(92),o=n(s),u=r(93),c=n(u),d=r(78),l=n(d),f=r(48),p=n(f),h=r(24),_=n(h),v=r(337),g=n(v);t.default={ChatEvent:a,ChatState:o,GroupRole:c,MessageStatus:l,MessageType:p,MessageTarget:_,QueryDirection:g},e.exports=t.default},700:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(335),i=function(e){return e&&e.__esModule?e:{default:e}}(n);t.default={MessageCache:i.default},e.exports=t.default},701:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i=r(77),a=n(i),s=r(137),o=n(s),u=r(138),c=n(u),d=r(331),l=n(d),f=r(702),p=n(f);t.default={Message:a.default,textMessage:o.default,fileMessage:c.default,audioMessage:l.default,callMessage:p.default},e.exports=t.default},702:function(e,t,r){"use strict";function n(e,t,r,n,i){var o=n.type,u=n.endCause,c=n.startTime,d=n.endTime,l=n.status,f=new a.default(e,t,r,i);return Object.assign(f,{type:s.CALL,call:{type:o,endCause:u,startTime:c,endTime:d,status:l}}),f}Object.defineProperty(t,"__esModule",{value:!0});var i=r(77),a=function(e){return e&&e.__esModule?e:{default:e}}(i),s=r(48);t.default={create:n},e.exports=t.default},703:function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e){return e.replace(/\.\d{3}/,"")}function o(e,t,r,n){var i={name:"message",attributes:{id:v.generateMessageId(e),to:t},body:[{name:"displayed",attributes:{id:r,xmlns:H.MAAII_RECEIPTS}}]};return n===J.GROUP&&(i.attributes.type="groupchat",i.attributes.to="multicast."+d.Strophe.getDomainFromJid(e),i.body.push({name:"thread",body:t})),m.default.build(i)}function u(e){var t=function(t,r){return new S.default(t,e,r)};d.Strophe.addConnectionPlugin("DeliveryReceipt",D.default),d.Strophe.addConnectionPlugin("DisplayedReceipt",N.default),d.Strophe.addConnectionPlugin("MultiDevice",x.default);var r=new R.default,n=t(r,"plugin.im.message"),i=new P.default,a=t(i,"plugin.im.chat-states"),s=t(new O.default(i),"plugin.im.chat-states"),o=t(new C.default,"plugin.im.message"),u=new E.default({name:"message",type:"chat"},o);u.register(n),u.register(a),u.register(new T.default(r)),u.register(s),d.Strophe.addConnectionPlugin("SupportedImMessage",u)}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),d=r(1),l=r(4),f=i(l),p=r(194),h=i(p),_=r(16),v=n(_),g=r(5),m=i(g),y=r(338),E=i(y),b=r(209),S=i(b),I=r(339),R=i(I),M=r(340),P=i(M),k=r(210),O=i(k),A=r(341),C=i(A),w=r(342),T=i(w),G=r(707),D=i(G),j=r(708),N=i(j),U=r(709),x=i(U),L=r(0),H=r(36),F=r(58),J=r(24),B=r(92),V=n(B),q=function(){function e(t,r){a(this,e),(0,f.default)(this),this._connectService=r,t.subscribe("plugin.im.message",this._onReceivedMessage.bind(this)),t.subscribe("plugin.im.delivery-receipt",this._onReceivedDeliveryReceipt.bind(this)),t.subscribe("plugin.im.chat-states",this._onChatStateUpdated.bind(this)),t.subscribe("plugin.im.dr-request",this._onReceivedDrRequest.bind(this)),t.subscribe("plugin.im.displayed-receipt",this._onReceivedDisplayedReceipt.bind(this)),u(t)}return c(e,[{key:"sendTextMessage",value:function(e){this._send(this._createTextMessageStanza(e)),this.emit(F.OUTGOING_MESSAGE,e)}},{key:"sendFileMessage",value:function(e){this._send(this._createFileMessageStanza(e)),this.emit(F.OUTGOING_MESSAGE,e)}},{key:"sendComposingState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J.USER;this._sendChatState(e,V.COMPOSING,t)}},{key:"sendActiveState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J.USER;this._sendChatState(e,V.ACTIVE,t)}},{key:"sendDeliveryReceipt",value:function(e,t){this._send(this._createDeliveryReceipt(e,t))}},{key:"sendDisplayedReceipt",value:function(e,t,r){var n=d.Strophe.getBareJidFromJid(this._connectService.getJid()),i=o(n,e,t,r);this._send(i),this.emit(F.MESSAGE_DISPLAYED,{roomId:e,jid:n,messageId:t,time:Date.now()})}},{key:"retrieveOfflineMessages",value:function(){var e=this;return new Promise(function(t,r){var n=e._connectService.getStropheConnection(),i=d.Strophe.getBareJidFromJid(e._connectService.getJid()),a=m.default.build({name:"iq",attributes:{type:"get",from:i,id:v.generateIqId(i)},body:[{name:"offline",attributes:{xmlns:"http://jabber.org/protocol/offline"},body:[{name:"fetch"}]}]});n.sendIQ(a,t,function(e){r(e?new Error((0,m.default)(e).content()):new L.TimeoutError("Retrieve offline messages timeout,\n              5000ms timeout exceeded."))},5e3)})}},{key:"_createTextMessageStanza",value:function(e){var t=this._getMessageStanzaStructure(e);return t.body.push({name:"body",body:e.content}),t.body.push({name:"active",attributes:{xmlns:H.CHAT_STATES}}),m.default.build(t)}},{key:"_createFileMessageStanza",value:function(e){var t=void 0,r=e.content,n=e.file,i=e.expires,a=n.duration,o=n.name,u=n.size,c=n.type,d=n.thumbnail,l=this._getMessageStanzaStructure(e);if(d){var f=d.replace(/data:\w+\/\w+;base64,/,"");t="sha1+"+(0,h.default)(f),l.body.push({name:"data",attributes:{xmlns:"urn:xmpp:bob",cid:t,type:c},body:f})}return l.body.push({name:"file",attributes:{xmlns:"urn:maaii:filesharing",name:o,"mime-type":c,size:u,date:s((new Date).toISOString()),expires:i?s(i):null,"thumbnail-cid":t,duration:a},body:[{name:"x",attributes:{xmlns:"jabber:x:oob"},body:[{name:"url",body:r}]}]}),m.default.build(l)}},{key:"_getMessageStanzaStructure",value:function(e){var t=e.id,r=e.from,n=e.to;return e.target===J.GROUP?{name:"message",attributes:{from:r,to:this._getMulticastEndpoint(),type:"groupchat",id:t},body:[{name:"thread",body:n}]}:{name:"message",attributes:{from:r,to:n,type:"chat",id:t},body:[]}}},{key:"_createDeliveryReceipt",value:function(e,t){var r=d.Strophe.getBareJidFromJid(this._connectService.getJid());return m.default.build({name:"message",attributes:{id:v.generateMessageId(r),to:e},body:[{name:"received",attributes:{id:t,xmlns:H.RECEIPTS}}]})}},{key:"_createChatStateStanza",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:J.USER,n=void 0,i=[{name:t,attributes:{xmlns:H.CHAT_STATES}}];return r===J.GROUP?(n={to:this._getMulticastEndpoint(),type:"groupchat"},i.unshift({name:"thread",body:e})):n={to:e,type:"chat"},m.default.build({name:"message",attributes:n,body:i})}},{key:"_getMulticastEndpoint",value:function(){var e=this._connectService.getJid();return"multicast."+d.Strophe.getDomainFromJid(e)}},{key:"_sendChatState",value:function(e,t,r){this._send(this._createChatStateStanza(e,t,r))}},{key:"_send",value:function(e){this._connectService.getStropheConnection().send(e)}},{key:"_onReceivedMessage",value:function(e){var t=d.Strophe.getBareJidFromJid(this._connectService.getJid());if(e.from===t)return void this.emit(F.OUTGOING_MESSAGE,e);this.emit(F.INCOMING_MESSAGE,e)}},{key:"_onReceivedDeliveryReceipt",value:function(e){this.emit(F.MESSAGE_DELIVERED,e)}},{key:"_onChatStateUpdated",value:function(e){d.Strophe.getBareJidFromJid(this._connectService.getJid())!==e.jid&&this.emit(F.CHAT_STATE_UPDATED,e)}},{key:"_onReceivedDrRequest",value:function(e){this.emit(F.DR_REQUEST_RECEIVED,e)}},{key:"_onReceivedDisplayedReceipt",value:function(e){this.emit(F.MESSAGE_DISPLAYED,e)}}]),e}();t.default=q,e.exports=t.default},704:function(e,t,r){"use strict";function n(e){var t=void 0,r=(0,d.default)(e);if(r.attr("ts")||r.attr("ts",(new Date).toISOString()),(0,u.isTextMessage)(e))t=(0,s.parseStanza)(e);else{if(!(0,u.isFileMessage)(e))return null;t=(0,o.parseStanza)(e)}return Object.assign({},t,{status:a.SUCCESS,serverTs:t.ts,deliveryTs:Date.now()})}Object.defineProperty(t,"__esModule",{value:!0});var i=r(78),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(i),s=r(137),o=r(138),u=r(7),c=r(5),d=function(e){return e&&e.__esModule?e:{default:e}}(c);t.default=n,e.exports=t.default},705:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=r(7),c=r(36),d=function(){function e(t){n(this,e),this._messageParser=t}return a(e,[{key:"canParse",value:function(e){var t=(0,o.default)(e),r=(0,u.unwrap)(e),n=i(r,1),a=n[0];return"forwarded"===t.name()&&t.attr("xmlns")===c.FORWARD&&this._messageParser.canParse(a)}},{key:"parse",value:function(e){var t=(0,u.unwrap)(e,"forwarded"),r=i(t,1),n=r[0];return this._messageParser.parse(n)}}]),e}();t.default=d,e.exports=t.default},706:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t,r,n,i){var a=(0,u.default)(n,["stanzaInString","target","roomId"]),s=new h.default(e,t,r,i);return Object.assign(s,a,{type:l.UNKNOWN}),s}function a(e){var t=void 0,r=void 0,n=void 0,a=(0,d.default)(e),o=s.Strophe.getBareJidFromJid(a.attr("from")),u=a.attr("id"),c=new Date(a.attr("ts")||Date.now()).getTime();return"groupchat"===a.attr("type")?(t=f.GROUP,r=a.find("thread")[0].content(),n=r):(t=f.USER,r=o,n=s.Strophe.getBareJidFromJid(a.attr("to"))),i(u,o,n,{stanzaInString:(new XMLSerializer).serializeToString(e),target:t,roomId:r},c)}Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(71),u=n(o),c=r(5),d=n(c),l=r(48),f=r(24),p=r(77),h=n(p);t.default={create:i,parseStanza:a},e.exports=t.default},707:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){if("message"!==e.nodeName||(0,p.isAckMessage)(e))return!1;var t=(0,f.default)(e).attr("type");return!t||-1!==g.indexOf(t)}function a(e){if(!i(e))return e;var t=s.Strophe.xmlElement("request",{xmlns:_.RECEIPTS});e.appendChild(t);var r=s.Strophe.xmlElement("request",{xmlns:_.MAAII_SERVER_RECEIPTS});return e.appendChild(r),e}Object.defineProperty(t,"__esModule",{value:!0}),t.shouldInjectReceiptRequest=i,t.injectReceiptRequest=a;var s=r(1),o=r(27),u=n(o),c=r(3),d=r(16),l=r(5),f=n(l),p=r(7),h=r(56),_=r(36),v=c.LoggerFactory.getInstance().getLogger("im/xmpp/strophe/plugin/DeliveryReceipt");s.Strophe.addNamespace("RECEIPTS",_.RECEIPTS),s.Strophe.addNamespace("MAAII_SERVER_RECEIPTS",_.MAAII_SERVER_RECEIPTS);var g=["normal","chat","groupchat","headline"],m={init:function(e){this._conn=e},statusChanged:function(e){var t=void 0;switch(e){case s.Strophe.Status.CONNECTED:t=d.addStanzaHandler;break;case s.Strophe.Status.ATTACHED:t=d.addDelayedStanzaHandler;break;default:return}t(this._conn,{name:"message"},this.deliveryReceiptRequestHandler.bind(this),h.STANZA_DELAY_MS)},deliveryReceiptRequestHandler:function(e){return(0,p.isAckMessage)(e)&&this.handleAckMessage(e),(0,p.isDeliveryReceiptRequest)(e)&&this.handleDeliveryReceiptRequest(e),!0},handleAckMessage:function(e){var t=void 0,r=(0,f.default)(e),n=r.findFirst("received"),i=n.attr("id"),a=n.attr("xmlns"),s=(0,p.getRecordInfo)(e),o=s.recordId,c=s.prevRecordId;if(a===_.RECEIPTS)t="recipient";else{if(a!==_.MAAII_SERVER_RECEIPTS)return void v.warn("unknown delivery receipt received: ",e);t="server"}u.default.publish("plugin.im.delivery-receipt",[{type:t,messageId:i,recordId:o,prevRecordId:c,time:new Date(r.attr("ts")).getTime()}])},handleDeliveryReceiptRequest:function(e){var t=(0,f.default)(e);u.default.publish("plugin.im.dr-request",[{jid:t.attr("from"),messageId:t.attr("id")}])}},y=s.Strophe.Connection.prototype._queueData;s.Strophe.Connection.prototype._queueData=function(e){((0,p.isTextMessage)(e)||(0,p.isFileMessage)(e))&&(e=a(e)),y.call(this,e)},t.default=m},708:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){var t=(0,d.default)(e),r=t.findFirst("displayed"),n=r.attr("id"),i=a.Strophe.getBareJidFromJid(t.attr("from")),s=new Date(t.attr("ts")||Date.now()).getTime(),o=i,u=(0,l.getRecordInfo)(e),c=u.recordId,f=u.prevRecordId;return"groupchat"===t.attr("type")&&(o=t.findFirst("thread").content()),{roomId:o,jid:i,messageId:n,recordId:c,prevRecordId:f,time:s}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(1),s=r(27),o=n(s),u=r(16),c=r(5),d=n(c),l=r(7),f=r(3),p=r(56),h=f.LoggerFactory.getInstance().getLogger("im/xmpp/strophe/plugin/DisplayedReceipt");a.Strophe.addNamespace("MAAII_RECEIPTS","urn:maaii:receipts");var _={init:function(e){this._conn=e},statusChanged:function(e){var t=void 0;switch(e){case a.Strophe.Status.CONNECTED:t=u.addStanzaHandler;break;case a.Strophe.Status.ATTACHED:t=u.addDelayedStanzaHandler;break;default:return}t(this._conn,{name:"message"},this._incomingMessageHandler,p.STANZA_DELAY_MS)},_incomingMessageHandler:function(e){if((0,l.isDisplayedReceipt)(e))try{var t=i(e);o.default.publish("plugin.im.displayed-receipt",[t])}catch(t){h.warn("Cannot parse the displayed receipt stanza: %s",t.message,e)}return!0}};t.default=_,e.exports=t.default},709:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i=r(1),a=r(27),s=function(e){return e&&e.__esModule?e:{default:e}}(a),o=r(57),u=r(78),c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(u),d=r(137),l=r(138),f=r(24),p={init:function(e){this._conn=e},statusChanged:function(e){switch(e){case i.Strophe.Status.CONNECTED:case i.Strophe.Status.ATTACHED:this._addEchoNotificationListeners();break;case i.Strophe.Status.DISCONNECTED:this._removeEchoNotificationListeners()}},_addEchoNotificationListeners:function(){this._echoTextMessageSubscription=s.default.subscribe("plugin.notification.echo.message.text",this._onReceivedEchoTextMessage.bind(this)),this._echoFileMessageSubscription=s.default.subscribe("plugin.notification.echo.message.file",this._onReceivedEchoFileMessage.bind(this)),this._echoDisplayedReceiptSubscription=s.default.subscribe("plugin.notification.echo.receipt.displayed",this._onReceivedEchoDisplayedReceipt.bind(this))},_removeEchoNotificationListeners:function(){s.default.unsubscribe(this._echoTextMessageSubscription),s.default.unsubscribe(this._echoFileMessageSubscription),s.default.unsubscribe(this._echoDisplayedReceiptSubscription)},_markGroupEchoMessageAsDelivered:function(e){var t=e.messageId,r=e.recordId,n=e.prevRecordId,i=e.type,a=Date.now();s.default.publish("plugin.im.delivery-receipt",[{type:i,messageId:t,recordId:r,prevRecordId:n,time:a}])},_onReceivedEchoTextMessage:function(e){var t=e.attributes,r=e.currentJid,a=(0,o.parseNameValueObjectArray)(t,!0),u=a.room,l=a.ts,p=a.id,h=a.msg,_=a.rid,v=a.prev_rid,g=a.is_group,m=i.Strophe.getBareJidFromJid(r),y=i.Strophe.getBareJidFromJid(u),E=new Date(l||Date.now()).getTime(),b="true"===g?f.GROUP:f.USER,S={status:c.SUCCESS,serverTs:E,target:b,roomId:y},I=(0,d.create)(p,m,y,{content:h,recordId:_,prevRecordId:v},E),R=Object.assign(I,S);if(s.default.publish("plugin.im.message",[R]),b===f.GROUP){var M={messageId:p,recordId:_,prevRecordId:v};this._markGroupEchoMessageAsDelivered(n({},M,{type:"server"})),this._markGroupEchoMessageAsDelivered(n({},M,{type:"recipient"}))}},_onReceivedEchoFileMessage:function(e){var t=e.attributes,r=e.currentJid,a=(0,o.parseNameValueObjectArray)(t,!0),u=a.room,d=a.ts,p=a.size,h=a.exp,_=a.id,v=a.mime,g=a.rid,m=a.prev_rid,y=a.is_group,E=a.file_url,b=a.file_name,S=a.tn_cid,I=i.Strophe.getBareJidFromJid(r),R=i.Strophe.getBareJidFromJid(u),M=new Date(d||Date.now()).getTime(),P="true"===y?f.GROUP:f.USER,k={status:c.SUCCESS,serverTs:M,target:P,roomId:R},O=(0,l.create)(_,I,R,{type:v,url:E,name:b,thumbnail:S,recordId:g,prevRecordId:m,size:parseInt(p,10),duration:parseInt(h,10)},M),A=Object.assign(O,k);if(s.default.publish("plugin.im.message",[A]),P===f.GROUP){var C={messageId:_,recordId:g,prevRecordId:m};this._markGroupEchoMessageAsDelivered(n({},C,{type:"server"})),this._markGroupEchoMessageAsDelivered(n({},C,{type:"recipient"}))}},_onReceivedEchoDisplayedReceipt:function(e){var t=e.attributes,r=e.currentJid,n=(0,o.parseNameValueObjectArray)(t,!0),a=n.room,u=n.ts,c=n.orig_id,d=n.rid,l=n.prev_rid;s.default.publish("plugin.im.displayed-receipt",[{roomId:i.Strophe.getBareJidFromJid(a),jid:i.Strophe.getBareJidFromJid(r),messageId:c,recordId:d,prevRecordId:l,time:new Date(u||Date.now()).getTime()}])}};t.default=p,e.exports=t.default},710:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function o(e){var t=(0,he.getGroupInfoFromResultIq)(e);if(null===t)throw new Ee.UnexpectedResponseError("Stanza cannot be parsed.");return t}function u(e,t){if(!t)return null;var r=(0,fe.default)(e),n=r.name()===t?r:r.findFirst(t);return n?n.attr("id"):null}function c(e){var t=u(e,"group");if(t)return t;var r=u(e,"query");if(!r)throw new Ee.NotFoundError("Missing group id.");return r}function d(e){var t=(0,fe.default)(e),r="group"===t.name()?t:t.findFirst("group"),n=r?r.attr("version"):null;if(!n)throw new Ee.NotFoundError("Missing group version.");return parseInt(n,10)}function l(e){var t=(0,fe.default)(e).findFirst("owner"),r=t?t.attr("jid"):null;if(!r)throw new Ee.NotFoundError("Missing group owner.");return r}function f(e){var t=(0,fe.default)(e).findFirst("subject");if(!t)throw new Ee.NotFoundError("Missing group subject.");return t.content()}function p(e){for(var t=[],r=(0,fe.default)(e).find("member"),n=0;n<r.length;n++){var i=r[n].attr("jid"),a=r[n].attr("role");!i||a!==me.ADMIN&&a!==me.MEMBER||t.push({jid:i,role:a})}return t}function h(e){var t={},r={};return(0,fe.default)(e).find("property").forEach(function(e){var n=e.attr("name"),i=e.attr("value");if(n&&i){var a=e.attr("scope"),s={value:i},o=e.attr("setOn");o&&(s.setOn=new Date(o).getTime());var u=e.content();u&&(s.content=u),a&&a===ye.USER?r[n]=s:t[n]=s}}),{properties:t,personalProperties:r}}function _(e){var t={};t.id=c(e),t.version=d(e),t.owner=l(e),t.subject=f(e),t.participants=p(e);var r=h(e),n=r.properties,i=r.personalProperties;return t.properties=n,t.personalProperties=i,t}function v(e){return(0,fe.default)(e).find("group").map(_)}function g(e){var t=e.type,r=e.message;return new((0,he.getErrorByStanzaErrorType)(t))(r)}function m(e){var t=new J.default(new z.default),r=new J.default(new x.default),n=new V.default,i=[{parser:t,channel:"plugin.im.message"},{parser:n,channel:"plugin.group.version"},{parser:new N.default(n),channel:"plugin.group.version"},{parser:r,channel:"plugin.im.chat-states"},{parser:new N.default(r),channel:"plugin.im.chat-states"},{parser:new H.default,channel:"plugin.im.displayed-receipt"}].map(function(t){var r=t.parser,n=t.channel;return new D.default(r,e,n)});return i.push(new ue.default(t)),i}function y(e){var t=[{parser:new K.default,channel:"plugin.group.joined.self"},{parser:new ee.default,channel:"plugin.group.joined.others"},{parser:new X.default,channel:"plugin.group.left"},{parser:new re.default,channel:"plugin.group.roles"},{parser:new ie.default,channel:"plugin.group.properties"},{parser:new se.default,channel:"plugin.group.subject"}];return t.map(function(t){var r=t.parser,n=t.channel;return new D.default(r,e,n)}).concat(t.map(function(t){var r=t.parser,n=t.channel;return new D.default(new N.default(r),e,n)}))}function E(e){S.Strophe.addConnectionPlugin("Error",de.default);var t=function(t,r){return new D.default(t,e,r)}(new Q.default,"plugin.im.message"),r=new T.default({name:"message",type:"groupchat"},t),n=m(e),i=y(e);[].concat(s(n),s(i)).forEach(function(e){return r.register(e)}),S.Strophe.addConnectionPlugin("SupportedGroupMessage",r)}Object.defineProperty(t,"__esModule",{value:!0});var b=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),S=r(1),I=r(4),R=n(I),M=r(75),P=n(M),k=r(25),O=n(k),A=r(193),C=n(A),w=r(338),T=n(w),G=r(209),D=n(G),j=r(210),N=n(j),U=r(340),x=n(U),L=r(711),H=n(L),F=r(712),J=n(F),B=r(713),V=n(B),q=r(339),z=n(q),W=r(341),Q=n(W),Y=r(714),X=n(Y),Z=r(715),K=n(Z),$=r(716),ee=n($),te=r(717),re=n(te),ne=r(718),ie=n(ne),ae=r(719),se=n(ae),oe=r(342),ue=n(oe),ce=r(720),de=n(ce),le=r(5),fe=n(le),pe=r(16),he=r(7),_e=r(206),ve=r(721),ge=r(58),me=r(93),ye=r(24),Ee=r(0),be=r(36),Se=function(){function e(t,r){a(this,e),(0,R.default)(this),this._pubsub=t,this._connectService=r,t.subscribe("plugin.group.joined.self",this._onGroupJoined.bind(this)),t.subscribe("plugin.group.joined.others",this._onParticipantsJoined.bind(this)),t.subscribe("plugin.group.left",this._onParticipantsLeft.bind(this)),t.subscribe("plugin.group.roles",this._onRolesChanged.bind(this)),t.subscribe("plugin.group.properties",this._onPropertiesChanged.bind(this)),t.subscribe("plugin.group.subject",this._onSubjectChanged.bind(this)),t.subscribe("plugin.group.error",this._onError.bind(this)),t.subscribe("plugin.group.version",this._onVersionChanged.bind(this)),E(t)}return b(e,[{key:"createGroup",value:function(e,t,r){var n=this._composeCreateGroupStanza(e,t,r);return this._sendIqRequest(n)}},{key:"addParticipants",value:function(e,t){var r=this._composeIq("set",[{name:"invite",attributes:{id:e,xmlns:be.MAAII_GROUP},body:t.map(function(e){return{name:"member",attributes:{jid:e}}})}]);return this._sendIqRequest(r)}},{key:"removeParticipants",value:function(e,t){var r=this._composeIq("set",[{name:"kick",attributes:{id:e,xmlns:be.MAAII_GROUP},body:t.map(function(e){return{name:"member",attributes:{jid:e}}})}]);return this._sendIqRequest(r)}},{key:"leaveGroup",value:function(e){var t=this._composeIq("set",[{name:"leave",attributes:{id:e,xmlns:be.MAAII_GROUP}}]);return this._sendIqRequest(t,function(){})}},{key:"changeParticipantRoles",value:function(e,t){var r=this._composeIq("set",[{name:"changeroles",attributes:{id:e,xmlns:be.MAAII_GROUP},body:(0,C.default)(t,function(e,t){return{name:"member",attributes:{jid:t,role:e}}})}]);return this._sendIqRequest(r)}},{key:"changeGroupSubject",value:function(e,t){var r=this;return new Promise(function(n,i){var a=(0,pe.generateMessageId)(e),s=function(e){return a===e.messageId},o=[{event:"plugin.im.delivery-receipt",filter:s,handler:function(e){return n({messageId:e.messageId})}},{event:"plugin.group.error",filter:s,handler:function(e){var t=e.error;return i(g(t))}}],u=(0,ve.subscribeEventsToRace)(r._pubsub,o),c=r._composeMessageStanza(e,a,[{name:"request",attributes:{xmlns:be.MAAII_SERVER_RECEIPTS}},{name:"subject",body:t}]);r._send(c),(0,P.default)(1e4).then(function(){u(),i(new Ee.TimeoutError("Timeout reached for the change subject request."))})})}},{key:"changeGroupProperties",value:function(e,t){var r=this;return new Promise(function(n,i){var a=(0,pe.generateMessageId)(e),o=function(e){return a===e.messageId},u=[{event:"plugin.im.delivery-receipt",filter:o,handler:function(e){return n({messageId:e.messageId})}},{event:"plugin.group.error",filter:o,handler:function(e){var t=e.error;return i(g(t))}}],c=(0,ve.subscribeEventsToRace)(r._pubsub,u),d=r._composeMessageStanza(e,a,[{name:"request",attributes:{xmlns:be.MAAII_SERVER_RECEIPTS}},{name:"properties",attributes:{xmlns:be.MAAII_GROUP},body:[].concat(s(Object.keys(t).map(function(e){var r={name:"property",attributes:{name:e,value:t[e]}};return"groupImage"===e&&(r.attributes.value=e,r.body=(0,_e.removeImageDataPrefix)(t[e])),r})))}]);r._send(d),(0,P.default)(1e4).then(function(){c(),i(new Ee.TimeoutError("Timeout reached for the change properties request."))})})}},{key:"changePersonalProperties",value:function(e,t){var r=this._composeIq("set",[{name:"properties",attributes:{id:e,xmlns:be.MAAII_GROUP},body:[].concat(s(Object.keys(t).map(function(e){return{name:"property",attributes:{name:e,scope:"user",value:t[e]}}})))}]);return this._sendIqRequest(r)}},{key:"fetchGroupDetails",value:function(e){var t=this._composeIq("get",[{name:"query",attributes:{id:e,xmlns:be.MAAII_GROUP}}]);return this._sendIqRequest(t,function(e){try{return _(e)}catch(e){throw new Ee.UnexpectedResponseError("Received malformed response.",e)}})}},{key:"fetchGroupMembership",value:function(e,t){var r=[{name:"max",body:""+e}];t&&r.push({name:"after",body:t});var n={name:"query",attributes:{xmlns:be.JABBER_SEARCH},body:{name:"set",attributes:{xmlns:be.RESULT_SET},body:r}},i=this._composeIq("set",n,"groups.maaii.com");return this._sendIqRequest(i,function(e){try{return v(e)}catch(e){throw new Ee.UnexpectedResponseError("Received malformed response.",e)}})}},{key:"_composeCreateGroupStanza",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._composeIq("set",[{name:"create",attributes:{xmlns:be.MAAII_GROUP},body:[{name:"group",body:[].concat(s(e.map(function(e){return{name:"member",attributes:{jid:e}}})),s(Object.keys(r).map(function(e){return{name:"property",attributes:{name:e,value:r[e]}}})),[{name:"subject",body:t}])}]}])}},{key:"_composeMessageStanza",value:function(e,t,r){var n=this._connectService.getJid(),i=S.Strophe.getDomainFromJid(n),a="multicast."+i;return fe.default.build({name:"message",attributes:{id:t,to:a,type:"groupchat"},body:[{name:"thread",body:e}].concat(s(r))})}},{key:"_composeIq",value:function(e,t,r){return fe.default.build({name:"iq",attributes:{id:(0,pe.generateIqId)(this._connectService.getJid()),type:e,to:r},body:t})}},{key:"_sendIqRequest",value:function(e,t,r){var n=this;return new Promise(function(i,a){n._connectService.getStropheConnection().sendIQ(e,function(e){var r=(0,O.default)(t)?t:o;try{i(r(e))}catch(e){a(e)}},function(e){var t=(0,O.default)(r)?r:he.createErrorFromErrorStanza;a(t(e))},1e4)})}},{key:"_send",value:function(e){this._connectService.getStropheConnection().send(e)}},{key:"_onGroupJoined",value:function(e){var t=e.id,r=e.version,n=e.groupInfo,i=n.subject,a=n.properties,s=n.owner,o=n.participants;this.emit(ge.GROUP_JOINED,{groupId:t,version:r,subject:i,properties:a,owner:s,participants:o})}},{key:"_onParticipantsJoined",value:function(e){this.emit(ge.PARTICIPANTS_JOINED,{groupId:e.id,participants:e.joined,version:e.version})}},{key:"_onParticipantsLeft",value:function(e){var t=e.left.map(function(e){return e.jid}),r=S.Strophe.getBareJidFromJid(this._connectService.getJid());this.emit(ge.PARTICIPANTS_LEFT,{groupId:e.id,participants:t,version:e.version}),t.includes(r)&&this.emit(ge.GROUP_LEFT,{groupId:e.id,version:e.version})}},{key:"_onRolesChanged",value:function(e){var t=e.roles.reduce(function(e,t){return Object.assign({},e,i({},t.jid,t.role))},{});this.emit(ge.ROLES_CHANGED,{groupId:e.id,participants:t,version:e.version})}},{key:"_onPropertiesChanged",value:function(e){var t=e.groupId,r=e.properties,n=e.version;this.emit(ge.PROPERTIES_CHANGED,{groupId:t,properties:r,version:n})}},{key:"_onSubjectChanged",value:function(e){var t=e.groupId,r=e.subject,n=e.version;this.emit(ge.SUBJECT_CHANGED,{groupId:t,subject:r,version:n})}},{key:"_onError",value:function(e){var t=e.messageId,r=e.groupId,n=e.error;this.emit(ge.ERROR,{messageId:t,groupId:r,error:g(n)})}},{key:"_onVersionChanged",value:function(e){this.emit(ge.GROUP_VERSION,e)}}]),e}();t.default=Se,e.exports=t.default},711:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=r(7),c=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,u.isDisplayedReceipt)(e)}},{key:"parse",value:function(e){var t=(0,o.default)(e),r=t.findFirst("displayed"),n=r.attr("id"),i=a.Strophe.getBareJidFromJid(t.attr("from")),s=new Date(t.attr("ts")||Date.now()).getTime(),c=i,d=(0,u.getRecordInfo)(e),l=d.recordId,f=d.prevRecordId;return"groupchat"===t.attr("type")&&(c=t.findFirst("thread").content()),{roomId:c,jid:i,messageId:n,recordId:l,prevRecordId:f,time:s}}}]),e}();t.default=c,e.exports=t.default},712:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(5),s=function(e){return e&&e.__esModule?e:{default:e}}(a),o=r(7),u=function(){function e(t){n(this,e),this._parser=t}return i(e,[{key:"canParse",value:function(e){var t=(0,s.default)(e);return(0,o.isGroupChat)(e)&&this._parser.canParse(t)}},{key:"parse",value:function(e){return this._parser.parse(e)}}]),e}();t.default=u,e.exports=t.default},713:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(7),s=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,a.isGroupChat)(e)}},{key:"parse",value:function(e){return{groupId:(0,a.getGroupId)(e),version:(0,a.getGroupVersion)(e)}}}]),e}();t.default=s,e.exports=t.default},714:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(7),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,a.isGroupLeftNotification)(e)}},{key:"parse",value:function(e){var t=(0,a.getGroupId)(e),r=(0,a.getGroupVersion)(e),n=(0,o.default)(e),i=n.findFirst("left");return{left:(0,a.parseMemberNodes)(i),id:t,version:r}}}]),e}();t.default=u,e.exports=t.default},715:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){var t=e.attr("jid"),r=e.findFirst("nick");return{jid:t,nickname:r&&r.content()}}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(7),o=r(5),u=function(e){return e&&e.__esModule?e:{default:e}}(o),c=function(){function e(){n(this,e)}return a(e,[{key:"canParse",value:function(e){return(0,s.isGroupSelfJoinedNotification)(e)}},{key:"parse",value:function(e){var t=(0,s.getGroupId)(e),r=(0,s.getGroupVersion)(e),n={participants:[],properties:{}};return(0,u.default)(e).findFirst("joined").findFirst("group").children().forEach(function(e){switch(e.name().toLowerCase()){case"owner":n.owner=i(e);break;case"subject":n.subject=e.content();break;case"member":n.participants.push((0,s.parseMemberNode)(e));break;case"property":var t=(0,s.getParsedPropertyData)(e),r=t.name,a=t.data;n.properties[r]=a}}),{groupInfo:n,id:t,version:r}}}]),e}();t.default=c,e.exports=t.default},716:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(7),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,a.isGroupOthersJoinedNotification)(e)}},{key:"parse",value:function(e){var t=(0,a.getGroupId)(e),r=(0,a.getGroupVersion)(e),n=(0,o.default)(e),i=n.findFirst("joined");return{joined:(0,a.parseMemberNodes)(i),id:t,version:r}}}]),e}();t.default=u,e.exports=t.default},717:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(7),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,a.isGroupRolesNotification)(e)}},{key:"parse",value:function(e){var t=(0,a.getGroupId)(e),r=(0,a.getGroupVersion)(e),n=(0,o.default)(e),i=n.findFirst("roles");return{roles:(0,a.parseMemberNodes)(i),id:t,version:r}}}]),e}();t.default=u,e.exports=t.default},718:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(7),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,a.isGroupPropertiesNotification)(e)}},{key:"parse",value:function(e){var t={},r=(0,a.getGroupId)(e),n=(0,a.getGroupVersion)(e);return(0,o.default)(e).findFirst("properties").find("property").forEach(function(e){var r=(0,a.getParsedPropertyData)(e),n=r.name,i=r.data;t[n]=i}),{groupId:r,version:n,properties:t}}}]),e}();t.default=u,e.exports=t.default},719:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(7),s=r(5),o=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(){n(this,e)}return i(e,[{key:"canParse",value:function(e){return(0,a.isGroupSubjectNotification)(e)}},{key:"parse",value:function(e){var t=(0,o.default)(e);return{groupId:(0,a.getGroupId)(e),version:(0,a.getGroupVersion)(e),subject:t.findFirst("subject").content()}}}]),e}();t.default=u,e.exports=t.default},720:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){var t={type:"unknown",message:""},r=(0,f.default)(e),n=r.attr("id"),i=r.findFirst("thread"),s=i&&i.content();s||h.error("The error stanza has no group id.\n      stanza: "+a.Strophe.serialize(e));var o=r.findFirst("error"),u=o.findFirst("text"),c=o.children(),d=c.length;return d<2?(h.warn("The error stanza has incomplete error information.\n      stanza: "+a.Strophe.serialize(e)),1===d&&(u?t.message=u.content():t.type=c[0].name())):(t.type=c[0].name(),t.message=u.content()),{messageId:n,groupId:s,error:t}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(1),s=r(27),o=n(s),u=r(16),c=r(7),d=r(3),l=r(5),f=n(l),p=r(56),h=d.LoggerFactory.getInstance().getLogger("im/xmpp/strophe/plugin/Error");t.default={init:function(e){this._conn=e},statusChanged:function(e){var t=void 0;switch(e){case a.Strophe.Status.CONNECTED:t=u.addStanzaHandler;break;case a.Strophe.Status.ATTACHED:t=u.addDelayedStanzaHandler;break;default:return}t(this._conn,{name:"message",type:"error"},this._onMessageReceived.bind(this),p.STANZA_DELAY_MS)},_onMessageReceived:function(e){if(!(0,c.isErrorNotification)(e))return!0;var t=i(e);return o.default.publish("plugin.group.error",[t]),!0}},e.exports=t.default},721:function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e){var t=e.subscribe,r=e.publish,n=e.unsubscribe;return(0,u.default)(t)&&(0,u.default)(r)&&(0,u.default)(n)}function a(e,t){(0,d.default)("pubsub",e,i,"expect pubsub to have `subscribe`, `publish` and `unsubscribe` methods"),(0,d.default)("eventHandlerDescriptors",t,Array.isArray,"expect array for `eventHandlerDescriptors`");var r=t.map(function(t){var r=t.event,n=t.filter,i=t.handler;return e.subscribe(r,function(e){n(e)&&i(e)})});return function(){r.forEach(function(t){return e.unsubscribe(t)}),r.length=0}}function s(e,t){(0,d.default)("pubsub",e,i,"expect pubsub to have `subscribe`, `publish` and `unsubscribe` methods"),(0,d.default)("eventHandlerDescriptors",t,Array.isArray,"expect array for `eventHandlerDescriptors`");var r=function(){n.forEach(function(t){return e.unsubscribe(t)}),n.length=0},n=t.map(function(t){var n=t.event,i=t.filter,a=t.handler;return e.subscribe(n,function(e){i(e)&&(a(e),r())})});return r}Object.defineProperty(t,"__esModule",{value:!0}),t.subscribeEvents=a,t.subscribeEventsToRace=s;var o=r(25),u=n(o),c=r(6),d=n(c)},722:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(){n(this,e)}return i(e,[{key:"querySummary",value:function(){return Promise.resolve([])}},{key:"queryLastMessage",value:function(e){return Promise.resolve({})}},{key:"fetchHistory",value:function(e,t){return Promise.resolve({query:t,items:[]})}}]),e}();t.default=a,e.exports=t.default},77:function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function e(t,r,i){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Date.now();n(this,e),this.id=t,this.from=r,this.to=i,this.ts=a,this.hasEdited=!1,this.hasDeleted=!1,this.recordId=null,this.prevRecordId=null};t.default=i,e.exports=t.default},78:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SENDING="sending",t.SUCCESS="success",t.FAILURE="failure",t.CANCELLED="cancelled"},79:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SERVER_TIME="server-time",t.CLIENT_TIME="client-time"},92:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ACTIVE="active",t.COMPOSING="composing"},93:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ADMIN="1",t.MEMBER="0"}},[676])});