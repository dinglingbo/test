<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chedao.websocket.webserver.user.dao.UserFriendDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.chedao.websocket.webserver.user.model.UserFriendEntity" id="userFriendMap">
        <result property="id" column="id"/>
        <result property="userid" column="user_id"/>
        <result property="username" column="user_name"/>
        <result property="friendid" column="friend_id"/>
        <result property="friendname" column="friend_name"/>
        <result property="typeid" column="type_id"/>
        <result property="buildtime" column="build_time"/>
    </resultMap>
    
  <sql id="Base_Column_List" > 
  	  	     id ,  	        
  	  	     userid ,
  	  	     username ,
  	  	     friendid ,
  	  	     friendname ,
  	  	     typeid ,
  	  	     buildtime
  </sql>

	<select id="queryObject" resultType="com.chedao.websocket.webserver.user.model.UserFriendEntity">
		select  <include refid="Base_Column_List" />  from user_friend where id = #{id}
	</select>
	<!--<select id="queryObject" resultType="com.chedao.websocket.webserver.user.model.UserInfoEntity">
		select  <include refid="Base_Column_List" />  from user_info where id = #{value}
	</select>
	
	<select id="queryByUid"  parameterType="long" resultType="com.chedao.websocket.webserver.user.model.UserInfoEntity">
		select  <include refid="Base_Column_List" />  from user_info where uid = #{id}
	</select>

	<select id="queryList" resultType="com.chedao.websocket.webserver.user.model.UserInfoEntity">
		select  <include refid="Base_Column_List" />  from user_info
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
 	<select id="queryTotal" resultType="int">
		select count(*) from user_info 
	</select>-->
	 
	<insert id="save" parameterType="com.chedao.websocket.webserver.user.model.UserFriendEntity" useGeneratedKeys="true" keyProperty="id">
		insert into user_friend
		(
			`userid`,
			`username`,
			`friendid`,
			`friendname`,
			`typeid`,
			`buildtime`
		)
		values
		(

			#{userid},
			#{username},
			#{friendid},
			#{friendname},
			#{typeid},
			NOW()
		)
	</insert>

	<!-- 批量增加 -->
	<insert id="saveBatch" parameterType="List">
		insert into user_friend
		(
		`user_id`,
		`user_name`,
		`friend_id`,
		`friend_name`,
		`type_id`,
		`build_time`
		)
		values
		<foreach collection="list" item="friend" index="index" separator=",">
			(#{friend.userid},#{friend.username},#{friend.friendid},#{friend.friendname},#{friend.typeid},now())
		</foreach>
	</insert>

	<update id="update" parameterType="com.chedao.websocket.webserver.user.model.UserFriendEntity">
		update user_friend
		<set>
			<if test="typeid != null">`type_id` = #{typeid},</if>
		</set>
		<set>
			<if test="friendname != null">`friend_name` = #{friendname} </if>
		</set>
		where user_id = #{userid} and friend_id=#{friendid}
	</update>

	<delete id="delete" parameterType="com.chedao.websocket.webserver.user.model.UserFriendEntity">
		delete from user_friend where ( user_id = #{userid} and friend_id=#{friendid} ) or ( user_id = #{friendid} and friend_id=#{userid} )
	</delete>

	<!--<update id="update" parameterType="com.chedao.websocket.webserver.user.model.UserInfoEntity">
		update user_info 
		<set>
			<if test="uid != null">`uid` = #{uid}, </if>
			<if test="deptid != null">`deptid` = #{deptid}, </if>
			<if test="name != null">`name` = #{name}, </if>
			<if test="nickname != null">`nickname` = #{nickname}, </if>
			<if test="sex != null">`sex` = #{sex}, </if>
			<if test="birthday != null">`birthday` = #{birthday}, </if>
			<if test="cardid != null">`cardid` = #{cardid}, </if>
			<if test="signature != null">`signature` = #{signature}, </if>
			<if test="school != null">`school` = #{school}, </if>
			<if test="education != null">`education` = #{education}, </if>
			<if test="address != null">`address` = #{address}, </if>
			<if test="phone != null">`phone` = #{phone}, </if>
			<if test="email != null">`email` = #{email}, </if>
			<if test="remark != null">`remark` = #{remark}, </if>
			<if test="profilephoto != null">`profilephoto` = #{profilephoto}, </if>
			<if test="createdate != null">`createdate` = #{createdate}, </if>
			<if test="createuser != null">`createuser` = #{createuser}, </if>
			<if test="updatedate != null">`updatedate` = #{updatedate}, </if>
			<if test="updateuser != null">`updateuser` = #{updateuser}</if>
		</set>
		where id = #{id}
	</update>
	
	<delete id="delete">
		delete from user_info where id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from user_info where id in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>-->

	<select id="isFriend" resultType="int">
		select count(1) from user_friend
		where user_id=#{userId} and friend_id=#{friendId}
	</select>

	<!-- 查找该用户某分组下的好友-->
	<select id="queryListUser" resultType="com.chedao.websocket.webserver.user.model.ImFriendUserInfoData" >
           select
		   	b.uid as id,
		    b.profilephoto as avatar,
		    a.friend_name as username,
		   	b.signature as sign
		   from user_friend a
		   INNER JOIN user_info b on b.uid = a.friend_id
		   where a.type_id = #{value}
    </select>

	<resultMap type="com.chedao.websocket.webserver.user.model.UserFriendTEntity" id="userFriendListMap">
		<result property="id" column="id"/>
		<result property="online" column="online"/>
		<result property="groupname" column="name"/>
		<association property="list" select="com.chedao.websocket.webserver.user.dao.UserFriendDao.queryListUser"
					 column="id">
		</association>
	</resultMap>
	<!-- 查找该用户好友列表-->
	<select id="queryUserFriendList" resultMap="userFriendListMap" >
            SELECT id, name, 2 as  online
			from user_type
			where user_id = #{userId}
    </select>

    <!-- 查找该用户某分组下的好友-->
    <select id="queryUserFriend" resultType="com.chedao.websocket.webserver.user.model.UserInfoEntity" >
           SELECT
            b.id,
            b.uid,
            b.deptid,
            b.`name`,
            a.friend_name AS nickname,
            b.sex,
            b.birthday,
            b.cardid,
            b.signature,
            b.school,
            b.education,
            b.province,
            b.city,
            b.area,
            b.address,
            b.phone,
            b.email,
            b.remark,
            b.profilephoto,
            b.createdate,
            b.createuser,
            b.updatedate,
            b.updateuser,
            b.lastondate,
            b.lastoffdate,
            b.lastupdatedate
          from user_friend a
          inner join user_info b
          on a.friend_id = b.uid
          where a.user_id = #{userid} and a.friend_id = #{friendid}
    </select>

</mapper>